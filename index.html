<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI Code Approval Portal</title>
    <!-- Note: Tailwind CDN is used for development. For production, install as PostCSS plugin -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // EmailJS Configuration
        const EMAIL_CONFIG = {
            serviceId: 'service_0xi7zg5',
            publicKey: 'zx157n_sqPsV0_piq',
            templates: {
                decision: 'template_approval_notifi',  // Template for approval/rejection notifications
                erpIntegration: 'template_erp_integration'  // Template for ERP integration notifications
            }
        };
        
        // Initialize EmailJS when page loads
        document.addEventListener('DOMContentLoaded', function() {
            emailjs.init(EMAIL_CONFIG.publicKey);
        });
        
        // Email sending functions
        async function sendDecisionNotification(requestData, decision, comments, reviewerInfo) {
            try {
                const statusClass = decision === 'approve' ? 'approved' : decision === 'reject' ? 'rejected' : 'forwarded';
                const statusText = decision === 'approve' ? 'Approved' : decision === 'reject' ? 'Rejected' : 'Forwarded for Review';
                const statusIcon = decision === 'approve' ? '' : decision === 'reject' ? '' : '';
                
                const templateParams = {
                    to_email: requestData.created_by_user?.email,
                    from_name: 'CSI Code Approval Portal',
                    decision: statusText, // 'Approved' or 'Rejected'
                    request_type: requestData.request_type || 'Request',
                    to_name: requestData.created_by_user?.username || 'User',
                    request_title: requestData.title || requestData.item_code || requestData.project_name,
                    request_id: requestData.id,
                    project_name: requestData.project?.project_name || 'N/A',
                    reviewer_name: reviewerInfo.username,
                    reviewer_type: reviewerInfo.role === 'admin' ? 'Admin' : 'Reviewer',
                    decision_date: new Date().toLocaleDateString(),
                    comments: comments || 'No comments provided',
                    status_class: statusClass,
                    status_text: statusText,
                    status_icon: statusIcon,
                    portal_link: window.location.origin + window.location.pathname
                };
                
                console.log('Sending decision notification with params:');
                console.log('Template ID:', EMAIL_CONFIG.templates.decision);
                console.log('Service ID:', EMAIL_CONFIG.serviceId);
                console.log('Template Parameters:', JSON.stringify(templateParams, null, 2));
                
                const response = await emailjs.send(
                    EMAIL_CONFIG.serviceId,
                    EMAIL_CONFIG.templates.decision,
                    templateParams
                );
                
                console.log('Decision notification sent successfully:', response);
                return { success: true };
                
            } catch (error) {
                console.error('Failed to send decision notification:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function sendERPIntegrationNotification(requestData, itemCodeData) {
            try {
                const templateParams = {
                    to_email: 'yogesh.nadesan@nesmapartners.com',
                    to_name: 'Yogesh',
                    item_code: itemCodeData.item_code || requestData.item_code,
                    description1: requestData.description1 || '',
                    description2: requestData.description2 || '',
                    uom: requestData.uom || '',
                    country_of_origin: requestData.country_of_origin || '',
                    model_number: requestData.model_number || '',
                    unit_price: requestData.unit_price || '',
                    currency_code: requestData.currency_code || '',
                    manufacturer: requestData.manufacturer || '',
                    project_name: requestData.project?.project_name || 'N/A',
                    admin_name: currentUser.username,
                    approval_date: new Date().toLocaleDateString(),
                    portal_link: window.location.origin + window.location.pathname
                };
                
                console.log('Sending ERP integration notification with params:');
                console.log('Template ID:', EMAIL_CONFIG.templates.erpIntegration);
                console.log('Service ID:', EMAIL_CONFIG.serviceId);
                console.log('Template Parameters:', JSON.stringify(templateParams, null, 2));
                
                const response = await emailjs.send(
                    EMAIL_CONFIG.serviceId,
                    EMAIL_CONFIG.templates.erpIntegration,
                    templateParams
                );
                
                console.log('ERP integration notification sent successfully:', response);
                return { success: true };
                
            } catch (error) {
                console.error('Failed to send ERP integration notification:', error);
                return { success: false, error: error.message };
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .container {
            max-width: 1400px;
            margin: auto;
        }
        .status-pending { 
            background-color: #fef3c7; 
            color: #92400e; 
        }
        .status-approved { 
            background-color: #d1fae5; 
            color: #065f46; 
        }
        .status-rejected { 
            background-color: #fee2e2; 
            color: #991b1b; 
        }
        .status-reviewer_approved { 
            background-color: #dbeafe; 
            color: #1e40af; 
        }
        .status-admin_approved { 
            background-color: #d1fae5; 
            color: #065f46; 
        }
        .status-reviewer_rejected { 
            background-color: #fee2e2; 
            color: #991b1b; 
        }
        .status-admin_rejected { 
            background-color: #fee2e2; 
            color: #991b1b; 
        }
        .request-card {
            transition: all 0.2s ease;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .csi-path-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        .csi-path-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px 0;
            color: white;
            transition: all 0.3s ease;
        }
        .csi-path-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        .csi-path-arrow {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 0 8px;
        }
        
        /* NEW: Deprecation styling for approval portal */
        .deprecated-attribute {
            background: linear-gradient(135deg, #FEF3C7 0%, #FBBF24 100%);
            border: 1px solid #F59E0B;
            border-radius: 6px;
            position: relative;
        }
        
        .deprecated-attribute::before {
            content: "âš ï¸ DEPRECATED VALUE";
            position: absolute;
            top: -8px;
            left: 8px;
            background: #F59E0B;
            color: white;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            font-weight: bold;
            z-index: 10;
        }
        
        .deprecated-warning {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .deprecated-warning::before {
            content: "âš ï¸";
            font-size: 16px;
            margin-right: 8px;
        }
        
        .attribute-selection-item {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            transition: all 0.2s ease;
        }
        
        .attribute-selection-item.has-deprecated {
            background: #FEF3C7;
            border-color: #F59E0B;
        }
        
        /* Workflow Dashboard Styles */
        .workflow-chart {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 24px;
            margin: 16px 0;
            border: 1px solid #e2e8f0;
        }
        
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            min-width: 120px;
            margin: 0 8px;
        }
        
        .workflow-milestone {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 12px;
            border: 3px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .workflow-milestone:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .milestone-submitted {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-color: #d97706;
            color: white;
        }
        
        .milestone-reviewer-approved {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            border-color: #2563eb;
            color: white;
        }
        
        .milestone-reviewer-rejected {
            background: linear-gradient(135deg, #f87171, #ef4444);
            border-color: #dc2626;
            color: white;
        }
        
        .milestone-admin-approved {
            background: linear-gradient(135deg, #34d399, #10b981);
            border-color: #059669;
            color: white;
        }
        
        .milestone-admin-rejected {
            background: linear-gradient(135deg, #fca5a5, #f87171);
            border-color: #dc2626;
            color: white;
        }
        
        .milestone-erp-integrated {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            border-color: #7c3aed;
            color: white;
        }
        
        .milestone-erp-pending {
            background: linear-gradient(135deg, #fde047, #eab308);
            border-color: #ca8a04;
            color: white;
        }
        
        .milestone-count {
            font-size: 18px;
            font-weight: 700;
        }
        
        .milestone-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .workflow-arrow {
            position: absolute;
            top: 40px;
            right: -20px;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #64748b, #94a3b8);
            z-index: 1;
        }
        
        .workflow-arrow::after {
            content: '';
            position: absolute;
            right: -8px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 8px solid #64748b;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }
        
        .workflow-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-left: 40px;
        }
        
        .workflow-branch-connector {
            width: 2px;
            height: 40px;
            background: linear-gradient(180deg, #64748b, #94a3b8);
            position: relative;
        }
        
        .workflow-branch-connector::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 20px;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #64748b, #94a3b8);
        }
        
        .workflow-row {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .workflow-section-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .workflow-tab-btn.active {
            border-color: #3b82f6 !important;
            color: #2563eb !important;
            background-color: #dbeafe !important;
        }
        
        .workflow-content {
            min-height: 300px;
        }
        
        .workflow-detail-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            padding: 24px;
            z-index: 1000;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .workflow-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        /* Pending Requests Sub-tabs Styles */
        .pending-subtab-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .pending-subtab-btn:hover {
            color: #374151;
        }
        
        .pending-subtab-btn.active {
            border-color: #3b82f6 !important;
            color: #2563eb !important;
        }
        
        .pending-subtab-content {
            min-height: 400px;
        }
        
        .request-type-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }
        
        .badge-project {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        
        .badge-item-code {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-standard-value {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-combination {
            background-color: #fde2e8;
            color: #be185d;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Approval Portal Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-red-600 text-sm hidden"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- SIMPLIFIED REVIEW MODAL -->
<div id="review-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b flex-shrink-0">
                <h2 id="review-modal-title" class="text-xl font-semibold text-gray-900">Review Project</h2>
                <button type="button" onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="sr-only">Close</span>
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto flex-1 min-h-0">
                <div id="review-modal-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="border-t p-6 flex-shrink-0">
                <div class="mb-4">
                    <label for="review-comments" class="block text-sm font-medium text-gray-700 mb-2">Comments</label>
                    <textarea id="review-comments" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Add your review comments..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeReviewModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <div id="modal-action-buttons">
                        <!-- Buttons will be dynamically added based on user role and item status -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Main Container -->
    <div id="main-container" class="container bg-white rounded-xl shadow-lg mt-8 hidden">
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b">
            <h1 class="text-3xl font-bold text-gray-800">CSI Code Approval Portal</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-sm text-gray-600"></span>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                    Logout
                </button>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="dashboard-stats" class="p-6 border-b bg-gray-50">
            <h2 class="text-xl font-semibold mb-6">Workflow Dashboard Overview</h2>
            
            <!-- Dashboard Navigation -->
            <div class="mb-6">
                <div class="flex flex-wrap gap-2 border-b">
                    <button class="workflow-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50" data-workflow="all">
                        All Types Combined
                    </button>
                    <button class="workflow-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50" data-workflow="projects">
                        Classification Projects
                    </button>
                    <button class="workflow-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50" data-workflow="item-codes">
                        Item Code Requests
                    </button>
                    <button class="workflow-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50" data-workflow="standard-values">
                        Standard Value Requests
                    </button>
                    <button class="workflow-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50" data-workflow="combinations">
                        Combination Requests
                    </button>
                </div>
            </div>

            <!-- Workflow Content Sections -->
            <div id="workflow-all" class="workflow-content">
                <div id="all-workflow-chart"></div>
            </div>

            <div id="workflow-projects" class="workflow-content hidden">
                <div id="projects-workflow-chart"></div>
            </div>

            <div id="workflow-item-codes" class="workflow-content hidden">
                <div id="item-codes-workflow-chart"></div>
            </div>

            <div id="workflow-standard-values" class="workflow-content hidden">
                <div id="standard-values-workflow-chart"></div>
            </div>

            <div id="workflow-combinations" class="workflow-content hidden">
                <div id="combinations-workflow-chart"></div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b">
            <nav class="flex space-x-8 px-6">
                <button class="tab-btn py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="pending-requests">
                    Pending Reviews
                </button>
                <button class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="all-requests">
                    All Requests
                </button>
                <button id="admin-tab" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hidden" data-tab="admin-panel">
                    Admin Panel
                </button>
            </nav>
        </div>
     
        <!-- Pending Requests Tab -->
        <div id="pending-requests-tab" class="tab-content p-6">
            <!-- Sub-tabs Navigation -->
            <div class="mb-6">
                <div class="border-b">
                    <nav class="flex space-x-6">
                        <button class="pending-subtab-btn py-3 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm" data-subtab="classification-projects">
                            Classification Projects
                        </button>
                        <button class="pending-subtab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm" data-subtab="item-codes">
                            Item Code Requests
                        </button>
                        <button class="pending-subtab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm" data-subtab="standard-values">
                            Standard Value Requests
                        </button>
                        <button class="pending-subtab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm" data-subtab="combinations">
                            Combination Requests
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Sub-tab Content Areas -->
            <div id="classification-projects-subtab" class="pending-subtab-content">
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Pending Classification Projects</h3>
                            <p class="text-sm text-gray-600">Projects awaiting your review decision</p>
                        </div>
                        
                        <!-- Bulk Action Controls -->
                        <div class="flex items-center space-x-2">
                            <button id="bulk-toggle-projects" 
                                    onclick="toggleBulkMode('projects')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium">
                                <span class="bulk-mode-text">Enable Bulk Actions</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions Bar (Hidden by default) -->
                    <div id="bulk-actions-projects" class="hidden mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-medium text-blue-800">
                                    <span id="selected-count-projects">0</span> items selected
                                </span>
                                <button onclick="selectAllItems('projects', true)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Select All
                                </button>
                                <button onclick="selectAllItems('projects', false)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Clear Selection
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="bulkApprove('projects')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Approve Selected
                                </button>
                                <button onclick="bulkReject('projects')" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Reject Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="classification-projects-container" class="space-y-4">
                    <!-- Classification projects will be loaded here -->
                </div>
            </div>

            <div id="item-codes-subtab" class="pending-subtab-content hidden">
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Pending Item Code Requests</h3>
                            <p class="text-sm text-gray-600">Item code requests awaiting your review decision</p>
                        </div>
                        
                        <!-- Bulk Action Controls -->
                        <div class="flex items-center space-x-2">
                            <button id="bulk-toggle-item-codes" 
                                    onclick="toggleBulkMode('item-codes')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium">
                                <span class="bulk-mode-text">Enable Bulk Actions</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions Bar (Hidden by default) -->
                    <div id="bulk-actions-item-codes" class="hidden mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-medium text-blue-800">
                                    <span id="selected-count-item-codes">0</span> items selected
                                </span>
                                <button onclick="selectAllItems('item-codes', true)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Select All
                                </button>
                                <button onclick="selectAllItems('item-codes', false)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Clear Selection
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="bulkApprove('item-codes')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Approve Selected
                                </button>
                                <button onclick="bulkReject('item-codes')" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Reject Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="item-codes-container" class="space-y-4">
                    <!-- Item code requests will be loaded here -->
                </div>
            </div>

            <div id="standard-values-subtab" class="pending-subtab-content hidden">
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Pending Standard Value Requests</h3>
                            <p class="text-sm text-gray-600">Standard value requests awaiting your review decision</p>
                        </div>
                        
                        <!-- Bulk Action Controls -->
                        <div class="flex items-center space-x-2">
                            <button id="bulk-toggle-standard-values" 
                                    onclick="toggleBulkMode('standard-values')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium">
                                <span class="bulk-mode-text">Enable Bulk Actions</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions Bar (Hidden by default) -->
                    <div id="bulk-actions-standard-values" class="hidden mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-medium text-blue-800">
                                    <span id="selected-count-standard-values">0</span> items selected
                                </span>
                                <button onclick="selectAllItems('standard-values', true)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Select All
                                </button>
                                <button onclick="selectAllItems('standard-values', false)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Clear Selection
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="bulkApprove('standard-values')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Approve Selected
                                </button>
                                <button onclick="bulkReject('standard-values')" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Reject Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="standard-values-container" class="space-y-4">
                    <!-- Standard value requests will be loaded here -->
                </div>
            </div>

            <div id="combinations-subtab" class="pending-subtab-content hidden">
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Pending Combination Requests</h3>
                            <p class="text-sm text-gray-600">Combination requests awaiting your review decision</p>
                        </div>
                        
                        <!-- Bulk Action Controls -->
                        <div class="flex items-center space-x-2">
                            <button id="bulk-toggle-combinations" 
                                    onclick="toggleBulkMode('combinations')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium">
                                <span class="bulk-mode-text">Enable Bulk Actions</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions Bar (Hidden by default) -->
                    <div id="bulk-actions-combinations" class="hidden mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-medium text-blue-800">
                                    <span id="selected-count-combinations">0</span> items selected
                                </span>
                                <button onclick="selectAllItems('combinations', true)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Select All
                                </button>
                                <button onclick="selectAllItems('combinations', false)" 
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Clear Selection
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="bulkApprove('combinations')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Approve Selected
                                </button>
                                <button onclick="bulkReject('combinations')" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium">
                                    Reject Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="combinations-container" class="space-y-4">
                    <!-- Combination requests will be loaded here -->
                </div>
            </div>
        </div>

        <!-- All Requests Tab -->
        <div id="all-requests-tab" class="tab-content p-6 hidden">
            <!-- Filter Controls -->
            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Filter Requests</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="submitted">Submitted</option>
                            <option value="reviewer_approved">Reviewer Approved</option>
                            <option value="reviewer_rejected">Reviewer Rejected</option>
                            <option value="admin_approved">Admin Approved</option>
                            <option value="admin_rejected">Admin Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Types</option>
                            <option value="project">Classification Projects</option>
                            <option value="code">Item Code Requests</option>
                            <option value="block">Block Combination Requests</option>
                            <option value="value">Standard Value Requests</option>
                        </select>
                    </div>
                    <div>
                        <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                        <select id="date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="applyFilters()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div id="all-requests-summary" class="mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-gray-500">
                    <div class="text-2xl font-bold text-gray-600" id="total-requests-count">0</div>
                    <div class="text-sm text-gray-600">Total Requests</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                    <div class="text-2xl font-bold text-yellow-600" id="pending-requests-count">0</div>
                    <div class="text-sm text-gray-600">Pending</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <div class="text-2xl font-bold text-blue-600" id="under-review-count">0</div>
                    <div class="text-sm text-gray-600">Under Review</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <div class="text-2xl font-bold text-green-600" id="approved-requests-count">0</div>
                    <div class="text-sm text-gray-600">Approved</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                    <div class="text-2xl font-bold text-red-600" id="rejected-requests-count">0</div>
                    <div class="text-sm text-gray-600">Rejected</div>
                </div>
            </div>

            <!-- Requests Container -->
            <div id="all-requests-container" class="space-y-4">
                <!-- All requests will be loaded here -->
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="admin-panel-tab" class="tab-content p-6 hidden">
            <div id="admin-panel-container" class="space-y-4">
                <!-- Admin panel content will be loaded here -->
            </div>
        </div>
    </div>

<script>
// ===== GLOBAL VARIABLES =====
let currentUser = null;
let currentReviewItem = null; // Store current item being reviewed

// Bulk approval state management
let selectedItems = {
    projects: [],
    'item-codes': [],
    'standard-values': [],
    combinations: []
};
let bulkApprovalMode = false;

// ===== EMAIL NOTIFICATION SYSTEM ===== (Replaced with new system)
// All email functions are now handled by the new sendDecisionNotification and sendERPIntegrationNotification functions

// ===== END EMAIL NOTIFICATION SYSTEM =====

// ===== SUPABASE INITIALIZATION =====
const SUPABASE_URL = 'https://mvftaaxgdygeyzcvzqfr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12ZnRhYXhnZHlnZXl6Y3Z6cWZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjI3OTQsImV4cCI6MjA3NDE5ODc5NH0.nj5c_AAEg4U2qlcE1vQDMWt0nfXpmUYR1lrTR6KCIDY';

// Ã°Å¸Å½Â¯ PERFECT SUPABASE SOLUTION - Handles all edge cases including auto-login URLs
// Check if client is already created on window to avoid redeclaration error
if (window.supabase && !window.supabaseInstance) {
    window.supabaseInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Ã¢Å“â€¦ Supabase client created successfully');
}

// Use var to allow redeclaration if the script is re-run (page reloads, auto-login)
var supabase = window.supabaseInstance;

// Validation
if (!supabase) {
    console.error('Ã¢ÂÅ’ Supabase client not available');
} else {
    console.log('Ã¢Å“â€¦ Supabase client ready for use');
}

// ===== MODAL FUNCTIONS =====
// Add this function to the approval portal
async function assignReviewer(requestId, requestType) {
    try {
        // First, get list of available reviewers
        const { data: reviewers, error: reviewerError } = await supabase
            .from('users')
            .select('id, username, email')
            .eq('role', 'reviewer')
            .eq('status', 'active');
            
        if (reviewerError) throw reviewerError;
        
        if (!reviewers || reviewers.length === 0) {
            alert('No active reviewers available');
            return;
        }
        
        // Create reviewer selection modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center';
        modal.innerHTML = `
            <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold mb-4">Assign Reviewer</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Reviewer:</label>
                    <select id="reviewer-select" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">Choose reviewer...</option>
                        ${reviewers.map(r => `<option value="${r.id}">${r.username} (${r.email})</option>`).join('')}
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md">Cancel</button>
                    <button onclick="performAssignment(${requestId}, '${requestType}')" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md">Assign</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error in assignReviewer:', error);
        alert('Failed to load reviewers: ' + error.message);
    }
}

async function performAssignment(requestId, requestType) {
    const reviewerId = document.getElementById('reviewer-select').value;
    if (!reviewerId) {
        alert('Please select a reviewer');
        return;
    }
    
    try {
        let table;
        switch(requestType) {
            case "code": table = "item_code_workflow"; break;
            case 'block': table = 'combination_requests'; break;
            case 'value': table = 'standard_value_requests'; break;
            default: throw new Error('Unknown request type');
        }
        
        const { error } = await supabase
            .from(table)
            .update({ reviewed_by: reviewerId })
            .eq('id', requestId);
            
        if (error) throw error;
        
        alert('Reviewer assigned successfully');
        document.querySelector('.fixed').remove(); // Close modal
        
        // Refresh the page data
        if (typeof loadPendingRequests === 'function') {
            loadPendingRequests();
        }
        
    } catch (error) {
        console.error('Error assigning reviewer:', error);
        alert('Failed to assign reviewer: ' + error.message);
    }
}
async function openReviewModal(type, id) {
    console.log('Opening review modal for type:', type, 'id:', id);
    
    if (type === 'project') {
        // Handle project review modal
        await openProjectReviewModal(id);
        return; // Exit early since openProjectReviewModal handles the modal
    }
    
    try {
        // For other types (code, block, value), use the item review modal
        await openItemReviewModal(type, id);
        
        // The openItemReviewModal function now handles everything including buttons
        
    } catch (error) {
        console.error('Error opening review modal:', error);
        alert('Error opening review modal: ' + error.message);
    }
}
async function loadItemRequestModal(type, id, title, content) {
    try {
        let data;
        
        switch(type) {
            case 'code':
                const { data: codeData, error: codeError } = await supabase
                    .from("item_code_workflow")
                    .select(`
                        *,
                        created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                        reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                        project:classification_projects(project_name, division_code, section_code, detailed_section_code, item_code)
                    `)
                    .eq('id', id)
                    .single();
                
                if (codeError) throw codeError;
                data = codeData;
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Item Code Request</h3>
                            <p class="text-sm text-gray-600">${data.project?.project_name || 'Unknown Project'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Reviewed by:</strong> ${data.reviewed_by_user?.username || 'Unassigned'}</div>
                            <div><strong>UOM:</strong> ${data.uom || 'N/A'}</div>
                            <div><strong>Country:</strong> ${data.country_of_origin || 'N/A'}</div>
                            <div><strong>Model:</strong> ${data.model_number || 'N/A'}</div>
                            <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                        </div>
                        <div><strong>Item Code:</strong> ${data.item_code || 'N/A'}</div>
                        <div><strong>Description 1:</strong> ${data.description1 || 'N/A'}</div>
                        <div><strong>Description 2:</strong> ${data.description2 || 'N/A'}</div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-900 mb-3">Financial Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><strong>Unit Price:</strong> <span class="text-green-600 font-semibold">${data.unit_price ? parseFloat(data.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'Not specified'}</span></div>
                                <div><strong>Currency:</strong> <span class="font-mono bg-yellow-100 px-2 py-1 rounded">${data.currency_code || 'Not specified'}</span></div>
                            </div>
                            <div class="mt-2"><strong>Manufacturer:</strong> <span class="text-blue-600 font-medium bg-blue-100 px-2 py-1 rounded">${data.manufacturer || 'Not specified'}</span></div>
                        </div>
                        
                        ${data.review_comments ? `<div class="bg-blue-50 p-3 rounded"><strong>Comments:</strong> ${data.review_comments}</div>` : ''}
                    </div>
                `;
                break;
                
            case 'block':
                const { data: blockData, error: blockError } = await supabase
                    .from('combination_requests')
                    .select(`
                        *,
                        created_by_user:users!combination_requests_created_by_fkey(username, email),
                        reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', id)
                    .single();
                
                if (blockError) throw blockError;
                data = blockData;
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Block Combination Request</h3>
                            <p class="text-sm text-gray-600">${data.project?.project_name || 'Unknown Project'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Reviewed by:</strong> ${data.reviewed_by_user?.username || 'Unassigned'}</div>
                            <div><strong>Request Type:</strong> ${data.request_type || 'N/A'}</div>
                            <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                        </div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                        <div><strong>Combination Signature:</strong> <code class="text-xs">${data.combination_signature || 'N/A'}</code></div>
                        ${data.reviewer_comments ? `<div class="bg-blue-50 p-3 rounded"><strong>Comments:</strong> ${data.reviewer_comments}</div>` : ''}
                    </div>
                `;
                break;
                
            case 'value':
                const { data: valueData, error: valueError } = await supabase
                    .from('standard_value_requests')
                    .select(`
                        *,
                        created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                        reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', id)
                    .single();
                
                if (valueError) throw valueError;
                data = valueData;
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Add Standard Value: ${data.new_value}</h3>
                            <p class="text-sm text-gray-600">Attribute: ${data.attribute_name}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Reviewed by:</strong> ${data.reviewed_by_user?.username || 'Unassigned'}</div>
                            <div><strong>Project:</strong> ${data.project?.project_name || 'N/A'}</div>
                            <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                        </div>
                        <div><strong>New Value:</strong> <span class="font-mono bg-green-100 px-2 py-1 rounded">${data.new_value}</span></div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                        ${data.reviewer_comments ? `<div class="bg-blue-50 p-3 rounded"><strong>Comments:</strong> ${data.reviewer_comments}</div>` : ''}
                    </div>
                `;
                break;
                
            default:
                throw new Error('Unknown request type: ' + type);
        }
        
        // Store the request info for modal buttons
        window.currentReviewRequest = { type, id };
        
    } catch (error) {
        console.error('Error loading item request modal:', error);
        content.innerHTML = `<div class="text-red-500">Error loading details: ${error.message}</div>`;
    }
}
async function submitModalReview(decision) {
    try {
        if (!window.currentReviewRequest) {
            alert('No item selected for review');
            return;
        }

        // FIXED: Don't normalize the decision - keep it as passed from the button
        console.log('Original decision from button:', decision);
        
        const comments = document.getElementById('review-comments').value;
        const { type, id } = window.currentReviewRequest;
        
        console.log('Submitting modal review:', decision, 'for', type, id, 'with comments:', comments);

        let result;
        
        if (currentUser.role === 'admin') {
            result = await submitAdminReview(type, id, decision, comments);
        } else {
            result = await submitReviewerReview(type, id, decision, comments);
        }

        if (result && result.success) {
            alert(result.message || 'Review submitted successfully');
            closeReviewModal();
            loadPendingRequests();
            loadDashboardStats();
        } else {
            alert(result?.message || 'Error processing review');
        }

    } catch (error) {
        console.error('Error submitting modal review:', error);
        alert('Error submitting review: ' + error.message);
    }
}

function closeReviewModal() {
    document.getElementById('review-modal').classList.add('hidden');
    currentReviewItem = null;
    window.currentReviewRequest = null;
    document.getElementById('review-comments').value = '';
}
async function openProjectReviewModal(projectId) {
    try {
        console.log('Loading project for review:', projectId, 'User role:', currentUser.role);
        
        let projectData;
        
        if (currentUser.role === 'admin') {
            // Admin can view any project - try admin function first, then fallback
            try {
                const { data, error } = await supabase
                    .rpc('admin_get_project_for_edit', {
                        project_id_param: projectId,
                        admin_id_param: currentUser.id
                    });
                
                if (error) throw error;
                
                if (data.success) {
                    projectData = data;
                } else {
                    throw new Error(data.message || 'Admin function failed');
                }
            } catch (adminError) {
                console.log('Admin function failed, using direct query:', adminError.message);
                
                // Fallback to direct database query
                const { data: directData, error: directError } = await supabase
                    .from('classification_projects')
                    .select(`
                        *,
                        creator:users!classification_projects_created_by_fkey(username, email),
                        reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                        admin:users!classification_projects_admin_id_fkey(username, email)
                    `)
                    .eq('id', projectId)
                    .single();
                
                if (directError) throw directError;
                
                // Get project attributes separately
                const { data: attributesData, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('*')
                    .eq('project_id', projectId);
                
                if (attrError) throw attrError;
                
                projectData = {
                    success: true,
                    project: {
                        ...directData,
                        creator_name: directData.creator?.username,
                        creator_email: directData.creator?.email,
                        reviewer_name: directData.reviewer?.username,
                        admin_name: directData.admin?.username
                    },
                    attributes: attributesData || []
                };
            }
        } else if (currentUser.role === 'reviewer') {
            // Try reviewer-specific function first
            try {
                const { data, error } = await supabase
                    .rpc('get_project_for_review', { 
                        project_id_param: projectId, 
                        reviewer_id_param: currentUser.id 
                    });

                if (error) throw error;

                if (data && data.success) {
                    projectData = data;
                } else {
                    throw new Error(data?.message || 'Reviewer function failed');
                }
            } catch (reviewerError) {
                console.log('Reviewer function failed, using direct query:', reviewerError.message);
                
                // Fallback for reviewers - they can view projects assigned to them or any project
                const { data: directData, error: directError } = await supabase
                    .from('classification_projects')
                    .select(`
                        *,
                        creator:users!classification_projects_created_by_fkey(username, email),
                        reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                        admin:users!classification_projects_admin_id_fkey(username, email)
                    `)
                    .eq('id', projectId)
                    .single();
                
                if (directError) throw directError;
                
                // Get project attributes separately
                const { data: attributesData, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('*')
                    .eq('project_id', projectId);
                
                if (attrError) throw attrError;
                
                projectData = {
                    success: true,
                    project: {
                        ...directData,
                        creator_name: directData.creator?.username,
                        creator_email: directData.creator?.email,
                        reviewer_name: directData.reviewer?.username,
                        admin_name: directData.admin?.username
                    },
                    attributes: attributesData || []
                };
            }
        } else {
            throw new Error('Unauthorized user role');
        }

        const project = projectData.project;
        const attributes = projectData.attributes || [];

        const modal = document.getElementById('review-modal');
        const title = document.getElementById('review-modal-title');
        const content = document.getElementById('review-modal-content');
        
        title.textContent = `${currentUser.role === 'admin' ? 'Admin Review' : 'Review'}: ${project.project_name}`;
        
        content.innerHTML = `
            <div class="space-y-6">
                <!-- Project Information -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-blue-900">${project.project_name}</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            project.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                            project.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                            project.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${project.status?.replace('_', ' ')?.toUpperCase() || 'UNKNOWN'}
                        </span>
                    </div>
                    
                    <!-- CSI Code Hierarchy Section -->
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${project.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${project.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${project.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${project.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${project.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${project.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${project.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${project.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-blue-700 font-mono text-sm mt-3">${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}</p>
                    ${project.additional_level_value ? `<p class="text-sm text-blue-600 mt-1">Additional Level: ${project.additional_level_value}</p>` : ''}
                </div>

                <!-- Basic Project Details -->
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Created by:</span>
                        <p class="mt-1">${project.creator_name || 'Unknown'} ${project.creator_email ? `(${project.creator_email})` : ''}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Assigned Reviewer:</span>
                        <p class="mt-1">${project.reviewer_name || 'Not assigned'}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Created:</span>
                        <p class="mt-1">${formatDate(project.created_at)}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Project ID:</span>
                        <p class="mt-1 font-mono">#${project.id}</p>
                    </div>
                    ${project.submitted_at ? `
                        <div class="bg-gray-50 p-3 rounded">
                            <span class="font-medium text-gray-600">Submitted:</span>
                            <p class="mt-1">${formatDate(project.submitted_at)}</p>
                        </div>
                    ` : ''}
                    ${project.reviewed_at ? `
                        <div class="bg-gray-50 p-3 rounded">
                            <span class="font-medium text-gray-600">Reviewed:</span>
                            <p class="mt-1">${formatDate(project.reviewed_at)}</p>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Project Attributes -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Attributes (${attributes.length})</h3>
                    ${attributes.length > 0 ? `
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${attributes.map(attr => `
                                <div class="border border-gray-200 p-3 rounded bg-white">
                                    <div class="font-medium text-gray-900 mb-2">${attr.attribute_name} ${attr.is_mandatory ? '(Required)' : '(Optional)'}</div>
                                    <div class="text-sm text-gray-600">
                                        Standard Values: ${attr.standard_values?.length || 0}
                                        ${attr.standard_values?.length > 0 ? `
                                            <div class="mt-2 max-h-20 overflow-y-auto">
                                                ${(() => {
                                                    // Ensure standard_values is properly parsed
                                                    let values = attr.standard_values;
                                                    if (typeof values === 'string') {
                                                        try {
                                                            values = JSON.parse(values);
                                                        } catch(e) {
                                                            console.warn('Failed to parse standard_values:', values);
                                                            return '<span class="text-red-500">Invalid standard values format</span>';
                                                        }
                                                    }
                                                    
                                                    if (!Array.isArray(values)) {
                                                        console.warn('Standard values is not an array:', values);
                                                        return '<span class="text-yellow-600">Standard values format error</span>';
                                                    }
                                                    
                                                    return values.map(val => {
                                                        // Handle both object and string formats
                                                        const valueName = typeof val === 'object' && val !== null ? (val.name || String(val)) : String(val);
                                                        const valueUnit = typeof val === 'object' && val !== null && val.unit ? val.unit : '';
                                                        const displayText = valueUnit ? `${valueName} (${valueUnit})` : valueName;
                                                        
                                                        return `
                                                            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1" title="${displayText}">
                                                                ${displayText}
                                                            </span>
                                                        `;
                                                    }).join('');
                                                })()}
                                            </div>
                                        ` : '<div class="text-gray-500 italic mt-1">No standard values defined</div>'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-4 text-gray-500 italic">
                            No attributes configured for this project
                        </div>
                    `}
                </div>

                ${project.reviewer_comments ? `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">Reviewer Comments</h3>
                        <p class="text-sm text-blue-800">${project.reviewer_comments}</p>
                    </div>
                ` : ''}

                ${project.admin_comments ? `
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h3 class="text-lg font-semibold text-green-900 mb-2">Admin Comments</h3>
                        <p class="text-sm text-green-800">${project.admin_comments}</p>
                    </div>
                ` : ''}
            </div>
        `;
        
        // Store current review item for modal buttons
        currentReviewItem = { type: 'project', id: projectId };
        window.currentReviewRequest = { type: 'project', id: projectId };
        
        // Set appropriate buttons based on user role and project status
        updateModalActionButtons('project', project);

        modal.classList.remove('hidden');
        
    } catch (error) {
        console.error('Error opening project review modal:', error);
        alert('Error loading project details: ' + error.message);
    }
}

async function openItemReviewModal(type, id) {
    try {
        console.log('Loading item for review:', type, id);
        
        let query, table;
        switch(type) {
            case 'code':
                table = 'item_code_workflow';
                query = supabase.from(table).select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `);
                break;
            case 'block':
                table = 'combination_requests';
                query = supabase.from(table).select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `);
                break;
            case 'value':
                table = 'standard_value_requests';
                query = supabase.from(table).select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `);
                break;
        }
        
        const { data, error } = await query.eq('id', id).single();
        if (error) throw error;
        
        let content = '';
        let projectData = null;
        let attributeData = null;

        // Get additional project and attribute data for comprehensive display
        if (type === 'code') {
            projectData = data.project;
            
            // Get project attributes if project exists
            if (data.project_id) {
                try {
                    const { data: attrs, error: attrError } = await supabase
                        .from('project_attributes')
                        .select(`
                            *,
                            standard_values (
                                id,
                                name,
                                value,
                                attribute_id
                            )
                        `)
                        .eq('project_id', data.project_id);
                    
                    if (attrError) {
                        console.warn('Failed to fetch with standard_values join:', attrError);
                        // Fallback: fetch attributes only
                        const { data: attrsOnly, error: fallbackError } = await supabase
                            .from('project_attributes')
                            .select('*')
                            .eq('project_id', data.project_id);
                        
                        if (!fallbackError && attrsOnly) {
                            // For each attribute, fetch standard values separately
                            const attributesWithValues = await Promise.all(
                                attrsOnly.map(async (attr) => {
                                    const { data: values, error: valueError } = await supabase
                                        .from('standard_values')
                                        .select('id, name, value, attribute_id')
                                        .eq('attribute_id', attr.id);
                                    
                                    return { ...attr, standard_values: values || [] };
                                })
                            );
                            attributeData = attributesWithValues;
                        }
                    } else {
                        attributeData = attrs;
                    }
                } catch (error) {
                    console.error('Error fetching attribute data:', error);
                    attributeData = null;
                }
            }
        }

        switch(type) {
            case 'code':
                content = `
                    <div class="space-y-6">
                        <!-- Request Status & Basic Info -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-semibold text-blue-900">Request Information</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                    data.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                    data.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                                    data.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                                    data.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                    'bg-gray-100 text-gray-800'
                                }">
                                    ${data.status?.replace('_', ' ')?.toUpperCase() || 'PENDING'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="font-medium">Request ID:</span> ${data.id}</div>
                                <div><span class="font-medium">Created:</span> ${formatDate(data.created_at)}</div>
                                <div><span class="font-medium">Requester:</span> ${data.created_by_user?.username || 'Unknown'} (${data.created_by_user?.email || 'N/A'})</div>
                                <div><span class="font-medium">Reviewer:</span> ${data.reviewed_by_user?.username || 'Not assigned'}</div>
                            </div>
                        </div>

                        <!-- Project Information -->
                        ${projectData ? `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Details</h3>
                            <div class="grid grid-cols-1 gap-3 text-sm">
                                <div><span class="font-medium">Project Name:</span> ${projectData.project_name || data.project?.project_name || 'N/A'}</div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Item Code Request Details -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h3 class="text-lg font-semibold text-green-900 mb-3">Item Code Request Details</h3>
                            <div class="space-y-3 text-sm">
                                <div><span class="font-medium">Requested Item Code:</span> <span class="font-mono text-lg">${data.item_code || 'N/A'}</span></div>
                                <div><span class="font-medium">Description 1:</span> ${data.description1 || 'N/A'}</div>
                                <div><span class="font-medium">Description 2:</span> ${data.description2 || 'N/A'}</div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><span class="font-medium">UOM:</span> ${data.uom || 'N/A'}</div>
                                    <div><span class="font-medium">Country of Origin:</span> ${data.country_of_origin || 'N/A'}</div>
                                </div>
                                <div><span class="font-medium">Model Number:</span> ${data.model_number || 'N/A'}</div>
                                
                                <!-- Financial Information Section -->
                                <div class="border-t pt-3 mt-3">
                                    <h4 class="font-semibold text-green-800 mb-2">Financial Information</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><span class="font-medium">Unit Price:</span> <span class="text-green-600 font-semibold">${data.unit_price ? (parseFloat(data.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})) : 'N/A'}</span></div>
                                        <div><span class="font-medium">Currency:</span> <span class="font-mono">${data.currency_code || 'N/A'}</span></div>
                                    </div>
                                    <div class="mt-2"><span class="font-medium">Manufacturer:</span> <span class="text-blue-600 font-medium">${data.manufacturer || 'N/A'}</span></div>
                                </div>
                                
                                <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${data.combination_signature || 'N/A'}</span></div>
                            </div>
                        </div>

                        

                        <!-- Review Comments -->
                        ${data.review_comments || data.reviewer_comments ? `
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="text-lg font-semibold text-blue-900 mb-2">Previous Review Comments</h3>
                            <p class="text-sm text-blue-800">${data.review_comments || data.reviewer_comments}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                break;
            case 'block':
                content = `
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Block Combination Request</h3>
                            <p class="text-sm text-gray-600">${data.project?.project_name || 'Unknown Project'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Request Type:</strong> ${data.request_type || 'N/A'}</div>
                        </div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                    </div>
                `;
                break;
            case 'value':
                content = `
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Add Standard Value: ${data.new_value}</h3>
                            <p class="text-sm text-gray-600">Attribute: ${data.attribute_name}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Project:</strong> ${data.project?.project_name || 'N/A'}</div>
                        </div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                    </div>
                `;
                break;
        }

        document.getElementById('review-modal-title').textContent = `Review ${type.charAt(0).toUpperCase() + type.slice(1)} Request`;
        document.getElementById('review-modal-content').innerHTML = content;
        
        // Store current review item for modal buttons
        currentReviewItem = { type, id };
        window.currentReviewRequest = { type, id };
        
        // Set up action buttons - THIS WAS MISSING!
        updateModalActionButtons(type, data);
        
        document.getElementById('review-modal').classList.remove('hidden');

    } catch (error) {
        console.error('Error loading item for review:', error);
        alert('Error loading item details: ' + error.message);
    }
}
async function submitCurrentReview(decision) {
    try {
        if (!currentReviewItem && !window.currentReviewRequest) {
            alert('No item selected for review');
            return;
        }

        // Get the review item (prefer currentReviewItem, fallback to window.currentReviewRequest)
        const reviewItem = currentReviewItem || window.currentReviewRequest;
        const comments = document.getElementById('review-comments').value.trim();
        
        console.log('Submitting review:', decision, 'for', reviewItem, 'with comments:', comments);

        let result;
        
        if (reviewItem.type === 'project') {
            // Handle project review (no deprecation check needed for projects)
            if (currentUser.role === 'admin') {
                result = await reviewAdminProject(reviewItem.id, decision);
            } else if (currentUser.role === 'reviewer') {
                result = await reviewReviewerRequest('project', reviewItem.id, decision);
            } else {
                throw new Error('Unauthorized user role for project review');
            }
        } else {
            // Handle item requests (code, value, block) with enhanced deprecation checks
            if (currentUser.role === 'admin') {
                // Use enhanced approval process for admin approvals
                await enhancedApprovalProcess(reviewItem.type, reviewItem.id, decision, comments);
            } else if (currentUser.role === 'reviewer') {
                // For reviewer approvals, also check deprecation but with different flow
                if (decision === 'approve' && reviewItem.type === 'code') {
                    // Load request data to check for deprecated values
                    const { data: codeRequest, error: codeError } = await supabase
                        .from('item_code_workflow')
                        .select(`
                            *,
                            classification_projects (id, project_name)
                        `)
                        .eq('id', reviewItem.id)
                        .single();

                    if (!codeError && codeRequest) {
                        // Get attribute data
                        const { data: attrs, error: attrError } = await supabase
                            .from('project_attributes')
                            .select(`
                                *,
                                standard_values (id, name, value, attribute_id)
                            `)
                            .eq('project_id', codeRequest.project_id);

                        if (!attrError && attrs) {
                            const deprecationCheck = await checkDeprecatedValuesInRequest(codeRequest, attrs);
                            
                            if (deprecationCheck.hasDeprecated) {
                                const deprecatedList = deprecationCheck.deprecatedValues
                                    .map(dv => `â€¢ ${dv.attributeName}: ${dv.valueName}`)
                                    .join('\n');
                                
                                const confirmMessage = `âš ï¸ REVIEWER NOTICE: DEPRECATED VALUES DETECTED
                                
This request contains ${deprecationCheck.deprecatedValues.length} deprecated standard value${deprecationCheck.deprecatedValues.length > 1 ? 's' : ''}:

${deprecatedList}

As a reviewer, you can still approve this request. The deprecated values will be forwarded to admin review with this deprecation notice.

Deprecated values are maintained for system compatibility but hidden from new item creation.

Continue with approval?`;

                                if (!confirm(confirmMessage)) {
                                    return; // User cancelled approval
                                }
                                
                                // Add deprecation notice to comments
                                const deprecationNotice = `\n\n[DEPRECATION NOTICE: This request contains deprecated values - ${deprecationCheck.deprecatedValues.map(dv => dv.attributeName + ':' + dv.valueName).join(', ')}]`;
                                const enhancedComments = comments + deprecationNotice;
                                
                                result = await submitReviewerReview(reviewItem.type, reviewItem.id, decision, enhancedComments);
                            } else {
                                result = await submitReviewerReview(reviewItem.type, reviewItem.id, decision, comments);
                            }
                        } else {
                            result = await submitReviewerReview(reviewItem.type, reviewItem.id, decision, comments);
                        }
                    } else {
                        result = await submitReviewerReview(reviewItem.type, reviewItem.id, decision, comments);
                    }
                } else {
                    result = await submitReviewerReview(reviewItem.type, reviewItem.id, decision, comments);
                }
            } else {
                throw new Error('Unauthorized user role for item review');
            }
        }

        // Close modal and refresh data
        closeReviewModal();
        await loadPendingRequests();
        await loadWorkflowDashboard();
        
        console.log('Review submitted successfully');
        
    } catch (error) {
        console.error('Error submitting review:', error);
        alert(`Error submitting review: ${error.message}`);
    }
}
function closeReviewModal() {
    const modal = document.getElementById('review-modal');
    modal.classList.add('hidden');
    
    // Clear the modal content
    document.getElementById('review-modal-content').innerHTML = '';
    document.getElementById('review-comments').value = '';
    document.getElementById('modal-action-buttons').innerHTML = '';
    
    // Clear current review item
    currentReviewItem = null;
    window.currentReviewRequest = null;
    
    console.log('Review modal closed');
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return 'Invalid Date';
    }
}
// ===== PROJECT CARD CREATION =====
function createProjectReviewCard(project) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">PROJECT REVIEW</span>
                    <span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">PENDING</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">${project.project_name}</h3>
                <p class="text-sm text-gray-600 font-mono">${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}</p>
                ${project.additional_level_value ? `<p class="text-sm text-gray-500">Additional Level: ${project.additional_level_value}</p>` : ''}
            </div>
            <div class="flex space-x-2 ml-4">
                <button onclick="openReviewModal('project', ${project.project_id})" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
                    Review Project
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded">
            <div>
                <span class="font-medium text-gray-600">Created by:</span>
                <p>${project.creator_name}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Attributes:</span>
                <p>${project.attribute_count || 0} configured</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Submitted:</span>
                <p>${new Date(project.submitted_at).toLocaleDateString()}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Project ID:</span>
                <p class="font-mono text-xs">${project.project_id}</p>
            </div>
        </div>
    `;
    
    return card;
}
function createAdminProjectReviewCard(project) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow';
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <h4 class="text-lg font-medium text-gray-900">${project.project_name}</h4>
                <p class="text-sm text-gray-600 mt-1">
                    ${project.division_code}  ${project.section_code}  ${project.detailed_section_code}  ${project.item_code}
                </p>
                ${project.additional_level_value ? `<p class="text-sm text-purple-600 mt-1">Additional Level: ${project.additional_level_value}</p>` : ''}
            </div>
            <span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                Pending Admin Review
            </span>
        </div>
        
        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
            <div><span class="font-medium">Creator:</span> ${project.creator_name}</div>
            <div><span class="font-medium">Reviewer:</span> ${project.reviewer_name}</div>
            <div><span class="font-medium">Submitted:</span> ${formatDate(project.submitted_at)}</div>
            <div><span class="font-medium">Reviewed:</span> ${formatDate(project.reviewer_approved_at)}</div>
            <div class="col-span-2"><span class="font-medium">Attributes:</span> ${project.attribute_count || 0}</div>
        </div>
        
        ${project.reviewer_comments ? `
            <div class="mb-4 p-3 bg-gray-50 rounded-md">
                <p class="text-sm font-medium text-gray-700">Reviewer Comments:</p>
                <p class="text-sm text-gray-600 mt-1">${project.reviewer_comments}</p>
            </div>
        ` : ''}
        
        <div class="flex justify-end space-x-3">
            <button onclick="reviewAdminProject(${project.project_id}, 'reject')" 
                    class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition-colors">
                Reject
            </button>
            <button onclick="reviewAdminProject(${project.project_id}, 'approve')" 
                    class="px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors">
                Approve
            </button>
        </div>
    `;
    
    return card;
}

function createAdminRequestReviewCard(request) {
    const statusClass = `status-${request.status}`;
    const requestTypeDisplay = {
        'code': 'Item Code Request',
        'value': 'Standard Value Request', 
        'block': 'Block Combination Request'
    };

    return `
        <div class="request-card bg-white rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">${requestTypeDisplay[request.type] || 'Unknown Request'}</h3>
                    <p class="text-sm text-gray-600">Request ID: ${request.id}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                    ${request.status.replace('_', ' ').toUpperCase()}
                </span>
            </div>
            
            <div class="space-y-3 mb-4">
                ${request.type === 'code' ? `
                    <div><span class="font-medium">Item Code:</span> ${request.item_code || 'N/A'}</div>
                    <div><span class="font-medium">Project:</span> ${request.project_name || 'N/A'}</div>
                    <div><span class="font-medium">UOM:</span> ${request.uom || 'N/A'}</div>
                    <div><span class="font-medium">Country:</span> ${request.country_of_origin || 'N/A'}</div>
                    <div><span class="font-medium">Model:</span> ${request.model_number || 'N/A'}</div>
                    <div><span class="font-medium">Price:</span> <span class="text-green-600 font-semibold">${request.unit_price ? (parseFloat(request.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ' + (request.currency_code || '')) : 'N/A'}</span></div>
                    <div><span class="font-medium">Manufacturer:</span> <span class="text-blue-600">${request.manufacturer || 'N/A'}</span></div>
                ` : request.type === 'value' ? `
                    <div><span class="font-medium">Attribute:</span> ${request.attribute_name || 'N/A'}</div>
                    <div><span class="font-medium">New Value:</span> ${request.new_value || 'N/A'}</div>
                    <div><span class="font-medium">Reason:</span> ${request.reason || 'N/A'}</div>
                ` : request.type === 'block' ? `
                    <div><span class="font-medium">Block Reason:</span> ${request.reason || 'N/A'}</div>
                    <div><span class="font-medium">Project:</span> ${request.project_name || 'N/A'}</div>
                ` : ''}
                <div><span class="font-medium">Requested:</span> ${formatDate(request.created_at)}</div>
                <div><span class="font-medium">Requester:</span> ${request.created_by_name || 'Unknown'}</div>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="viewRequestDetails('${request.type}', ${request.id})" 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                    View Full Details
                </button>
                <button onclick="reviewAdminRequest('${request.type}', ${request.id}, 'reject')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                    Reject
                </button>
                <button onclick="reviewAdminRequest('${request.type}', ${request.id}, 'approve')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                    Approve
                </button>
            </div>
        </div>
    `;
}
async function reviewAdminProject(projectId, decision) {
    const comments = prompt(`Enter your comments for ${decision === 'approve' ? 'approving' : 'rejecting'} this project:`);
    if (comments === null) return; // User cancelled
    
    try {
        const { data, error } = await supabase
            .rpc('admin_review_decision', {
                project_id_param: projectId,
                admin_id_param: currentUser.id,
                decision_param: decision,
                comments_param: comments
            });

        if (error) throw error;

        if (data.success) {
            // Email notifications are now handled automatically by the new email system in approval functions
            
            alert(`Project ${decision === 'approve' ? 'approved' : 'rejected'} successfully`);
            loadPendingRequests(); // Reload the pending requests
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error reviewing project:', error);
        alert('Failed to submit review');
    }
}
async function viewRequestDetails(type, requestId) {
    try {
        console.log('Loading request details for:', type, requestId);
        
        if (type === 'project') {
            // Handle project details differently
            await openProjectReviewModal(requestId);
            return;
        }
        
        let requestData = null;
        let projectData = null;
        let attributeData = null;

        // Get request details based on type
        if (type === 'code') {
            const { data, error } = await supabase
                .from("item_code_workflow")
                .select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                    classification_projects (
                        id, project_name, division_code, section_code, 
                        detailed_section_code, item_code, additional_level_name, 
                        additional_level_value, status
                    )
                `)
                .eq('id', requestId)
                .single();
            
            if (error) throw error;
            requestData = data;
            projectData = data.classification_projects;

            // DEBUG: Log the actual data we're getting
            console.log('Full requestData:', requestData);
            console.log('Unit Price:', requestData.unit_price);
            console.log('Currency:', requestData.currency_code);
            console.log('Manufacturer:', requestData.manufacturer);
            console.log('Project Data:', projectData);
            console.log('Attribute Selections:', requestData.attribute_selections);

            // Get project attributes for item code requests
            if (projectData) {
                try {
                    // Try first with standard_values join
                    const { data: attrs, error: attrError } = await supabase
                        .from('project_attributes')
                        .select(`
                            *,
                            standard_values (
                                id,
                                name,
                                value,
                                attribute_id
                            )
                        `)
                        .eq('project_id', projectData.id);
                    
                    if (attrError) {
                        console.warn('Failed to fetch with standard_values join:', attrError);
                        // Fallback: fetch attributes only
                        const { data: attrsOnly, error: fallbackError } = await supabase
                            .from('project_attributes')
                            .select('*')
                            .eq('project_id', projectData.id);
                        
                        if (fallbackError) throw fallbackError;
                        
                        // For each attribute, fetch standard values separately
                        const attributesWithValues = await Promise.all(
                            attrsOnly.map(async (attr) => {
                                const { data: values, error: valueError } = await supabase
                                    .from('standard_values')
                                    .select('id, name, value, attribute_id')
                                    .eq('attribute_id', attr.id);
                                
                                if (valueError) {
                                    console.warn(`Failed to fetch values for attribute ${attr.id}:`, valueError);
                                    return { ...attr, standard_values: [] };
                                }
                                
                                return { ...attr, standard_values: values || [] };
                            })
                        );
                        
                        attributeData = attributesWithValues;
                    } else {
                        attributeData = attrs;
                    }
                    
                    console.log('Final attributeData for code request:', attributeData);
                } catch (error) {
                    console.error('Error fetching attribute data:', error);
                    attributeData = null;
                }
            }

        } else if (type === 'value') {
            const { data, error } = await supabase
                .from('standard_value_requests')
                .select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    classification_projects (
                        id, project_name, division_code, section_code, 
                        detailed_section_code, item_code, additional_level_name, 
                        additional_level_value, status
                    )
                `)
                .eq('id', requestId)
                .single();
            
            if (error) throw error;
            requestData = data;
            projectData = data.classification_projects;

            // Get the specific attribute for value requests
            if (data.attribute_id) {
                try {
                    // Try first with standard_values join
                    const { data: attrs, error: attrError } = await supabase
                        .from('project_attributes')
                        .select(`
                            *,
                            standard_values (
                                id,
                                name,
                                value,
                                attribute_id
                            )
                        `)
                        .eq('id', data.attribute_id);
                    
                    if (attrError) {
                        console.warn('Failed to fetch with standard_values join:', attrError);
                        // Fallback: fetch attribute only
                        const { data: attrOnly, error: fallbackError } = await supabase
                            .from('project_attributes')
                            .select('*')
                            .eq('id', data.attribute_id);
                        
                        if (fallbackError) throw fallbackError;
                        
                        // Fetch standard values separately
                        const { data: values, error: valueError } = await supabase
                            .from('standard_values')
                            .select('id, name, value, attribute_id')
                            .eq('attribute_id', data.attribute_id);
                        
                        if (valueError) {
                            console.warn(`Failed to fetch values for attribute ${data.attribute_id}:`, valueError);
                            attributeData = attrOnly.map(attr => ({ ...attr, standard_values: [] }));
                        } else {
                            attributeData = attrOnly.map(attr => ({ ...attr, standard_values: values || [] }));
                        }
                    } else {
                        attributeData = attrs;
                    }
                } catch (error) {
                    console.error('Error fetching attribute data:', error);
                    attributeData = null;
                }
            }

        } else if (type === 'block') {
            const { data, error } = await supabase
                .from('combination_requests')
                .select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    classification_projects (
                        id, project_name, division_code, section_code, 
                        detailed_section_code, item_code, additional_level_name, 
                        additional_level_value, status
                    )
                `)
                .eq('id', requestId)
                .single();
            
            if (error) throw error;
            requestData = data;
            projectData = data.classification_projects;
        }

        if (!requestData) {
            throw new Error('No data found for this request');
        }

        // Build the detail HTML using the comprehensive admin-style layout
        let detailHTML = `
            <div class="space-y-6">
                <!-- Request Status & Basic Info -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-semibold text-blue-900">Request Information</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            requestData.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            requestData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                            requestData.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                            requestData.status === 'rejected' ? 'bg-red-100 text-red-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${requestData.status.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-medium">Request ID:</span> ${requestData.id}</div>
                        <div><span class="font-medium">Created:</span> ${formatDate(requestData.created_at)}</div>
                        <div><span class="font-medium">Requester:</span> ${requestData.created_by_user?.username || 'Unknown'} (${requestData.created_by_user?.email || 'N/A'})</div>
                        <div><span class="font-medium">Reviewer:</span> ${requestData.reviewed_by_user?.username || 'Not assigned'}</div>
                    </div>
                </div>

                <!-- Project Information -->
                ${projectData ? `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Details</h3>
                    <div class="grid grid-cols-1 gap-3 text-sm">
                        <div><span class="font-medium">Project Name:</span> ${projectData.project_name || 'N/A'}</div>
                        <div><span class="font-medium">CSI Code:</span> 
                            <span class="font-mono">${projectData.division_code}-${projectData.section_code}-${projectData.detailed_section_code}-${projectData.item_code}</span>
                        </div>
                        ${projectData.additional_level_value ? `
                            <div><span class="font-medium">Additional Level:</span> ${projectData.additional_level_name}: ${projectData.additional_level_value}</div>
                        ` : ''}
                        <div><span class="font-medium">Project Status:</span> 
                            <span class="px-2 py-1 rounded text-xs ${
                                projectData.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                                projectData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">
                                ${projectData.status?.replace('_', ' ')?.toUpperCase() || 'UNKNOWN'}
                            </span>
                        </div>
                    </div>
                </div>
                ` : ''}
        `;

        // Request-specific details
        if (type === 'code') {
            detailHTML += `
                <!-- Item Code Request Details -->
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="text-lg font-semibold text-green-900 mb-3">Item Code Request Details</h3>
                    <div class="space-y-3 text-sm">
                        <div><span class="font-medium">Requested Item Code:</span> <span class="font-mono text-lg">${requestData.item_code || 'N/A'}</span></div>
                        <div><span class="font-medium">Description 1:</span> ${requestData.description1 || 'N/A'}</div>
                        <div><span class="font-medium">Description 2:</span> ${requestData.description2 || 'N/A'}</div>
                        
                        <!-- Basic Technical Info -->
                        <div class="border-t pt-3 mt-3">
                            <h4 class="font-semibold text-green-800 mb-2">Technical Specifications</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">UOM:</span> ${requestData.uom || 'N/A'}</div>
                                <div><span class="font-medium">Country of Origin:</span> ${requestData.country_of_origin || 'N/A'}</div>
                            </div>
                            <div class="mt-2"><span class="font-medium">Model Number:</span> ${requestData.model_number || 'N/A'}</div>
                        </div>
                        
                        <!-- Financial Information -->
                        <div class="border-t pt-3 mt-3">
                            <h4 class="font-semibold text-green-800 mb-2">Financial Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">Unit Price:</span> <span class="text-green-600 font-semibold">${requestData.unit_price ? (parseFloat(requestData.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})) : 'N/A'}</span></div>
                                <div><span class="font-medium">Currency:</span> <span class="font-mono">${requestData.currency_code || 'N/A'}</span></div>
                            </div>
                            <div class="mt-2"><span class="font-medium">Manufacturer:</span> <span class="text-blue-600 font-medium">${requestData.manufacturer || 'N/A'}</span></div>
                        </div>
                        
                        <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                    </div>
                </div>

                
            `;
            
            // Show selected attributes for item code requests with enhanced deprecation support
            if (attributeData && requestData.attribute_selections) {
                const selections = requestData.attribute_selections || {};
                let hasDeprecatedValues = false;
                let deprecatedValuesInfo = [];
                
                detailHTML += `
                    <!-- Attribute Selections Section -->
                    <div class="bg-purple-50 p-4 rounded-lg mt-4">
                        <h3 class="text-lg font-semibold text-purple-900 mb-3">Selected Attribute Values</h3>
                        <div class="space-y-3">
                `;
                
                for (const attr of attributeData) {
                    const selectedValueId = selections[attr.id];
                    const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                    
                    // Check if the selected value is deprecated
                    let isDeprecated = false;
                    let deprecationInfo = null;
                    
                    if (selectedValue) {
                        // Check deprecation status via enhanced duplicate check
                        try {
                            const { data: duplicateCheck } = await supabase
                                .rpc('enhanced_duplicate_check', {
                                    project_id_param: requestData.project_id,
                                    attribute_selections_param: { [attr.id]: { value: selectedValue.name } },
                                    uom_param: requestData.uom || '',
                                    country_of_origin_param: requestData.country_of_origin || '',
                                    model_number_param: requestData.model_number || '',
                                    manufacturer_param: requestData.manufacturer || ''
                                });
                                
                            if (duplicateCheck && duplicateCheck.deprecated_values_in_request && duplicateCheck.deprecated_values_in_request.length > 0) {
                                const deprecatedValue = duplicateCheck.deprecated_values_in_request.find(dv => 
                                    dv.attribute_id === attr.id && dv.value_name === selectedValue.name
                                );
                                if (deprecatedValue) {
                                    isDeprecated = true;
                                    deprecationInfo = deprecatedValue;
                                    hasDeprecatedValues = true;
                                    deprecatedValuesInfo.push({
                                        attributeName: attr.attribute_name,
                                        valueName: selectedValue.name,
                                        deprecatedAt: deprecationInfo.deprecated_at,
                                        deprecatedReason: deprecationInfo.deprecated_reason
                                    });
                                }
                            }
                        } catch (error) {
                            console.warn('Could not check deprecation status:', error);
                        }
                    }
                    
                    const itemClass = isDeprecated ? 'attribute-selection-item has-deprecated deprecated-attribute' : 'attribute-selection-item';
                    
                    detailHTML += `
                        <div class="${itemClass}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${attr.attribute_name}</div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        ${attr.is_mandatory ? '<span class="text-red-600 font-semibold">[Required]</span>' : '<span class="text-gray-500">[Optional]</span>'}
                                    </div>
                                </div>
                                <div class="ml-4 text-right">
                                    <div class="font-semibold text-blue-600">${selectedValue ? selectedValue.name : 'Not selected'}</div>
                                    ${isDeprecated ? '<div class="text-xs text-orange-600 font-medium">âš ï¸ Deprecated Value</div>' : ''}
                                </div>
                            </div>
                            ${isDeprecated ? `
                                <div class="mt-2 p-2 bg-orange-100 border border-orange-300 rounded text-xs text-orange-800">
                                    <div class="font-semibold">âš ï¸ Deprecation Notice:</div>
                                    <div>This value was deprecated ${deprecationInfo?.deprecated_at ? 'on ' + new Date(deprecationInfo.deprecated_at).toLocaleDateString() : 'previously'}</div>
                                    ${deprecationInfo?.deprecated_reason ? `<div class="mt-1"><strong>Reason:</strong> ${deprecationInfo.deprecated_reason}</div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                detailHTML += `
                        </div>
                    </div>
                `;
                
                // Add general deprecation warning if any deprecated values found
                if (hasDeprecatedValues) {
                    detailHTML += `
                        <!-- Deprecation Warning Section -->
                        <div class="deprecated-warning">
                            <div class="font-semibold text-orange-800 mb-2">Deprecation Warning</div>
                            <div class="text-sm text-orange-700">
                                This request contains ${deprecatedValuesInfo.length} deprecated standard value${deprecatedValuesInfo.length > 1 ? 's' : ''}. 
                                ${deprecatedValuesInfo.length === 1 ? 'This value is' : 'These values are'} preserved for compatibility but hidden from new item creation.
                            </div>
                            <div class="mt-2 text-xs text-orange-600">
                                <strong>Note:</strong> Approving this request will maintain the deprecated value${deprecatedValuesInfo.length > 1 ? 's' : ''} in the system. 
                                Consider discussing alternative values with the requester if needed.
                            </div>
                        </div>
                    `;
                }
                
            } else {
                detailHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg mt-4">
                        <p class="text-gray-500 italic">No attribute selections found</p>
                    </div>
                `;
            }
            
            detailHTML += `
                    </div>
                </div>
            `;

        } else if (type === 'value') {
            const currentAttribute = attributeData[0];
            
            // Check if requested value conflicts with existing deprecated values
            let deprecationConflict = null;
            if (currentAttribute && currentAttribute.standard_values) {
                const existingValue = currentAttribute.standard_values.find(val => 
                    val.name.toLowerCase() === requestData.new_value.toLowerCase()
                );
                
                if (existingValue) {
                    // Check if this existing value is deprecated
                    try {
                        const { data: usageData, error } = await supabase
                            .rpc('get_standard_value_usage', {
                                project_id_param: requestData.project_id,
                                attribute_id_param: currentAttribute.id
                            });
                        
                        if (!error && usageData) {
                            const valueUsage = usageData.find(u => u.value_name === existingValue.name);
                            if (valueUsage && valueUsage.status === 'deprecated') {
                                deprecationConflict = {
                                    existingValue: existingValue.name,
                                    deprecatedAt: valueUsage.deprecated_at,
                                    deprecatedReason: valueUsage.deprecation_reason,
                                    usageCount: valueUsage.usage_count
                                };
                            }
                        }
                    } catch (error) {
                        console.warn('Could not check deprecation status for value request:', error);
                    }
                }
            }
            
            detailHTML += `
                <!-- Standard Value Request Details -->
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <h3 class="text-lg font-semibold text-purple-900 mb-3">Standard Value Request Details</h3>
                    <div class="space-y-3">
                        <div><span class="font-medium">Attribute:</span> ${requestData.attribute_name} ${currentAttribute?.is_mandatory ? '(Required)' : '(Optional)'}</div>
                        <div><span class="font-medium">Requested New Value:</span> <span class="text-green-600 font-bold text-lg">${requestData.new_value}</span></div>
                        <div><span class="font-medium">Justification:</span> ${requestData.reason || 'No reason provided'}</div>
                        
                        ${deprecationConflict ? `
                            <!-- Deprecation Conflict Warning -->
                            <div class="deprecated-warning mt-3">
                                <div class="font-semibold text-orange-800 mb-2">âš ï¸ Deprecation Conflict Detected</div>
                                <div class="text-sm text-orange-700">
                                    A value named "${deprecationConflict.existingValue}" already exists but is currently deprecated.
                                    ${deprecationConflict.deprecatedAt ? `Deprecated on: ${new Date(deprecationConflict.deprecatedAt).toLocaleDateString()}` : ''}
                                </div>
                                ${deprecationConflict.deprecatedReason ? `
                                    <div class="text-xs text-orange-600 mt-1">
                                        <strong>Deprecation reason:</strong> ${deprecationConflict.deprecatedReason}
                                    </div>
                                ` : ''}
                                <div class="text-xs text-orange-600 mt-2">
                                    <strong>Current usage:</strong> ${deprecationConflict.usageCount} approved items
                                </div>
                                <div class="mt-2 p-2 bg-orange-100 border border-orange-300 rounded text-xs">
                                    <strong>Recommendation:</strong> Consider reactivating the existing deprecated value instead of creating a duplicate.
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Current Standard Values -->
                <div class="bg-gray-50 p-4 rounded-lg mt-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Current Standard Values for "${requestData.attribute_name}"</h3>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${currentAttribute?.standard_values?.map(val => `
                            <div class="flex items-center space-x-2 p-2 bg-white rounded border">
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                <span>${val.name}</span>
                            </div>
                        `).join('') || '<p class="text-gray-500 italic">No existing values found</p>'}
                        <div class="flex items-center space-x-2 p-2 bg-green-100 border border-green-300 rounded">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span class="font-bold text-green-800">+ ${requestData.new_value} (New - Pending Approval)</span>
                        </div>
                    </div>
                </div>
            `;

        } else if (type === 'block') {
            detailHTML += `
                <!-- Block Combination Details -->
                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <h3 class="text-lg font-semibold text-red-900 mb-3">Block Combination Request</h3>
                    <div class="space-y-3">
                        <div><span class="font-medium">Request Type:</span> ${requestData.request_type || 'Block'}</div>
                        <div><span class="font-medium">Reason for Blocking:</span> ${requestData.reason || 'No reason provided'}</div>
                        <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                    </div>
                </div>

                <!-- Combination to Block -->
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200 mt-4">
                    <h3 class="text-lg font-semibold text-orange-900 mb-3">Combination Values to Block</h3>
                    <div class="space-y-4">
            `;

            // Show the combination that will be blocked
            if (attributeData && requestData.attribute_selections) {
                const selections = requestData.attribute_selections || {};
                attributeData.forEach(attr => {
                    const selectedValueId = selections[attr.id];
                    const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                    
                    detailHTML += `
                        <div class="border border-orange-200 p-3 rounded bg-white">
                            <div class="font-medium text-orange-900 mb-2">${attr.attribute_name}</div>
                            <div class="text-sm text-red-600 font-medium"> Will be blocked: ${selectedValue ? selectedValue.name : 'None selected'}</div>
                        </div>
                    `;
                });
            } else {
                detailHTML += `<p class="text-gray-500 italic">No combination data found</p>`;
            }
            
            detailHTML += `
                    </div>
                </div>
            `;
        }

        // Add any existing review comments
        if (requestData.review_comments || requestData.reviewer_comments) {
            detailHTML += `
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">Previous Review Comments</h3>
                    <p class="text-sm text-blue-800">${requestData.review_comments || requestData.reviewer_comments}</p>
                </div>
            `;
        }

        // Close the main container div
        detailHTML += `
            </div>
        `;

        // Show the modal
        document.getElementById('review-modal-title').textContent = `Review ${type.charAt(0).toUpperCase() + type.slice(1)} Request #${requestId}`;
        document.getElementById('review-modal-content').innerHTML = detailHTML;

        // Store the current review request for the action buttons
        window.currentReviewRequest = { type: type, id: requestId };
        currentReviewItem = { type: type, id: requestId };

        // Set up action buttons based on user role and request status
        updateModalActionButtons(type, requestData);

        document.getElementById('review-modal').classList.remove('hidden');

    } catch (error) {
     
     
        console.error('Error loading request details:', error);
        alert('Error loading request details: ' + error.message);
    }
}


function showAdminRequestDetailModal(type, requestData, projectData, attributeData) {
    const modal = document.getElementById('review-modal');
    const title = document.getElementById('review-modal-title');
    const content = document.getElementById('review-modal-content');
    
    const typeNames = {
        'code': 'Item Code Request',
        'value': 'Standard Value Request',
        'block': 'Block Combination Request'
    };
    
    title.textContent = `Admin Review: ${typeNames[type]}`;
    
    let detailHTML = `
        <div class="space-y-6">
            <!-- Request Status & Basic Info -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-semibold text-blue-900">Request Information</h3>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${
                        requestData.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        requestData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${requestData.status.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="font-medium">Request ID:</span> ${requestData.id}</div>
                    <div><span class="font-medium">Created:</span> ${formatDate(requestData.created_at)}</div>
                    <div><span class="font-medium">Requester:</span> ${requestData.created_by_user?.username || 'Unknown'} (${requestData.created_by_user?.email || 'N/A'})</div>
                    <div><span class="font-medium">Reviewer:</span> ${requestData.reviewed_by_user?.username || 'Not assigned'}</div>
                </div>
            </div>

            <!-- Project Information -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Details</h3>
                <div class="grid grid-cols-1 gap-3 text-sm">
                    <div><span class="font-medium">Project Name:</span> ${projectData?.project_name || 'N/A'}</div>
                    
                    <!-- CSI Code Hierarchy Section -->
                    ${projectData ? `
                        <div class="csi-path-container">
                            <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                            <div class="flex flex-col space-y-1">
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.division_code || 'N/A'}</span>
                                    <span class="csi-path-arrow"></span>
                                    <span class="text-xs opacity-90">${projectData.division_description || 'Division Description'}</span>
                                </div>
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.section_code || 'N/A'}</span>
                                    <span class="csi-path-arrow"></span>
                                    <span class="text-xs opacity-90">${projectData.section_description || 'Section Description'}</span>
                                </div>
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.detailed_section_code || 'N/A'}</span>
                                    <span class="csi-path-arrow"></span>
                                    <span class="text-xs opacity-90">${projectData.detailed_section_description || 'Detailed Section Description'}</span>
                                </div>
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.item_code || 'N/A'}</span>
                                    <span class="csi-path-arrow"></span>
                                    <span class="text-xs opacity-90">${projectData.item_description || 'Item Description'}</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div><span class="font-medium">CSI Code:</span> 
                        <span class="font-mono">${projectData?.division_code}-${projectData?.section_code}-${projectData?.detailed_section_code}-${projectData?.item_code}</span>
                    </div>
                    ${projectData?.additional_level_value ? `
                        <div><span class="font-medium">Additional Level:</span> ${projectData.additional_level_name}: ${projectData.additional_level_value}</div>
                    ` : ''}
                    ${projectData ? `
    <div><span class="font-medium">Project Status:</span> 
        <span class="px-2 py-1 rounded text-xs ${
            projectData.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
            projectData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
            'bg-yellow-100 text-yellow-800'
        }">
            ${projectData.status?.replace('_', ' ')?.toUpperCase() || 'UNKNOWN'}
        </span>
    </div>
` : ''}
                </div>
            </div>
    `;

    if (type === 'code') {
        detailHTML += `
            <!-- Item Code Request Details -->
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <h3 class="text-lg font-semibold text-green-900 mb-3">Item Code Request Details</h3>
                <div class="space-y-3 text-sm">
                    <div><span class="font-medium">Requested Item Code:</span> <span class="font-mono text-lg">${requestData.item_code || 'N/A'}</span></div>
                    <div><span class="font-medium">Description 1:</span> ${requestData.description1 || 'N/A'}</div>
                    <div><span class="font-medium">Description 2:</span> ${requestData.description2 || 'N/A'}</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><span class="font-medium">UOM:</span> ${requestData.uom || 'N/A'}</div>
                        <div><span class="font-medium">Country of Origin:</span> ${requestData.country_of_origin || 'N/A'}</div>
                    </div>
                    <div><span class="font-medium">Model Number:</span> ${requestData.model_number || 'N/A'}</div>
                    
                    <!-- NEW FINANCIAL INFORMATION SECTION -->
                    <div class="border-t pt-3 mt-3">
                        <h4 class="font-semibold text-green-800 mb-2">Financial Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="font-medium">Unit Price:</span> <span class="text-green-600 font-semibold">${requestData.unit_price ? (parseFloat(requestData.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})) : 'N/A'}</span></div>
                            <div><span class="font-medium">Currency:</span> <span class="font-mono">${requestData.currency_code || 'N/A'}</span></div>
                        </div>
                        <div class="mt-2"><span class="font-medium">Manufacturer:</span> <span class="text-blue-600 font-medium">${requestData.manufacturer || 'N/A'}</span></div>
                    </div>
                    
                    <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                </div>
            </div>


        `;
        
        // Show selected attributes for item code requests
        if (attributeData && requestData.attribute_selections) {
            const selections = requestData.attribute_selections || {};
            attributeData.forEach(attr => {
                const selectedValueId = selections[attr.id];
                const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                
                detailHTML += `
                    
                `;
            });
        } else {
            detailHTML += `<p class="text-gray-500 italic">No attribute selections found</p>`;
        }
        
        detailHTML += `
                </div>
            </div>
        `;

    } else if (type === 'value') {
        const currentAttribute = attributeData[0];
        detailHTML += `
            <!-- Standard Value Request Details -->
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <h3 class="text-lg font-semibold text-purple-900 mb-3">Standard Value Request Details</h3>
                <div class="space-y-3">
                    <div><span class="font-medium">Attribute:</span> ${requestData.attribute_name} ${currentAttribute?.is_mandatory ? '(Required)' : '(Optional)'}</div>
                    <div><span class="font-medium">Requested New Value:</span> <span class="text-green-600 font-bold text-lg">${requestData.new_value}</span></div>
                    <div><span class="font-medium">Justification:</span> ${requestData.reason || 'No reason provided'}</div>
                </div>
            </div>

            <!-- Current Standard Values -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Current Standard Values for "${requestData.attribute_name}"</h3>
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    ${currentAttribute?.standard_values?.map(val => `
                        <div class="flex items-center space-x-2 p-2 bg-white rounded border">
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            <span>${val.name}</span>
                        </div>
                    `).join('') || '<p class="text-gray-500 italic">No existing values found</p>'}
                    <div class="flex items-center space-x-2 p-2 bg-green-100 border border-green-300 rounded">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="font-bold text-green-800">+ ${requestData.new_value} (New - Pending Approval)</span>
                    </div>
                </div>
            </div>
        `;

    } else if (type === 'block') {
        detailHTML += `
            <!-- Block Combination Details -->
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                <h3 class="text-lg font-semibold text-red-900 mb-3">Block Combination Request</h3>
                <div class="space-y-3">
                    <div><span class="font-medium">Request Type:</span> ${requestData.request_type || 'Block'}</div>
                    <div><span class="font-medium">Reason for Blocking:</span> ${requestData.reason || 'No reason provided'}</div>
                    <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                </div>
            </div>

            <!-- Combination to Block -->
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <h3 class="text-lg font-semibold text-orange-900 mb-3">Combination Values to Block</h3>
                <div class="space-y-4">
        `;

        // Show the combination that will be blocked
        if (attributeData && requestData.attribute_selections) {
            const selections = requestData.attribute_selections || {};
            attributeData.forEach(attr => {
                const selectedValueId = selections[attr.id];
                const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                
                if (selectedValue) {
                    detailHTML += `
                        <div class="border border-orange-200 p-3 rounded bg-white">
                            <div class="font-medium text-orange-900 mb-2">${attr.attribute_name} ${attr.is_mandatory ? '(Required)' : '(Optional)'}</div>
                            <div class="mt-2">
                                <span class="bg-red-100 text-red-800 px-3 py-1 rounded font-medium">
                                     WILL BE BLOCKED: ${selectedValue.name}
                                </span>
                            </div>
                        </div>
                    `;
                }
            });
        } else {
            detailHTML += `<p class="text-gray-500 italic">No combination details found</p>`;
        }

        detailHTML += `
                </div>
                <div class="mt-4 p-3 bg-red-100 border border-red-200 rounded">
                    <p class="text-red-800 text-sm">
                        <strong> Warning:</strong> Approving this request will prevent users from generating item codes 
                        using this exact combination of attribute values. This action cannot be easily undone.
                    </p>
                </div>
            </div>
        `;
    }

    // Add reviewer comments if they exist
    if (requestData.reviewer_comments || requestData.review_comments) {
        detailHTML += `
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Reviewer Comments</h3>
                <p class="text-sm text-gray-700">${requestData.reviewer_comments || requestData.review_comments || 'No comments provided'}</p>
            </div>
        `;
    }

    detailHTML += `
        </div>
    `;

    content.innerHTML = detailHTML;
    
    // Store current request info for approval buttons in modal
    window.currentReviewRequest = { type, id: requestData.id };
    
    // Set appropriate buttons based on user role and request status
updateModalActionButtons(type, requestData);

modal.classList.remove('hidden');
}


function updateModalActionButtons(type, itemData) {
    const buttonContainer = document.getElementById('modal-action-buttons');
    const userRole = currentUser.role;
    const status = itemData.status || 'unknown';
    
    console.log('Setting up modal buttons for:', { type, userRole, status });
    console.log('Project data:', itemData);
    
    let buttonsHTML = '';
    
    if (type === 'project') {
        // Classification Project buttons
        if (userRole === 'reviewer') {
            if (status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                         Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                         Reject
                    </button>
                `;
            } else if (status === 'reviewer_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                         You Approved This
                    </span>
                `;
            } else if (status === 'reviewer_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                         You Rejected This
                    </span>
                `;
            } else {
                // Fallback for reviewers - show buttons anyway for debugging
                console.log('Unknown status for reviewer project:', status, '- showing fallback buttons');
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                         Approve (Status: ${status})
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                         Reject (Status: ${status})
                    </button>
                `;
            }
        } else if (userRole === 'admin') {
            if (status === 'reviewer_approved' || status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                         Final Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                         Final Reject
                    </button>
                `;
            } else if (status === 'admin_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                         Approved by You
                    </span>
                `;
            } else if (status === 'admin_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                         Rejected by You
                    </span>
                `;
            } else {
                // Fallback for admins - show buttons anyway for debugging
                console.log('Unknown status for admin project:', status, '- showing fallback buttons');
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                         Final Approve (Status: ${status})
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                         Final Reject (Status: ${status})
                    </button>
                `;
            }
        }
    } else {
        // Item Request buttons (code, value, block)
        if (userRole === 'reviewer') {
            if (status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                         Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                         Reject
                    </button>
                `;
            } else if (status === 'reviewer_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                         You Approved This
                    </span>
                `;
            } else if (status === 'reviewer_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                         You Rejected This
                    </span>
                `;
            }
        } else if (userRole === 'admin') {
            if (status === 'reviewer_approved' || status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                         Final Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                         Final Reject
                    </button>
                `;
            } else if (status === 'admin_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                         Approved by You
                    </span>
                `;
            } else if (status === 'admin_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                         Rejected by You
                    </span>
                `;
            }
        }
    }
    
    // Fallback for unknown status or scenarios
    if (!buttonsHTML) {
        console.warn('No buttons generated for:', { type, userRole, status, itemData });
        if (type === 'project' && (userRole === 'reviewer' || userRole === 'admin')) {
            // Force show project buttons for debugging
            buttonsHTML = `
                <button onclick="submitCurrentReview('approve')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                     Force Approve
                </button>
                <button onclick="submitCurrentReview('reject')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                     Force Reject
                </button>
                <div class="text-xs text-gray-500 mt-1">Status: ${status} | Role: ${userRole}</div>
            `;
        } else {
            buttonsHTML = `
                <span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-md text-sm">
                    Status: ${status} - No actions available (${type})
                </span>
            `;
        }
    }
    
    // Check if button container exists
    if (!buttonContainer) {
        console.error('Button container not found! modal-action-buttons element is missing');
        return;
    }
    
    buttonContainer.innerHTML = buttonsHTML;
    console.log('Modal buttons set:', buttonsHTML);
}
async function reviewAdminRequest(type, requestId, decision) {
    console.log('reviewAdminRequest called with:', { type, requestId, decision });
    
    // Prevent any form submission or page reload
    event?.preventDefault();
    
    const comments = prompt(`Enter your comments for ${decision === 'approve' ? 'approving' : 'rejecting'} this request:`);
    if (comments === null) {
        console.log('User cancelled the review');
        return; // User cancelled
    }
    
    try {
        console.log('Processing admin request:', { type, requestId, decision, comments });
        
        // Show loading state
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'loading-msg';
        loadingMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded z-50';
        loadingMsg.textContent = 'Processing...';
        document.body.appendChild(loadingMsg);
        
        let updateResult;
        
        // Handle the update based on request type
        if (type === 'project') {
            console.log('Processing classification project:', requestId);
            
            // Use the admin review decision RPC function for projects
            const { data, error } = await supabase.rpc('admin_review_decision', {
                project_id_param: requestId,
                admin_id_param: currentUser.id,
                decision_param: decision,
                comments_param: comments
            });
            
            if (error) {
                console.error('Error reviewing project:', error);
                throw error;
            }
            
            console.log('Project review response:', data);
            
            if (data.success) {
                updateResult = { success: true, message: data.message };
                
                // Send email notification for project admin decision
                try {
                    const { data: projectData, error: fetchError } = await supabase
                        .from('classification_projects')
                        .select(`
                            *,
                            created_by_user:users!classification_projects_created_by_fkey(username, email)
                        `)
                        .eq('id', requestId)
                        .single();
                        
                    if (!fetchError && projectData) {
                        projectData.request_type = 'Classification Project';
                        projectData.title = projectData.project_name;
                        projectData.project = { project_name: projectData.project_name };
                        
                        console.log('Sending admin email notification for project...');
                        await sendDecisionNotification(projectData, decision, comments, currentUser);
                        console.log('Admin project email notification sent successfully');
                    }
                } catch (emailError) {
                    console.error('Failed to send email notification for admin project decision:', emailError);
                    // Don't fail the approval if email fails
                }
            } else {
                throw new Error(data.message || 'Project review failed');
            }
            
        } else if (type === 'code') {
            console.log('Processing item code request:', requestId);
            const { data: beforeUpdate, error: fetchError } = await supabase
                .from("item_code_workflow")
                .select('*')
                .eq('id', requestId)
                .single();
            
            if (fetchError) {
                console.error('Error fetching item code request:', fetchError);
                throw fetchError;
            }
            
            console.log('Item code request before update:', beforeUpdate);
            
            const updateData = {
                status: decision === 'approve' ? 'admin_approved' : 'admin_rejected',
                admin_comments: comments,
                admin_reviewed_by: currentUser.id,
                admin_reviewed_at: new Date().toISOString()
            };
            
            console.log('Updating item code request with:', updateData);
            
            const { data: updateResponse, error: updateError } = await supabase
                .from("item_code_workflow")
                .update(updateData)
                .eq('id', requestId)
                .select();
            
            if (updateError) {
                console.error('Error updating item code request:', updateError);
                throw updateError;
            }
            
            console.log('Update response:', updateResponse);
            updateResult = { success: true, message: `Item code request ${decision}d successfully` };
            
            // ADDED: Call createItemCodeFromRequest if approved to set approved_by and approved_at fields
            if (decision === 'approve') {
                try {
                    console.log('Setting final approval fields for approved item code...');
                    await createItemCodeFromRequest(requestId);
                    console.log('Final approval fields set successfully');
                } catch (approvalError) {
                    console.error('Error setting final approval fields:', approvalError);
                    // Don't fail the approval if this fails
                }
            }
            
            // Send email notifications for item code decisions
            try {
                // Get request details with creator information
                const { data: requestData, error: fetchError } = await supabase
                    .from("item_code_workflow")
                    .select(`
                        *,
                        created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', requestId)
                    .single();
                    
                if (!fetchError && requestData) {
                    requestData.request_type = 'Item Code Request';
                    requestData.title = requestData.item_code;
                    
                    console.log('Sending admin email notification for item code...');
                    await sendDecisionNotification(requestData, decision, comments, currentUser);
                    console.log('Admin item code email notification sent successfully');
                    
                    // If approved, send ERP integration notification
                    if (decision === 'approve') {
                        console.log('Sending ERP integration notification...');
                        await sendERPIntegrationNotification(requestData, { item_code: requestData.item_code });
                        console.log('ERP integration notification sent successfully');
                    }
                }
            } catch (emailError) {
                console.error('Failed to send email notification for admin item code decision:', emailError);
                // Don't fail the approval if email fails
            }
            
        } else if (type === 'value') {
            console.log('Processing standard value request:', requestId);
            
            if (decision === 'approve') {
                // For standard value requests, we need to add the value and update status
                const { data: requestData, error: fetchError } = await supabase
                    .from('standard_value_requests')
                    .select('*, project_attributes(standard_values)')
                    .eq('id', requestId)
                    .single();
                
                if (fetchError) {
                    console.error('Error fetching standard value request:', fetchError);
                    throw fetchError;
                }
                
                console.log('Standard value request data:', requestData);
                
                // Get current attribute values
                const { data: attributeData, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('standard_values')
                    .eq('id', requestData.attribute_id)
                    .single();
                
                if (attrError) {
                    console.error('Error fetching attribute data:', attrError);
                    throw attrError;
                }
                
                console.log('Current attribute data:', attributeData);
                
                // Add new value if it doesn't exist
                const currentValues = attributeData.standard_values || [];
                const valueExists = currentValues.some(val => val.name === requestData.new_value);
                
                if (!valueExists) {
                    const newValue = { name: requestData.new_value, unit: '' };
                    const updatedValues = [...currentValues, newValue];
                    
                    console.log('Adding new value:', newValue, 'to existing values:', currentValues);
                    
                    const { error: updateAttrError } = await supabase
                        .from('project_attributes')
                        .update({ standard_values: updatedValues })
                        .eq('id', requestData.attribute_id);
                    
                    if (updateAttrError) {
                        console.error('Error updating attribute values:', updateAttrError);
                        throw updateAttrError;
                    }
                    
                    console.log('Successfully updated attribute values');
                }
            }
            
            // Update request status
            const statusUpdateData = {
                status: decision === 'approve' ? 'admin_approved' : 'admin_rejected',
                admin_reviewed_by: currentUser.id,
                admin_reviewed_at: new Date().toISOString(),
                admin_comments: comments
            };
            
            console.log('Updating standard value request status with:', statusUpdateData);
            
            const { data: statusResponse, error: statusError } = await supabase
                .from('standard_value_requests')
                .update(statusUpdateData)
                .eq('id', requestId)
                .select();
            
            if (statusError) {
                console.error('Error updating standard value request status:', statusError);
                throw statusError;
            }
            
            console.log('Status update response:', statusResponse);
            updateResult = { success: true, message: `Standard value request ${decision}d successfully` };
            
            // Send email notifications for standard value decisions
            try {
                // Get request details with creator information
                const { data: requestData, error: fetchError } = await supabase
                    .from('standard_value_requests')
                    .select(`
                        *,
                        created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', requestId)
                    .single();
                    
                if (!fetchError && requestData) {
                    requestData.request_type = 'Standard Value Request';
                    requestData.title = `${requestData.attribute_name}: ${requestData.new_value}`;
                    
                    console.log('Sending admin email notification for standard value...');
                    await sendDecisionNotification(requestData, decision, comments, currentUser);
                    console.log('Admin standard value email notification sent successfully');
                }
            } catch (emailError) {
                console.error('Failed to send email notification for admin standard value decision:', emailError);
                // Don't fail the approval if email fails
            }
            
        } else if (type === 'block') {
            console.log('Processing combination block request:', requestId);
            
            const statusUpdateData = {
                status: decision === 'approve' ? 'admin_approved' : 'admin_rejected',
                admin_reviewed_by: currentUser.id,
                admin_reviewed_at: new Date().toISOString(),
                admin_comments: comments
            };
            
            console.log('Updating combination request with:', statusUpdateData);
            
            const { data: updateResponse, error: updateError } = await supabase
                .from('combination_requests')
                .update(statusUpdateData)
                .eq('id', requestId)
                .select();
            
            if (updateError) {
                console.error('Error updating combination request:', updateError);
                throw updateError;
            }
            
            console.log('Combination request update response:', updateResponse);
            updateResult = { success: true, message: `Combination block request ${decision}d successfully` };
            
            // Send email notifications for combination block decisions
            try {
                // Get request details with creator information
                const { data: requestData, error: fetchError } = await supabase
                    .from('combination_requests')
                    .select(`
                        *,
                        created_by_user:users!combination_requests_created_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', requestId)
                    .single();
                    
                if (!fetchError && requestData) {
                    requestData.request_type = 'Block Combination Request';
                    requestData.title = 'Block Combination';
                    
                    console.log('Sending admin email notification for combination block...');
                    await sendDecisionNotification(requestData, decision, comments, currentUser);
                    console.log('Admin combination block email notification sent successfully');
                }
            } catch (emailError) {
                console.error('Failed to send email notification for admin combination decision:', emailError);
                // Don't fail the approval if email fails
            }
            
        } else {
            throw new Error('Unknown request type: ' + type);
        }
        
        // Remove loading message
        document.getElementById('loading-msg')?.remove();
        
        // Show success message
        alert(updateResult.message);
        
        // Show success message
        alert(updateResult.message);
        
        console.log('Refreshing data...');
        
        // Refresh the data
        await loadPendingRequests();
        await loadWorkflowDashboard();
        
        console.log('Review completed successfully');
        
    } catch (error) {
        console.error('Error reviewing request:', error);
        
        // Remove loading message
        document.getElementById('loading-msg')?.remove();
        
        // Show detailed error
        alert(`Error processing request: ${error.message}\n\nCheck console for more details.`);
    }
}
// ===== ITEM CARD CREATION =====
function createPendingRequestCard(request) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
    
    const typeLabel = request.type === 'code' ? 'Item Code' : 
                     request.type === 'block' ? 'Block Combination' : 'Standard Value';
    const titleText = request.type === 'code' ? request.item_code :
                     request.type === 'value' ? `${request.attribute_name}: ${request.new_value}` :
                     'Block Combination Request';
    
    const buttonText = request.isAssigned ? 'Review' : 'Claim & Review';
    const buttonClass = request.isAssigned ? 
        'bg-blue-600 hover:bg-blue-700' : 
        'bg-green-600 hover:bg-green-700';
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">${typeLabel}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">PENDING</span>
                    ${!request.isAssigned ? '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">UNASSIGNED</span>' : ''}
                </div>
                <h3 class="text-lg font-semibold text-gray-900">${titleText}</h3>
                <p class="text-sm text-gray-600">${request.project?.project_name || 'Unknown Project'}</p>
            </div>
            <div class="flex space-x-2 ml-4">
                <button onclick="openReviewModal('${request.type}', ${request.id})" 
                        class="${buttonClass} text-white px-4 py-2 rounded text-sm font-medium">
                    ${buttonText}
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded">
            <div>
                <span class="font-medium text-gray-600">Requested by:</span>
                <p>${request.created_by_user?.username || 'Unknown'}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Created:</span>
                <p>${new Date(request.created_at).toLocaleDateString()}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Request ID:</span>
                <p class="font-mono text-xs">${request.id}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Status:</span>
                <p class="capitalize">${request.status.replace('_', ' ')}</p>
            </div>
        </div>
    `;
    
    return card;
}

// ===== LOAD PENDING REQUESTS =====
async function loadPendingRequests() {
    console.log('Loading pending requests for user:', currentUser);
    
    try {
        // Initialize sub-tabs
        initializePendingSubTabs();
        
        // Load the default sub-tab (classification projects)
        await switchPendingSubTab('classification-projects');
        
    } catch (error) {
        console.error('Error loading pending requests:', error);
        document.getElementById('classification-projects-container').innerHTML = 
            '<div class="text-center text-red-500 py-8">Error loading pending requests</div>';
    }
}

function initializePendingSubTabs() {
    // Add event listeners for sub-tab buttons
    document.querySelectorAll('.pending-subtab-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const subtab = btn.dataset.subtab;
            await switchPendingSubTab(subtab);
        });
    });
}

async function switchPendingSubTab(subtabName) {
    // Update sub-tab buttons
    document.querySelectorAll('.pending-subtab-btn').forEach(btn => {
        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    const activeBtn = document.querySelector(`[data-subtab="${subtabName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
        activeBtn.classList.remove('border-transparent', 'text-gray-500');
    }
    
    // Hide all sub-tab content
    document.querySelectorAll('.pending-subtab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected sub-tab content
    const activeContent = document.getElementById(`${subtabName}-subtab`);
    if (activeContent) {
        activeContent.classList.remove('hidden');
    }
    
    // Load appropriate data
    await loadPendingRequestsByType(subtabName);
}

async function loadPendingRequestsByType(requestType) {
    const containerMap = {
        'classification-projects': 'classification-projects-container',
        'item-codes': 'item-codes-container', 
        'standard-values': 'standard-values-container',
        'combinations': 'combinations-container'
    };
    
    const containerId = containerMap[requestType];
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('Container not found:', containerId);
        return;
    }
    
    // Show loading state
    container.innerHTML = '<div class="text-center text-gray-500 py-8">Loading...</div>';
    
    try {
        switch (requestType) {
            case 'classification-projects':
                await loadPendingClassificationProjects();
                break;
            case 'item-codes':
                await loadPendingItemCodes();
                break;
            case 'standard-values':
                await loadPendingStandardValues();
                break;
            case 'combinations':
                await loadPendingCombinations();
                break;
            default:
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Unknown request type</div>';
        }
    } catch (error) {
        console.error(`Error loading ${requestType}:`, error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading requests</div>';
    }
}
async function loadPendingClassificationProjects() {
    const container = document.getElementById('classification-projects-container');
    
    try {
        let pendingProjects = [];
        
        if (currentUser.role === 'reviewer') {
            // Load projects assigned to this reviewer
            const { data, error } = await supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    project_attributes(id, attribute_name, is_mandatory)
                `)
                .eq('assigned_reviewer_id', currentUser.id)
                .eq('status', 'submitted')
                .order('submitted_at', { ascending: true });
                
            if (error) throw error;
            pendingProjects = (data || []).map(project => ({
                ...project,
                attributes_count: project.project_attributes?.length || 0
            }));
        } else if (currentUser.role === 'admin') {
            // Load projects approved by reviewer awaiting admin decision
            const { data, error } = await supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                    project_attributes(id, attribute_name, is_mandatory)
                `)
                .eq('status', 'reviewer_approved')
                .order('reviewed_at', { ascending: true });
                
            if (error) throw error;
            pendingProjects = (data || []).map(project => ({
                ...project,
                attributes_count: project.project_attributes?.length || 0
            }));
        }
        
        if (pendingProjects.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No pending classification projects</div>';
            return;
        }
        
        // Render classification projects
        container.innerHTML = pendingProjects.map(project => `
            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="text-lg font-semibold text-gray-800">${project.project_name}</h4>
                            <span class="badge-project request-type-badge">Classification Project</span>
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-mono">#${project.id}</span>
                        </div>
                        
                        <!-- CSI Path Display -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-3 rounded-lg mb-3">
                            <div class="text-xs font-medium text-blue-800 mb-2">CSI Classification Hierarchy</div>
                            <div class="flex flex-wrap items-center gap-2 text-sm">
                                <div class="flex items-center bg-blue-100 rounded px-2 py-1">
                                    <span class="font-bold text-blue-900">${project.division_code}</span>
                                    ${project.division_description ? `<span class="ml-1 text-blue-700">- ${project.division_description}</span>` : ''}
                                </div>
                                <span class="text-blue-600"></span>
                                <div class="flex items-center bg-blue-100 rounded px-2 py-1">
                                    <span class="font-bold text-blue-900">${project.section_code}</span>
                                    ${project.section_description ? `<span class="ml-1 text-blue-700">- ${project.section_description}</span>` : ''}
                                </div>
                                <span class="text-blue-600"></span>
                                <div class="flex items-center bg-blue-100 rounded px-2 py-1">
                                    <span class="font-bold text-blue-900">${project.detailed_section_code}</span>
                                    ${project.detailed_section_description ? `<span class="ml-1 text-blue-700">- ${project.detailed_section_description}</span>` : ''}
                                </div>
                                <span class="text-blue-600"></span>
                                <div class="flex items-center bg-blue-200 rounded px-2 py-1">
                                    <span class="font-bold text-blue-900">${project.item_code}</span>
                                    ${project.item_description ? `<span class="ml-1 text-blue-700">- ${project.item_description}</span>` : ''}
                                </div>
                            </div>
                            
                            ${project.additional_level_name && project.additional_level_value ? `
                                <div class="mt-2 pt-2 border-t border-blue-200">
                                    <div class="text-xs font-medium text-blue-800 mb-1">Additional Level</div>
                                    <div class="flex items-center bg-green-100 rounded px-2 py-1 inline-flex">
                                        <span class="font-bold text-green-900">${project.additional_level_name}:</span>
                                        <span class="ml-1 text-green-700">${project.additional_level_value}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewProjectDetails(${project.id})" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                            View Details
                        </button>
                        ${currentUser.role === 'reviewer' ? `
                            <button onclick="quickReviewProject(${project.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickReviewProject(${project.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        ` : `
                            <button onclick="quickAdminReviewProject(${project.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickAdminReviewProject(${project.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        `}
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created by:</span>
                        <span class="text-sm text-gray-800">${project.creator?.username || 'Unknown'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created:</span>
                        <span class="text-sm text-gray-800">${new Date(project.created_at).toLocaleDateString()}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Project Attributes:</span>
                        <span class="text-sm text-gray-800 bg-purple-100 text-purple-800 px-2 py-1 rounded">${project.attributes_count || 'Loading...'} attributes</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Status:</span>
                        <span class="text-sm px-2 py-1 rounded capitalize ${
                            project.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' : 
                            project.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' : 
                            'bg-gray-100 text-gray-800'
                        }">${project.status.replace('_', ' ')}</span>
                    </div>
                    ${currentUser.role === 'admin' && project.reviewer ? `
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed by:</span>
                            <span class="text-sm text-gray-800">${project.reviewer.username}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed:</span>
                            <span class="text-sm text-gray-800">${new Date(project.reviewed_at).toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                </div>
                ${project.reviewer_comments ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                        <span class="text-sm font-medium text-blue-800">Reviewer Comments:</span>
                        <p class="text-sm text-blue-700 mt-1">${project.reviewer_comments}</p>
                    </div>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading classification projects:', error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading classification projects</div>';
    }
}

async function loadPendingItemCodes() {
    const container = document.getElementById('item-codes-container');
    
    try {
        let pendingItemCodes = [];
        
        if (currentUser.role === 'reviewer') {
            // Load item codes assigned to this reviewer
            const { data, error } = await supabase
                .from('item_code_workflow')
                .select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    project:classification_projects(
                        id, project_name, division_code, section_code, detailed_section_code, 
                        item_code, additional_level_name, additional_level_value,
                        division_description, section_description, detailed_section_description, item_description
                    )
                `)
                .eq('reviewed_by', currentUser.id)
                .eq('status', 'pending')
                .order('created_at', { ascending: true });
                
            if (error) throw error;
            pendingItemCodes = data || [];
        } else if (currentUser.role === 'admin') {
            // Load item codes approved by reviewer awaiting admin decision
            const { data, error } = await supabase
                .from('item_code_workflow')
                .select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                    project:classification_projects(
                        id, project_name, division_code, section_code, detailed_section_code, 
                        item_code, additional_level_name, additional_level_value,
                        division_description, section_description, detailed_section_description, item_description
                    )
                `)
                .eq('status', 'reviewer_approved')
                .order('reviewed_at', { ascending: true });
                
            if (error) throw error;
            pendingItemCodes = data || [];
        }
        
        if (pendingItemCodes.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No pending item code requests</div>';
            return;
        }
        
        // Render item codes
        container.innerHTML = pendingItemCodes.map(item => `
            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="text-lg font-semibold text-gray-800">${item.item_code}</h4>
                            <span class="badge-item-code request-type-badge">Item Code Request</span>
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-mono">#${item.id}</span>
                        </div>
                        
                        <!-- CSI Path Display -->
                        ${item.project ? `
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg mb-3">
                                <div class="text-xs font-medium text-green-800 mb-2">Associated Project CSI Classification</div>
                                <div class="flex flex-wrap items-center gap-2 text-sm">
                                    <div class="flex items-center bg-green-100 rounded px-2 py-1">
                                        <span class="font-bold text-green-900">${item.project.division_code || 'N/A'}</span>
                                        ${item.project.division_description ? `<span class="ml-1 text-green-700">- ${item.project.division_description}</span>` : ''}
                                    </div>
                                    <span class="text-green-600"></span>
                                    <div class="flex items-center bg-green-100 rounded px-2 py-1">
                                        <span class="font-bold text-green-900">${item.project.section_code || 'N/A'}</span>
                                        ${item.project.section_description ? `<span class="ml-1 text-green-700">- ${item.project.section_description}</span>` : ''}
                                    </div>
                                    <span class="text-green-600"></span>
                                    <div class="flex items-center bg-green-100 rounded px-2 py-1">
                                        <span class="font-bold text-green-900">${item.project.detailed_section_code || 'N/A'}</span>
                                        ${item.project.detailed_section_description ? `<span class="ml-1 text-green-700">- ${item.project.detailed_section_description}</span>` : ''}
                                    </div>
                                    <span class="text-green-600"></span>
                                    <div class="flex items-center bg-green-200 rounded px-2 py-1">
                                        <span class="font-bold text-green-900">${item.project.item_code || 'N/A'}</span>
                                        ${item.project.item_description ? `<span class="ml-1 text-green-700">- ${item.project.item_description}</span>` : ''}
                                    </div>
                                </div>
                                
                                ${item.project.additional_level_name && item.project.additional_level_value ? `
                                    <div class="mt-2 pt-2 border-t border-green-200">
                                        <div class="text-xs font-medium text-green-800 mb-1">Additional Level</div>
                                        <div class="flex items-center bg-yellow-100 rounded px-2 py-1 inline-flex">
                                            <span class="font-bold text-yellow-900">${item.project.additional_level_name}:</span>
                                            <span class="ml-1 text-yellow-700">${item.project.additional_level_value}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="mt-2 pt-2 border-t border-green-200">
                                    <div class="text-xs font-medium text-green-800">Project: ${item.project.project_name}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewItemCodeDetails(${item.id})" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                            View Details
                        </button>
                        ${currentUser.role === 'reviewer' ? `
                            <button onclick="quickReviewItemCode(${item.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickReviewItemCode(${item.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        ` : `
                            <button onclick="quickAdminReviewItemCode(${item.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickAdminReviewItemCode(${item.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        `}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <span class="text-sm font-medium text-gray-600">Description 1:</span>
                        <span class="text-sm text-gray-800">${item.description1 || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Description 2:</span>
                        <span class="text-sm text-gray-800">${item.description2 || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created by:</span>
                        <span class="text-sm text-gray-800">${item.created_by_user?.username || 'Unknown'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">UOM:</span>
                        <span class="text-sm text-gray-800">${item.uom || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created:</span>
                        <span class="text-sm text-gray-800">${new Date(item.created_at).toLocaleDateString()}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Status:</span>
                        <span class="text-sm px-2 py-1 rounded capitalize ${
                            item.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                            item.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' : 
                            'bg-gray-100 text-gray-800'
                        }">${item.status.replace('_', ' ')}</span>
                    </div>
                    ${currentUser.role === 'admin' && item.reviewed_by_user ? `
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed by:</span>
                            <span class="text-sm text-gray-800">${item.reviewed_by_user.username}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed:</span>
                            <span class="text-sm text-gray-800">${new Date(item.reviewed_at).toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                </div>
                ${item.reviewer_comments ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                        <span class="text-sm font-medium text-blue-800">Reviewer Comments:</span>
                        <p class="text-sm text-blue-700 mt-1">${item.reviewer_comments}</p>
                    </div>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading item codes:', error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading item codes</div>';
    }
}

async function loadPendingStandardValues() {
    const container = document.getElementById('standard-values-container');
    
    try {
        let pendingStandardValues = [];
        
        if (currentUser.role === 'reviewer') {
            // Load standard values assigned to this reviewer
            const { data, error } = await supabase
                .from('standard_value_requests')
                .select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    project:classification_projects(project_name),
                    project_attributes(attribute_name, standard_values)
                `)
                .eq('reviewed_by', currentUser.id)
                .eq('status', 'pending')
                .order('created_at', { ascending: true });
                
            if (error) throw error;
            pendingStandardValues = data || [];
        } else if (currentUser.role === 'admin') {
            // Load standard values approved by reviewer awaiting admin decision
            const { data, error } = await supabase
                .from('standard_value_requests')
                .select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name),
                    project_attributes(attribute_name, standard_values)
                `)
                .eq('status', 'reviewer_approved')
                .order('reviewed_at', { ascending: true });
                
            if (error) throw error;
            pendingStandardValues = data || [];
        }
        
        if (pendingStandardValues.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No pending standard value requests</div>';
            return;
        }
        
        // Render standard values
        container.innerHTML = pendingStandardValues.map(item => `
            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="text-lg font-semibold text-gray-800">${item.attribute_name} - ${item.new_value}</h4>
                            <span class="badge-standard-value request-type-badge">Standard Value Request</span>
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-mono">#${item.id}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewStandardValueDetails(${item.id})" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                            View Details
                        </button>
                        ${currentUser.role === 'reviewer' ? `
                            <button onclick="quickReviewStandardValue(${item.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickReviewStandardValue(${item.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        ` : `
                            <button onclick="quickAdminReviewStandardValue(${item.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickAdminReviewStandardValue(${item.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        `}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <span class="text-sm font-medium text-gray-600">Attribute:</span>
                        <span class="text-sm text-gray-800">${item.attribute_name}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">New Value:</span>
                        <span class="text-sm text-gray-800 font-semibold bg-green-100 text-green-800 px-2 py-1 rounded">${item.new_value}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Project:</span>
                        <span class="text-sm text-gray-800">${item.project?.project_name || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created by:</span>
                        <span class="text-sm text-gray-800">${item.created_by_user?.username || 'Unknown'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Reason:</span>
                        <span class="text-sm text-gray-800">${item.reason || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created:</span>
                        <span class="text-sm text-gray-800">${new Date(item.created_at).toLocaleDateString()}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Status:</span>
                        <span class="text-sm px-2 py-1 rounded capitalize ${
                            item.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                            item.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' : 
                            'bg-gray-100 text-gray-800'
                        }">${item.status.replace('_', ' ')}</span>
                    </div>
                    ${currentUser.role === 'admin' && item.reviewed_by_user ? `
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed by:</span>
                            <span class="text-sm text-gray-800">${item.reviewed_by_user.username}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed:</span>
                            <span class="text-sm text-gray-800">${new Date(item.reviewed_at).toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                </div>
                ${item.reviewer_comments ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                        <span class="text-sm font-medium text-blue-800">Reviewer Comments:</span>
                        <p class="text-sm text-blue-700 mt-1">${item.reviewer_comments}</p>
                    </div>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading standard values:', error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading standard values</div>';
    }
}

async function loadPendingCombinations() {
    const container = document.getElementById('combinations-container');
    
    try {
        let pendingCombinations = [];
        
        if (currentUser.role === 'reviewer') {
            // Load combinations assigned to this reviewer
            const { data, error } = await supabase
                .from('combination_requests')
                .select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    project:classification_projects(project_name)
                `)
                .eq('reviewed_by', currentUser.id)
                .eq('status', 'pending')
                .order('created_at', { ascending: true });
                
            if (error) throw error;
            pendingCombinations = data || [];
        } else if (currentUser.role === 'admin') {
            // Load combinations approved by reviewer awaiting admin decision
            const { data, error } = await supabase
                .from('combination_requests')
                .select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `)
                .eq('status', 'reviewer_approved')
                .order('reviewed_at', { ascending: true });
                
            if (error) throw error;
            pendingCombinations = data || [];
        }
        
        if (pendingCombinations.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No pending combination requests</div>';
            return;
        }
        
        // Render combinations
        container.innerHTML = pendingCombinations.map(item => `
            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="text-lg font-semibold text-gray-800">${item.request_type === 'block' ? 'Block' : 'Generate'} Combination</h4>
                            <span class="badge-combination request-type-badge">Combination Request</span>
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-mono">#${item.id}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewCombinationDetails(${item.id})" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                            View Details
                        </button>
                        ${currentUser.role === 'reviewer' ? `
                            <button onclick="quickReviewCombination(${item.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickReviewCombination(${item.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        ` : `
                            <button onclick="quickAdminReviewCombination(${item.id}, 'approve')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="quickAdminReviewCombination(${item.id}, 'reject')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                        `}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <span class="text-sm font-medium text-gray-600">Request Type:</span>
                        <span class="text-sm px-2 py-1 rounded capitalize ${
                            item.request_type === 'block' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                        }">${item.request_type}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Project:</span>
                        <span class="text-sm text-gray-800">${item.project?.project_name || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created by:</span>
                        <span class="text-sm text-gray-800">${item.created_by_user?.username || 'Unknown'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Created:</span>
                        <span class="text-sm text-gray-800">${new Date(item.created_at).toLocaleDateString()}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">UOM:</span>
                        <span class="text-sm text-gray-800">${item.uom || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Country:</span>
                        <span class="text-sm text-gray-800">${item.country_of_origin || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Status:</span>
                        <span class="text-sm px-2 py-1 rounded capitalize ${
                            item.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                            item.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' : 
                            'bg-gray-100 text-gray-800'
                        }">${item.status.replace('_', ' ')}</span>
                    </div>
                    ${currentUser.role === 'admin' && item.reviewed_by_user ? `
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed by:</span>
                            <span class="text-sm text-gray-800">${item.reviewed_by_user.username}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Reviewed:</span>
                            <span class="text-sm text-gray-800">${new Date(item.reviewed_at).toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                </div>
                ${item.reason ? `
                    <div class="mt-4 p-3 bg-yellow-50 rounded border-l-4 border-yellow-400">
                        <span class="text-sm font-medium text-yellow-800">Reason:</span>
                        <p class="text-sm text-yellow-700 mt-1">${item.reason}</p>
                    </div>
                ` : ''}
                ${item.reviewer_comments ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                        <span class="text-sm font-medium text-blue-800">Reviewer Comments:</span>
                        <p class="text-sm text-blue-700 mt-1">${item.reviewer_comments}</p>
                    </div>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading combinations:', error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading combinations</div>';
    }
}

// ===== BULK APPROVAL FUNCTIONS =====

function toggleBulkMode(requestType) {
    const isCurrentlyEnabled = selectedItems[requestType].length > 0 || 
                              document.getElementById(`bulk-actions-${requestType}`).classList.contains('block');
    
    if (isCurrentlyEnabled) {
        // Disable bulk mode
        selectedItems[requestType] = [];
        document.getElementById(`bulk-actions-${requestType}`).classList.add('hidden');
        document.getElementById(`bulk-toggle-${requestType}`).querySelector('.bulk-mode-text').textContent = 'Enable Bulk Actions';
        
        // Remove checkboxes and reset styling
        const container = document.getElementById(`${requestType === 'projects' ? 'classification-projects' : requestType}-container`);
        const checkboxes = container.querySelectorAll('.bulk-checkbox');
        checkboxes.forEach(cb => cb.remove());
        
        const cards = container.querySelectorAll('.bg-white');
        cards.forEach(card => {
            card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
        });
        
    } else {
        // Enable bulk mode
        document.getElementById(`bulk-actions-${requestType}`).classList.remove('hidden');
        document.getElementById(`bulk-toggle-${requestType}`).querySelector('.bulk-mode-text').textContent = 'Disable Bulk Actions';
        
        // Add checkboxes to all items
        addCheckboxesToItems(requestType);
    }
    
    updateSelectedCount(requestType);
}

function addCheckboxesToItems(requestType) {
    const containerMap = {
        'projects': 'classification-projects-container',
        'item-codes': 'item-codes-container', 
        'standard-values': 'standard-values-container',
        'combinations': 'combinations-container'
    };
    
    const container = document.getElementById(containerMap[requestType]);
    const cards = container.querySelectorAll('.bg-white');
    
    cards.forEach(card => {
        // Extract item ID from existing buttons
        const viewButton = card.querySelector('button[onclick*="Details"]');
        const itemId = extractItemIdFromButton(viewButton);
        
        if (itemId && !card.querySelector('.bulk-checkbox')) {
            // Create checkbox
            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'bulk-checkbox absolute top-4 left-4 z-10';
            checkboxContainer.innerHTML = `
                <input type="checkbox" 
                       id="bulk-${requestType}-${itemId}" 
                       data-item-id="${itemId}"
                       onchange="handleItemSelection('${requestType}', ${itemId})"
                       class="w-4 h-4 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
            `;
            
            // Make card relative positioned if not already
            card.style.position = 'relative';
            card.appendChild(checkboxContainer);
        }
    });
}

function extractItemIdFromButton(button) {
    if (!button) return null;
    
    const onclick = button.getAttribute('onclick');
    if (!onclick) return null;
    
    // Extract ID from patterns like "viewProjectDetails(123)" or "viewItemCodeDetails(456)"
    const match = onclick.match(/\((\d+)\)/);
    return match ? parseInt(match[1]) : null;
}

function handleItemSelection(requestType, itemId) {
    const checkbox = document.getElementById(`bulk-${requestType}-${itemId}`);
    const card = checkbox.closest('.bg-white');
    
    if (checkbox.checked) {
        if (!selectedItems[requestType].includes(itemId)) {
            selectedItems[requestType].push(itemId);
        }
        card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
    } else {
        selectedItems[requestType] = selectedItems[requestType].filter(id => id !== itemId);
        card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
    }
    
    updateSelectedCount(requestType);
}

function selectAllItems(requestType, selectAll) {
    const containerMap = {
        'projects': 'classification-projects-container',
        'item-codes': 'item-codes-container', 
        'standard-values': 'standard-values-container',
        'combinations': 'combinations-container'
    };
    
    const container = document.getElementById(containerMap[requestType]);
    const checkboxes = container.querySelectorAll('.bulk-checkbox input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        const itemId = parseInt(checkbox.dataset.itemId);
        const card = checkbox.closest('.bg-white');
        
        checkbox.checked = selectAll;
        
        if (selectAll) {
            if (!selectedItems[requestType].includes(itemId)) {
                selectedItems[requestType].push(itemId);
            }
            card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
        } else {
            selectedItems[requestType] = selectedItems[requestType].filter(id => id !== itemId);
            card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
        }
    });
    
    updateSelectedCount(requestType);
}

function updateSelectedCount(requestType) {
    const count = selectedItems[requestType].length;
    const countElement = document.getElementById(`selected-count-${requestType}`);
    if (countElement) {
        countElement.textContent = count;
    }
}

async function bulkApprove(requestType) {
    await processBulkAction(requestType, 'approve');
}

async function bulkReject(requestType) {
    await processBulkAction(requestType, 'reject');
}

async function processBulkAction(requestType, action) {
    const selectedIds = selectedItems[requestType];
    const actionText = action === 'approve' ? 'approve' : 'reject';
    const actionNoun = action === 'approve' ? 'approval' : 'rejection';
    
    if (selectedIds.length === 0) {
        alert(`No ${requestType.replace('-', ' ')} selected for ${actionNoun}.`);
        return;
    }
    
    const confirmMessage = `Are you sure you want to ${actionText} ${selectedIds.length} ${requestType.replace('-', ' ')} request${selectedIds.length > 1 ? 's' : ''}?`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Get comments for bulk action
    const comments = prompt(`Comments for bulk ${actionNoun} (optional):`);
    
    try {
        // Show loading indicator
        const loadingMessage = `Processing bulk ${actionNoun}...`;
        console.log(loadingMessage);
        
        let result;
        
        // Since bulk RPC functions don't exist in the database, use individual processing
        console.log('Using individual processing for bulk actions...');
        await processBulkActionFallback(requestType, action, selectedIds, comments);
        
    } catch (error) {
        console.error(`Bulk ${actionNoun} failed:`, error);
        alert(`Bulk ${actionNoun} failed: ${error.message}`);
    }
}

async function processBulkActionFallback(requestType, action, selectedIds, comments) {
    const results = [];
    let successful = 0;
    let failed = 0;
    
    // Process each item individually
    for (const itemId of selectedIds) {
        try {
            await processSingleApproval(requestType, itemId, action, comments);
            results.push({ id: itemId, success: true });
            successful++;
        } catch (error) {
            console.error(`Failed to ${action} ${requestType} ${itemId}:`, error);
            results.push({ id: itemId, success: false, error: error.message });
            failed++;
        }
    }
    
    // Show results
    const actionNoun = action === 'approve' ? 'approval' : 'rejection';
    const message = `Bulk ${actionNoun} completed (fallback mode)!\n` +
                   `Successful: ${successful}\n` +
                   `Failed: ${failed}`;
    
    if (failed > 0) {
        console.warn('Some items failed:', results.filter(r => !r.success));
    }
    
    alert(message);
    
    // Clear selection and refresh data
    selectedItems[requestType] = [];
    toggleBulkMode(requestType);
    await loadPendingRequests();
}

async function processSingleApproval(requestType, itemId, action, comments) {
    const decision = action === 'approve' ? 
        (currentUser.role === 'admin' ? 'admin_approve' : 'reviewer_approve') :
        (currentUser.role === 'admin' ? 'admin_reject' : 'reviewer_reject');
    
    switch (requestType) {
        case 'projects':
            if (currentUser.role === 'admin') {
                return await supabase.rpc('admin_review_decision', {
                    project_id_param: itemId,
                    admin_id_param: currentUser.id,
                    decision_param: action, // 'approve' or 'reject', not 'approved' or 'rejected'
                    comments_param: comments || ''
                });
            } else {
                return await supabase.rpc('review_project_decision', {
                    project_id_param: itemId,
                    reviewer_id_param: currentUser.id,
                    decision_param: action, // 'approve' or 'reject', not 'approved' or 'rejected'
                    comments_param: comments || ''
                });
            }
            
        case 'item-codes':
            return await supabase.rpc('approve_item_code_workflow', {
                request_id_param: itemId,
                reviewer_id_param: currentUser.id,
                decision_param: decision,
                comments_param: comments || ''
            });
            
        case 'standard-values':
            // Update standard value request
            const { data, error } = await supabase
                .from('standard_value_requests')
                .update({
                    status: action === 'approve' ? 
                        (currentUser.role === 'admin' ? 'admin_approved' : 'reviewer_approved') :
                        (currentUser.role === 'admin' ? 'admin_rejected' : 'reviewer_rejected'),
                    [currentUser.role === 'admin' ? 'admin_reviewed_at' : 'reviewed_at']: new Date().toISOString(),
                    [currentUser.role === 'admin' ? 'admin_reviewed_by' : 'reviewed_by']: currentUser.id,
                    [currentUser.role === 'admin' ? 'admin_comments' : 'reviewer_comments']: comments || ''
                })
                .eq('id', itemId);
                
            if (error) throw error;
            return { data, error: null };
            
        case 'combinations':
            // Update combination request  
            const { data: combData, error: combError } = await supabase
                .from('combination_requests')
                .update({
                    status: action === 'approve' ? 
                        (currentUser.role === 'admin' ? 'admin_approved' : 'reviewer_approved') :
                        (currentUser.role === 'admin' ? 'admin_rejected' : 'reviewer_rejected'),
                    [currentUser.role === 'admin' ? 'admin_reviewed_at' : 'reviewed_at']: new Date().toISOString(),
                    [currentUser.role === 'admin' ? 'admin_reviewed_by' : 'reviewed_by']: currentUser.id,
                    [currentUser.role === 'admin' ? 'admin_comments' : 'reviewer_comments']: comments || ''
                })
                .eq('id', itemId);
                
            if (combError) throw combError;
            return { data: combData, error: null };
            
        default:
            throw new Error(`Unknown request type: ${requestType}`);
    }
}

// ===== COMPREHENSIVE DETAIL VIEWING FUNCTIONS =====

async function viewProjectDetails(projectId) {
    try {
        console.log('Loading project details for:', projectId);
        
        // Load complete project data with attributes
        const { data: projectData, error: projectError } = await supabase
            .from('classification_projects')
            .select(`
                *,
                creator:users!classification_projects_created_by_fkey(username, email),
                reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                admin:users!classification_projects_admin_id_fkey(username, email),
                project_attributes(
                    id, attribute_name, standard_values, is_mandatory, is_manual_entry
                )
            `)
            .eq('id', projectId)
            .single();
        
        if (projectError) throw projectError;
        if (!projectData) throw new Error('Project not found');
        
        // Show the detail modal
        showProjectDetailModal(projectData);
        
    } catch (error) {
        console.error('Error loading project details:', error);
        alert('Error loading project details: ' + error.message);
    }
}

function showProjectDetailModal(project) {
    // Create modal HTML
    const modalHtml = `
        <div id="project-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 class="text-2xl font-semibold text-gray-900">Classification Project Details</h2>
                    <button onclick="closeProjectDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <!-- Basic Info Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">BASIC INFO</span>
                            Project Information
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Project Name:</span>
                                    <p class="text-sm text-gray-800 font-semibold">${project.project_name}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Status:</span>
                                    <span class="text-sm px-2 py-1 rounded capitalize ${
                                        project.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' : 
                                        project.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' : 
                                        project.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">${project.status.replace('_', ' ')}</span>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Created:</span>
                                    <p class="text-sm text-gray-800">${new Date(project.created_at).toLocaleString()}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Submitted:</span>
                                    <p class="text-sm text-gray-800">${project.submitted_at ? new Date(project.submitted_at).toLocaleString() : 'Not submitted'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Updated:</span>
                                    <p class="text-sm text-gray-800">${new Date(project.updated_at).toLocaleString()}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Project ID:</span>
                                    <p class="text-sm text-gray-800 font-mono">#${project.id}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CSI Hierarchy Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">CSI HIERARCHY</span>
                            Classification Structure
                        </h3>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg">
                            <div class="space-y-3">
                                <div class="flex items-center bg-blue-100 rounded-lg p-3">
                                    <div class="flex-1">
                                        <div class="font-bold text-blue-900 text-lg">${project.division_code}</div>
                                        <div class="text-blue-700 text-sm">${project.division_description || 'No description'}</div>
                                        <div class="text-xs text-blue-600">Division</div>
                                    </div>
                                </div>
                                <div class="text-center text-blue-600">ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬Å“</div>
                                <div class="flex items-center bg-blue-100 rounded-lg p-3">
                                    <div class="flex-1">
                                        <div class="font-bold text-blue-900 text-lg">${project.section_code}</div>
                                        <div class="text-blue-700 text-sm">${project.section_description || 'No description'}</div>
                                        <div class="text-xs text-blue-600">Section</div>
                                    </div>
                                </div>
                                <div class="text-center text-blue-600">ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬Å“</div>
                                <div class="flex items-center bg-blue-100 rounded-lg p-3">
                                    <div class="flex-1">
                                        <div class="font-bold text-blue-900 text-lg">${project.detailed_section_code}</div>
                                        <div class="text-blue-700 text-sm">${project.detailed_section_description || 'No description'}</div>
                                        <div class="text-xs text-blue-600">Detailed Section</div>
                                    </div>
                                </div>
                                <div class="text-center text-blue-600">ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬Å“</div>
                                <div class="flex items-center bg-blue-200 rounded-lg p-3">
                                    <div class="flex-1">
                                        <div class="font-bold text-blue-900 text-lg">${project.item_code}</div>
                                        <div class="text-blue-700 text-sm">${project.item_description || 'No description'}</div>
                                        <div class="text-xs text-blue-600">Item</div>
                                    </div>
                                </div>
                                
                                ${project.additional_level_name && project.additional_level_value ? `
                                    <div class="text-center text-green-600">ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬Å“</div>
                                    <div class="flex items-center bg-green-100 rounded-lg p-3">
                                        <div class="flex-1">
                                            <div class="font-bold text-green-900 text-lg">${project.additional_level_value}</div>
                                            <div class="text-green-700 text-sm">${project.additional_level_name}</div>
                                            <div class="text-xs text-green-600">Additional Level</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- People Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm mr-2">PEOPLE</span>
                            Project Team
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center p-3 bg-white rounded border">
                                    <div class="text-sm font-medium text-gray-600">Created by</div>
                                    <div class="text-lg font-semibold text-gray-800">${project.creator?.username || 'Unknown'}</div>
                                    <div class="text-xs text-gray-500">${project.creator?.email || ''}</div>
                                </div>
                                <div class="text-center p-3 bg-white rounded border">
                                    <div class="text-sm font-medium text-gray-600">Assigned Reviewer</div>
                                    <div class="text-lg font-semibold text-gray-800">${project.reviewer?.username || 'Not assigned'}</div>
                                    <div class="text-xs text-gray-500">${project.reviewer?.email || ''}</div>
                                </div>
                                <div class="text-center p-3 bg-white rounded border">
                                    <div class="text-sm font-medium text-gray-600">Admin</div>
                                    <div class="text-lg font-semibold text-gray-800">${project.admin?.username || 'Not assigned'}</div>
                                    <div class="text-xs text-gray-500">${project.admin?.email || ''}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Project Attributes Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm mr-2">ATTRIBUTES</span>
                            Project Attributes & Values
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            ${project.project_attributes && project.project_attributes.length > 0 ? `
                                <div class="space-y-4 max-h-96 overflow-y-auto">
                                    ${project.project_attributes.map(attr => `
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <h4 class="font-semibold text-gray-800">${attr.attribute_name}</h4>
                                                    <div class="flex gap-2 mt-1">
                                                        ${attr.is_mandatory ? 
                                                            '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">Mandatory</span>' : 
                                                            '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">Optional</span>'
                                                        }
                                                        ${attr.is_manual_entry ? 
                                                            '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">Manual Entry</span>' : 
                                                            '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">Predefined Values</span>'
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            ${attr.standard_values && attr.standard_values.length > 0 ? `
                                                <div>
                                                    <div class="text-sm font-medium text-gray-600 mb-2">Standard Values:</div>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${(() => {
                                                            // Handle different data formats for standard values
                                                            let values = attr.standard_values;
                                                            
                                                            // Parse if it's a JSON string
                                                            if (typeof values === 'string') {
                                                                try {
                                                                    values = JSON.parse(values);
                                                                } catch(e) {
                                                                    console.warn('Failed to parse standard_values:', values);
                                                                    return '<span class="text-red-500 text-sm">Invalid format</span>';
                                                                }
                                                            }
                                                            
                                                            // Ensure it's an array
                                                            if (!Array.isArray(values)) {
                                                                console.warn('Standard values not an array:', values);
                                                                return '<span class="text-yellow-600 text-sm">Format error</span>';
                                                            }
                                                            
                                                            return values.map(value => {
                                                                // Handle both object and string formats
                                                                const valueName = typeof value === 'object' && value !== null ? 
                                                                    (value.name || String(value)) : String(value);
                                                                const valueUnit = typeof value === 'object' && value !== null && value.unit ? 
                                                                    value.unit : '';
                                                                const displayText = valueUnit ? `${valueName} (${valueUnit})` : valueName;
                                                                
                                                                return `<span class="bg-blue-50 text-blue-800 px-2 py-1 rounded text-sm border">${displayText}</span>`;
                                                            }).join('');
                                                        })()}
                                                    </div>
                                                </div>
                                            ` : `
                                                <div class="text-sm text-gray-500 italic">No predefined values (manual entry allowed)</div>
                                            `}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center text-gray-500 py-8">No attributes configured for this project</div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Review Data Section -->
                    ${(project.reviewer_comments || project.admin_comments || project.reviewed_at || project.admin_reviewed_at) ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">REVIEW DATA</span>
                                Review History
                            </h3>
                            <div class="space-y-4">
                                ${project.reviewed_at ? `
                                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="text-sm font-medium text-blue-800">Reviewer Review</div>
                                                <div class="text-xs text-blue-600">${new Date(project.reviewed_at).toLocaleString()}</div>
                                            </div>
                                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">Reviewed</span>
                                        </div>
                                        ${project.reviewer_comments ? `
                                            <div class="mt-2">
                                                <div class="text-sm text-blue-700">${project.reviewer_comments}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                ${project.admin_reviewed_at ? `
                                    <div class="bg-green-50 border-l-4 border-green-400 p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="text-sm font-medium text-green-800">Admin Review</div>
                                                <div class="text-xs text-green-600">${new Date(project.admin_reviewed_at).toLocaleString()}</div>
                                            </div>
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Admin Reviewed</span>
                                        </div>
                                        ${project.admin_comments ? `
                                            <div class="mt-2">
                                                <div class="text-sm text-green-700">${project.admin_comments}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Review Actions Section -->
                    ${(project.status === 'submitted' && currentUser.role === 'reviewer') || (project.status === 'reviewer_approved' && currentUser.role === 'admin') ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-sm mr-2">REVIEW ACTIONS</span>
                                Your Review Decision
                            </h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="mb-4">
                                    <label for="project-review-comments" class="block text-sm font-medium text-gray-700 mb-2">Comments:</label>
                                    <textarea id="project-review-comments" rows="4" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Enter your review comments..."></textarea>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="submitProjectReview(${project.id}, 'approve')" 
                                        class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 font-medium">
                                        Approve Project
                                    </button>
                                    <button onclick="submitProjectReview(${project.id}, 'reject')" 
                                        class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600 font-medium">
                                        Reject Project
                                    </button>
                                    <button onclick="closeProjectDetailModal()" 
                                        class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeProjectDetailModal() {
    const modal = document.getElementById('project-detail-modal');
    if (modal) {
        modal.remove();
    }
}

// ===== ITEM CODE DETAILS MODAL =====
async function viewItemCodeDetails(requestId) {
    try {
        // Fetch item code request details with project info
        const { data: request, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                admin_reviewed_by_user:users!item_code_workflow_admin_reviewed_by_fkey(username, email),
                project:classification_projects(
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email)
                )
            `)
            .eq('id', requestId)
            .single();

        if (error) throw error;
        if (!request) throw new Error('Item code request not found');

        // Get project attributes if project exists
        let projectAttributes = [];
        if (request.project?.id) {
            const { data: attrs } = await supabase
                .from('project_attributes')
                .select('*')
                .eq('project_id', request.project.id)
                .order('attribute_name');
            projectAttributes = attrs || [];
        }

        showItemCodeDetailModal(request, projectAttributes);
        
    } catch (error) {
        console.error('Error loading item code details:', error);
        alert('Error loading request details: ' + error.message);
    }
}

function showItemCodeDetailModal(request, projectAttributes) {
    // Remove existing modal if present
    const existingModal = document.getElementById('item-code-detail-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const statusDisplayText = {
        'pending': 'Pending Review',
        'reviewer_approved': 'Pending Admin Approval', 
        'reviewer_rejected': 'Reviewer Rejected',
        'admin_approved': 'Admin Approved',
        'admin_rejected': 'Admin Rejected'
    };

    const statusColors = {
        'pending': 'text-yellow-600',
        'reviewer_approved': 'text-blue-600',
        'reviewer_rejected': 'text-orange-600', 
        'admin_approved': 'text-green-600',
        'admin_rejected': 'text-red-600'
    };

    // Generate CSI hierarchy display
    const project = request.project;
    let csiHierarchy = '';
    if (project) {
        csiHierarchy = `
            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-lg mb-6">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/>
                    </svg>
                    CSI Code Hierarchy
                </h4>
                <div class="flex flex-wrap items-center space-x-2 text-sm">
                    <span class="px-3 py-1 bg-blue-200 text-blue-900 rounded font-medium">${project.division_code}</span>
                    <span class="text-gray-500">&rarr;</span>
                    <span class="px-3 py-1 bg-indigo-200 text-indigo-900 rounded font-medium">${project.section_code}</span>
                    <span class="text-gray-500">&rarr;</span>
                    <span class="px-3 py-1 bg-purple-200 text-purple-900 rounded font-medium">${project.detailed_section_code}</span>
                    <span class="text-gray-500">&rarr;</span>
                    <span class="px-3 py-1 bg-green-200 text-green-900 rounded font-medium">${project.item_code}</span>
                    ${project.additional_level_name ? `
                        <span class="text-gray-500">&rarr;</span>
                        <span class="px-3 py-1 bg-yellow-200 text-yellow-900 rounded font-medium">${project.additional_level_value}</span>
                    ` : ''}
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    <strong>Project:</strong> ${project.project_name}
                </div>
            </div>
        `;
    }

    // Generate attribute selections display
    let attributeSelectionsHtml = '';
    if (request.attribute_selections) {
        let selections;
        
        // Parse JSON string if needed
        if (typeof request.attribute_selections === 'string') {
            try {
                selections = JSON.parse(request.attribute_selections);
            } catch(e) {
                console.warn('Failed to parse attribute_selections:', request.attribute_selections);
                selections = {};
            }
        } else if (typeof request.attribute_selections === 'object' && request.attribute_selections !== null) {
            selections = request.attribute_selections;
        } else {
            selections = {};
        }
        
        const entries = Object.entries(selections);
        if (entries.length > 0) {
            attributeSelectionsHtml = `
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">Selected Attributes</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${entries.map(([attr, value]) => `
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="font-medium text-gray-700">${attr}</div>
                                <div class="text-blue-600">${value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }

    const modalHtml = `
        <div id="item-code-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Item Code Request Details</h2>
                    <button onclick="closeItemCodeDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- Basic Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Basic Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Request ID:</label>
                                <p class="font-mono text-sm">#${request.id}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Status:</label>
                                <p class="${statusColors[request.status] || 'text-gray-600'} font-medium">
                                    ${statusDisplayText[request.status] || request.status}
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Item Code:</label>
                                <p class="font-mono font-bold text-blue-600">${request.item_code || 'Not generated'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Created:</label>
                                <p>${new Date(request.created_at).toLocaleString()}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Created by:</label>
                                <p>${request.created_by_user?.username || 'Unknown'} (${request.created_by_user?.email || 'N/A'})</p>
                            </div>
                            ${request.reviewed_by_user ? `
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Reviewed by:</label>
                                    <p>${request.reviewed_by_user.username} (${request.reviewed_by_user.email})</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- CSI Hierarchy (if project exists) -->
                    ${csiHierarchy}

                    <!-- Item Details -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Item Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Description 1:</label>
                                <p>${request.description1 || 'Not specified'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Description 2:</label>
                                <p>${request.description2 || 'Not specified'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Unit of Measure:</label>
                                <p>${request.uom || 'Not specified'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Country of Origin:</label>
                                <p>${request.country_of_origin || 'Not specified'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Model Number:</label>
                                <p>${request.model_number || 'Not specified'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Manufacturer:</label>
                                <p>${request.manufacturer || 'Not specified'}</p>
                            </div>
                            ${request.unit_price ? `
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Unit Price:</label>
                                    <p>${request.unit_price} ${request.currency_code || ''}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Selected Attributes -->
                    ${attributeSelectionsHtml}

                    <!-- Review Comments -->
                    ${request.review_comments || request.admin_comments ? `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Review Comments</h3>
                            <div class="space-y-3">
                                ${request.review_comments ? `
                                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <div class="font-medium text-yellow-800">Reviewer Comments:</div>
                                        <p class="mt-1 text-yellow-700">${request.review_comments}</p>
                                        ${request.reviewed_at ? `<div class="text-xs text-yellow-600 mt-2">Reviewed: ${new Date(request.reviewed_at).toLocaleString()}</div>` : ''}
                                    </div>
                                ` : ''}
                                ${request.admin_comments ? `
                                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div class="font-medium text-blue-800">Admin Comments:</div>
                                        <p class="mt-1 text-blue-700">${request.admin_comments}</p>
                                        ${request.admin_reviewed_at ? `<div class="text-xs text-blue-600 mt-2">Admin Reviewed: ${new Date(request.admin_reviewed_at).toLocaleString()}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Review Actions -->
                    ${(currentUser.role === 'reviewer' && request.status === 'pending' && (request.reviewed_by === currentUser.id || !request.reviewed_by)) ||
                      (currentUser.role === 'admin' && request.status === 'reviewer_approved') ? `
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Review Actions</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Comments:</label>
                                    <textarea id="item-code-review-comments" 
                                              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                              rows="4" 
                                              placeholder="Enter your review comments..."></textarea>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="submitItemCodeReview(${request.id}, 'approve')" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-medium">
                                        Approve
                                    </button>
                                    <button onclick="submitItemCodeReview(${request.id}, 'reject')" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-medium">
                                        Reject
                                    </button>
                                    <button onclick="closeItemCodeDetailModal()" 
                                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeItemCodeDetailModal() {
    const modal = document.getElementById('item-code-detail-modal');
    if (modal) {
        modal.remove();
    }
}

async function submitItemCodeReview(requestId, decision) {
    try {
        const comments = document.getElementById('item-code-review-comments').value.trim();
        
        if (!comments) {
            alert('Please provide review comments');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this item code request?`);
        if (!confirmed) return;
        
        // Call the appropriate review function
        if (currentUser.role === 'reviewer') {
            await reviewItemCodeRequest(requestId, decision, comments);
        } else if (currentUser.role === 'admin') {
            await adminReviewItemCodeRequest(requestId, decision, comments);
        }
        
        // Close modal and refresh data
        closeItemCodeDetailModal();
        await switchPendingSubTab('item-codes');
        
    } catch (error) {
        console.error('Error submitting item code review:', error);
        alert('Error submitting review: ' + error.message);
    }
}

// ===== STANDARD VALUE DETAILS MODAL =====
async function viewStandardValueDetails(requestId) {
    try {
        // Fetch standard value request details with project and attribute info
        const { data: request, error } = await supabase
            .from('standard_value_requests')
            .select(`
                *,
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                admin_reviewed_by_user:users!standard_value_requests_admin_reviewed_by_fkey(username, email),
                project:classification_projects(*),
                attribute:project_attributes(*)
            `)
            .eq('id', requestId)
            .single();

        if (error) throw error;
        if (!request) throw new Error('Standard value request not found');

        showStandardValueDetailModal(request);
        
    } catch (error) {
        console.error('Error loading standard value details:', error);
        alert('Error loading request details: ' + error.message);
    }
}

function showStandardValueDetailModal(request) {
    // Remove existing modal if present
    const existingModal = document.getElementById('standard-value-detail-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const statusDisplayText = {
        'pending': 'Pending Review',
        'reviewer_approved': 'Pending Admin Approval', 
        'reviewer_rejected': 'Reviewer Rejected',
        'admin_approved': 'Admin Approved',
        'admin_rejected': 'Admin Rejected'
    };

    const statusColors = {
        'pending': 'text-yellow-600',
        'reviewer_approved': 'text-blue-600',
        'reviewer_rejected': 'text-orange-600', 
        'admin_approved': 'text-green-600',
        'admin_rejected': 'text-red-600'
    };

    // Generate existing standard values display
    let existingValuesHtml = '';
    if (request.attribute && request.attribute.standard_values) {
        let standardValues = request.attribute.standard_values;
        
        // Parse JSON string if needed
        if (typeof standardValues === 'string') {
            try {
                standardValues = JSON.parse(standardValues);
            } catch(e) {
                console.warn('Failed to parse standard_values:', standardValues);
                standardValues = [];
            }
        }
        
        // Ensure it's an array
        if (!Array.isArray(standardValues)) {
            console.warn('Standard values is not an array:', standardValues);
            standardValues = [];
        }
        
        if (standardValues.length > 0) {
            existingValuesHtml = `
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">Current Standard Values</h4>
                    <div class="flex flex-wrap gap-2">
                        ${standardValues.map(value => {
                            // Handle both object and string formats
                            const valueName = typeof value === 'object' && value !== null ? 
                                (value.name || String(value)) : String(value);
                            const valueUnit = typeof value === 'object' && value !== null && value.unit ? 
                                value.unit : '';
                            const displayText = valueUnit ? `${valueName} (${valueUnit})` : valueName;
                            
                            return `
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                    ${displayText}
                                </span>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
    }

    const modalHtml = `
        <div id="standard-value-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Standard Value Request Details</h2>
                    <button onclick="closeStandardValueDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- Basic Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Basic Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Request ID:</label>
                                <p class="font-mono text-sm">#${request.id}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Status:</label>
                                <p class="${statusColors[request.status] || 'text-gray-600'} font-medium">
                                    ${statusDisplayText[request.status] || request.status}
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Project:</label>
                                <p>${request.project?.project_name || 'Unknown Project'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Created:</label>
                                <p>${new Date(request.created_at).toLocaleString()}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Created by:</label>
                                <p>${request.created_by_user?.username || 'Unknown'} (${request.created_by_user?.email || 'N/A'})</p>
                            </div>
                            ${request.reviewed_by_user ? `
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Reviewed by:</label>
                                    <p>${request.reviewed_by_user.username} (${request.reviewed_by_user.email})</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Attribute Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Attribute Information</h3>
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-blue-700">Attribute Name:</label>
                                    <p class="font-semibold text-blue-900">${request.attribute_name}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-blue-700">Mandatory:</label>
                                    <p class="text-blue-900">${request.attribute?.is_mandatory ? 'Yes' : 'No'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Standard Values -->
                    ${existingValuesHtml}

                    <!-- New Value Request -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">New Value Request</h3>
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="text-sm font-medium text-green-700">Requested New Value:</label>
                                    <p class="font-bold text-green-900 text-lg">${request.new_value}</p>
                                </div>
                            </div>
                            ${request.reason ? `
                                <div>
                                    <label class="text-sm font-medium text-green-700">Reason for Request:</label>
                                    <p class="text-green-900 mt-1">${request.reason}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Review Comments -->
                    ${request.reviewer_comments || request.admin_comments ? `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Review Comments</h3>
                            <div class="space-y-3">
                                ${request.reviewer_comments ? `
                                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <div class="font-medium text-yellow-800">Reviewer Comments:</div>
                                        <p class="mt-1 text-yellow-700">${request.reviewer_comments}</p>
                                        ${request.reviewed_at ? `<div class="text-xs text-yellow-600 mt-2">Reviewed: ${new Date(request.reviewed_at).toLocaleString()}</div>` : ''}
                                    </div>
                                ` : ''}
                                ${request.admin_comments ? `
                                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div class="font-medium text-blue-800">Admin Comments:</div>
                                        <p class="mt-1 text-blue-700">${request.admin_comments}</p>
                                        ${request.admin_reviewed_at ? `<div class="text-xs text-blue-600 mt-2">Admin Reviewed: ${new Date(request.admin_reviewed_at).toLocaleString()}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Review Actions -->
                    ${(currentUser.role === 'reviewer' && request.status === 'pending' && (request.reviewed_by === currentUser.id || !request.reviewed_by)) ||
                      (currentUser.role === 'admin' && request.status === 'reviewer_approved') ? `
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Review Actions</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Comments:</label>
                                    <textarea id="standard-value-review-comments" 
                                              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                              rows="4" 
                                              placeholder="Enter your review comments..."></textarea>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="submitStandardValueReview(${request.id}, 'approve')" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-medium">
                                        Approve
                                    </button>
                                    <button onclick="submitStandardValueReview(${request.id}, 'reject')" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-medium">
                                        Reject
                                    </button>
                                    <button onclick="closeStandardValueDetailModal()" 
                                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeStandardValueDetailModal() {
    const modal = document.getElementById('standard-value-detail-modal');
    if (modal) {
        modal.remove();
    }
}

async function submitStandardValueReview(requestId, decision) {
    try {
        const comments = document.getElementById('standard-value-review-comments').value.trim();
        
        if (!comments) {
            alert('Please provide review comments');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this standard value request?`);
        if (!confirmed) return;
        
        // Call the appropriate review function
        if (currentUser.role === 'reviewer') {
            await reviewStandardValueRequest(requestId, decision, comments);
        } else if (currentUser.role === 'admin') {
            await adminReviewStandardValueRequest(requestId, decision, comments);
        }
        
        // Close modal and refresh data
        closeStandardValueDetailModal();
        await switchPendingSubTab('standard-values');
        
    } catch (error) {
        console.error('Error submitting standard value review:', error);
        alert('Error submitting review: ' + error.message);
    }
}

// ===== COMBINATION DETAILS MODAL =====
async function viewCombinationDetails(requestId) {
    try {
        // Fetch combination request details with project info
        const { data: request, error } = await supabase
            .from('combination_requests')
            .select(`
                *,
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                admin_reviewed_by_user:users!combination_requests_admin_reviewed_by_fkey(username, email),
                project:classification_projects(
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email)
                )
            `)
            .eq('id', requestId)
            .single();

        if (error) throw error;
        if (!request) throw new Error('Combination request not found');

        // Get project attributes if project exists
        let projectAttributes = [];
        if (request.project?.id) {
            const { data: attrs } = await supabase
                .from('project_attributes')
                .select('*')
                .eq('project_id', request.project.id)
                .order('attribute_name');
            projectAttributes = attrs || [];
        }

        showCombinationDetailModal(request, projectAttributes);
        
    } catch (error) {
        console.error('Error loading combination details:', error);
        alert('Error loading request details: ' + error.message);
    }
}

function showCombinationDetailModal(request, projectAttributes) {
    // Remove existing modal if present
    const existingModal = document.getElementById('combination-detail-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const statusDisplayText = {
        'pending': 'Pending Review',
        'reviewer_approved': 'Pending Admin Approval', 
        'reviewer_rejected': 'Reviewer Rejected',
        'admin_approved': 'Admin Approved',
        'admin_rejected': 'Admin Rejected'
    };

    const statusColors = {
        'pending': 'text-yellow-600',
        'reviewer_approved': 'text-blue-600',
        'reviewer_rejected': 'text-orange-600', 
        'admin_approved': 'text-green-600',
        'admin_rejected': 'text-red-600'
    };

    const requestTypeDisplay = {
        'generate': { label: 'Generate Item Code', color: 'text-green-600', bgColor: 'bg-green-100' },
        'block': { label: 'Block Combination', color: 'text-red-600', bgColor: 'bg-red-100' }
    };

    const typeInfo = requestTypeDisplay[request.request_type] || requestTypeDisplay['generate'];

    // Generate CSI hierarchy display
    const project = request.project;
    let csiHierarchy = '';
    if (project) {
        csiHierarchy = `
            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-lg mb-6">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/>
                    </svg>
                    Project CSI Hierarchy
                </h4>
                <div class="flex flex-wrap items-center space-x-2 text-sm">
                    <span class="px-3 py-1 bg-blue-200 text-blue-900 rounded font-medium">${project.division_code}</span>
                    <span class="text-gray-500">&rarr;</span>
                    <span class="px-3 py-1 bg-indigo-200 text-indigo-900 rounded font-medium">${project.section_code}</span>
                    <span class="text-gray-500">&rarr;</span>
                    <span class="px-3 py-1 bg-purple-200 text-purple-900 rounded font-medium">${project.detailed_section_code}</span>
                    <span class="text-gray-500">&rarr;</span>
                    <span class="px-3 py-1 bg-green-200 text-green-900 rounded font-medium">${project.item_code}</span>
                    ${project.additional_level_name ? `
                        <span class="text-gray-500">&rarr;</span>
                        <span class="px-3 py-1 bg-yellow-200 text-yellow-900 rounded font-medium">${project.additional_level_value}</span>
                    ` : ''}
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    <strong>Project:</strong> ${project.project_name}
                </div>
            </div>
        `;
    }

    // Generate attribute selections display
    let attributeSelectionsHtml = '';
    if (request.attribute_selections) {
        let selections;
        
        // Parse JSON string if needed
        if (typeof request.attribute_selections === 'string') {
            try {
                selections = JSON.parse(request.attribute_selections);
            } catch(e) {
                console.warn('Failed to parse attribute_selections:', request.attribute_selections);
                selections = {};
            }
        } else if (typeof request.attribute_selections === 'object' && request.attribute_selections !== null) {
            selections = request.attribute_selections;
        } else {
            selections = {};
        }
        
        const entries = Object.entries(selections);
        if (entries.length > 0) {
            attributeSelectionsHtml = `
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">Selected Attribute Combination</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${entries.map(([attr, value]) => `
                            <div class="bg-gray-50 p-3 rounded border-l-4 border-blue-500">
                                <div class="font-medium text-gray-700">${attr}</div>
                                <div class="text-blue-600 font-semibold">${value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }

    const modalHtml = `
        <div id="combination-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Combination Request Details</h2>
                    <button onclick="closeCombinationDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- Basic Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Basic Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Request ID:</label>
                                <p class="font-mono text-sm">#${request.id}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Request Type:</label>
                                <p class="${typeInfo.color} font-medium">${typeInfo.label}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Status:</label>
                                <p class="${statusColors[request.status] || 'text-gray-600'} font-medium">
                                    ${statusDisplayText[request.status] || request.status}
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Created:</label>
                                <p>${new Date(request.created_at).toLocaleString()}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Created by:</label>
                                <p>${request.created_by_user?.username || 'Unknown'} (${request.created_by_user?.email || 'N/A'})</p>
                            </div>
                            ${request.reviewed_by_user ? `
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Reviewed by:</label>
                                    <p>${request.reviewed_by_user.username} (${request.reviewed_by_user.email})</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- CSI Hierarchy (if project exists) -->
                    ${csiHierarchy}

                    <!-- Request-specific Details -->
                    ${request.request_type === 'generate' ? `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Item Generation Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                ${request.uom ? `
                                    <div>
                                        <label class="text-sm font-medium text-green-700">Unit of Measure:</label>
                                        <p class="text-green-900">${request.uom}</p>
                                    </div>
                                ` : ''}
                                ${request.country_of_origin ? `
                                    <div>
                                        <label class="text-sm font-medium text-green-700">Country of Origin:</label>
                                        <p class="text-green-900">${request.country_of_origin}</p>
                                    </div>
                                ` : ''}
                                ${request.model_number ? `
                                    <div>
                                        <label class="text-sm font-medium text-green-700">Model Number:</label>
                                        <p class="text-green-900">${request.model_number}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Block Request Details</h3>
                            ${request.reason ? `
                                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <div>
                                        <label class="text-sm font-medium text-red-700">Reason for Blocking:</label>
                                        <p class="text-red-900 mt-1">${request.reason}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `}

                    <!-- Selected Attributes -->
                    ${attributeSelectionsHtml}

                    <!-- Review Comments -->
                    ${request.reviewer_comments || request.admin_comments ? `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Review Comments</h3>
                            <div class="space-y-3">
                                ${request.reviewer_comments ? `
                                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <div class="font-medium text-yellow-800">Reviewer Comments:</div>
                                        <p class="mt-1 text-yellow-700">${request.reviewer_comments}</p>
                                        ${request.reviewed_at ? `<div class="text-xs text-yellow-600 mt-2">Reviewed: ${new Date(request.reviewed_at).toLocaleString()}</div>` : ''}
                                    </div>
                                ` : ''}
                                ${request.admin_comments ? `
                                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div class="font-medium text-blue-800">Admin Comments:</div>
                                        <p class="mt-1 text-blue-700">${request.admin_comments}</p>
                                        ${request.admin_reviewed_at ? `<div class="text-xs text-blue-600 mt-2">Admin Reviewed: ${new Date(request.admin_reviewed_at).toLocaleString()}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Review Actions -->
                    ${(currentUser.role === 'reviewer' && request.status === 'pending' && (request.reviewed_by === currentUser.id || !request.reviewed_by)) ||
                      (currentUser.role === 'admin' && request.status === 'reviewer_approved') ? `
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Review Actions</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Comments:</label>
                                    <textarea id="combination-review-comments" 
                                              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                              rows="4" 
                                              placeholder="Enter your review comments..."></textarea>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="submitCombinationReview(${request.id}, 'approve')" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-medium">
                                        Approve
                                    </button>
                                    <button onclick="submitCombinationReview(${request.id}, 'reject')" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-medium">
                                        Reject
                                    </button>
                                    <button onclick="closeCombinationDetailModal()" 
                                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeCombinationDetailModal() {
    const modal = document.getElementById('combination-detail-modal');
    if (modal) {
        modal.remove();
    }
}

async function submitCombinationReview(requestId, decision) {
    try {
        const comments = document.getElementById('combination-review-comments').value.trim();
        
        if (!comments) {
            alert('Please provide review comments');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this combination request?`);
        if (!confirmed) return;
        
        // Call the appropriate review function
        if (currentUser.role === 'reviewer') {
            await reviewCombinationRequest(requestId, decision, comments);
        } else if (currentUser.role === 'admin') {
            await adminReviewCombinationRequest(requestId, decision, comments);
        }
        
        // Close modal and refresh data
        closeCombinationDetailModal();
        await switchPendingSubTab('combinations');
        
    } catch (error) {
        console.error('Error submitting combination review:', error);
        alert('Error submitting review: ' + error.message);
    }
}

async function submitProjectReview(projectId, decision) {
    try {
        const comments = document.getElementById('project-review-comments').value.trim();
        
        if (!comments) {
            alert('Please provide review comments');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this project?`);
        if (!confirmed) return;
        
        // Call the appropriate review function
        if (currentUser.role === 'reviewer') {
            await reviewProject(projectId, decision, comments);
        } else if (currentUser.role === 'admin') {
            await adminReviewProject(projectId, decision, comments);
        }
        
        // Close modal and refresh data
        closeProjectDetailModal();
        await switchPendingSubTab('classification-projects');
        
    } catch (error) {
        console.error('Error submitting project review:', error);
        alert('Error submitting review: ' + error.message);
    }
}

function createDetailedAdminReviewCard(item) {
    const card = document.createElement('div');
    card.className = `request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow ${
        item.priority === 'high' ? 'border-l-4 border-l-orange-500' : 'border-l-4 border-l-blue-500'
    }`;
    
    const typeInfo = {
        'project': { 
            icon: 'Ã°Å¸â€œÂ', 
            color: 'purple', 
            label: 'Classification Project',
            bgClass: 'bg-purple-100 text-purple-800'
        },
        'code': { 
            icon: 'Ã°Å¸â€œÂ¦', 
            color: 'green', 
            label: 'Item Code Request',
            bgClass: 'bg-green-100 text-green-800'
        },
        'value': { 
            icon: 'Ã°Å¸â€œÅ ', 
            color: 'blue', 
            label: 'Standard Value Request',
            bgClass: 'bg-blue-100 text-blue-800'
        },
        'block': { 
            icon: 'Ã°Å¸Å¡Â«', 
            color: 'red', 
            label: 'Block Combination',
            bgClass: 'bg-red-100 text-red-800'
        }
    };

    const info = typeInfo[item.type] || typeInfo['code'];
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">${info.icon}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${info.bgClass}">
                        ${info.label}
                    </span>
                    ${item.priority === 'high' ? `
                        
                    ` : ''}
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                    }">
                        ${item.status.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.title}</h3>
                ${item.type === 'project' ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                    </div>
                ` : (item.type === 'code' || item.type === 'value') && item.project ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">Associated Project CSI Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.division_code || item.project?.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.division_description || item.project?.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.section_code || item.project?.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.section_description || item.project?.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.detailed_section_code || item.project?.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.detailed_section_description || item.project?.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.item_code || item.project?.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.item_description || item.project?.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                        <div class="text-xs text-white mt-2 opacity-75">Project: ${item.project.project_name || item.project?.project_name || 'Unknown Project'}</div>
                    </div>
                ` : `
                    <p class="text-sm text-gray-600 mb-2">${item.subtitle}</p>
                `}
                
                <!-- Detailed Information Grid -->
                <div class="grid grid-cols-2 gap-4 text-xs bg-gray-50 p-3 rounded mt-3">
                    <div>
                        <span class="font-medium text-gray-600">Requester:</span>
                        <p class="text-gray-800">${item.creator_name || 'Unknown'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Reviewer:</span>
                        <p class="text-gray-800">${item.reviewer_name || 'Unassigned'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Date:</span>
                        <p class="text-gray-800">${formatDate(item.date)}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">ID:</span>
                        <p class="text-gray-800 font-mono">#${item.id}</p>
                    </div>
                </div>

                ${item.type === 'code' ? `
                    <div class="mt-3 text-xs space-y-1">
                        <div><span class="font-medium">UOM:</span> ${item.uom || 'N/A'}</div>
                        <div><span class="font-medium">Country:</span> ${item.country_of_origin || 'N/A'}</div>
                        <div><span class="font-medium">Model:</span> ${item.model_number || 'N/A'}</div>
                    </div>
                ` : ''}

                ${item.type === 'value' ? `
                    <div class="mt-3 p-2 bg-green-50 rounded text-xs">
                        <span class="font-medium text-green-800">New Value:</span> 
                        <span class="text-green-900 font-bold">${item.new_value}</span>
                        <br>
                        <span class="font-medium text-green-800">Reason:</span> 
                        <span class="text-green-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}

                ${item.type === 'block' ? `
                    <div class="mt-3 p-2 bg-red-50 rounded text-xs">
                        <span class="font-medium text-red-800">Block Reason:</span> 
                        <span class="text-red-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}

                ${(item.reviewer_comments || item.review_comments) ? `
                    <div class="mt-3 p-2 bg-blue-50 rounded text-xs">
                        <span class="font-medium text-blue-800">Reviewer Comments:</span>
                        <p class="text-blue-900 mt-1">${item.reviewer_comments || item.review_comments}</p>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <div class="flex space-x-2 mt-4">
            <button onclick="viewRequestDetails('${item.type}', ${item.id})" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                 View Full Details
            </button>
            ${item.priority === 'high' ? `
                <button onclick="reviewAdminRequest('${item.type}', ${item.id}, 'approve')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                     Approve
                </button>
                <button onclick="reviewAdminRequest('${item.type}', ${item.id}, 'reject')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                     Reject
                </button>
            ` : `
                <button onclick="assignReviewer(${item.id}, '${item.type}')" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    Assign Reviewer
                </button>
            `}
        </div>
    `;
    
    return card;
}
async function loadReviewerPendingRequests() {
    const container = document.getElementById('pending-requests-container');
    container.innerHTML = ''; // Clear existing content
    let hasContent = false;

    try {
        console.log('Loading reviewer pending requests for:', currentUser.id);

    // Section 1: Load ONLY projects pending review (status = 'submitted')
        console.log('Loading projects pending review...');
        
        // First, let's check what projects are assigned to this reviewer (any status)
        const { data: allAssignedProjects, error: allProjectsError } = await supabase
            .from('classification_projects')
            .select(`
                id,
                project_name,
                division_code,
                section_code,
                detailed_section_code,
                item_code,
                additional_level_name,
                additional_level_value,
                created_by,
                submitted_at,
                status,
                assigned_reviewer_id
            `)
            .eq('assigned_reviewer_id', currentUser.id);
            
        console.log('All projects assigned to reviewer:', allAssignedProjects);
        console.log('All projects error:', allProjectsError);
        
        // Now filter for only submitted projects
        const assignedProjects = allAssignedProjects?.filter(project => project.status === 'submitted') || [];
        const projectsError = allProjectsError;
        
        console.log('Filtered submitted projects:', assignedProjects);

        if (projectsError) {
            console.error('Error loading assigned projects:', projectsError);
        } else {
            console.log('Projects pending review (submitted only):', assignedProjects);
            // Debug: Log the first project to verify structure and status
            if (assignedProjects && assignedProjects.length > 0) {
                console.log('First project structure:', assignedProjects[0]);
                console.log('Project ID field:', assignedProjects[0].id);
                console.log('Project status:', assignedProjects[0].status);
            }
        }
        
        // Get creator information separately if needed
        if (assignedProjects && assignedProjects.length > 0) {
            for (let project of assignedProjects) {
                const { data: creator } = await supabase
                    .from('users')
                    .select('username, email')
                    .eq('id', project.created_by)
                    .single();
                project.creator = creator;
            }
        }

        // Section 2: Load ONLY item code requests with status 'pending' assigned to this reviewer
        console.log('Loading item code requests pending review...');
        const { data: itemCodeRequests, error: itemCodeError } = await supabase
            .from('item_code_workflow')
            .select(`
                id, item_code, status, created_at, uom, country_of_origin, 
                model_number, description1, description2, reviewer_comments,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name, division_code, section_code, detailed_section_code, item_code, division_description, section_description, detailed_section_description, item_description)
            `)
            .eq('reviewed_by', currentUser.id)
            .eq('status', 'pending')  // ONLY pending requests
            .order('created_at', { ascending: false });

        if (itemCodeError) {
            console.error('Error loading item code requests:', itemCodeError);
        } else {
            console.log('Item code requests pending review:', itemCodeRequests);
        }

        // Section 3: Load ONLY standard value requests with status 'pending' assigned to this reviewer
        console.log('Loading standard value requests pending review...');
        const { data: standardValueRequests, error: standardValueError } = await supabase
            .from('standard_value_requests')
            .select(`
                id, attribute_name, new_value, reason, status, created_at, reviewer_comments,
                created_by_user:created_by(username, email),
                project:project_id(project_name, division_code, section_code, detailed_section_code, item_code, division_description, section_description, detailed_section_description, item_description)
            `)
            .eq('reviewed_by', currentUser.id)
            .eq('status', 'pending')  // ONLY pending requests
            .order('created_at', { ascending: false });

        if (standardValueError) {
            console.error('Error loading standard value requests:', standardValueError);
        } else {
            console.log('Standard value requests pending review:', standardValueRequests);
        }

        // Section 4: Load ONLY combination requests with status 'pending' assigned to this reviewer
        console.log('Loading combination requests pending review...');
        const { data: combinationRequests, error: combinationError } = await supabase
            .from('combination_requests')
            .select(`
                id, request_type, reason, status, created_at, reviewer_comments,
                created_by_user:created_by(username, email),
                project:project_id(project_name)
            `)
            .eq('reviewed_by', currentUser.id)
            .eq('status', 'pending')  // ONLY pending requests
            .order('created_at', { ascending: false });

        if (combinationError) {
            console.error('Error loading combination requests:', combinationError);
        } else {
            console.log('Combination requests pending review:', combinationRequests);
        }

        // Display Projects Section (ONLY if they are truly pending reviewer action)
        if (assignedProjects && assignedProjects.length > 0) {
            hasContent = true;
            const projectsSection = document.createElement('div');
            projectsSection.className = 'mb-8';
            projectsSection.innerHTML = `
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-purple-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                         PROJECTS AWAITING YOUR REVIEW (${assignedProjects.length})
                    </h3>
                    <p class="text-sm text-purple-700">Classification projects submitted and waiting for your review decision</p>
                </div>
                <div id="assigned-projects-container" class="grid gap-4"></div>
            `;
            container.appendChild(projectsSection);

            const projectsContainer = document.getElementById('assigned-projects-container');
            assignedProjects.forEach(project => {
                projectsContainer.appendChild(createSimpleReviewerCard({
                    ...project,
                    id: project.id, // Use the actual id field
                    project_id: project.id, // Also provide project_id for compatibility
                    type: 'project',
                    title: project.project_name,
                    subtitle: `${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}`,
                    creator_name: project.creator?.username || 'Unknown',
                    date: project.submitted_at,
                    status: project.status, // Use actual status from database
                    canReview: project.status === 'submitted'  // Only show review buttons for submitted projects
                }));
            });
        }

        // Display Item Code Requests Section (ONLY pending ones)
        if (itemCodeRequests && itemCodeRequests.length > 0) {
            hasContent = true;
            const itemCodeSection = document.createElement('div');
            itemCodeSection.className = 'mb-8';
            itemCodeSection.innerHTML = `
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                         ITEM CODE REQUESTS AWAITING YOUR REVIEW (${itemCodeRequests.length})
                    </h3>
                    <p class="text-sm text-green-700">Item code requests assigned to you and waiting for your review decision</p>
                </div>
                <div id="item-code-container" class="grid gap-4"></div>
            `;
            container.appendChild(itemCodeSection);

            const itemCodeContainer = document.getElementById('item-code-container');
            itemCodeRequests.forEach(request => {
                itemCodeContainer.appendChild(createSimpleReviewerCard({
                    ...request,
                    type: 'code',
                    title: request.item_code || 'Item Code Request',
                    subtitle: request.project?.project_name || 'Unknown Project',
                    creator_name: request.created_by_user?.username,
                    date: request.created_at,
                    canReview: true  // Flag to show review buttons
                }));
            });
        }

        // Display Standard Value Requests Section (ONLY pending ones)
        if (standardValueRequests && standardValueRequests.length > 0) {
            hasContent = true;
            const standardValueSection = document.createElement('div');
            standardValueSection.className = 'mb-8';
            standardValueSection.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                         STANDARD VALUE REQUESTS AWAITING YOUR REVIEW (${standardValueRequests.length})
                    </h3>
                    <p class="text-sm text-blue-700">Standard value requests assigned to you and waiting for your review decision</p>
                </div>
                <div id="standard-value-container" class="grid gap-4"></div>
            `;
            container.appendChild(standardValueSection);

            const standardValueContainer = document.getElementById('standard-value-container');
            standardValueRequests.forEach(request => {
                standardValueContainer.appendChild(createSimpleReviewerCard({
                    ...request,
                    type: 'value',
                    title: `Add Value: ${request.new_value}`,
                    subtitle: `Attribute: ${request.attribute_name}`,
                    creator_name: request.created_by_user?.username,
                    date: request.created_at,
                    canReview: true  // Flag to show review buttons
                }));
            });
        }

        // Display Combination Requests Section (ONLY pending ones)
        if (combinationRequests && combinationRequests.length > 0) {
            hasContent = true;
            const combinationSection = document.createElement('div');
            combinationSection.className = 'mb-8';
            combinationSection.innerHTML = `
                <div class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-red-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"></path>
                        </svg>
                         COMBINATION BLOCK REQUESTS AWAITING YOUR REVIEW (${combinationRequests.length})
                    </h3>
                    <p class="text-sm text-red-700">Combination block requests assigned to you and waiting for your review decision</p>
                </div>
                <div id="combination-container" class="grid gap-4"></div>
            `;
            container.appendChild(combinationSection);

            const combinationContainer = document.getElementById('combination-container');
            combinationRequests.forEach(request => {
                combinationContainer.appendChild(createSimpleReviewerCard({
                    ...request,
                    type: 'block',
                    title: `Block Combination`,
                    subtitle: request.project?.project_name || 'Unknown Project',
                    creator_name: request.created_by_user?.username,
                    date: request.created_at,
                    canReview: true  // Flag to show review buttons
                }));
            });
        }

        if (!hasContent) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg">All caught up!</p>
                    <p class="text-sm">No items currently awaiting your review</p>
                    <p class="text-xs text-gray-400 mt-2">When new items are assigned to you, they'll appear here</p>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading reviewer pending requests:', error);
        container.innerHTML = `
            <div class="text-center text-red-500 py-8">
                <p>Error loading pending requests</p>
                <p class="text-sm mt-2">${error.message}</p>
            </div>
        `;
    }
}
function createSimpleReviewerCard(item) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow border-l-4 border-l-blue-500';
    
    const typeInfo = {
        'project': { icon: 'Ã°Å¸â€œÂ', label: 'Classification Project', bgClass: 'bg-purple-100 text-purple-800' },
        'code': { icon: 'Ã°Å¸â€œÂ¦', label: 'Item Code Request', bgClass: 'bg-green-100 text-green-800' },
        'value': { icon: 'Ã°Å¸â€œÅ ', label: 'Standard Value Request', bgClass: 'bg-blue-100 text-blue-800' },
        'block': { icon: 'Ã°Å¸Å¡Â«', label: 'Block Combination', bgClass: 'bg-red-100 text-red-800' }
    };

    const info = typeInfo[item.type] || typeInfo['code'];
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">${info.icon}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${info.bgClass}">
                        ${info.label}
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.status === 'pending' || item.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' :
                        item.status === 'reviewer_approved' ? 'bg-green-100 text-green-800' :
                        item.status === 'reviewer_rejected' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${item.status?.replace('_', ' ')?.toUpperCase() || 'PENDING'}
                    </span>
                </div>
                <h4 class="font-semibold text-gray-900">${item.title}</h4>
                ${item.type === 'project' ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                    </div>
                ` : (item.type === 'code' || item.type === 'value') && item.project ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">Associated Project CSI Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.division_code || item.project?.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.division_description || item.project?.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.section_code || item.project?.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.section_description || item.project?.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.detailed_section_code || item.project?.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.detailed_section_description || item.project?.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.item_code || item.project?.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow"></span>
                                <span class="text-xs opacity-90">${item.project.item_description || item.project?.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                        <div class="text-xs text-white mt-2 opacity-75">Project: ${item.project.project_name || item.project?.project_name || 'Unknown Project'}</div>
                    </div>
                ` : `
                    <p class="text-sm text-gray-600">${item.subtitle}</p>
                `}
                <div class="text-xs text-gray-500 mt-2">
                    <span>By: ${item.creator_name || 'Unknown'}</span> | 
                    <span>${formatDate(item.date)}</span> | 
                    <span>ID: #${item.id}</span>
                </div>
            </div>
        </div>
        
        <div class="flex space-x-2">
            <button onclick="openReviewModal('${item.type}', ${item.id})" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                 Review Details
            </button>
            ${item.status === 'pending' || item.status === 'submitted' ? `
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'approve'); return false;" 
                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                     Approve
                </button>
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'reject'); return false;" 
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                     Reject
                </button>
            ` : `
                <span class="px-3 py-2 bg-gray-100 text-gray-600 rounded text-sm">
                    ${item.status === 'reviewer_approved' ? ' Approved' : 
                      item.status === 'reviewer_rejected' ? ' Rejected' : 
                      'Reviewed'}
                </span>
            `}
        </div>
    `;
    
    return card;
}

function createDetailedReviewerCard(item) {
    const card = document.createElement('div');
    card.className = `request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow ${
        item.priority === 'assigned' ? 'border-l-4 border-l-blue-500' : 'border-l-4 border-l-gray-400'
    }`;
    
    const typeInfo = {
        'project': { 
            icon: 'Ã°Å¸â€œÂ', 
            color: 'purple', 
            label: 'Classification Project',
            bgClass: 'bg-purple-100 text-purple-800'
        },
        'code': { 
            icon: 'Ã°Å¸â€œÂ¦', 
            color: 'green', 
            label: 'Item Code Request',
            bgClass: 'bg-green-100 text-green-800'
        },
        'value': { 
            icon: 'Ã°Å¸â€œÅ ', 
            color: 'blue', 
            label: 'Standard Value Request',
            bgClass: 'bg-blue-100 text-blue-800'
        },
        'block': { 
            icon: 'Ã°Å¸Å¡Â«', 
            color: 'red', 
            label: 'Block Combination',
            bgClass: 'bg-red-100 text-red-800'
        }
    };

    const info = typeInfo[item.type] || typeInfo['code'];
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">${info.icon}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${info.bgClass}">
                        ${info.label}
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        ASSIGNED TO YOU
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.status === 'pending' || item.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' :
                        item.status === 'reviewer_approved' ? 'bg-green-100 text-green-800' :
                        item.status === 'reviewer_rejected' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${item.status?.replace('_', ' ')?.toUpperCase() || 'PENDING'}
                    </span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.title}</h3>
                <p class="text-sm text-gray-600 mb-2">${item.subtitle}</p>
                
                <!-- Detailed Information Grid -->
                <div class="grid grid-cols-2 gap-4 text-xs bg-gray-50 p-3 rounded mt-3">
                    <div>
                        <span class="font-medium text-gray-600">Requester:</span>
                        <p class="text-gray-800">${item.creator_name || 'Unknown'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Reviewer:</span>
                        <p class="text-gray-800">${item.reviewer_name || 'You'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Date:</span>
                        <p class="text-gray-800">${formatDate(item.date)}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">ID:</span>
                        <p class="text-gray-800 font-mono">#${item.id}</p>
                    </div>
                </div>

                ${item.type === 'code' ? `
                    <div class="mt-3 text-xs space-y-1">
                        <div><span class="font-medium">UOM:</span> ${item.uom || 'N/A'}</div>
                        <div><span class="font-medium">Country:</span> ${item.country_of_origin || 'N/A'}</div>
                        <div><span class="font-medium">Model:</span> ${item.model_number || 'N/A'}</div>
                    </div>
                ` : ''}

                ${item.type === 'value' ? `
                    <div class="mt-3 p-2 bg-green-50 rounded text-xs">
                        <span class="font-medium text-green-800">New Value:</span> 
                        <span class="text-green-900 font-bold">${item.new_value}</span>
                        <br>
                        <span class="font-medium text-green-800">Reason:</span> 
                        <span class="text-green-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}

                ${item.type === 'block' ? `
                    <div class="mt-3 p-2 bg-red-50 rounded text-xs">
                        <span class="font-medium text-red-800">Block Reason:</span> 
                        <span class="text-red-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <div class="flex space-x-2 mt-4">
            <button onclick="openReviewModal('${item.type}', ${item.id})" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                 Review Details
            </button>
            ${item.status === 'pending' || item.status === 'submitted' ? `
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'approve'); return false;" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                     Approve
                </button>
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'reject'); return false;" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                     Reject
                </button>
            ` : `
                <span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-md text-sm font-medium">
                    ${item.status === 'reviewer_approved' ? ' You Approved' : 
                      item.status === 'reviewer_rejected' ? ' You Rejected' : 
                      'Reviewed'}
                </span>
            `}
        </div>
    `;
    
    return card;
}
async function reviewReviewerRequest(type, requestId, decision) {
    console.log('reviewReviewerRequest called with:', { type, requestId, decision });
    
    // Validate requestId is not undefined
    if (!requestId || requestId === 'undefined') {
        console.error('Invalid requestId:', requestId);
        alert('Error: Invalid request ID. Please refresh the page and try again.');
        return;
    }
    
    // Prevent any form submission or page reload
    event?.preventDefault();
    
    const comments = prompt(`Enter your comments for ${decision === 'approve' ? 'approving' : 'rejecting'} this request:`);
    if (comments === null) {
        console.log('User cancelled the review');
        return; // User cancelled
    }
    
    try {
        console.log('Processing reviewer request:', { type, requestId, decision, comments });
        
        // Show loading state
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'loading-msg-reviewer';
        loadingMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded z-50';
        loadingMsg.textContent = 'Processing...';
        document.body.appendChild(loadingMsg);
        
        let result;
        
        if (type === 'project') {
            // Handle project review using direct database update
            const newStatus = decision === 'approve' ? 'reviewer_approved' : 'reviewer_rejected';
            
            console.log('Updating project with ID:', requestId, 'to status:', newStatus);
            
            const { error } = await supabase
                .from('classification_projects')
                .update({
                    status: newStatus,
                    reviewer_comments: comments,
                    reviewed_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .eq('id', requestId);

            if (error) {
                console.error('Database update error:', error);
                throw error;
            }
            
            console.log('Project status updated successfully');
            
            // Send email notification for project decisions - ONLY for rejections
            // (Approvals go to admin, so we don't want to notify requester twice)
            if (decision === 'reject') {
                try {
                    // Get project details with creator information
                    const { data: projectData, error: fetchError } = await supabase
                        .from('classification_projects')
                        .select(`
                            *,
                            created_by_user:users!classification_projects_created_by_fkey(username, email)
                        `)
                        .eq('id', requestId)
                        .single();
                        
                    if (!fetchError && projectData) {
                        projectData.request_type = 'Classification Project';
                        projectData.title = projectData.project_name;
                        projectData.project = { project_name: projectData.project_name };
                        
                        console.log('Sending email notification for project rejection...');
                        await sendDecisionNotification(projectData, decision, comments, currentUser);
                        console.log('Project rejection email notification sent successfully');
                    }
                } catch (emailError) {
                    console.error('Failed to send email notification for project rejection:', emailError);
                    // Don't fail the approval if email fails
                }
            } else {
                console.log('Project approved - skipping email notification (admin will handle final notification)');
                
                // NOTIFY ADMIN about new project awaiting their review
                try {
                    // Get admin users
                    const { data: adminUsers, error: adminError } = await supabase
                        .from('users')
                        .select('email, username')
                        .eq('role', 'admin')
                        .eq('status', 'active');
                    
                    if (!adminError && adminUsers && adminUsers.length > 0) {
                        // Get project details
                        const { data: projectData, error: fetchError } = await supabase
                            .from('classification_projects')
                            .select(`
                                *,
                                created_by_user:users!classification_projects_created_by_fkey(username, email)
                            `)
                            .eq('id', requestId)
                            .single();
                        
                        if (!fetchError && projectData) {
                            // Send notification to each admin
                            for (const admin of adminUsers) {
                                const adminNotificationData = {
                                    created_by_user: {
                                        email: admin.email,
                                        username: admin.username
                                    },
                                    request_type: 'Classification Project - Admin Review Required',
                                    title: projectData.project_name,
                                    project_name: projectData.project_name,
                                    project: { project_name: projectData.project_name },
                                    id: projectData.id
                                };
                                
                                const adminReviewerInfo = {
                                    username: currentUser.username,
                                    role: 'reviewer'
                                };
                                
                                console.log(`Sending admin notification to ${admin.email}...`);
                                await sendDecisionNotification(adminNotificationData, 'forwarded', 
                                    `This project has been approved by reviewer ${currentUser.username} and is now awaiting your admin review.\n\nReviewer Comments: ${comments || 'No comments provided'}`, 
                                    adminReviewerInfo);
                                console.log(`Admin notification sent to ${admin.email}`);
                            }
                        }
                    }
                } catch (emailError) {
                    console.error('Failed to send admin notification:', emailError);
                    // Don't fail the approval if admin notification fails
                }
            }
            
            result = {
                success: true,
                message: decision === 'approve' ? 
                    'Project approved and forwarded to admin for final review' : 
                    'Project rejected'
            };
        } else {
            // Handle item requests using the submitReviewerReview function
            result = await submitReviewerReview(type, requestId, decision, comments);
        }
        
        // Remove loading message
        document.getElementById('loading-msg-reviewer')?.remove();
        
        if (result && result.success) {
            // Email notifications are now handled automatically by submitReviewerReview function
            
            alert(result.message || 'Review submitted successfully');
            await loadPendingRequests();
            await loadWorkflowDashboard();
        } else {
            alert(result?.message || 'Error processing review');
        }
        
    } catch (error) {
        console.error('Error reviewing request:', error);
        
        // Remove loading message
        document.getElementById('loading-msg-reviewer')?.remove();
        
        alert(`Error processing request: ${error.message}`);
    }
}
async function claimRequest(type, requestId) {
    try {
        const confirmed = confirm('Do you want to claim this request for review?');
        if (!confirmed) return;
        
        let table;
        switch(type) {
            case "code": table = "item_code_workflow"; break;
            case 'value': table = 'standard_value_requests'; break;
            case 'block': table = 'combination_requests'; break;
            default: throw new Error('Unknown request type');
        }
        
        const { error } = await supabase
            .from(table)
            .update({ reviewed_by: currentUser.id })
            .eq('id', requestId)
            .is('reviewed_by', null);
        
        if (error) throw error;
        
        alert('Request claimed successfully!');
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error claiming request:', error);
        alert('Error claiming request: ' + error.message);
    }
}
async function loadPendingProjectReviews() {
    try {
        console.log('Loading pending project reviews for reviewer:', currentUser.id);
        
        const { data: projects, error } = await supabase
            .rpc('get_pending_reviews', { reviewer_id_param: currentUser.id });

        console.log('Pending projects response:', projects, error);

        if (error) throw error;

        const container = document.getElementById('pending-requests-container');
        
        if (projects && projects.length > 0) {
            // Add section header for projects
            const projectsSection = document.createElement('div');
            projectsSection.className = 'mb-6';
            projectsSection.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Classification Projects Pending Review (${projects.length})
                </h3>
                <div id="pending-projects-container" class="space-y-4"></div>
            `;
            container.appendChild(projectsSection);

            const projectsContainer = document.getElementById('pending-projects-container');
            projects.forEach(project => {
                projectsContainer.appendChild(createProjectReviewCard(project));
            });
        }
    } catch (error) {
        console.error('Error loading pending project reviews:', error);
    }
}

async function loadPendingItemRequests() {
    try {
        console.log('Loading pending item requests for reviewer:', currentUser.id);
        
        // Get assigned requests
        const [codeRequests, blockRequests, valueRequests] = await Promise.all([
            supabase.from("item_code_workflow").select(`
                *, 
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).eq('reviewed_by', currentUser.id).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('combination_requests').select(`
                *, 
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).eq('reviewed_by', currentUser.id).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('standard_value_requests').select(`
                *, 
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).eq('reviewed_by', currentUser.id).eq('status', 'pending').order('created_at', { ascending: false })
        ]);

        // Get unassigned requests
        const [unassignedCodes, unassignedBlocks, unassignedValues] = await Promise.all([
            supabase.from("item_code_workflow").select(`
                *, 
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).is('reviewed_by', null).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('combination_requests').select(`
                *, 
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).is('reviewed_by', null).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('standard_value_requests').select(`
                *, 
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).is('reviewed_by', null).eq('status', 'pending').order('created_at', { ascending: false })
        ]);

        const container = document.getElementById('pending-requests-container');

        // Combine assigned and unassigned requests
        const assignedRequests = [
            ...(codeRequests.data || []).map(r => ({...r, type: 'code', isAssigned: true})),
            ...(blockRequests.data || []).map(r => ({...r, type: 'block', isAssigned: true})),
            ...(valueRequests.data || []).map(r => ({...r, type: 'value', isAssigned: true}))
        ];

        const unassignedRequests = [
            ...(unassignedCodes.data || []).map(r => ({...r, type: 'code', isAssigned: false})),
            ...(unassignedBlocks.data || []).map(r => ({...r, type: 'block', isAssigned: false})),
            ...(unassignedValues.data || []).map(r => ({...r, type: 'value', isAssigned: false}))
        ];

        // Add item requests sections
        if (assignedRequests.length > 0 || unassignedRequests.length > 0) {
            const itemsSection = document.createElement('div');
            itemsSection.className = 'mt-8';
            itemsSection.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Item Requests Pending Review
                </h3>
            `;
            container.appendChild(itemsSection);

            if (assignedRequests.length > 0) {
                const assignedSection = document.createElement('div');
                assignedSection.innerHTML = `
                    <h4 class="text-md font-medium text-gray-700 mb-3">
                        Assigned to You (${assignedRequests.length})
                    </h4>
                    <div class="grid gap-4 mb-6" id="assigned-requests"></div>
                `;
                container.appendChild(assignedSection);

                const assignedContainer = document.getElementById('assigned-requests');
                assignedRequests.forEach(request => {
                    assignedContainer.appendChild(createPendingRequestCard(request));
                });
            }

            if (unassignedRequests.length > 0) {
                const unassignedSection = document.createElement('div');
                unassignedSection.innerHTML = `
                    <h4 class="text-md font-medium text-gray-700 mb-3">
                        Available to Claim (${unassignedRequests.length})
                    </h4>
                    <div class="grid gap-4" id="unassigned-requests"></div>
                `;
                container.appendChild(unassignedSection);

                const unassignedContainer = document.getElementById('unassigned-requests');
                unassignedRequests.forEach(request => {
                    unassignedContainer.appendChild(createPendingRequestCard(request));
                });
            }
        }

        // Check if there are no requests at all
        const totalRequests = assignedRequests.length + unassignedRequests.length;
        const hasProjects = document.getElementById('pending-projects-container') && 
                           document.getElementById('pending-projects-container').children.length > 0;
        
        if (totalRequests === 0 && !hasProjects) {
            if (!document.querySelector('.no-requests-message')) {
                const noRequestsDiv = document.createElement('div');
                noRequestsDiv.className = 'text-center text-gray-500 py-8 no-requests-message';
                noRequestsDiv.innerHTML = `
                    <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>No pending requests</p>
                `;
                container.appendChild(noRequestsDiv);
            }
        }
    } catch (error) {
        console.error('Error loading pending item requests:', error);
    }
}

// ===== LOAD ALL REQUESTS =====
async function loadAllRequests() {
    try {
        console.log('Loading all requests for user:', currentUser);
        
        // Load user's projects and item requests based on role
        let allRequests = [];
        
        if (currentUser.role === 'reviewer' || currentUser.role === 'admin') {
            // For reviewers and admins, load both projects they've reviewed and item requests
            allRequests = await Promise.all([
                loadUserProjects(),
                loadUserItemRequests()
            ]);
        } else {
            // For other users, load only their own requests
            allRequests = await Promise.all([
                loadUserProjects(),
                loadUserItemRequests()
            ]);
        }
        
        // Flatten the results
        const flatRequests = allRequests.flat();
        
        // Update summary stats
        updateRequestsSummary(flatRequests);
        
        // Display requests
        displayAllRequests(flatRequests);
        
    } catch (error) {
        console.error('Error loading all requests:', error);
        const container = document.getElementById('all-requests-container');
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Error loading requests</div>';
    }
}

async function loadUserProjects() {
    try {
        let query;
        
        if (currentUser.role === 'reviewer') {
            // Load projects assigned to this reviewer
            query = supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                    admin:users!classification_projects_admin_id_fkey(username, email)
                `)
                .eq('assigned_reviewer_id', currentUser.id);
        } else if (currentUser.role === 'admin') {
            // Load all projects for admin
            query = supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                    admin:users!classification_projects_admin_id_fkey(username, email)
                `);
        } else {
            // Load projects created by this user
            query = supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                    admin:users!classification_projects_admin_id_fkey(username, email)
                `)
                .eq('created_by', currentUser.id);
        }
        
        const { data: projects, error } = await query.order('updated_at', { ascending: false });
        
        if (error) throw error;
        
        return (projects || []).map(project => ({
            ...project,
            type: 'project',
            request_type: 'Classification Project',
            title: project.project_name,
            created_at: project.created_at,
            updated_at: project.updated_at,
            created_by_name: project.creator?.username,
            reviewed_by_name: project.reviewer?.username,
            admin_name: project.admin?.username
        }));
    } catch (error) {
        console.error('Error loading user projects:', error);
        return [];
    }
}

async function loadUserItemRequests() {
    try {
        let codeRequests = [], blockRequests = [], valueRequests = [];
        
        if (currentUser.role === 'reviewer') {
            // Load requests assigned to this reviewer
            const [codes, blocks, values] = await Promise.all([
                supabase.from('item_code_workflow').select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('reviewed_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('combination_requests').select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('reviewed_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('standard_value_requests').select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('reviewed_by', currentUser.id).order('created_at', { ascending: false })
            ]);
            
            codeRequests = codes.data || [];
            blockRequests = blocks.data || [];
            valueRequests = values.data || [];
        } else if (currentUser.role === 'admin') {
            // Load all requests for admin
            const [codes, blocks, values] = await Promise.all([
                supabase.from('item_code_workflow').select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).order('created_at', { ascending: false }),
                
                supabase.from('combination_requests').select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).order('created_at', { ascending: false }),
                
                supabase.from('standard_value_requests').select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).order('created_at', { ascending: false })
            ]);
            
            codeRequests = codes.data || [];
            blockRequests = blocks.data || [];
            valueRequests = values.data || [];
        } else {
            // Load requests created by this user
            const [codes, blocks, values] = await Promise.all([
                supabase.from('item_code_workflow').select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('created_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('combination_requests').select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('created_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('standard_value_requests').select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('created_by', currentUser.id).order('created_at', { ascending: false })
            ]);
            
            codeRequests = codes.data || [];
            blockRequests = blocks.data || [];
            valueRequests = values.data || [];
        }
        
        // Map to standard format
        const allItemRequests = [
            ...codeRequests.map(r => ({
                ...r,
                type: 'code',
                request_type: 'Item Code Request',
                title: r.item_code,
                created_by_name: r.created_by_user?.username,
                reviewed_by_name: r.reviewed_by_user?.username
            })),
            ...blockRequests.map(r => ({
                ...r,
                type: 'block',
                request_type: 'Block Combination Request',
                title: 'Block Combination',
                created_by_name: r.created_by_user?.username,
                reviewed_by_name: r.reviewed_by_user?.username
            })),
            ...valueRequests.map(r => ({
                ...r,
                type: 'value',
                request_type: 'Standard Value Request',
                title: `${r.attribute_name}: ${r.new_value}`,
                created_by_name: r.created_by_user?.username,
                reviewed_by_name: r.reviewed_by_user?.username
            }))
        ];
        
        return allItemRequests;
    } catch (error) {
        console.error('Error loading user item requests:', error);
        return [];
    }
}

function updateRequestsSummary(requests) {
    const total = requests.length;
    const pending = requests.filter(r => r.status === 'pending' || r.status === 'draft').length;
    const underReview = requests.filter(r => r.status === 'submitted' || r.status === 'reviewer_approved').length;
    const approved = requests.filter(r => r.status === 'admin_approved').length;
    const rejected = requests.filter(r => r.status === 'reviewer_rejected' || r.status === 'admin_rejected').length;
    
    document.getElementById('total-requests-count').textContent = total;
    document.getElementById('pending-requests-count').textContent = pending;
    document.getElementById('under-review-count').textContent = underReview;
    document.getElementById('approved-requests-count').textContent = approved;
    document.getElementById('rejected-requests-count').textContent = rejected;
}

function displayAllRequests(requests) {
    const container = document.getElementById('all-requests-container');
    container.innerHTML = '';
    
    if (requests.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-lg">No requests found</p>
                <p class="text-sm">Try adjusting your filters or create a new request</p>
            </div>
        `;
        return;
    }
    
    // Group requests by type
    const groupedRequests = {
        project: requests.filter(r => r.type === 'project'),
        code: requests.filter(r => r.type === 'code'),
        block: requests.filter(r => r.type === 'block'),
        value: requests.filter(r => r.type === 'value')
    };
    
    // Display each group
    Object.entries(groupedRequests).forEach(([type, typeRequests]) => {
        if (typeRequests.length > 0) {
            const sectionTitle = {
                project: 'Classification Projects',
                code: 'Item Code Requests',
                block: 'Block Combination Requests',
                value: 'Standard Value Requests'
            }[type];
            
            const section = document.createElement('div');
            section.className = 'mb-8';
            section.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <span class="mr-2">${getTypeIcon(type)}</span>
                    ${sectionTitle} (${typeRequests.length})
                </h3>
                <div class="grid gap-4" id="${type}-requests-section"></div>
            `;
            container.appendChild(section);
            
            const sectionContainer = document.getElementById(`${type}-requests-section`);
            typeRequests.forEach(request => {
                sectionContainer.appendChild(createAllRequestCard(request));
            });
        }
    });
}

function getTypeIcon(type) {
    const icons = {
        project: 'Ã°Å¸â€œÂ',
        code: 'Ã°Å¸â€œÂ¦',
        block: 'Ã°Å¸Å¡Â«',
        value: 'Ã°Å¸â€œÅ '
    };
    return icons[type] || 'Ã°Å¸â€œâ€ž';
}

function createAllRequestCard(request) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
    
    const statusClass = getStatusClass(request.status);
    const statusText = getStatusText(request.status);
    const canReview = canUserReview(request);
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">${request.request_type}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">${statusText}</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">${request.title}</h3>
                <p class="text-sm text-gray-600">${request.project?.project_name || 'No Project'}</p>
            </div>
            <div class="flex space-x-2 ml-4">
                ${canReview ? 
                    `<button onclick="openReviewModal('${request.type}', ${request.id})" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        Review
                    </button>` : ''
                }
                <button onclick="openReviewModal('${request.type}', ${request.id})" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                    View Details
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm bg-gray-50 p-3 rounded">
            <div>
                <span class="font-medium text-gray-600">Created by:</span>
                <p>${request.created_by_name || 'Unknown'}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Created:</span>
                <p>${new Date(request.created_at).toLocaleDateString()}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Last Updated:</span>
                <p>${new Date(request.updated_at || request.created_at).toLocaleDateString()}</p>
            </div>
            ${request.reviewed_by_name ? `
            <div>
                <span class="font-medium text-gray-600">Reviewed by:</span>
                <p>${request.reviewed_by_name}</p>
            </div>
            ` : ''}
            ${request.admin_name ? `
            <div>
                <span class="font-medium text-gray-600">Admin:</span>
                <p>${request.admin_name}</p>
            </div>
            ` : ''}
            <div>
                <span class="font-medium text-gray-600">Request ID:</span>
                <p class="font-mono text-xs">${request.id}</p>
            </div>
        </div>
        
        ${(request.reviewer_comments || request.admin_comments || request.review_comments) ? `
        <div class="mt-4 p-3 bg-blue-50 rounded border-l-4 border-blue-200">
            <span class="font-medium text-gray-600">Comments:</span>
            <p class="text-sm text-gray-800 mt-1">${request.reviewer_comments || request.admin_comments || request.review_comments}</p>
        </div>
        ` : ''}
    `;
    
    return card;
}

function getStatusClass(status) {
    const classes = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'draft': 'bg-gray-100 text-gray-800',
        'submitted': 'bg-blue-100 text-blue-800',
        'reviewer_approved': 'bg-green-100 text-green-800',
        'reviewer_rejected': 'bg-red-100 text-red-800',
        'admin_approved': 'bg-green-100 text-green-800',
        'admin_rejected': 'bg-red-100 text-red-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'pending': 'PENDING',
        'draft': 'DRAFT',
        'submitted': 'SUBMITTED',
        'reviewer_approved': 'REVIEWER APPROVED',
        'reviewer_rejected': 'REVIEWER REJECTED',
        'admin_approved': 'ADMIN APPROVED',
        'admin_rejected': 'ADMIN REJECTED'
    };
    return texts[status] || status.toUpperCase();
}

function canUserReview(request) {
    if (currentUser.role === 'admin') {
        return request.status === 'reviewer_approved';
    } else if (currentUser.role === 'reviewer') {
        return request.status === 'submitted' || request.status === 'pending';
    }
    return false;
}

async function applyFilters() {
    const statusFilter = document.getElementById('status-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    
    console.log('Applying filters:', { statusFilter, typeFilter, dateFilter });
    
    try {
        // Load all requests first
        const allRequests = await loadUserItemRequests();
        
        // Apply filters
        let filteredRequests = allRequests;
        
        // Filter by status
        if (statusFilter) {
            filteredRequests = filteredRequests.filter(request => request.status === statusFilter);
        }
        
        // Filter by type
        if (typeFilter) {
            if (typeFilter === 'project') {
                // Load and filter projects
                const projects = await loadUserProjects();
                const filteredProjects = statusFilter ? 
                    projects.filter(p => p.status === statusFilter) : projects;
                
                filteredRequests = [
                    ...filteredProjects.map(p => ({...p, type: 'project'})),
                    ...filteredRequests.filter(r => r.type !== 'project')
                ];
            } else {
                filteredRequests = filteredRequests.filter(request => request.type === typeFilter);
            }
        } else {
            // If no type filter, include projects
            const projects = await loadUserProjects();
            const filteredProjects = statusFilter ? 
                projects.filter(p => p.status === statusFilter) : projects;
            
            filteredRequests = [
                ...filteredProjects.map(p => ({...p, type: 'project'})),
                ...filteredRequests
            ];
        }
        
        // Filter by date
        if (dateFilter) {
            const now = new Date();
            let dateThreshold;
            
            switch(dateFilter) {
                case 'today':
                    dateThreshold = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    dateThreshold = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    dateThreshold = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    dateThreshold = null;
            }
            
            if (dateThreshold) {
                filteredRequests = filteredRequests.filter(request => {
                    const requestDate = new Date(request.created_at);
                    return requestDate >= dateThreshold;
                });
            }
        }
        
        // Update display
        updateRequestsSummary(filteredRequests);
        displayAllRequests(filteredRequests);
        
    } catch (error) {
        console.error('Error applying filters:', error);
        alert('Error applying filters');
    }
}
async function loadAdminAwaitingApproval() {
    try {
        console.log('Loading admin awaiting approval');
        const container = document.getElementById('pending-requests-container');
        container.innerHTML = '';

        // Load projects pending admin approval (status = 'reviewer_approved')
        const { data: projects, error: projectError } = await supabase
            .from('classification_projects')
            .select(`
                *,
                creator:users!classification_projects_created_by_fkey(username, email),
                reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                attribute_count:project_attributes(count)
            `)
            .eq('status', 'reviewer_approved')
            .order('reviewed_at', { ascending: true });

        if (projectError) {
            console.error('Error loading pending admin projects:', projectError);
        }

        // Load all types of requests that need admin approval
        const [codeRequests, blockRequests, valueRequests] = await Promise.all([
            // Item code requests pending admin approval
            supabase.from('item_code_workflow').select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                project:classification_projects(project_name)
            `).in('status', ['reviewer_approved', 'pending']).order('created_at', { ascending: false }),
            
            // Combination requests pending admin approval
            supabase.from('combination_requests').select(`
                *,
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                project:classification_projects(project_name)
            `).in('status', ['reviewer_approved', 'pending']).order('created_at', { ascending: false }),
            
            // Standard value requests pending admin approval
            supabase.from('standard_value_requests').select(`
                *,
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                project:classification_projects(project_name)
            `).in('status', ['reviewer_approved', 'pending']).order('created_at', { ascending: false })
        ]);

        console.log('Admin pending data:', {
            projects: projects?.length || 0,
            codeRequests: codeRequests.data?.length || 0,
            blockRequests: blockRequests.data?.length || 0,
            valueRequests: valueRequests.data?.length || 0
        });

        let hasContent = false;

        // Add projects pending admin approval
        if (projects && projects.length > 0) {
            hasContent = true;
            const projectsSection = document.createElement('div');
            projectsSection.className = 'mb-6';
            projectsSection.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Classification Projects Pending Admin Approval (${projects.length})
                </h3>
                <div id="pending-admin-projects-container" class="space-y-4"></div>
            `;
            container.appendChild(projectsSection);

            const projectsContainer = document.getElementById('pending-admin-projects-container');
            projects.forEach(project => {
                // Flatten the attribute count
                const flattenedProject = {
                    ...project,
                    project_id: project.id,
                    creator_name: project.creator?.username || 'Unknown',
                    reviewer_name: project.reviewer?.username || 'Unknown',
                    reviewer_approved_at: project.reviewed_at,
                    attribute_count: project.attribute_count?.[0]?.count || 0
                };
                projectsContainer.appendChild(createAdminProjectReviewCard(flattenedProject));
            });
        }

        // Process and display all request types
        const allRequests = [
            ...(codeRequests.data || []).map(r => ({
                ...r,
                type: 'code',
                request_type: 'Item Code Request',
                title: r.item_code || 'New Item Code',
                created_by_name: r.created_by_user?.username || 'Unknown',
                reviewed_by_name: r.reviewed_by_user?.username || 'Unknown'
            })),
            ...(blockRequests.data || []).map(r => ({
                ...r,
                type: 'block',
                request_type: 'Block Combination Request',
                title: 'Block Combination',
                created_by_name: r.created_by_user?.username || 'Unknown',
                reviewed_by_name: r.reviewed_by_user?.username || 'Unknown'
            })),
            ...(valueRequests.data || []).map(r => ({
                ...r,
                type: 'value',
                request_type: 'Standard Value Request',
                title: `${r.attribute_name}: ${r.new_value}`,
                created_by_name: r.created_by_user?.username || 'Unknown',
                reviewed_by_name: r.reviewed_by_user?.username || 'Unknown'
            }))
        ];

        if (allRequests.length > 0) {
            hasContent = true;
            
            // Group requests by status
            const pendingRequests = allRequests.filter(r => r.status === 'pending');
            const reviewerApprovedRequests = allRequests.filter(r => r.status === 'reviewer_approved');
            
            // Show reviewer approved requests first (higher priority)
            if (reviewerApprovedRequests.length > 0) {
                const reviewerApprovedSection = document.createElement('div');
                reviewerApprovedSection.className = 'mt-8';
                reviewerApprovedSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        Requests Approved by Reviewer - Awaiting Admin Decision (${reviewerApprovedRequests.length})
                    </h3>
                    <div id="reviewer-approved-requests-container" class="space-y-4"></div>
                `;
                container.appendChild(reviewerApprovedSection);

                const reviewerApprovedContainer = document.getElementById('reviewer-approved-requests-container');
                reviewerApprovedRequests.forEach(request => {
                    const cardElement = document.createElement('div');
cardElement.innerHTML = createAdminRequestReviewCard(request);
reviewerApprovedContainer.appendChild(cardElement.firstElementChild);
                });
            }
            
            // Show pending requests
            if (pendingRequests.length > 0) {
                const pendingSection = document.createElement('div');
                pendingSection.className = 'mt-8';
                pendingSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Other Pending Requests (${pendingRequests.length})
                    </h3>
                    <div id="pending-other-requests-container" class="space-y-4"></div>
                `;
                container.appendChild(pendingSection);

                const pendingContainer = document.getElementById('pending-other-requests-container');
                pendingRequests.forEach(request => {
                    const cardElement = document.createElement('div');
cardElement.innerHTML = createAdminRequestReviewCard(request);
pendingContainer.appendChild(cardElement.firstElementChild);
                });
            }
        }

        if (!hasContent) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg">No items pending admin approval</p>
                    <p class="text-sm">All submissions have been processed</p>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading admin awaiting approval:', error);
        const container = document.getElementById('pending-requests-container');
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Error loading admin requests</div>';
    }
}

// ===== CREATE ITEM CODE FROM APPROVED REQUEST =====
async function createItemCodeFromRequest(requestId) {
    try {
        console.log('Finalizing item code approval for request ID:', requestId);
        
        // Since the record is already in item_code_workflow, we just update the final approval fields
        const updateData = {
            approved_by: currentUser.id,
            approved_at: new Date().toISOString(),
            erp_integrated: false
        };
        
        console.log('Updating item code workflow with final approval data:', updateData);
        
        const { data: updatedItemCode, error: updateError } = await supabase
            .from('item_code_workflow')
            .update(updateData)
            .eq('id', requestId)
            .select()
            .single();
            
        if (updateError) {
            console.error('Error updating item code workflow:', updateError);
            throw updateError;
        }
        
        console.log('Item code workflow updated successfully:', updatedItemCode);
        return updatedItemCode;
        
    } catch (error) {
        console.error('Error in createItemCodeFromRequest:', error);
        throw error;
    }
}
// ===== REVIEW SUBMISSION FUNCTIONS =====
async function submitReviewerReview(type, id, decision, comments) {
    const newStatus = decision === 'approve' ? 'reviewer_approved' : 'reviewer_rejected';
    
    let table, updateData;
    
    switch(type) {
        case 'code':
            table = 'item_code_workflow';
            updateData = {
                status: newStatus,
                reviewer_comments: comments,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            };
            break;
        case 'block':
            table = 'combination_requests';
            updateData = {
                status: newStatus,
                reviewer_comments: comments,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            };
            break;
        case 'value':
            table = 'standard_value_requests';
            updateData = {
                status: newStatus,
                reviewer_comments: comments,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            };
            break;
    }
    
    // Update database
    const { error } = await supabase
        .from(table)
        .update(updateData)
        .eq('id', id);
    
    if (error) {
        console.error('Database update error:', error);
        throw error;
    }
    
    // Send email notification to request creator - ONLY for rejections
    // (Approvals go to admin, so we don't want to notify requester twice)
    if (decision === 'reject') {
        try {
            // Get request details with creator information
            const { data: requestData, error: fetchError } = await supabase
                .from(table)
                .select(`
                    *,
                    created_by_user:users!${table}_created_by_fkey(username, email),
                    project:classification_projects(project_name)
                `)
                .eq('id', id)
                .single();
                
            if (!fetchError && requestData) {
                // Add request type for display
                requestData.request_type = {
                    'item_code_workflow': 'Item Code Request',
                    'combination_requests': 'Block Combination Request', 
                    'standard_value_requests': 'Standard Value Request'
                }[table];
                
                requestData.title = requestData.item_code || requestData.request_type || 'Request';
                
                console.log('Sending email notification for item request rejection...');
                await sendDecisionNotification(requestData, decision, comments, currentUser);
                console.log('Item request rejection email notification sent successfully');
            }
        } catch (emailError) {
            console.error('Failed to send email notification:', emailError);
            // Don't fail the approval if email fails
        }
    } else {
        console.log('Item request approved - skipping email notification (admin will handle final notification)');
        
        // NOTIFY ADMIN about new item request awaiting their review
        try {
            // Get admin users
            const { data: adminUsers, error: adminError } = await supabase
                .from('users')
                .select('email, username')
                .eq('role', 'admin')
                .eq('status', 'active');
            
            if (!adminError && adminUsers && adminUsers.length > 0) {
                // Get request details
                const { data: requestData, error: fetchError } = await supabase
                    .from(table)
                    .select(`
                        *,
                        created_by_user:users!${table}_created_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', id)
                    .single();
                
                if (!fetchError && requestData) {
                    const requestTypeName = {
                        'item_code_workflow': 'Item Code Request',
                        'combination_requests': 'Block Combination Request', 
                        'standard_value_requests': 'Standard Value Request'
                    }[table];
                    
                    const requestTitle = requestData.item_code || requestData.new_value || requestTypeName;
                    
                    // Send notification to each admin
                    for (const admin of adminUsers) {
                        const adminNotificationData = {
                            created_by_user: {
                                email: admin.email,
                                username: admin.username
                            },
                            request_type: requestTypeName + ' - Admin Review Required',
                            title: requestTitle,
                            project_name: requestData.project?.project_name || 'N/A',
                            project: { project_name: requestData.project?.project_name || 'N/A' },
                            id: requestData.id
                        };
                        
                        const adminReviewerInfo = {
                            username: currentUser.username,
                            role: 'reviewer'
                        };
                        
                        console.log(`Sending admin notification to ${admin.email} for ${requestTypeName}...`);
                        await sendDecisionNotification(adminNotificationData, 'forwarded', 
                            `This ${requestTypeName.toLowerCase()} has been approved by reviewer ${currentUser.username} and is now awaiting your admin review.\n\nOriginal Request: ${requestTitle}\nRequester: ${requestData.created_by_user?.username}\nReviewer Comments: ${comments || 'No comments provided'}`, 
                            adminReviewerInfo);
                        console.log(`Admin notification sent to ${admin.email}`);
                    }
                }
            }
        } catch (emailError) {
            console.error('Failed to send admin notification:', emailError);
            // Don't fail the approval if admin notification fails
        }
    }
    
    return {
        success: true,
        message: decision === 'approve' ? 
            'Request approved and forwarded to admin for final review' : 
            'Request rejected'
    };
}
async function submitAdminReview(type, id, decision, comments) {
    try {
        console.log('submitAdminReview called with:', { type, id, decision, comments });
        
        if (type === 'project') {
            // Handle project review using the correct RPC function
            const { data, error } = await supabase.rpc('admin_review_decision', {
                project_id_param: id,
                admin_id_param: currentUser.id,
                decision_param: decision,
                comments_param: comments
            });
            
            if (error) {
                console.error('RPC error:', error);
                throw error;
            }
            
            // Send email notification for project decisions
            try {
                const { data: projectData, error: fetchError } = await supabase
                    .from('classification_projects')
                    .select(`
                        *,
                        created_by_user:users!classification_projects_created_by_fkey(username, email)
                    `)
                    .eq('id', id)
                    .single();
                    
                if (!fetchError && projectData) {
                    projectData.request_type = 'Classification Project';
                    projectData.title = projectData.project_name;
                    projectData.project = { project_name: projectData.project_name };
                    
                    await sendDecisionNotification(projectData, decision, comments, currentUser);
                }
            } catch (emailError) {
                console.error('Failed to send email notification for project:', emailError);
            }
            
            console.log('Admin review decision response:', data);
            return data;
        }
        
        // Handle item requests - normalize decision values
        const normalizedDecision = decision === 'approved' ? 'approve' : decision === 'rejected' ? 'reject' : decision;
        const newStatus = normalizedDecision === 'approve' ? 'admin_approved' : 'admin_rejected';
        
        let table, updateData;
        
        switch(type) {
            case 'code':
                table = 'item_code_workflow';
                updateData = {
                    status: newStatus,
                    admin_comments: comments,
                    admin_reviewed_by: currentUser.id,
                    admin_reviewed_at: new Date().toISOString()
                };
                break;
            case 'block':
                table = 'combination_requests';
                updateData = {
                    status: newStatus,
                    admin_comments: comments,
                    admin_reviewed_by: currentUser.id,
                    admin_reviewed_at: new Date().toISOString()
                };
                break;
            case 'value':
                table = 'standard_value_requests';
                updateData = {
                    status: newStatus,
                    admin_comments: comments,
                    admin_reviewed_by: currentUser.id,
                    admin_reviewed_at: new Date().toISOString()
                };
                break;
            default:
                throw new Error('Unknown request type: ' + type);
        }
        
        console.log('Updating table:', table, 'with data:', updateData);
        
        // Get request details before updating for email notification
        const { data: requestData, error: fetchError } = await supabase
            .from(table)
            .select(`
                *,
                created_by_user:users!${table}_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('id', id)
            .single();
        
        const { error } = await supabase
            .from(table)
            .update(updateData)
            .eq('id', id);
        
        if (error) {
            console.error('Database update error:', error);
            throw error;
        }

        // ADDED: Handle item code finalization for admin-approved item_code_workflow requests
        let itemCodeData = null;
        if (table === 'item_code_workflow' && newStatus === 'admin_approved') {
            console.log('Finalizing item code for admin-approved request...');
            try {
                itemCodeData = await createItemCodeFromRequest(id);
                console.log('Item code finalized successfully for request:', id);
                
                // Send ERP integration notification to Yogesh
                if (requestData) {
                    await sendERPIntegrationNotification(requestData, itemCodeData);
                }
            } catch (createError) {
                console.error('Error creating item code:', createError);
                // Note: We don't throw here to avoid rolling back the approval
                // The request is still approved, but item code creation failed
            }
        }
        
        // Send email notification to request creator
        try {
            if (requestData) {
                // Add request type for display
                requestData.request_type = {
                    'item_code_workflow': 'Item Code Request',
                    'combination_requests': 'Block Combination Request', 
                    'standard_value_requests': 'Standard Value Request'
                }[table];
                
                requestData.title = requestData.item_code || requestData.request_type || 'Request';
                
                await sendDecisionNotification(requestData, normalizedDecision, comments, currentUser);
            }
        } catch (emailError) {
            console.error('Failed to send email notification:', emailError);
            // Don't fail the approval if email fails
        }
        
        return {
            success: true,
            message: normalizedDecision === 'approve' ? 
                'Request approved successfully' : 
                'Request rejected successfully'
        };
    } catch (error) {
        console.error('Error in submitAdminReview:', error);
        return {
            success: false,
            message: 'Error processing review: ' + error.message
        };
    }
}
// ===== WORKFLOW DASHBOARD =====
async function loadWorkflowDashboard() {
    try {
        console.log('Loading workflow dashboard for user:', currentUser);
        
        // Load all workflow statistics
        const [projectStats, itemCodeStats, standardValueStats, combinationStats] = await Promise.all([
            supabase.rpc('get_project_workflow_stats', { user_id_param: currentUser.id, user_role_param: currentUser.role }),
            supabase.rpc('get_item_code_workflow_stats', { user_id_param: currentUser.id, user_role_param: currentUser.role }),
            supabase.rpc('get_standard_value_workflow_stats', { user_id_param: currentUser.id, user_role_param: currentUser.role }),
            supabase.rpc('get_combination_workflow_stats', { user_id_param: currentUser.id, user_role_param: currentUser.role })
        ]);
        
        if (projectStats.error) console.error('Project stats error:', projectStats.error);
        if (itemCodeStats.error) console.error('Item code stats error:', itemCodeStats.error);
        if (standardValueStats.error) console.error('Standard value stats error:', standardValueStats.error);
        if (combinationStats.error) console.error('Combination stats error:', combinationStats.error);
        
        // Store stats globally for use by individual charts
        window.workflowStats = {
            projects: projectStats.data || {},
            itemCodes: itemCodeStats.data || {},
            standardValues: standardValueStats.data || {},
            combinations: combinationStats.data || {},
            combined: calculateCombinedStats(projectStats.data, itemCodeStats.data, standardValueStats.data, combinationStats.data)
        };
        
        // Load the default view (all types combined)
        renderWorkflowChart('all', window.workflowStats.combined);
        
        // Add event listeners for workflow tabs
        document.querySelectorAll('.workflow-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => switchWorkflowTab(btn.dataset.workflow));
        });
        
    } catch (error) {
        console.error('Error loading workflow dashboard:', error);
        // Show error message in dashboard
        document.getElementById('all-workflow-chart').innerHTML = 
            '<div class="text-center text-red-500 py-8">Error loading dashboard data. Please refresh the page.</div>';
    }
}

function calculateCombinedStats(projects, itemCodes, standardValues, combinations) {
    const combined = {
        submitted: 0,
        pending_reviewer: 0,
        reviewer_approved: 0,
        reviewer_rejected: 0,
        pending_admin: 0,
        admin_approved: 0,
        admin_rejected: 0,
        erp_integrated: 0,
        erp_pending: 0
    };
    
    // Add stats from all sources
    [projects, itemCodes, standardValues, combinations].forEach(stats => {
        if (stats) {
            combined.submitted += stats.submitted || 0;
            combined.pending_reviewer += stats.pending_reviewer || 0;
            combined.reviewer_approved += stats.reviewer_approved || 0;
            combined.reviewer_rejected += stats.reviewer_rejected || 0;
            combined.pending_admin += stats.pending_admin || 0;
            combined.admin_approved += stats.admin_approved || 0;
            combined.admin_rejected += stats.admin_rejected || 0;
            combined.erp_integrated += stats.erp_integrated || 0;
            combined.erp_pending += stats.erp_pending || 0;
        }
    });
    
    return combined;
}

function switchWorkflowTab(workflowType) {
    // Update tab buttons
    document.querySelectorAll('.workflow-tab-btn').forEach(btn => {
        btn.classList.remove('active', 'border-blue-500', 'text-blue-600', 'bg-blue-50');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    const activeBtn = document.querySelector(`[data-workflow="${workflowType}"]`);
    activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600', 'bg-blue-50');
    activeBtn.classList.remove('border-transparent', 'text-gray-500');
    
    // Hide all workflow content sections
    document.querySelectorAll('.workflow-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected workflow content
    document.getElementById(`workflow-${workflowType}`).classList.remove('hidden');
    
    // Render appropriate chart
    const statsMap = {
        'all': window.workflowStats.combined,
        'projects': window.workflowStats.projects,
        'item-codes': window.workflowStats.itemCodes,
        'standard-values': window.workflowStats.standardValues,
        'combinations': window.workflowStats.combinations
    };
    
    renderWorkflowChart(workflowType, statsMap[workflowType]);
}

function renderWorkflowChart(workflowType, stats) {
    const containerId = workflowType === 'all' ? 'all-workflow-chart' : `${workflowType.replace('-', '-')}-workflow-chart`;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('Container not found:', containerId);
        return;
    }
    
    const workflowTitle = {
        'all': 'All Request Types Combined',
        'projects': 'Classification Projects Workflow',
        'item-codes': 'Item Code Requests Workflow', 
        'standard-values': 'Standard Value Requests Workflow',
        'combinations': 'Combination Requests Workflow'
    }[workflowType];
    
    // For item codes, show ERP integration branch
    const showERPBranch = workflowType === 'item-codes' || workflowType === 'all';
    
    container.innerHTML = `
        <div class="workflow-chart">
            <div class="workflow-section-title">${workflowTitle}</div>
            
            <!-- Main Workflow Row -->
            <div class="workflow-row">
                <!-- Submitted -->
                <div class="workflow-step">
                    <div class="workflow-milestone milestone-submitted" onclick="showWorkflowDetail('${workflowType}', 'submitted', ${stats.submitted || 0})">
                        <div class="milestone-count">${stats.submitted || 0}</div>
                        <div class="milestone-label">Submitted</div>
                    </div>
                    <div class="text-xs text-gray-600 mt-2 font-medium">Initial Submission</div>
                    <div class="workflow-arrow"></div>
                </div>
                
                <!-- Reviewer Decision Point -->
                <div class="workflow-step">
                    <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                        <!-- Pending Reviewer -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-submitted" onclick="showWorkflowDetail('${workflowType}', 'pending_reviewer', ${stats.pending_reviewer || 0})">
                                <div class="milestone-count">${stats.pending_reviewer || 0}</div>
                                <div class="milestone-label">Pending</div>
                            </div>
                        </div>
                        
                        <!-- Reviewer Approved -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-reviewer-approved" onclick="showWorkflowDetail('${workflowType}', 'reviewer_approved', ${stats.reviewer_approved || 0})">
                                <div class="milestone-count">${stats.reviewer_approved || 0}</div>
                                <div class="milestone-label">Approved</div>
                            </div>
                            <div class="workflow-arrow"></div>
                        </div>
                        
                        <!-- Reviewer Rejected -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-reviewer-rejected" onclick="showWorkflowDetail('${workflowType}', 'reviewer_rejected', ${stats.reviewer_rejected || 0})">
                                <div class="milestone-count">${stats.reviewer_rejected || 0}</div>
                                <div class="milestone-label">Rejected</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 mt-2 font-medium">Reviewer Decision</div>
                </div>
                
                <!-- Admin Decision Point -->
                <div class="workflow-step">
                    <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                        <!-- Pending Admin -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-submitted" onclick="showWorkflowDetail('${workflowType}', 'pending_admin', ${stats.pending_admin || 0})">
                                <div class="milestone-count">${stats.pending_admin || 0}</div>
                                <div class="milestone-label">Pending</div>
                            </div>
                        </div>
                        
                        <!-- Admin Approved -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-admin-approved" onclick="showWorkflowDetail('${workflowType}', 'admin_approved', ${stats.admin_approved || 0})">
                                <div class="milestone-count">${stats.admin_approved || 0}</div>
                                <div class="milestone-label">Approved</div>
                            </div>
                            ${showERPBranch ? '<div class="workflow-arrow"></div>' : ''}
                        </div>
                        
                        <!-- Admin Rejected -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-admin-rejected" onclick="showWorkflowDetail('${workflowType}', 'admin_rejected', ${stats.admin_rejected || 0})">
                                <div class="milestone-count">${stats.admin_rejected || 0}</div>
                                <div class="milestone-label">Rejected</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 mt-2 font-medium">Admin Decision</div>
                </div>
                
                ${showERPBranch ? `
                <!-- ERP Integration (Item Codes Only) -->
                <div class="workflow-step">
                    <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                        <!-- ERP Integrated -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-erp-integrated" onclick="showWorkflowDetail('${workflowType}', 'erp_integrated', ${stats.erp_integrated || 0})">
                                <div class="milestone-count">${stats.erp_integrated || 0}</div>
                                <div class="milestone-label">Integrated</div>
                            </div>
                        </div>
                        
                        <!-- ERP Pending -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="workflow-milestone milestone-erp-pending" onclick="showWorkflowDetail('${workflowType}', 'erp_pending', ${stats.erp_pending || 0})">
                                <div class="milestone-count">${stats.erp_pending || 0}</div>
                                <div class="milestone-label">Pending</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 mt-2 font-medium">ERP Integration</div>
                </div>
                ` : ''}
            </div>
            
            <!-- Workflow Legend -->
            <div class="mt-8 p-4 bg-white rounded-lg border">
                <div class="text-sm font-semibold text-gray-700 mb-3">Workflow Guide</div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-gradient-to-r from-yellow-400 to-yellow-500"></div>
                        <span>Submitted - Awaiting reviewer</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-gradient-to-r from-blue-400 to-blue-500"></div>
                        <span>Reviewer Approved</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-gradient-to-r from-green-400 to-green-500"></div>
                        <span>Admin Approved</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-gradient-to-r from-red-400 to-red-500"></div>
                        <span>Rejected</span>
                    </div>
                    ${showERPBranch ? `
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-gradient-to-r from-purple-400 to-purple-500"></div>
                        <span>ERP Integrated</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400"></div>
                        <span>ERP Pending</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function showWorkflowDetail(workflowType, status, count) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'workflow-overlay';
    overlay.onclick = closeWorkflowDetail;
    
    // Create popup
    const popup = document.createElement('div');
    popup.className = 'workflow-detail-popup';
    
    const statusLabels = {
        'submitted': 'Total Submitted Requests',
        'pending_reviewer': 'Pending Reviewer Decision',
        'reviewer_approved': 'Reviewer Approved Requests', 
        'reviewer_rejected': 'Reviewer Rejected Requests',
        'pending_admin': 'Pending Admin Decision',
        'admin_approved': 'Admin Approved Requests',
        'admin_rejected': 'Admin Rejected Requests',
        'erp_integrated': 'ERP Integrated Items',
        'erp_pending': 'ERP Integration Pending'
    };
    
    popup.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">${statusLabels[status] || status}</h3>
            <button onclick="closeWorkflowDetail()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div class="mb-4">
            <div class="text-3xl font-bold text-blue-600">${count}</div>
            <div class="text-sm text-gray-600">Total requests in this status</div>
        </div>
        <div class="text-sm text-gray-700">
            <p>Click on the tabs above to view detailed request listings for this workflow stage.</p>
        </div>
    `;
    
    document.body.appendChild(overlay);
    document.body.appendChild(popup);
}

function closeWorkflowDetail() {
    const overlay = document.querySelector('.workflow-overlay');
    const popup = document.querySelector('.workflow-detail-popup');
    if (overlay) overlay.remove();
    if (popup) popup.remove();
}

// ===== LOGIN FUNCTIONS =====
async function handleLogin(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const email = formData.get('email');
    const password = formData.get('password');
    
    try {
        console.log('Attempting login for:', email);
        
        const { data, error } = await supabase
            .rpc('authenticate_user', {
                email_param: email,
                password_param: password
            });
        
        console.log('Login response:', data);
        
        if (error) throw error;
        
        if (data.success) {
            currentUser = data.user;
            console.log('Login successful:', currentUser);
            
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('main-container').classList.remove('hidden');
            document.getElementById('user-info').textContent = `${currentUser.username} (${currentUser.role})`;
            
            // Show admin tab if user is admin
            if (currentUser.role === 'admin') {
                document.getElementById('admin-tab').classList.remove('hidden');
            }
            
            await loadWorkflowDashboard();
            await loadPendingRequests();
        } else {
            document.getElementById('login-error').textContent = data.message;
            document.getElementById('login-error').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Login error:', error);
        document.getElementById('login-error').textContent = 'Login failed. Please try again.';
        document.getElementById('login-error').classList.remove('hidden');
    }
}

function handleLogout() {
    currentUser = null;
    document.getElementById('main-container').classList.add('hidden');
    document.getElementById('login-modal').classList.remove('hidden');
    document.getElementById('login-error').classList.add('hidden');
    document.getElementById('admin-tab').classList.add('hidden');
}

// ===== TAB FUNCTIONS =====
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active state from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    
    // Add active state to clicked button
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.add('border-blue-500', 'text-blue-600');
    activeBtn.classList.remove('border-transparent', 'text-gray-500');
    
    // Load appropriate content
    if (tabName === 'pending-requests') {
        loadPendingRequests();
    } else if (tabName === 'all-requests') {
        loadAllRequests();
    } else if (tabName === 'admin-panel') {
        loadAdminPanel();
    }
}

async function loadAdminPanel() {
    const container = document.getElementById('admin-panel-container');
    container.innerHTML = '<div class="text-center text-gray-500 py-8">Admin panel functionality - to be implemented</div>';
}

// ===== QUICK REVIEW FUNCTIONS FOR CARD BUTTONS =====

// Classification Projects
async function quickReviewProject(projectId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this project:`);
        
        if (comments === null) {
            // User cancelled
            return;
        }
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this project?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        // Call the core review function
        await reviewProject(projectId, decision, comments.trim());
        
        // Refresh the current view
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick review:', error);
        alert('Error processing review: ' + error.message);
    }
}

async function quickAdminReviewProject(projectId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this project (Admin Review):`);
        
        if (comments === null) {
            // User cancelled
            return;
        }
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this project as admin?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        // Call the core admin review function
        await adminReviewProject(projectId, decision, comments.trim());
        
        // Refresh the current view
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick admin review:', error);
        alert('Error processing admin review: ' + error.message);
    }
}

// Item Code Requests
async function quickReviewItemCode(requestId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this item code request:`);
        
        if (comments === null) return;
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this item code request?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        await reviewItemCodeRequest(requestId, decision, comments.trim());
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick item code review:', error);
        alert('Error processing review: ' + error.message);
    }
}

async function quickAdminReviewItemCode(requestId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this item code request (Admin Review):`);
        
        if (comments === null) return;
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this item code request as admin?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        await adminReviewItemCodeRequest(requestId, decision, comments.trim());
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick admin item code review:', error);
        alert('Error processing admin review: ' + error.message);
    }
}

// Standard Value Requests
async function quickReviewStandardValue(requestId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this standard value request:`);
        
        if (comments === null) return;
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this standard value request?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        await reviewStandardValueRequest(requestId, decision, comments.trim());
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick standard value review:', error);
        alert('Error processing review: ' + error.message);
    }
}

async function quickAdminReviewStandardValue(requestId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this standard value request (Admin Review):`);
        
        if (comments === null) return;
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this standard value request as admin?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        await adminReviewStandardValueRequest(requestId, decision, comments.trim());
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick admin standard value review:', error);
        alert('Error processing admin review: ' + error.message);
    }
}

// Combination Requests
async function quickReviewCombination(requestId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this combination request:`);
        
        if (comments === null) return;
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this combination request?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        await reviewCombinationRequest(requestId, decision, comments.trim());
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick combination review:', error);
        alert('Error processing review: ' + error.message);
    }
}

async function quickAdminReviewCombination(requestId, decision) {
    try {
        const comments = prompt(`Please provide ${decision} comments for this combination request (Admin Review):`);
        
        if (comments === null) return;
        
        if (!comments.trim()) {
            alert('Comments are required for review decisions');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to ${decision} this combination request as admin?\n\nComments: ${comments}`);
        if (!confirmed) return;
        
        await adminReviewCombinationRequest(requestId, decision, comments.trim());
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error in quick admin combination review:', error);
        alert('Error processing admin review: ' + error.message);
    }
}

// ===== CORE REVIEW FUNCTIONS FOR PROJECTS =====

async function reviewProject(projectId, decision, comments) {
    try {
        console.log('reviewProject called with:', { projectId, decision, comments });
        
        // Use the existing RPC function for reviewer decisions
        const { data, error } = await supabase.rpc('review_project_decision', {
            project_id_param: projectId,
            reviewer_id_param: currentUser.id,
            decision_param: decision === 'approve' ? 'approved' : 'rejected',
            comments_param: comments
        });
        
        if (error) {
            console.error('RPC error:', error);
            throw error;
        }
        
        if (data && !data.success) {
            throw new Error(data.message || 'Review failed');
        }
        
        // Send email notification
        try {
            const { data: projectData, error: fetchError } = await supabase
                .from('classification_projects')
                .select(`
                    *,
                    created_by_user:users!classification_projects_created_by_fkey(username, email)
                `)
                .eq('id', projectId)
                .single();
                
            if (!fetchError && projectData) {
                const requestData = {
                    ...projectData,
                    request_type: 'Classification Project',
                    title: projectData.project_name,
                    project: { project_name: projectData.project_name }
                };
                
                await sendDecisionNotification(requestData, decision, comments, currentUser);
            }
        } catch (emailError) {
            console.error('Failed to send email notification:', emailError);
        }
        
        alert(`Project ${decision}d successfully`);
        console.log('Review decision response:', data);
        
    } catch (error) {
        console.error('Error reviewing project:', error);
        throw error;
    }
}

async function adminReviewProject(projectId, decision, comments) {
    try {
        console.log('adminReviewProject called with:', { projectId, decision, comments });
        
        // Use the existing RPC function for admin decisions
        const { data, error } = await supabase.rpc('admin_review_decision', {
            project_id_param: projectId,
            admin_id_param: currentUser.id,
            decision_param: decision,
            comments_param: comments
        });
        
        if (error) {
            console.error('RPC error:', error);
            throw error;
        }
        
        if (data && !data.success) {
            throw new Error(data.message || 'Admin review failed');
        }
        
        // Send email notification
        try {
            const { data: projectData, error: fetchError } = await supabase
                .from('classification_projects')
                .select(`
                    *,
                    created_by_user:users!classification_projects_created_by_fkey(username, email)
                `)
                .eq('id', projectId)
                .single();
                
            if (!fetchError && projectData) {
                const requestData = {
                    ...projectData,
                    request_type: 'Classification Project',
                    title: projectData.project_name,
                    project: { project_name: projectData.project_name }
                };
                
                await sendDecisionNotification(requestData, decision, comments, currentUser);
            }
        } catch (emailError) {
            console.error('Failed to send email notification:', emailError);
        }
        
        alert(`Project ${decision}d by admin successfully`);
        console.log('Admin review decision response:', data);
        
    } catch (error) {
        console.error('Error admin reviewing project:', error);
        throw error;
    }
}

// ===== REVIEW FUNCTIONS FOR SPECIFIC REQUEST TYPES =====

// Item Code Request Review Functions
async function reviewItemCodeRequest(requestId, decision, comments) {
    try {
        const status = decision === 'approve' ? 'reviewer_approved' : 'reviewer_rejected';
        
        const { data, error } = await supabase
            .from('item_code_workflow')
            .update({
                status: status,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString(),
                reviewer_comments: comments
            })
            .eq('id', requestId)
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .single();

        if (error) throw error;

        // Send email notification
        const requestData = {
            ...data,
            request_type: 'Item Code Request',
            title: data.item_code
        };
        
        await sendDecisionNotification(requestData, decision, comments, currentUser);
        
        alert(`Item code request ${decision}d successfully`);
        
    } catch (error) {
        console.error('Error reviewing item code request:', error);
        throw error;
    }
}

async function adminReviewItemCodeRequest(requestId, decision, comments) {
    try {
        const status = decision === 'approve' ? 'admin_approved' : 'admin_rejected';
        
        // Build the update object
        const updateFields = {
            status: status,
            admin_reviewed_by: currentUser.id,
            admin_reviewed_at: new Date().toISOString(),
            admin_comments: comments
        };
        
        // If approving, also set the approved_by and approved_at fields
        if (decision === 'approve') {
            updateFields.approved_by = currentUser.id;
            updateFields.approved_at = new Date().toISOString();
        }
        
        const { data, error } = await supabase
            .from('item_code_workflow')
            .update(updateFields)
            .eq('id', requestId)
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .single();

        if (error) throw error;

        // Send email notification
        const requestData = {
            ...data,
            request_type: 'Item Code Request',
            title: data.item_code
        };
        
        await sendDecisionNotification(requestData, decision, comments, currentUser);
        
        alert(`Item code request ${decision}d by admin successfully`);
        
    } catch (error) {
        console.error('Error admin reviewing item code request:', error);
        throw error;
    }
}

// Standard Value Request Review Functions
async function reviewStandardValueRequest(requestId, decision, comments) {
    try {
        const status = decision === 'approve' ? 'reviewer_approved' : 'reviewer_rejected';
        
        const { data, error } = await supabase
            .from('standard_value_requests')
            .update({
                status: status,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString(),
                reviewer_comments: comments
            })
            .eq('id', requestId)
            .select(`
                *,
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .single();

        if (error) throw error;

        // Send email notification
        const requestData = {
            ...data,
            request_type: 'Standard Value Request',
            title: `${data.attribute_name}: ${data.new_value}`
        };
        
        await sendDecisionNotification(requestData, decision, comments, currentUser);
        
        alert(`Standard value request ${decision}d successfully`);
        
    } catch (error) {
        console.error('Error reviewing standard value request:', error);
        throw error;
    }
}

async function adminReviewStandardValueRequest(requestId, decision, comments) {
    try {
        const status = decision === 'approve' ? 'admin_approved' : 'admin_rejected';
        
        // Update the request status
        const { data, error } = await supabase
            .from('standard_value_requests')
            .update({
                status: status,
                admin_reviewed_by: currentUser.id,
                admin_reviewed_at: new Date().toISOString(),
                admin_comments: comments
            })
            .eq('id', requestId)
            .select(`
                *,
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                project:classification_projects(project_name),
                attribute:project_attributes(*)
            `)
            .single();

        if (error) throw error;

        // If approved, add the new value to the project attribute
        if (decision === 'approve' && data.attribute) {
            const currentValues = Array.isArray(data.attribute.standard_values) 
                ? data.attribute.standard_values 
                : [];
            
            // Add the new value if it doesn't already exist
            const newValue = data.new_value;
            const valueExists = currentValues.some(val => 
                (typeof val === 'string' && val === newValue) ||
                (typeof val === 'object' && val.name === newValue)
            );
            
            if (!valueExists) {
                const updatedValues = [...currentValues, { name: newValue }];
                
                const { error: updateError } = await supabase
                    .from('project_attributes')
                    .update({ standard_values: updatedValues })
                    .eq('id', data.attribute_id);

                if (updateError) {
                    console.error('Error updating attribute standard values:', updateError);
                }
            }
        }

        // Send email notification
        const requestData = {
            ...data,
            request_type: 'Standard Value Request',
            title: `${data.attribute_name}: ${data.new_value}`
        };
        
        await sendDecisionNotification(requestData, decision, comments, currentUser);
        
        alert(`Standard value request ${decision}d by admin successfully`);
        
    } catch (error) {
        console.error('Error admin reviewing standard value request:', error);
        throw error;
    }
}

// Combination Request Review Functions
async function reviewCombinationRequest(requestId, decision, comments) {
    try {
        const status = decision === 'approve' ? 'reviewer_approved' : 'reviewer_rejected';
        
        const { data, error } = await supabase
            .from('combination_requests')
            .update({
                status: status,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString(),
                reviewer_comments: comments
            })
            .eq('id', requestId)
            .select(`
                *,
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .single();

        if (error) throw error;

        // Send email notification
        const requestTypeLabel = data.request_type === 'block' ? 'Block Combination' : 'Generate Combination';
        const requestData = {
            ...data,
            request_type: requestTypeLabel,
            title: requestTypeLabel
        };
        
        await sendDecisionNotification(requestData, decision, comments, currentUser);
        
        alert(`Combination request ${decision}d successfully`);
        
    } catch (error) {
        console.error('Error reviewing combination request:', error);
        throw error;
    }
}

async function adminReviewCombinationRequest(requestId, decision, comments) {
    try {
        const status = decision === 'approve' ? 'admin_approved' : 'admin_rejected';
        
        const { data, error } = await supabase
            .from('combination_requests')
            .update({
                status: status,
                admin_reviewed_by: currentUser.id,
                admin_reviewed_at: new Date().toISOString(),
                admin_comments: comments
            })
            .eq('id', requestId)
            .select(`
                *,
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .single();

        if (error) throw error;

        // If this is a generate request that's been approved, trigger item code generation
        if (decision === 'approve' && data.request_type === 'generate') {
            // Here you could call an item code generation function if needed
            console.log('Generate combination request approved - item code generation may be triggered');
        }

        // If this is a block request that's been approved, add to blocked combinations
        if (decision === 'approve' && data.request_type === 'block') {
            console.log('Block combination request approved - combination will be blocked');
        }

        // Send email notification
        const requestTypeLabel = data.request_type === 'block' ? 'Block Combination' : 'Generate Combination';
        const requestData = {
            ...data,
            request_type: requestTypeLabel,
            title: requestTypeLabel
        };
        
        await sendDecisionNotification(requestData, decision, comments, currentUser);
        
        alert(`Combination request ${decision}d by admin successfully`);
        
    } catch (error) {
        console.error('Error admin reviewing combination request:', error);
        throw error;
    }
}

// ===== INITIALIZATION =====
async function initializeApp() {
    console.log('Initializing app...');
    
    // Supabase client is now initialized globally - no need to recreate here
    
    // Add event listeners
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });
    
    console.log('App initialized successfully');
}

// NEW: Enhanced deprecation checking functions for approval portal
async function checkDeprecatedValuesInRequest(requestData, attributeData) {
    try {
        if (!requestData.attribute_selections || !attributeData) {
            return { hasDeprecated: false, deprecatedValues: [] };
        }

        const selections = requestData.attribute_selections || {};
        const deprecatedValues = [];

        // Use enhanced duplicate check to identify deprecated values
        const { data: duplicateCheck, error } = await supabase
            .rpc('enhanced_duplicate_check', {
                project_id_param: requestData.project_id,
                attribute_selections_param: selections,
                uom_param: requestData.uom || '',
                country_of_origin_param: requestData.country_of_origin || '',
                model_number_param: requestData.model_number || '',
                manufacturer_param: requestData.manufacturer || ''
            });

        if (error) {
            console.warn('Error checking deprecated values:', error);
            return { hasDeprecated: false, deprecatedValues: [] };
        }

        if (duplicateCheck && duplicateCheck.deprecated_values_in_request && duplicateCheck.deprecated_values_in_request.length > 0) {
            duplicateCheck.deprecated_values_in_request.forEach(depValue => {
                const attribute = attributeData.find(attr => attr.id === depValue.attribute_id);
                if (attribute) {
                    deprecatedValues.push({
                        attributeId: depValue.attribute_id,
                        attributeName: attribute.attribute_name,
                        valueName: depValue.value_name,
                        deprecatedAt: depValue.deprecated_at,
                        deprecatedReason: depValue.deprecated_reason
                    });
                }
            });
        }

        return {
            hasDeprecated: deprecatedValues.length > 0,
            deprecatedValues: deprecatedValues,
            duplicateCheckResult: duplicateCheck
        };

    } catch (error) {
        console.error('Error in checkDeprecatedValuesInRequest:', error);
        return { hasDeprecated: false, deprecatedValues: [], error: error.message };
    }
}

// Enhanced approval function with deprecation warnings
async function enhancedApprovalProcess(type, requestId, decision, comments) {
    try {
        // First, check for deprecated values if this is an approval
        if (decision === 'approve') {
            let requestData = null;
            let attributeData = null;

            // Load request data based on type
            if (type === 'code') {
                const { data: codeRequest, error: codeError } = await supabase
                    .from('item_code_workflow')
                    .select(`
                        *,
                        classification_projects (
                            id, project_name
                        )
                    `)
                    .eq('id', requestId)
                    .single();

                if (codeError) throw codeError;
                requestData = codeRequest;

                // Get attribute data for the project
                if (requestData.project_id) {
                    const { data: attrs, error: attrError } = await supabase
                        .from('project_attributes')
                        .select(`
                            *,
                            standard_values (id, name, value, attribute_id)
                        `)
                        .eq('project_id', requestData.project_id);

                    if (!attrError) {
                        attributeData = attrs;
                    }
                }
            }

            // Check for deprecated values
            if (requestData && attributeData) {
                const deprecationCheck = await checkDeprecatedValuesInRequest(requestData, attributeData);
                
                if (deprecationCheck.hasDeprecated) {
                    const deprecatedList = deprecationCheck.deprecatedValues
                        .map(dv => `â€¢ ${dv.attributeName}: ${dv.valueName}`)
                        .join('\n');
                    
                    const confirmMessage = `âš ï¸ DEPRECATION WARNING
                    
This request contains ${deprecationCheck.deprecatedValues.length} deprecated standard value${deprecationCheck.deprecatedValues.length > 1 ? 's' : ''}:

${deprecatedList}

Deprecated values are preserved for system compatibility but hidden from new item creation.

Effects of approval:
âœ“ Request will be approved normally
âœ“ Deprecated values preserved in approved item
âœ“ System integrity maintained
âœ“ Duplicate detection continues working

Continue with approval?`;

                    if (!confirm(confirmMessage)) {
                        return; // User cancelled approval
                    }
                }
            }
        }

        // Proceed with normal approval process
        await processApprovalDecision(type, requestId, decision, comments);

    } catch (error) {
        console.error('Enhanced approval process error:', error);
        alert('Error in approval process: ' + error.message);
    }
}

// Wrapper to maintain compatibility while adding deprecation checks
async function processApprovalDecision(type, requestId, decision, comments) {
    // This calls the original approval logic
    if (type === 'code') {
        await reviewItemCodeRequest(requestId, decision, comments);
    } else if (type === 'value') {
        await reviewStandardValueRequest(requestId, decision, comments);
    } else if (type === 'block') {
        await reviewBlockCombinationRequest(requestId, decision, comments);
    }
}

// Show deprecation analysis modal for detailed review
async function showDeprecationAnalysisModal(requestData, deprecationCheck) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.id = 'deprecation-analysis-modal';
    
    const deprecatedList = deprecationCheck.deprecatedValues
        .map(dv => `
            <div class="p-3 bg-orange-50 border border-orange-200 rounded mb-2">
                <div class="font-medium text-orange-800">${dv.attributeName}</div>
                <div class="text-sm text-orange-700">Value: <strong>${dv.valueName}</strong></div>
                ${dv.deprecatedAt ? `<div class="text-xs text-orange-600">Deprecated: ${new Date(dv.deprecatedAt).toLocaleDateString()}</div>` : ''}
                ${dv.deprecatedReason ? `<div class="text-xs text-orange-600">Reason: ${dv.deprecatedReason}</div>` : ''}
            </div>
        `).join('');
    
    modal.innerHTML = `
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">âš ï¸ Deprecation Analysis</h3>
                    <button onclick="closeDeprecationAnalysisModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <div class="font-medium text-gray-900 mb-2">Request contains deprecated values:</div>
                        ${deprecatedList}
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                        <h4 class="font-medium text-blue-800 mb-2">Impact Analysis</h4>
                        <div class="text-sm text-blue-700 space-y-1">
                            <div>âœ“ System integrity maintained</div>
                            <div>âœ“ Duplicate detection preserved</div>
                            <div>âœ“ Existing items unaffected</div>
                            <div>âœ“ Search functionality maintained</div>
                            <div>âš ï¸ Values hidden from new item creation</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeDeprecationAnalysisModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeDeprecationAnalysisModal() {
    const modal = document.getElementById('deprecation-analysis-modal');
    if (modal) {
        modal.remove();
    }
}

// Make functions globally available
window.checkDeprecatedValuesInRequest = checkDeprecatedValuesInRequest;
window.enhancedApprovalProcess = enhancedApprovalProcess;
window.showDeprecationAnalysisModal = showDeprecationAnalysisModal;
window.closeDeprecationAnalysisModal = closeDeprecationAnalysisModal;

// Start the app when page loads
document.addEventListener('DOMContentLoaded', initializeApp);

</script>

</body>
</html>
