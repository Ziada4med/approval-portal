<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI Code Approval Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .container {
            max-width: 1400px;
            margin: auto;
        }
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-approved { @apply bg-green-100 text-green-800; }
        .status-rejected { @apply bg-red-100 text-red-800; }
        .status-reviewer_approved { @apply bg-blue-100 text-blue-800; }
        .status-admin_approved { @apply bg-green-100 text-green-800; }
        .status-reviewer_rejected { @apply bg-red-100 text-red-800; }
        .status-admin_rejected { @apply bg-red-100 text-red-800; }
        .request-card {
            transition: all 0.2s ease;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .csi-path-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        .csi-path-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px 0;
            color: white;
            transition: all 0.3s ease;
        }
        .csi-path-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        .csi-path-arrow {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 0 8px;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Approval Portal Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-red-600 text-sm hidden"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- SIMPLIFIED REVIEW MODAL -->
<div id="review-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b flex-shrink-0">
                <h2 id="review-modal-title" class="text-xl font-semibold text-gray-900">Review Project</h2>
                <button type="button" onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="sr-only">Close</span>
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto flex-1 min-h-0">
                <div id="review-modal-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="border-t p-6 flex-shrink-0">
                <div class="mb-4">
                    <label for="review-comments" class="block text-sm font-medium text-gray-700 mb-2">Comments</label>
                    <textarea id="review-comments" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Add your review comments..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeReviewModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <div id="modal-action-buttons">
                        <!-- Buttons will be dynamically added based on user role and item status -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Main Container -->
    <div id="main-container" class="container bg-white rounded-xl shadow-lg mt-8 hidden">
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b">
            <h1 class="text-3xl font-bold text-gray-800">CSI Code Approval Portal</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-sm text-gray-600"></span>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                    Logout
                </button>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="dashboard-stats" class="p-6 border-b bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">Dashboard Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                    <div class="text-2xl font-bold text-yellow-600" id="pending-count">0</div>
                    <div class="text-sm text-gray-600">Pending Review</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <div class="text-2xl font-bold text-blue-600" id="reviewer-approved-count">0</div>
                    <div class="text-sm text-gray-600">Awaiting Admin</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <div class="text-2xl font-bold text-green-600" id="approved-count">0</div>
                    <div class="text-sm text-gray-600">Approved</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                    <div class="text-2xl font-bold text-red-600" id="rejected-count">0</div>
                    <div class="text-sm text-gray-600">Rejected</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b">
            <nav class="flex space-x-8 px-6">
                <button class="tab-btn py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="pending-requests">
                    Pending Reviews
                </button>
                <button class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="all-requests">
                    All Requests
                </button>
                <button id="reviewer-history-btn" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hidden" data-tab="reviewer-history">
                    My Reviews
                </button>
                <button id="admin-tab" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hidden" data-tab="admin-panel">
                    Admin Panel
                </button>
            </nav>
        </div>
     
        <!-- Pending Requests Tab -->
        <div id="pending-requests-tab" class="tab-content p-6">
            <!-- Search Controls -->
            <div class="bg-white border rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Search & Filter</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search by Request ID</label>
                        <input type="text" id="pending-request-id-search" placeholder="Enter request ID..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchPendingRequests()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search by Project ID</label>
                        <input type="text" id="pending-project-search" placeholder="Enter project ID..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchPendingRequests()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search by Creator</label>
                        <input type="text" id="pending-creator-search" placeholder="Enter creator name..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchPendingRequests()">
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearPendingSearch()" 
                                class="w-full px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-sm">
                            Clear Filters
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <span id="pending-search-results" class="text-sm text-gray-600"></span>
                </div>
            </div>

            <div id="pending-requests-container" class="space-y-4">
                <!-- Pending requests will be loaded here -->
            </div>
        </div>

        <!-- All Requests Tab -->
        <div id="all-requests-tab" class="tab-content p-6 hidden">
            <!-- Filter Controls -->
            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Search & Filter All Requests</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div>
                        <label for="all-project-search" class="block text-sm font-medium text-gray-700 mb-1">Project ID</label>
                        <input type="text" id="all-project-search" placeholder="Enter project ID..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchAllRequests()">
                    </div>
                    <div>
                        <label for="all-creator-search" class="block text-sm font-medium text-gray-700 mb-1">Creator</label>
                        <input type="text" id="all-creator-search" placeholder="Enter creator name..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchAllRequests()">
                    </div>
                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" onchange="searchAllRequests()">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="submitted">Submitted</option>
                            <option value="reviewer_approved">Reviewer Approved</option>
                            <option value="reviewer_rejected">Reviewer Rejected</option>
                            <option value="admin_approved">Admin Approved</option>
                            <option value="admin_rejected">Admin Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" onchange="searchAllRequests()">
                            <option value="">All Types</option>
                            <option value="project">Classification Projects</option>
                            <option value="code">Item Code Requests</option>
                            <option value="block">Block Combination Requests</option>
                            <option value="value">Standard Value Requests</option>
                        </select>
                    </div>
                    <div>
                        <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                        <select id="date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" onchange="searchAllRequests()">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearAllRequestsSearch()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm">
                            Clear All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div id="all-requests-summary" class="mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-gray-500">
                    <div class="text-2xl font-bold text-gray-600" id="total-requests-count">0</div>
                    <div class="text-sm text-gray-600">Total Requests</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                    <div class="text-2xl font-bold text-yellow-600" id="pending-requests-count">0</div>
                    <div class="text-sm text-gray-600">Pending</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <div class="text-2xl font-bold text-blue-600" id="under-review-count">0</div>
                    <div class="text-sm text-gray-600">Under Review</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <div class="text-2xl font-bold text-green-600" id="approved-requests-count">0</div>
                    <div class="text-sm text-gray-600">Approved</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                    <div class="text-2xl font-bold text-red-600" id="rejected-requests-count">0</div>
                    <div class="text-sm text-gray-600">Rejected</div>
                </div>
            </div>

            <!-- Requests Container -->
            <div id="all-requests-container" class="space-y-4">
                <!-- All requests will be loaded here -->
            </div>
        </div>

        <!-- Reviewer History Tab -->
        <div id="reviewer-history-tab" class="tab-content p-6 hidden">
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">My Review History</h3>
                <p class="text-sm text-gray-600 mb-4">Items you have reviewed and taken action on (approved/rejected)</p>
            </div>
            
            <!-- Summary Stats for Reviewer History -->
            <div id="reviewer-history-summary" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <div class="text-2xl font-bold text-green-600" id="history-approved-count">0</div>
                    <div class="text-sm text-gray-600">Approved by Me</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                    <div class="text-2xl font-bold text-red-600" id="history-rejected-count">0</div>
                    <div class="text-sm text-gray-600">Rejected by Me</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <div class="text-2xl font-bold text-blue-600" id="history-total-count">0</div>
                    <div class="text-sm text-gray-600">Total Reviewed</div>
                </div>
            </div>

            <!-- Filter for History -->
            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                <h4 class="text-md font-semibold text-gray-800 mb-4">üîç Search & Filter Review History</h4>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div>
                        <label for="history-request-id-search" class="block text-sm font-medium text-gray-700 mb-1">Request ID</label>
                        <input type="text" id="history-request-id-search" placeholder="Enter request ID..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchReviewerHistory()">
                    </div>
                    <div>
                        <label for="history-project-search" class="block text-sm font-medium text-gray-700 mb-1">Project ID</label>
                        <input type="text" id="history-project-search" placeholder="Enter project ID..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchReviewerHistory()">
                    </div>
                    <div>
                        <label for="history-creator-search" class="block text-sm font-medium text-gray-700 mb-1">Creator</label>
                        <input type="text" id="history-creator-search" placeholder="Enter creator name..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchReviewerHistory()">
                    </div>
                    <div>
                        <label for="history-status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="history-status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="searchReviewerHistory()">
                            <option value="">All Actions</option>
                            <option value="reviewer_approved">Approved</option>
                            <option value="reviewer_rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label for="history-type-filter" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="history-type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="searchReviewerHistory()">
                            <option value="">All Types</option>
                            <option value="project">Projects</option>
                            <option value="code">Item Codes</option>
                            <option value="value">Standard Values</option>
                            <option value="block">Combinations</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearHistorySearch()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm">
                            Clear All
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Container -->
            <div id="reviewer-history-container" class="space-y-4">
                <!-- Review history will be loaded here -->
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="admin-panel-tab" class="tab-content p-6 hidden">
            <!-- Search Controls for Admin -->
            <div class="bg-white border rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Search Admin Requests</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search by Request ID</label>
                        <input type="text" id="admin-request-id-search" placeholder="Enter request ID..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchAdminRequests()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search by Creator</label>
                        <input type="text" id="admin-creator-search" placeholder="Enter creator name..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchAdminRequests()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search by Reviewer</label>
                        <input type="text" id="admin-reviewer-search" placeholder="Enter reviewer name..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchAdminRequests()">
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearAdminSearch()" 
                                class="w-full px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-sm">
                            Clear Filters
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <span id="admin-search-results" class="text-sm text-gray-600"></span>
                </div>
            </div>
            
            <div id="admin-panel-container" class="space-y-4">
                <!-- Admin panel content will be loaded here -->
            </div>
        </div>
    </div>

<script>
// ===== GLOBAL VARIABLES =====
let supabase;
let currentUser = null;
let currentReviewItem = null; // Store current item being reviewed

// ===== SUPABASE INITIALIZATION =====
const SUPABASE_URL = 'https://mvftaaxgdygeyzcvzqfr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12ZnRhYXhnZHlnZXl6Y3Z6cWZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjI3OTQsImV4cCI6MjA3NDE5ODc5NH0.nj5c_AAEg4U2qlcE1vQDMWt0nfXpmUYR1lrTR6KCIDY';

// ===== MODAL FUNCTIONS =====
// Add this function to the approval portal
async function assignReviewer(requestId, requestType) {
    try {
        // First, get list of available reviewers
        const { data: reviewers, error: reviewerError } = await supabase
            .from('users')
            .select('id, username, email')
            .eq('role', 'reviewer')
            .eq('status', 'active');
            
        if (reviewerError) throw reviewerError;
        
        if (!reviewers || reviewers.length === 0) {
            alert('No active reviewers available');
            return;
        }
        
        // Create reviewer selection modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center';
        modal.innerHTML = `
            <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold mb-4">Assign Reviewer</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Reviewer:</label>
                    <select id="reviewer-select" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">Choose reviewer...</option>
                        ${reviewers.map(r => `<option value="${r.id}">${r.username} (${r.email})</option>`).join('')}
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md">Cancel</button>
                    <button onclick="performAssignment(${requestId}, '${requestType}')" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md">Assign</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error in assignReviewer:', error);
        alert('Failed to load reviewers: ' + error.message);
    }
}

async function performAssignment(requestId, requestType) {
    const reviewerId = document.getElementById('reviewer-select').value;
    if (!reviewerId) {
        alert('Please select a reviewer');
        return;
    }
    
    try {
        let table;
        switch(requestType) {
            case 'code': table = 'item_code_requests'; break;
            case 'block': table = 'combination_requests'; break;
            case 'value': table = 'standard_value_requests'; break;
            default: throw new Error('Unknown request type');
        }
        
        const { error } = await supabase
            .from(table)
            .update({ reviewed_by: reviewerId })
            .eq('id', requestId);
            
        if (error) throw error;
        
        alert('Reviewer assigned successfully');
        document.querySelector('.fixed').remove(); // Close modal
        
        // Refresh the page data
        if (typeof loadPendingRequests === 'function') {
            loadPendingRequests();
        }
        
    } catch (error) {
        console.error('Error assigning reviewer:', error);
        alert('Failed to assign reviewer: ' + error.message);
    }
}
async function openReviewModal(type, id) {
    console.log('Opening review modal for type:', type, 'id:', id);
    
    if (type === 'project') {
        // Handle project review modal
        await openProjectReviewModal(id);
        return; // Exit early since openProjectReviewModal handles the modal
    }
    
    try {
        // For other types (code, block, value), use the item review modal
        await openItemReviewModal(type, id);
        
        // The openItemReviewModal function now handles everything including buttons
        
    } catch (error) {
        console.error('Error opening review modal:', error);
        alert('Error opening review modal: ' + error.message);
    }
}
async function loadItemRequestModal(type, id, title, content) {
    try {
        let data;
        
        switch(type) {
            case 'code':
                const { data: codeData, error: codeError } = await supabase
                    .from('item_code_requests')
                    .select(`
                        *,
                        created_by_user:users!item_code_requests_created_by_fkey(username, email),
                        reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                        project:classification_projects(project_name, division_code, section_code, detailed_section_code, item_code)
                    `)
                    .eq('id', id)
                    .single();
                
                if (codeError) throw codeError;
                data = codeData;
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Item Code Request</h3>
                            <p class="text-sm text-gray-600">${data.project?.project_name || 'Unknown Project'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Reviewed by:</strong> ${data.reviewed_by_user?.username || 'Unassigned'}</div>
                            <div><strong>UOM:</strong> ${data.uom || 'N/A'}</div>
                            <div><strong>Country:</strong> ${data.country_of_origin || 'N/A'}</div>
                            <div><strong>Model:</strong> ${data.model_number || 'N/A'}</div>
                            <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                        </div>
                        <div><strong>Item Code:</strong> ${data.item_code || 'N/A'}</div>
                        <div><strong>Description 1:</strong> ${data.description1 || 'N/A'}</div>
                        <div><strong>Description 2:</strong> ${data.description2 || 'N/A'}</div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-900 mb-3">√É¬∞√Ö¬∏√¢‚Ç¨‚Ñ¢√Ç¬∞ Financial Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><strong>Unit Price:</strong> <span class="text-green-600 font-semibold">${data.unit_price ? parseFloat(data.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'Not specified'}</span></div>
                                <div><strong>Currency:</strong> <span class="font-mono bg-yellow-100 px-2 py-1 rounded">${data.currency_code || 'Not specified'}</span></div>
                            </div>
                            <div class="mt-2"><strong>Manufacturer:</strong> <span class="text-blue-600 font-medium bg-blue-100 px-2 py-1 rounded">${data.manufacturer || 'Not specified'}</span></div>
                        </div>
                        
                        ${data.review_comments ? `<div class="bg-blue-50 p-3 rounded"><strong>Comments:</strong> ${data.review_comments}</div>` : ''}
                    </div>
                `;
                break;
                
            case 'block':
                const { data: blockData, error: blockError } = await supabase
                    .from('combination_requests')
                    .select(`
                        *,
                        created_by_user:users!combination_requests_created_by_fkey(username, email),
                        reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', id)
                    .single();
                
                if (blockError) throw blockError;
                data = blockData;
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Block Combination Request</h3>
                            <p class="text-sm text-gray-600">${data.project?.project_name || 'Unknown Project'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Reviewed by:</strong> ${data.reviewed_by_user?.username || 'Unassigned'}</div>
                            <div><strong>Request Type:</strong> ${data.request_type || 'N/A'}</div>
                            <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                        </div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                        <div><strong>Combination Signature:</strong> <code class="text-xs">${data.combination_signature || 'N/A'}</code></div>
                        ${data.reviewer_comments ? `<div class="bg-blue-50 p-3 rounded"><strong>Comments:</strong> ${data.reviewer_comments}</div>` : ''}
                    </div>
                `;
                break;
                
            case 'value':
                const { data: valueData, error: valueError } = await supabase
                    .from('standard_value_requests')
                    .select(`
                        *,
                        created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                        reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                        project:classification_projects(project_name)
                    `)
                    .eq('id', id)
                    .single();
                
                if (valueError) throw valueError;
                data = valueData;
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Add Standard Value: ${data.new_value}</h3>
                            <p class="text-sm text-gray-600">Attribute: ${data.attribute_name}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Reviewed by:</strong> ${data.reviewed_by_user?.username || 'Unassigned'}</div>
                            <div><strong>Project:</strong> ${data.project?.project_name || 'N/A'}</div>
                            <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                        </div>
                        <div><strong>New Value:</strong> <span class="font-mono bg-green-100 px-2 py-1 rounded">${data.new_value}</span></div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                        ${data.reviewer_comments ? `<div class="bg-blue-50 p-3 rounded"><strong>Comments:</strong> ${data.reviewer_comments}</div>` : ''}
                    </div>
                `;
                break;
                
            default:
                throw new Error('Unknown request type: ' + type);
        }
        
        // Store the request info for modal buttons
        window.currentReviewRequest = { type, id };
        
    } catch (error) {
        console.error('Error loading item request modal:', error);
        content.innerHTML = `<div class="text-red-500">Error loading details: ${error.message}</div>`;
    }
}
async function submitModalReview(decision) {
    try {
        if (!window.currentReviewRequest) {
            alert('No item selected for review');
            return;
        }

        // FIXED: Don't normalize the decision - keep it as passed from the button
        console.log('Original decision from button:', decision);
        
        const comments = document.getElementById('review-comments').value;
        const { type, id } = window.currentReviewRequest;
        
        console.log('Submitting modal review:', decision, 'for', type, id, 'with comments:', comments);

        let result;
        
        if (currentUser.role === 'admin') {
            result = await submitAdminReview(type, id, decision, comments);
        } else {
            result = await submitReviewerReview(type, id, decision, comments);
        }

        if (result && result.success) {
            alert(result.message || 'Review submitted successfully');
            closeReviewModal();
            loadPendingRequests();
            loadDashboardStats();
        } else {
            alert(result?.message || 'Error processing review');
        }

    } catch (error) {
        console.error('Error submitting modal review:', error);
        alert('Error submitting review: ' + error.message);
    }
}

function closeReviewModal() {
    document.getElementById('review-modal').classList.add('hidden');
    currentReviewItem = null;
    window.currentReviewRequest = null;
    document.getElementById('review-comments').value = '';
}
async function openProjectReviewModal(projectId) {
    try {
        console.log('Loading project for review:', projectId, 'User role:', currentUser.role);
        
        let projectData;
        
        if (currentUser.role === 'admin') {
            // Admin can view any project - try admin function first, then fallback
            try {
                const { data, error } = await supabase
                    .rpc('admin_get_project_for_edit', {
                        project_id_param: projectId,
                        admin_id_param: currentUser.id
                    });
                
                if (error) throw error;
                
                if (data.success) {
                    projectData = data;
                } else {
                    throw new Error(data.message || 'Admin function failed');
                }
            } catch (adminError) {
                console.log('Admin function failed, using direct query:', adminError.message);
                
                // Fallback to direct database query
                const { data: directData, error: directError } = await supabase
                    .from('classification_projects')
                    .select(`
                        *,
                        creator:users!classification_projects_created_by_fkey(username, email),
                        reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                        admin:users!classification_projects_admin_id_fkey(username, email)
                    `)
                    .eq('id', projectId)
                    .single();
                
                if (directError) throw directError;
                
                // Get project attributes separately
                const { data: attributesData, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('*')
                    .eq('project_id', projectId);
                
                if (attrError) throw attrError;
                
                projectData = {
                    success: true,
                    project: {
                        ...directData,
                        creator_name: directData.creator?.username,
                        creator_email: directData.creator?.email,
                        reviewer_name: directData.reviewer?.username,
                        admin_name: directData.admin?.username
                    },
                    attributes: attributesData || []
                };
            }
        } else if (currentUser.role === 'reviewer') {
            // Try reviewer-specific function first
            try {
                const { data, error } = await supabase
                    .rpc('get_project_for_review', { 
                        project_id_param: projectId, 
                        reviewer_id_param: currentUser.id 
                    });

                if (error) throw error;

                if (data && data.success) {
                    projectData = data;
                } else {
                    throw new Error(data?.message || 'Reviewer function failed');
                }
            } catch (reviewerError) {
                console.log('Reviewer function failed, using direct query:', reviewerError.message);
                
                // Fallback for reviewers - they can view projects assigned to them or any project
                const { data: directData, error: directError } = await supabase
                    .from('classification_projects')
                    .select(`
                        *,
                        creator:users!classification_projects_created_by_fkey(username, email),
                        reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                        admin:users!classification_projects_admin_id_fkey(username, email)
                    `)
                    .eq('id', projectId)
                    .single();
                
                if (directError) throw directError;
                
                // Get project attributes separately
                const { data: attributesData, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('*')
                    .eq('project_id', projectId);
                
                if (attrError) throw attrError;
                
                projectData = {
                    success: true,
                    project: {
                        ...directData,
                        creator_name: directData.creator?.username,
                        creator_email: directData.creator?.email,
                        reviewer_name: directData.reviewer?.username,
                        admin_name: directData.admin?.username
                    },
                    attributes: attributesData || []
                };
            }
        } else {
            throw new Error('Unauthorized user role');
        }

        const project = projectData.project;
        const attributes = projectData.attributes || [];

        const modal = document.getElementById('review-modal');
        const title = document.getElementById('review-modal-title');
        const content = document.getElementById('review-modal-content');
        
        title.textContent = `${currentUser.role === 'admin' ? 'Admin Review' : 'Review'}: ${project.project_name}`;
        
        content.innerHTML = `
            <div class="space-y-6">
                <!-- Project Information -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-blue-900">${project.project_name}</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            project.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                            project.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                            project.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${project.status?.replace('_', ' ')?.toUpperCase() || 'UNKNOWN'}
                        </span>
                    </div>
                    
                    <!-- CSI Code Hierarchy Section -->
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${project.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${project.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${project.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${project.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${project.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${project.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${project.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${project.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-blue-700 font-mono text-sm mt-3">${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}</p>
                    ${project.additional_level_value ? `<p class="text-sm text-blue-600 mt-1">Additional Level: ${project.additional_level_value}</p>` : ''}
                </div>

                <!-- Basic Project Details -->
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Created by:</span>
                        <p class="mt-1">${project.creator_name || 'Unknown'} ${project.creator_email ? `(${project.creator_email})` : ''}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Assigned Reviewer:</span>
                        <p class="mt-1">${project.reviewer_name || 'Not assigned'}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Created:</span>
                        <p class="mt-1">${formatDate(project.created_at)}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <span class="font-medium text-gray-600">Project ID:</span>
                        <p class="mt-1 font-mono">#${project.id}</p>
                    </div>
                    ${project.submitted_at ? `
                        <div class="bg-gray-50 p-3 rounded">
                            <span class="font-medium text-gray-600">Submitted:</span>
                            <p class="mt-1">${formatDate(project.submitted_at)}</p>
                        </div>
                    ` : ''}
                    ${project.reviewed_at ? `
                        <div class="bg-gray-50 p-3 rounded">
                            <span class="font-medium text-gray-600">Reviewed:</span>
                            <p class="mt-1">${formatDate(project.reviewed_at)}</p>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Project Attributes -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Attributes (${attributes.length})</h3>
                    ${attributes.length > 0 ? `
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${attributes.map(attr => `
                                <div class="border border-gray-200 p-3 rounded bg-white">
                                    <div class="font-medium text-gray-900 mb-2">${attr.attribute_name} ${attr.is_mandatory ? '(Required)' : '(Optional)'}</div>
                                    <div class="text-sm text-gray-600">
                                        Standard Values: ${attr.standard_values?.length || 0}
                                        ${attr.standard_values?.length > 0 ? `
                                            <div class="mt-2 max-h-20 overflow-y-auto">
                                                ${attr.standard_values.map(val => {
                                                    // Handle both object and string formats
                                                    const valueName = typeof val === 'object' ? val.name : val;
                                                    const valueUnit = typeof val === 'object' && val.unit ? val.unit : '';
                                                    const displayText = valueUnit ? `${valueName} (${valueUnit})` : valueName;
                                                    
                                                    return `
                                                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1" title="${displayText}">
                                                            ${displayText}
                                                        </span>
                                                    `;
                                                }).join('')}
                                            </div>
                                        ` : '<div class="text-gray-500 italic mt-1">No standard values defined</div>'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-4 text-gray-500 italic">
                            No attributes configured for this project
                        </div>
                    `}
                </div>

                ${project.reviewer_comments ? `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">Reviewer Comments</h3>
                        <p class="text-sm text-blue-800">${project.reviewer_comments}</p>
                    </div>
                ` : ''}

                ${project.admin_comments ? `
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h3 class="text-lg font-semibold text-green-900 mb-2">Admin Comments</h3>
                        <p class="text-sm text-green-800">${project.admin_comments}</p>
                    </div>
                ` : ''}
            </div>
        `;
        
        // Store current review item for modal buttons
        currentReviewItem = { type: 'project', id: projectId };
        window.currentReviewRequest = { type: 'project', id: projectId };
        
        // Set appropriate buttons based on user role and project status
        updateModalActionButtons('project', project);

        modal.classList.remove('hidden');
        
    } catch (error) {
        console.error('Error opening project review modal:', error);
        alert('Error loading project details: ' + error.message);
    }
}

async function openItemReviewModal(type, id) {
    try {
        console.log('Loading item for review:', type, id);
        
        let query, table;
        switch(type) {
            case 'code':
                table = 'item_code_requests';
                query = supabase.from(table).select(`
                    *,
                    created_by_user:users!item_code_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `);
                break;
            case 'block':
                table = 'combination_requests';
                query = supabase.from(table).select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `);
                break;
            case 'value':
                table = 'standard_value_requests';
                query = supabase.from(table).select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `);
                break;
        }
        
        const { data, error } = await query.eq('id', id).single();
        if (error) throw error;
        
        let content = '';
        let projectData = null;
        let attributeData = null;

        // Get additional project and attribute data for comprehensive display
        if (type === 'code') {
            projectData = data.project;
            
            // Get project attributes if project exists
            if (data.project_id) {
                try {
                    const { data: attrs, error: attrError } = await supabase
                        .from('project_attributes')
                        .select(`
                            *,
                            standard_values (
                                id,
                                name,
                                value,
                                attribute_id
                            )
                        `)
                        .eq('project_id', data.project_id);
                    
                    if (attrError) {
                        console.warn('Failed to fetch with standard_values join:', attrError);
                        // Fallback: fetch attributes only
                        const { data: attrsOnly, error: fallbackError } = await supabase
                            .from('project_attributes')
                            .select('*')
                            .eq('project_id', data.project_id);
                        
                        if (!fallbackError && attrsOnly) {
                            // For each attribute, fetch standard values separately
                            const attributesWithValues = await Promise.all(
                                attrsOnly.map(async (attr) => {
                                    const { data: values, error: valueError } = await supabase
                                        .from('standard_values')
                                        .select('id, name, value, attribute_id')
                                        .eq('attribute_id', attr.id);
                                    
                                    return { ...attr, standard_values: values || [] };
                                })
                            );
                            attributeData = attributesWithValues;
                        }
                    } else {
                        attributeData = attrs;
                    }
                } catch (error) {
                    console.error('Error fetching attribute data:', error);
                    attributeData = null;
                }
            }
        }

        switch(type) {
            case 'code':
                content = `
                    <div class="space-y-6">
                        <!-- Request Status & Basic Info -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-semibold text-blue-900">Request Information</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                    data.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                    data.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                                    data.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                                    data.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                    'bg-gray-100 text-gray-800'
                                }">
                                    ${data.status?.replace('_', ' ')?.toUpperCase() || 'PENDING'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="font-medium">Request ID:</span> ${data.id}</div>
                                <div><span class="font-medium">Created:</span> ${formatDate(data.created_at)}</div>
                                <div><span class="font-medium">Requester:</span> ${data.created_by_user?.username || 'Unknown'} (${data.created_by_user?.email || 'N/A'})</div>
                                <div><span class="font-medium">Reviewer:</span> ${data.reviewed_by_user?.username || 'Not assigned'}</div>
                            </div>
                        </div>

                        <!-- Project Information -->
                        ${projectData ? `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Details</h3>
                            <div class="grid grid-cols-1 gap-3 text-sm">
                                <div><span class="font-medium">Project Name:</span> ${projectData.project_name || data.project?.project_name || 'N/A'}</div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Item Code Request Details -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h3 class="text-lg font-semibold text-green-900 mb-3">Item Code Request Details</h3>
                            <div class="space-y-3 text-sm">
                                <div><span class="font-medium">Requested Item Code:</span> <span class="font-mono text-lg">${data.item_code || 'N/A'}</span></div>
                                <div><span class="font-medium">Description 1:</span> ${data.description1 || 'N/A'}</div>
                                <div><span class="font-medium">Description 2:</span> ${data.description2 || 'N/A'}</div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><span class="font-medium">UOM:</span> ${data.uom || 'N/A'}</div>
                                    <div><span class="font-medium">Country of Origin:</span> ${data.country_of_origin || 'N/A'}</div>
                                </div>
                                <div><span class="font-medium">Model Number:</span> ${data.model_number || 'N/A'}</div>
                                
                                <!-- Financial Information Section -->
                                <div class="border-t pt-3 mt-3">
                                    <h4 class="font-semibold text-green-800 mb-2">Financial Information</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><span class="font-medium">Unit Price:</span> <span class="text-green-600 font-semibold">${data.unit_price ? (parseFloat(data.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})) : 'N/A'}</span></div>
                                        <div><span class="font-medium">Currency:</span> <span class="font-mono">${data.currency_code || 'N/A'}</span></div>
                                    </div>
                                    <div class="mt-2"><span class="font-medium">Manufacturer:</span> <span class="text-blue-600 font-medium">${data.manufacturer || 'N/A'}</span></div>
                                </div>
                                
                                <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${data.combination_signature || 'N/A'}</span></div>
                            </div>
                        </div>

                        

                        <!-- Review Comments -->
                        ${data.review_comments || data.reviewer_comments ? `
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="text-lg font-semibold text-blue-900 mb-2">Previous Review Comments</h3>
                            <p class="text-sm text-blue-800">${data.review_comments || data.reviewer_comments}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                break;
            case 'block':
                content = `
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Block Combination Request</h3>
                            <p class="text-sm text-gray-600">${data.project?.project_name || 'Unknown Project'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Request Type:</strong> ${data.request_type || 'N/A'}</div>
                        </div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                    </div>
                `;
                break;
            case 'value':
                content = `
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-semibold">Add Standard Value: ${data.new_value}</h3>
                            <p class="text-sm text-gray-600">Attribute: ${data.attribute_name}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Created by:</strong> ${data.created_by_user?.username || 'N/A'}</div>
                            <div><strong>Project:</strong> ${data.project?.project_name || 'N/A'}</div>
                        </div>
                        <div><strong>Reason:</strong> ${data.reason || 'N/A'}</div>
                    </div>
                `;
                break;
        }

        document.getElementById('review-modal-title').textContent = `Review ${type.charAt(0).toUpperCase() + type.slice(1)} Request`;
        document.getElementById('review-modal-content').innerHTML = content;
        
        // Store current review item for modal buttons
        currentReviewItem = { type, id };
        window.currentReviewRequest = { type, id };
        
        // Set up action buttons - THIS WAS MISSING!
        updateModalActionButtons(type, data);
        
        document.getElementById('review-modal').classList.remove('hidden');

    } catch (error) {
        console.error('Error loading item for review:', error);
        alert('Error loading item details: ' + error.message);
    }
}
async function submitCurrentReview(decision) {
    try {
        if (!currentReviewItem && !window.currentReviewRequest) {
            alert('No item selected for review');
            return;
        }

        // Get the review item (prefer currentReviewItem, fallback to window.currentReviewRequest)
        const reviewItem = currentReviewItem || window.currentReviewRequest;
        const comments = document.getElementById('review-comments').value.trim();
        
        console.log('Submitting review:', decision, 'for', reviewItem, 'with comments:', comments);

        

        let result;
        
        if (reviewItem.type === 'project') {
            // Handle project review
            if (currentUser.role === 'admin') {
                result = await reviewAdminProject(reviewItem.id, decision);
            } else if (currentUser.role === 'reviewer') {
                result = await reviewReviewerRequest('project', reviewItem.id, decision);
            } else {
                throw new Error('Unauthorized user role for project review');
            }
        } else {
            // Handle item requests (code, value, block)
            if (currentUser.role === 'admin') {
                result = await reviewAdminRequest(reviewItem.type, reviewItem.id, decision);
            } else if (currentUser.role === 'reviewer') {
                result = await submitReviewerReview(reviewItem.type, reviewItem.id, decision, comments);
            } else {
                throw new Error('Unauthorized user role for item review');
            }
        }

        // Close modal and refresh data
        closeReviewModal();
        await loadPendingRequests();
        await loadDashboardStats();
        
        console.log('Review submitted successfully');
        
    } catch (error) {
        console.error('Error submitting review:', error);
        alert(`Error submitting review: ${error.message}`);
    }
}
function closeReviewModal() {
    const modal = document.getElementById('review-modal');
    modal.classList.add('hidden');
    
    // Clear the modal content
    document.getElementById('review-modal-content').innerHTML = '';
    document.getElementById('review-comments').value = '';
    document.getElementById('modal-action-buttons').innerHTML = '';
    
    // Clear current review item
    currentReviewItem = null;
    window.currentReviewRequest = null;
    
    console.log('Review modal closed');
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return 'Invalid Date';
    }
}
// ===== PROJECT CARD CREATION =====
function createProjectReviewCard(project) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">PROJECT REVIEW</span>
                    <span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">PENDING</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">${project.project_name}</h3>
                <p class="text-sm text-gray-600 font-mono">${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}</p>
                ${project.additional_level_value ? `<p class="text-sm text-gray-500">Additional Level: ${project.additional_level_value}</p>` : ''}
            </div>
            <div class="flex space-x-2 ml-4">
                <button onclick="openReviewModal('project', ${project.project_id})" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
                    Review Project
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded">
            <div>
                <span class="font-medium text-gray-600">Created by:</span>
                <p>${project.creator_name}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Attributes:</span>
                <p>${project.attribute_count || 0} configured</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Submitted:</span>
                <p>${new Date(project.submitted_at).toLocaleDateString()}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Project ID:</span>
                <p class="font-mono text-xs">${project.project_id}</p>
            </div>
        </div>
    `;
    
    return card;
}
function createAdminProjectReviewCard(project) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow';
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <h4 class="text-lg font-medium text-gray-900">${project.project_name}</h4>
                <p class="text-sm text-gray-600 mt-1">
                    ${project.division_code} √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ ${project.section_code} √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ ${project.detailed_section_code} √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ ${project.item_code}
                </p>
                ${project.additional_level_value ? `<p class="text-sm text-purple-600 mt-1">Additional Level: ${project.additional_level_value}</p>` : ''}
            </div>
            <span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                Pending Admin Review
            </span>
        </div>
        
        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
            <div><span class="font-medium">Creator:</span> ${project.creator_name}</div>
            <div><span class="font-medium">Reviewer:</span> ${project.reviewer_name}</div>
            <div><span class="font-medium">Submitted:</span> ${formatDate(project.submitted_at)}</div>
            <div><span class="font-medium">Reviewed:</span> ${formatDate(project.reviewer_approved_at)}</div>
            <div class="col-span-2"><span class="font-medium">Attributes:</span> ${project.attribute_count || 0}</div>
        </div>
        
        ${project.reviewer_comments ? `
            <div class="mb-4 p-3 bg-gray-50 rounded-md">
                <p class="text-sm font-medium text-gray-700">Reviewer Comments:</p>
                <p class="text-sm text-gray-600 mt-1">${project.reviewer_comments}</p>
            </div>
        ` : ''}
        
        <div class="flex justify-end space-x-3">
            <button onclick="reviewAdminProject(${project.project_id}, 'reject')" 
                    class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition-colors">
                Reject
            </button>
            <button onclick="reviewAdminProject(${project.project_id}, 'approve')" 
                    class="px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors">
                Approve
            </button>
        </div>
    `;
    
    return card;
}

function createAdminRequestReviewCard(request) {
    const statusClass = `status-${request.status}`;
    const requestTypeDisplay = {
        'code': 'Item Code Request',
        'value': 'Standard Value Request', 
        'block': 'Block Combination Request'
    };

    return `
        <div class="request-card bg-white rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">${requestTypeDisplay[request.type] || 'Unknown Request'}</h3>
                    <p class="text-sm text-gray-600">Request ID: ${request.id}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                    ${request.status.replace('_', ' ').toUpperCase()}
                </span>
            </div>
            
            <div class="space-y-3 mb-4">
                ${request.type === 'code' ? `
                    <div><span class="font-medium">Item Code:</span> ${request.item_code || 'N/A'}</div>
                    <div><span class="font-medium">Project:</span> ${request.project_name || 'N/A'}</div>
                    <div><span class="font-medium">UOM:</span> ${request.uom || 'N/A'}</div>
                    <div><span class="font-medium">Country:</span> ${request.country_of_origin || 'N/A'}</div>
                    <div><span class="font-medium">Model:</span> ${request.model_number || 'N/A'}</div>
                    <div><span class="font-medium">Price:</span> <span class="text-green-600 font-semibold">${request.unit_price ? (parseFloat(request.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ' + (request.currency_code || '')) : 'N/A'}</span></div>
                    <div><span class="font-medium">Manufacturer:</span> <span class="text-blue-600">${request.manufacturer || 'N/A'}</span></div>
                ` : request.type === 'value' ? `
                    <div><span class="font-medium">Attribute:</span> ${request.attribute_name || 'N/A'}</div>
                    <div><span class="font-medium">New Value:</span> ${request.new_value || 'N/A'}</div>
                    <div><span class="font-medium">Reason:</span> ${request.reason || 'N/A'}</div>
                ` : request.type === 'block' ? `
                    <div><span class="font-medium">Block Reason:</span> ${request.reason || 'N/A'}</div>
                    <div><span class="font-medium">Project:</span> ${request.project_name || 'N/A'}</div>
                ` : ''}
                <div><span class="font-medium">Requested:</span> ${formatDate(request.created_at)}</div>
                <div><span class="font-medium">Requester:</span> ${request.created_by_name || 'Unknown'}</div>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="viewRequestDetails('${request.type}', ${request.id})" 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                    View Full Details
                </button>
                <button onclick="reviewAdminRequest('${request.type}', ${request.id}, 'reject')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                    Reject
                </button>
                <button onclick="reviewAdminRequest('${request.type}', ${request.id}, 'approve')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                    Approve
                </button>
            </div>
        </div>
    `;
}
async function reviewAdminProject(projectId, decision) {
    const comments = prompt(`Enter your comments for ${decision === 'approve' ? 'approving' : 'rejecting'} this project:`);
    if (comments === null) return; // User cancelled
    
    try {
        const { data, error } = await supabase
            .rpc('admin_review_decision', {
                project_id_param: projectId,
                admin_id_param: currentUser.id,
                decision_param: decision,
                comments_param: comments
            });

        if (error) throw error;

        if (data.success) {
            alert(`Project ${decision === 'approve' ? 'approved' : 'rejected'} successfully`);
            loadPendingRequests(); // Reload the pending requests
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error reviewing project:', error);
        alert('Failed to submit review');
    }
}
async function viewRequestDetails(type, requestId) {
    try {
        console.log('Loading request details for:', type, requestId);
        
        if (type === 'project') {
            // Handle project details differently
            await openProjectReviewModal(requestId);
            return;
        }
        
        let requestData = null;
        let projectData = null;
        let attributeData = null;

        // Get request details based on type
        if (type === 'code') {
            const { data, error } = await supabase
                .from('item_code_requests')
                .select(`
                    *,
                    created_by_user:users!item_code_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                    classification_projects (
                        id, project_name, division_code, section_code, 
                        detailed_section_code, item_code, additional_level_name, 
                        additional_level_value, status
                    )
                `)
                .eq('id', requestId)
                .single();
            
            if (error) throw error;
            requestData = data;
            projectData = data.classification_projects;

            // DEBUG: Log the actual data we're getting
            console.log('Full requestData:', requestData);
            console.log('Unit Price:', requestData.unit_price);
            console.log('Currency:', requestData.currency_code);
            console.log('Manufacturer:', requestData.manufacturer);
            console.log('Project Data:', projectData);
            console.log('Attribute Selections:', requestData.attribute_selections);

            // Get project attributes for item code requests
            if (projectData) {
                try {
                    // Try first with standard_values join
                    const { data: attrs, error: attrError } = await supabase
                        .from('project_attributes')
                        .select(`
                            *,
                            standard_values (
                                id,
                                name,
                                value,
                                attribute_id
                            )
                        `)
                        .eq('project_id', projectData.id);
                    
                    if (attrError) {
                        console.warn('Failed to fetch with standard_values join:', attrError);
                        // Fallback: fetch attributes only
                        const { data: attrsOnly, error: fallbackError } = await supabase
                            .from('project_attributes')
                            .select('*')
                            .eq('project_id', projectData.id);
                        
                        if (fallbackError) throw fallbackError;
                        
                        // For each attribute, fetch standard values separately
                        const attributesWithValues = await Promise.all(
                            attrsOnly.map(async (attr) => {
                                const { data: values, error: valueError } = await supabase
                                    .from('standard_values')
                                    .select('id, name, value, attribute_id')
                                    .eq('attribute_id', attr.id);
                                
                                if (valueError) {
                                    console.warn(`Failed to fetch values for attribute ${attr.id}:`, valueError);
                                    return { ...attr, standard_values: [] };
                                }
                                
                                return { ...attr, standard_values: values || [] };
                            })
                        );
                        
                        attributeData = attributesWithValues;
                    } else {
                        attributeData = attrs;
                    }
                    
                    console.log('Final attributeData for code request:', attributeData);
                } catch (error) {
                    console.error('Error fetching attribute data:', error);
                    attributeData = null;
                }
            }

        } else if (type === 'value') {
            const { data, error } = await supabase
                .from('standard_value_requests')
                .select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    classification_projects (
                        id, project_name, division_code, section_code, 
                        detailed_section_code, item_code, additional_level_name, 
                        additional_level_value, status
                    )
                `)
                .eq('id', requestId)
                .single();
            
            if (error) throw error;
            requestData = data;
            projectData = data.classification_projects;

            // Get the specific attribute for value requests
            if (data.attribute_id) {
                try {
                    // Try first with standard_values join
                    const { data: attrs, error: attrError } = await supabase
                        .from('project_attributes')
                        .select(`
                            *,
                            standard_values (
                                id,
                                name,
                                value,
                                attribute_id
                            )
                        `)
                        .eq('id', data.attribute_id);
                    
                    if (attrError) {
                        console.warn('Failed to fetch with standard_values join:', attrError);
                        // Fallback: fetch attribute only
                        const { data: attrOnly, error: fallbackError } = await supabase
                            .from('project_attributes')
                            .select('*')
                            .eq('id', data.attribute_id);
                        
                        if (fallbackError) throw fallbackError;
                        
                        // Fetch standard values separately
                        const { data: values, error: valueError } = await supabase
                            .from('standard_values')
                            .select('id, name, value, attribute_id')
                            .eq('attribute_id', data.attribute_id);
                        
                        if (valueError) {
                            console.warn(`Failed to fetch values for attribute ${data.attribute_id}:`, valueError);
                            attributeData = attrOnly.map(attr => ({ ...attr, standard_values: [] }));
                        } else {
                            attributeData = attrOnly.map(attr => ({ ...attr, standard_values: values || [] }));
                        }
                    } else {
                        attributeData = attrs;
                    }
                } catch (error) {
                    console.error('Error fetching attribute data:', error);
                    attributeData = null;
                }
            }

        } else if (type === 'block') {
            const { data, error } = await supabase
                .from('combination_requests')
                .select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    classification_projects (
                        id, project_name, division_code, section_code, 
                        detailed_section_code, item_code, additional_level_name, 
                        additional_level_value, status
                    )
                `)
                .eq('id', requestId)
                .single();
            
            if (error) throw error;
            requestData = data;
            projectData = data.classification_projects;
        }

        if (!requestData) {
            throw new Error('No data found for this request');
        }

        // Build the detail HTML using the comprehensive admin-style layout
        let detailHTML = `
            <div class="space-y-6">
                <!-- Request Status & Basic Info -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-semibold text-blue-900">Request Information</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            requestData.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            requestData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                            requestData.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                            requestData.status === 'rejected' ? 'bg-red-100 text-red-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${requestData.status.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-medium">Request ID:</span> ${requestData.id}</div>
                        <div><span class="font-medium">Created:</span> ${formatDate(requestData.created_at)}</div>
                        <div><span class="font-medium">Requester:</span> ${requestData.created_by_user?.username || 'Unknown'} (${requestData.created_by_user?.email || 'N/A'})</div>
                        <div><span class="font-medium">Reviewer:</span> ${requestData.reviewed_by_user?.username || 'Not assigned'}</div>
                    </div>
                </div>

                <!-- Project Information -->
                ${projectData ? `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Details</h3>
                    <div class="grid grid-cols-1 gap-3 text-sm">
                        <div><span class="font-medium">Project Name:</span> ${projectData.project_name || 'N/A'}</div>
                        <div><span class="font-medium">CSI Code:</span> 
                            <span class="font-mono">${projectData.division_code}-${projectData.section_code}-${projectData.detailed_section_code}-${projectData.item_code}</span>
                        </div>
                        ${projectData.additional_level_value ? `
                            <div><span class="font-medium">Additional Level:</span> ${projectData.additional_level_name}: ${projectData.additional_level_value}</div>
                        ` : ''}
                        <div><span class="font-medium">Project Status:</span> 
                            <span class="px-2 py-1 rounded text-xs ${
                                projectData.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
                                projectData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">
                                ${projectData.status?.replace('_', ' ')?.toUpperCase() || 'UNKNOWN'}
                            </span>
                        </div>
                    </div>
                </div>
                ` : ''}
        `;

        // Request-specific details
        if (type === 'code') {
            detailHTML += `
                <!-- Item Code Request Details -->
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="text-lg font-semibold text-green-900 mb-3">Item Code Request Details</h3>
                    <div class="space-y-3 text-sm">
                        <div><span class="font-medium">Requested Item Code:</span> <span class="font-mono text-lg">${requestData.item_code || 'N/A'}</span></div>
                        <div><span class="font-medium">Description 1:</span> ${requestData.description1 || 'N/A'}</div>
                        <div><span class="font-medium">Description 2:</span> ${requestData.description2 || 'N/A'}</div>
                        
                        <!-- Basic Technical Info -->
                        <div class="border-t pt-3 mt-3">
                            <h4 class="font-semibold text-green-800 mb-2">Technical Specifications</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">UOM:</span> ${requestData.uom || 'N/A'}</div>
                                <div><span class="font-medium">Country of Origin:</span> ${requestData.country_of_origin || 'N/A'}</div>
                            </div>
                            <div class="mt-2"><span class="font-medium">Model Number:</span> ${requestData.model_number || 'N/A'}</div>
                        </div>
                        
                        <!-- Financial Information -->
                        <div class="border-t pt-3 mt-3">
                            <h4 class="font-semibold text-green-800 mb-2">Financial Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">Unit Price:</span> <span class="text-green-600 font-semibold">${requestData.unit_price ? (parseFloat(requestData.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})) : 'N/A'}</span></div>
                                <div><span class="font-medium">Currency:</span> <span class="font-mono">${requestData.currency_code || 'N/A'}</span></div>
                            </div>
                            <div class="mt-2"><span class="font-medium">Manufacturer:</span> <span class="text-blue-600 font-medium">${requestData.manufacturer || 'N/A'}</span></div>
                        </div>
                        
                        <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                    </div>
                </div>

                
            `;
            
            // Show selected attributes for item code requests
            if (attributeData && requestData.attribute_selections) {
                const selections = requestData.attribute_selections || {};
                attributeData.forEach(attr => {
                    const selectedValueId = selections[attr.id];
                    const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                    
                    detailHTML += `
                        
                    `;
                });
            } else {
                detailHTML += `<p class="text-gray-500 italic">No attribute selections found</p>`;
            }
            
            detailHTML += `
                    </div>
                </div>
            `;

        } else if (type === 'value') {
            const currentAttribute = attributeData[0];
            detailHTML += `
                <!-- Standard Value Request Details -->
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <h3 class="text-lg font-semibold text-purple-900 mb-3">Standard Value Request Details</h3>
                    <div class="space-y-3">
                        <div><span class="font-medium">Attribute:</span> ${requestData.attribute_name} ${currentAttribute?.is_mandatory ? '(Required)' : '(Optional)'}</div>
                        <div><span class="font-medium">Requested New Value:</span> <span class="text-green-600 font-bold text-lg">${requestData.new_value}</span></div>
                        <div><span class="font-medium">Justification:</span> ${requestData.reason || 'No reason provided'}</div>
                    </div>
                </div>

                <!-- Current Standard Values -->
                <div class="bg-gray-50 p-4 rounded-lg mt-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Current Standard Values for "${requestData.attribute_name}"</h3>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${currentAttribute?.standard_values?.map(val => `
                            <div class="flex items-center space-x-2 p-2 bg-white rounded border">
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                <span>${val.name}</span>
                            </div>
                        `).join('') || '<p class="text-gray-500 italic">No existing values found</p>'}
                        <div class="flex items-center space-x-2 p-2 bg-green-100 border border-green-300 rounded">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span class="font-bold text-green-800">+ ${requestData.new_value} (New - Pending Approval)</span>
                        </div>
                    </div>
                </div>
            `;

        } else if (type === 'block') {
            detailHTML += `
                <!-- Block Combination Details -->
                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <h3 class="text-lg font-semibold text-red-900 mb-3">Block Combination Request</h3>
                    <div class="space-y-3">
                        <div><span class="font-medium">Request Type:</span> ${requestData.request_type || 'Block'}</div>
                        <div><span class="font-medium">Reason for Blocking:</span> ${requestData.reason || 'No reason provided'}</div>
                        <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                    </div>
                </div>

                <!-- Combination to Block -->
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200 mt-4">
                    <h3 class="text-lg font-semibold text-orange-900 mb-3">Combination Values to Block</h3>
                    <div class="space-y-4">
            `;

            // Show the combination that will be blocked
            if (attributeData && requestData.attribute_selections) {
                const selections = requestData.attribute_selections || {};
                attributeData.forEach(attr => {
                    const selectedValueId = selections[attr.id];
                    const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                    
                    detailHTML += `
                        <div class="border border-orange-200 p-3 rounded bg-white">
                            <div class="font-medium text-orange-900 mb-2">${attr.attribute_name}</div>
                            <div class="text-sm text-red-600 font-medium">√É¬∞√Ö¬∏√Ö¬°√Ç¬´ Will be blocked: ${selectedValue ? selectedValue.name : 'None selected'}</div>
                        </div>
                    `;
                });
            } else {
                detailHTML += `<p class="text-gray-500 italic">No combination data found</p>`;
            }
            
            detailHTML += `
                    </div>
                </div>
            `;
        }

        // Add any existing review comments
        if (requestData.review_comments || requestData.reviewer_comments) {
            detailHTML += `
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">Previous Review Comments</h3>
                    <p class="text-sm text-blue-800">${requestData.review_comments || requestData.reviewer_comments}</p>
                </div>
            `;
        }

        // Close the main container div
        detailHTML += `
            </div>
        `;

        // Show the modal
        document.getElementById('review-modal-title').textContent = `Review ${type.charAt(0).toUpperCase() + type.slice(1)} Request #${requestId}`;
        document.getElementById('review-modal-content').innerHTML = detailHTML;

        // Store the current review request for the action buttons
        window.currentReviewRequest = { type: type, id: requestId };
        currentReviewItem = { type: type, id: requestId };

        // Set up action buttons based on user role and request status
        updateModalActionButtons(type, requestData);

        document.getElementById('review-modal').classList.remove('hidden');

    } catch (error) {
     
     
        console.error('Error loading request details:', error);
        alert('Error loading request details: ' + error.message);
    }
}


function showAdminRequestDetailModal(type, requestData, projectData, attributeData) {
    const modal = document.getElementById('review-modal');
    const title = document.getElementById('review-modal-title');
    const content = document.getElementById('review-modal-content');
    
    const typeNames = {
        'code': 'Item Code Request',
        'value': 'Standard Value Request',
        'block': 'Block Combination Request'
    };
    
    title.textContent = `Admin Review: ${typeNames[type]}`;
    
    let detailHTML = `
        <div class="space-y-6">
            <!-- Request Status & Basic Info -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-semibold text-blue-900">Request Information</h3>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${
                        requestData.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        requestData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${requestData.status.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="font-medium">Request ID:</span> ${requestData.id}</div>
                    <div><span class="font-medium">Created:</span> ${formatDate(requestData.created_at)}</div>
                    <div><span class="font-medium">Requester:</span> ${requestData.created_by_user?.username || 'Unknown'} (${requestData.created_by_user?.email || 'N/A'})</div>
                    <div><span class="font-medium">Reviewer:</span> ${requestData.reviewed_by_user?.username || 'Not assigned'}</div>
                </div>
            </div>

            <!-- Project Information -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Details</h3>
                <div class="grid grid-cols-1 gap-3 text-sm">
                    <div><span class="font-medium">Project Name:</span> ${projectData?.project_name || 'N/A'}</div>
                    
                    <!-- CSI Code Hierarchy Section -->
                    ${projectData ? `
                        <div class="csi-path-container">
                            <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                            <div class="flex flex-col space-y-1">
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.division_code || 'N/A'}</span>
                                    <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                    <span class="text-xs opacity-90">${projectData.division_description || 'Division Description'}</span>
                                </div>
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.section_code || 'N/A'}</span>
                                    <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                    <span class="text-xs opacity-90">${projectData.section_description || 'Section Description'}</span>
                                </div>
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.detailed_section_code || 'N/A'}</span>
                                    <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                    <span class="text-xs opacity-90">${projectData.detailed_section_description || 'Detailed Section Description'}</span>
                                </div>
                                <div class="csi-path-item">
                                    <span class="font-bold">${projectData.item_code || 'N/A'}</span>
                                    <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                    <span class="text-xs opacity-90">${projectData.item_description || 'Item Description'}</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div><span class="font-medium">CSI Code:</span> 
                        <span class="font-mono">${projectData?.division_code}-${projectData?.section_code}-${projectData?.detailed_section_code}-${projectData?.item_code}</span>
                    </div>
                    ${projectData?.additional_level_value ? `
                        <div><span class="font-medium">Additional Level:</span> ${projectData.additional_level_name}: ${projectData.additional_level_value}</div>
                    ` : ''}
                    ${projectData ? `
    <div><span class="font-medium">Project Status:</span> 
        <span class="px-2 py-1 rounded text-xs ${
            projectData.status === 'admin_approved' ? 'bg-green-100 text-green-800' :
            projectData.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' :
            'bg-yellow-100 text-yellow-800'
        }">
            ${projectData.status?.replace('_', ' ')?.toUpperCase() || 'UNKNOWN'}
        </span>
    </div>
` : ''}
                </div>
            </div>
    `;

    if (type === 'code') {
        detailHTML += `
            <!-- Item Code Request Details -->
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <h3 class="text-lg font-semibold text-green-900 mb-3">Item Code Request Details</h3>
                <div class="space-y-3 text-sm">
                    <div><span class="font-medium">Requested Item Code:</span> <span class="font-mono text-lg">${requestData.item_code || 'N/A'}</span></div>
                    <div><span class="font-medium">Description 1:</span> ${requestData.description1 || 'N/A'}</div>
                    <div><span class="font-medium">Description 2:</span> ${requestData.description2 || 'N/A'}</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><span class="font-medium">UOM:</span> ${requestData.uom || 'N/A'}</div>
                        <div><span class="font-medium">Country of Origin:</span> ${requestData.country_of_origin || 'N/A'}</div>
                    </div>
                    <div><span class="font-medium">Model Number:</span> ${requestData.model_number || 'N/A'}</div>
                    
                    <!-- NEW FINANCIAL INFORMATION SECTION -->
                    <div class="border-t pt-3 mt-3">
                        <h4 class="font-semibold text-green-800 mb-2">Financial Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="font-medium">Unit Price:</span> <span class="text-green-600 font-semibold">${requestData.unit_price ? (parseFloat(requestData.unit_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})) : 'N/A'}</span></div>
                            <div><span class="font-medium">Currency:</span> <span class="font-mono">${requestData.currency_code || 'N/A'}</span></div>
                        </div>
                        <div class="mt-2"><span class="font-medium">Manufacturer:</span> <span class="text-blue-600 font-medium">${requestData.manufacturer || 'N/A'}</span></div>
                    </div>
                    
                    <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                </div>
            </div>


        `;
        
        // Show selected attributes for item code requests
        if (attributeData && requestData.attribute_selections) {
            const selections = requestData.attribute_selections || {};
            attributeData.forEach(attr => {
                const selectedValueId = selections[attr.id];
                const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                
                detailHTML += `
                    
                `;
            });
        } else {
            detailHTML += `<p class="text-gray-500 italic">No attribute selections found</p>`;
        }
        
        detailHTML += `
                </div>
            </div>
        `;

    } else if (type === 'value') {
        const currentAttribute = attributeData[0];
        detailHTML += `
            <!-- Standard Value Request Details -->
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <h3 class="text-lg font-semibold text-purple-900 mb-3">Standard Value Request Details</h3>
                <div class="space-y-3">
                    <div><span class="font-medium">Attribute:</span> ${requestData.attribute_name} ${currentAttribute?.is_mandatory ? '(Required)' : '(Optional)'}</div>
                    <div><span class="font-medium">Requested New Value:</span> <span class="text-green-600 font-bold text-lg">${requestData.new_value}</span></div>
                    <div><span class="font-medium">Justification:</span> ${requestData.reason || 'No reason provided'}</div>
                </div>
            </div>

            <!-- Current Standard Values -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Current Standard Values for "${requestData.attribute_name}"</h3>
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    ${currentAttribute?.standard_values?.map(val => `
                        <div class="flex items-center space-x-2 p-2 bg-white rounded border">
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            <span>${val.name}</span>
                        </div>
                    `).join('') || '<p class="text-gray-500 italic">No existing values found</p>'}
                    <div class="flex items-center space-x-2 p-2 bg-green-100 border border-green-300 rounded">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="font-bold text-green-800">+ ${requestData.new_value} (New - Pending Approval)</span>
                    </div>
                </div>
            </div>
        `;

    } else if (type === 'block') {
        detailHTML += `
            <!-- Block Combination Details -->
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                <h3 class="text-lg font-semibold text-red-900 mb-3">Block Combination Request</h3>
                <div class="space-y-3">
                    <div><span class="font-medium">Request Type:</span> ${requestData.request_type || 'Block'}</div>
                    <div><span class="font-medium">Reason for Blocking:</span> ${requestData.reason || 'No reason provided'}</div>
                    <div><span class="font-medium">Combination Signature:</span> <span class="font-mono text-xs">${requestData.combination_signature || 'N/A'}</span></div>
                </div>
            </div>

            <!-- Combination to Block -->
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <h3 class="text-lg font-semibold text-orange-900 mb-3">Combination Values to Block</h3>
                <div class="space-y-4">
        `;

        // Show the combination that will be blocked
        if (attributeData && requestData.attribute_selections) {
            const selections = requestData.attribute_selections || {};
            attributeData.forEach(attr => {
                const selectedValueId = selections[attr.id];
                const selectedValue = attr.standard_values.find(val => val.id === selectedValueId);
                
                if (selectedValue) {
                    detailHTML += `
                        <div class="border border-orange-200 p-3 rounded bg-white">
                            <div class="font-medium text-orange-900 mb-2">${attr.attribute_name} ${attr.is_mandatory ? '(Required)' : '(Optional)'}</div>
                            <div class="mt-2">
                                <span class="bg-red-100 text-red-800 px-3 py-1 rounded font-medium">
                                    √É¬∞√Ö¬∏√Ö¬°√Ç¬´ WILL BE BLOCKED: ${selectedValue.name}
                                </span>
                            </div>
                        </div>
                    `;
                }
            });
        } else {
            detailHTML += `<p class="text-gray-500 italic">No combination details found</p>`;
        }

        detailHTML += `
                </div>
                <div class="mt-4 p-3 bg-red-100 border border-red-200 rounded">
                    <p class="text-red-800 text-sm">
                        <strong>√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Warning:</strong> Approving this request will prevent users from generating item codes 
                        using this exact combination of attribute values. This action cannot be easily undone.
                    </p>
                </div>
            </div>
        `;
    }

    // Add reviewer comments if they exist
    if (requestData.reviewer_comments || requestData.review_comments) {
        detailHTML += `
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Reviewer Comments</h3>
                <p class="text-sm text-gray-700">${requestData.reviewer_comments || requestData.review_comments || 'No comments provided'}</p>
            </div>
        `;
    }

    detailHTML += `
        </div>
    `;

    content.innerHTML = detailHTML;
    
    // Store current request info for approval buttons in modal
    window.currentReviewRequest = { type, id: requestData.id };
    
    // Set appropriate buttons based on user role and request status
updateModalActionButtons(type, requestData);

modal.classList.remove('hidden');
}


function updateModalActionButtons(type, itemData) {
    const buttonContainer = document.getElementById('modal-action-buttons');
    const userRole = currentUser.role;
    const status = itemData.status || 'unknown';
    
    console.log('Setting up modal buttons for:', { type, userRole, status });
    console.log('Project data:', itemData);
    
    let buttonsHTML = '';
    
    if (type === 'project') {
        // Classification Project buttons
        if (userRole === 'reviewer') {
            if (status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Reject
                    </button>
                `;
            } else if (status === 'reviewer_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ You Approved This
                    </span>
                `;
            } else if (status === 'reviewer_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô You Rejected This
                    </span>
                `;
            } else {
                // Fallback for reviewers - show buttons anyway for debugging
                console.log('Unknown status for reviewer project:', status, '- showing fallback buttons');
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approve (Status: ${status})
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Reject (Status: ${status})
                    </button>
                `;
            }
        } else if (userRole === 'admin') {
            if (status === 'reviewer_approved' || status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Final Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Final Reject
                    </button>
                `;
            } else if (status === 'admin_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approved by You
                    </span>
                `;
            } else if (status === 'admin_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Rejected by You
                    </span>
                `;
            } else {
                // Fallback for admins - show buttons anyway for debugging
                console.log('Unknown status for admin project:', status, '- showing fallback buttons');
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Final Approve (Status: ${status})
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Final Reject (Status: ${status})
                    </button>
                `;
            }
        }
    } else {
        // Item Request buttons (code, value, block)
        if (userRole === 'reviewer') {
            if (status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Reject
                    </button>
                `;
            } else if (status === 'reviewer_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ You Approved This
                    </span>
                `;
            } else if (status === 'reviewer_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô You Rejected This
                    </span>
                `;
            }
        } else if (userRole === 'admin') {
            if (status === 'reviewer_approved' || status === 'submitted' || status === 'pending') {
                buttonsHTML = `
                    <button onclick="submitCurrentReview('approve')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Final Approve
                    </button>
                    <button onclick="submitCurrentReview('reject')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Final Reject
                    </button>
                `;
            } else if (status === 'admin_approved') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md text-sm">
                        √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approved by You
                    </span>
                `;
            } else if (status === 'admin_rejected') {
                buttonsHTML = `
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-md text-sm">
                        √É¬¢√Ç¬ù√Ö‚Äô Rejected by You
                    </span>
                `;
            }
        }
    }
    
    // Fallback for unknown status or scenarios
    if (!buttonsHTML) {
        console.warn('No buttons generated for:', { type, userRole, status, itemData });
        if (type === 'project' && (userRole === 'reviewer' || userRole === 'admin')) {
            // Force show project buttons for debugging
            buttonsHTML = `
                <button onclick="submitCurrentReview('approve')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                    √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Force Approve
                </button>
                <button onclick="submitCurrentReview('reject')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                    √É¬¢√Ç¬ù√Ö‚Äô Force Reject
                </button>
                <div class="text-xs text-gray-500 mt-1">Status: ${status} | Role: ${userRole}</div>
            `;
        } else {
            buttonsHTML = `
                <span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-md text-sm">
                    Status: ${status} - No actions available (${type})
                </span>
            `;
        }
    }
    
    // Check if button container exists
    if (!buttonContainer) {
        console.error('Button container not found! modal-action-buttons element is missing');
        return;
    }
    
    buttonContainer.innerHTML = buttonsHTML;
    console.log('Modal buttons set:', buttonsHTML);
}
async function reviewAdminRequest(type, requestId, decision) {
    console.log('reviewAdminRequest called with:', { type, requestId, decision });
    
    // Prevent any form submission or page reload
    event?.preventDefault();
    
    const comments = prompt(`Enter your comments for ${decision === 'approve' ? 'approving' : 'rejecting'} this request:`);
    if (comments === null) {
        console.log('User cancelled the review');
        return; // User cancelled
    }
    
    try {
        console.log('Processing admin request:', { type, requestId, decision, comments });
        
        // Show loading state
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'loading-msg';
        loadingMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded z-50';
        loadingMsg.textContent = 'Processing...';
        document.body.appendChild(loadingMsg);
        
        let updateResult;
        
        // Handle the update based on request type
        if (type === 'project') {
            console.log('Processing classification project:', requestId);
            
            // Use the admin review decision RPC function for projects
            const { data, error } = await supabase.rpc('admin_review_decision', {
                project_id_param: requestId,
                admin_id_param: currentUser.id,
                decision_param: decision,
                comments_param: comments
            });
            
            if (error) {
                console.error('Error reviewing project:', error);
                throw error;
            }
            
            console.log('Project review response:', data);
            
            if (data.success) {
                updateResult = { success: true, message: data.message };
            } else {
                throw new Error(data.message || 'Project review failed');
            }
            
        } else if (type === 'code') {
            console.log('Processing item code request:', requestId);
            const { data: beforeUpdate, error: fetchError } = await supabase
                .from('item_code_requests')
                .select('*')
                .eq('id', requestId)
                .single();
            
            if (fetchError) {
                console.error('Error fetching item code request:', fetchError);
                throw fetchError;
            }
            
            console.log('Item code request before update:', beforeUpdate);
            
            const updateData = {
                status: decision === 'approve' ? 'admin_approved' : 'admin_rejected',
                review_comments: comments,
                reviewed_at: new Date().toISOString()
            };
            
            console.log('Updating item code request with:', updateData);
            
            const { data: updateResponse, error: updateError } = await supabase
                .from('item_code_requests')
                .update(updateData)
                .eq('id', requestId)
                .select();
            
            if (updateError) {
                console.error('Error updating item code request:', updateError);
                throw updateError;
            }
            
            console.log('Update response:', updateResponse);
            updateResult = { success: true, message: `Item code request ${decision}d successfully` };
            
        } else if (type === 'value') {
            console.log('Processing standard value request:', requestId);
            
            if (decision === 'approve') {
                // For standard value requests, we need to add the value and update status
                const { data: requestData, error: fetchError } = await supabase
                    .from('standard_value_requests')
                    .select('*, project_attributes(standard_values)')
                    .eq('id', requestId)
                    .single();
                
                if (fetchError) {
                    console.error('Error fetching standard value request:', fetchError);
                    throw fetchError;
                }
                
                console.log('Standard value request data:', requestData);
                
                // Get current attribute values
                const { data: attributeData, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('standard_values')
                    .eq('id', requestData.attribute_id)
                    .single();
                
                if (attrError) {
                    console.error('Error fetching attribute data:', attrError);
                    throw attrError;
                }
                
                console.log('Current attribute data:', attributeData);
                
                // Add new value if it doesn't exist
                const currentValues = attributeData.standard_values || [];
                const valueExists = currentValues.some(val => val.name === requestData.new_value);
                
                if (!valueExists) {
                    const newValue = { name: requestData.new_value, unit: '' };
                    const updatedValues = [...currentValues, newValue];
                    
                    console.log('Adding new value:', newValue, 'to existing values:', currentValues);
                    
                    const { error: updateAttrError } = await supabase
                        .from('project_attributes')
                        .update({ standard_values: updatedValues })
                        .eq('id', requestData.attribute_id);
                    
                    if (updateAttrError) {
                        console.error('Error updating attribute values:', updateAttrError);
                        throw updateAttrError;
                    }
                    
                    console.log('Successfully updated attribute values');
                }
            }
            
            // Update request status
            const statusUpdateData = {
                status: decision === 'approve' ? 'admin_approved' : 'admin_rejected',
                admin_reviewed_by: currentUser.id,
                admin_reviewed_at: new Date().toISOString(),
                admin_comments: comments
            };
            
            console.log('Updating standard value request status with:', statusUpdateData);
            
            const { data: statusResponse, error: statusError } = await supabase
                .from('standard_value_requests')
                .update(statusUpdateData)
                .eq('id', requestId)
                .select();
            
            if (statusError) {
                console.error('Error updating standard value request status:', statusError);
                throw statusError;
            }
            
            console.log('Status update response:', statusResponse);
            updateResult = { success: true, message: `Standard value request ${decision}d successfully` };
            
        } else if (type === 'block') {
            console.log('Processing combination block request:', requestId);
            
            const statusUpdateData = {
                status: decision === 'approve' ? 'admin_approved' : 'admin_rejected',
                admin_reviewed_by: currentUser.id,
                admin_reviewed_at: new Date().toISOString(),
                admin_comments: comments
            };
            
            console.log('Updating combination request with:', statusUpdateData);
            
            const { data: updateResponse, error: updateError } = await supabase
                .from('combination_requests')
                .update(statusUpdateData)
                .eq('id', requestId)
                .select();
            
            if (updateError) {
                console.error('Error updating combination request:', updateError);
                throw updateError;
            }
            
            console.log('Combination request update response:', updateResponse);
            updateResult = { success: true, message: `Combination block request ${decision}d successfully` };
            
        } else {
            throw new Error('Unknown request type: ' + type);
        }
        
        // Remove loading message
        document.getElementById('loading-msg')?.remove();
        
        // Show success message
        alert(updateResult.message);
        
        console.log('Refreshing data...');
        
        // Refresh the data
        await loadPendingRequests();
        await loadDashboardStats();
        
        console.log('Review completed successfully');
        
    } catch (error) {
        console.error('Error reviewing request:', error);
        
        // Remove loading message
        document.getElementById('loading-msg')?.remove();
        
        // Show detailed error
        alert(`Error processing request: ${error.message}\n\nCheck console for more details.`);
    }
}
// ===== ITEM CARD CREATION =====
function createPendingRequestCard(request) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
    
    const typeLabel = request.type === 'code' ? 'Item Code' : 
                     request.type === 'block' ? 'Block Combination' : 'Standard Value';
    const titleText = request.type === 'code' ? request.item_code :
                     request.type === 'value' ? `${request.attribute_name}: ${request.new_value}` :
                     'Block Combination Request';
    
    const buttonText = request.isAssigned ? 'Review' : 'Claim & Review';
    const buttonClass = request.isAssigned ? 
        'bg-blue-600 hover:bg-blue-700' : 
        'bg-green-600 hover:bg-green-700';
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">${typeLabel}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">PENDING</span>
                    ${!request.isAssigned ? '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">UNASSIGNED</span>' : ''}
                </div>
                <h3 class="text-lg font-semibold text-gray-900">${titleText}</h3>
                <p class="text-sm text-gray-600">${request.project?.project_name || 'Unknown Project'}</p>
            </div>
            <div class="flex space-x-2 ml-4">
                <button onclick="openReviewModal('${request.type}', ${request.id})" 
                        class="${buttonClass} text-white px-4 py-2 rounded text-sm font-medium">
                    ${buttonText}
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded">
            <div>
                <span class="font-medium text-gray-600">Requested by:</span>
                <p>${request.created_by_user?.username || 'Unknown'}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Created:</span>
                <p>${new Date(request.created_at).toLocaleDateString()}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Request ID:</span>
                <p class="font-mono text-xs">${request.id}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Status:</span>
                <p class="capitalize">${request.status.replace('_', ' ')}</p>
            </div>
        </div>
    `;
    
    return card;
}

// ===== LOAD PENDING REQUESTS =====
async function loadPendingRequests() {
    console.log('Loading pending requests for user:', currentUser);
    
    const container = document.getElementById('pending-requests-container');
    container.innerHTML = ''; // Clear existing content
    
    try {
        if (currentUser.role === 'admin') {
            await loadAdminPendingRequests();
        } else if (currentUser.role === 'reviewer') {
            await loadReviewerPendingRequests();
        } else {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No pending requests for your role</div>';
        }
    } catch (error) {
        console.error('Error loading pending requests:', error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading pending requests</div>';
    }
}
async function loadAdminPendingRequests() {
    const container = document.getElementById('pending-requests-container');
    let hasContent = false;

    try {
        console.log('Loading admin pending requests - checking for reviewer_approved items only');
        
        // Load ONLY requests that need admin attention (reviewer_approved status)
        const [
            reviewerApprovedProjects,
            reviewerApprovedItemCodes,
            reviewerApprovedStandardValues,
            reviewerApprovedCombinations
        ] = await Promise.all([
            // Projects approved by reviewer, awaiting admin final approval
            supabase.from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email)
                `)
                .eq('status', 'reviewer_approved')
                .is('admin_reviewed_at', null)  // Ensure not already reviewed by admin
                .order('reviewed_at', { ascending: true }),

            // Item code requests approved by reviewer, awaiting admin final approval
            supabase.from('item_code_requests')
                .select(`
                    *,
                    created_by_user:users!item_code_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name, division_code, section_code, detailed_section_code, item_code, division_description, section_description, detailed_section_description, item_description)
                `)
                .eq('status', 'reviewer_approved')
                .order('reviewed_at', { ascending: true }),

            // Standard value requests approved by reviewer, awaiting admin final approval
            supabase.from('standard_value_requests')
                .select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name, division_code, section_code, detailed_section_code, item_code, division_description, section_description, detailed_section_description, item_description),
                    project_attributes(attribute_name, standard_values)
                `)
                .eq('status', 'reviewer_approved')
                .is('admin_reviewed_at', null)  // Ensure not already reviewed by admin
                .order('reviewed_at', { ascending: true }),

            // Combination requests approved by reviewer, awaiting admin final approval
            supabase.from('combination_requests')
                .select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name, division_code, section_code, detailed_section_code, item_code)
                `)
                .eq('status', 'reviewer_approved')
                .is('admin_reviewed_at', null)  // Ensure not already reviewed by admin
                .order('reviewed_at', { ascending: true })
        ]);

        console.log('Admin pending query results:', {
            projects: reviewerApprovedProjects.data?.length || 0,
            itemCodes: reviewerApprovedItemCodes.data?.length || 0, 
            standardValues: reviewerApprovedStandardValues.data?.length || 0,
            combinations: reviewerApprovedCombinations.data?.length || 0
        });

        // FILTER OUT: Remove item code requests that have already been processed into final item_codes
        let filteredItemCodes = reviewerApprovedItemCodes.data || [];
        if (filteredItemCodes.length > 0) {
            console.log('Filtering out already processed item code requests...');
            
            // Get all existing final item codes to compare against
            const { data: existingItemCodes } = await supabase
                .from('item_codes')
                .select('item_code, project_id, combination_signature');
            
            if (existingItemCodes) {
                const existingSignatures = new Set(existingItemCodes.map(ic => 
                    `${ic.project_id}-${ic.combination_signature}`
                ));
                
                const originalCount = filteredItemCodes.length;
                filteredItemCodes = filteredItemCodes.filter(request => {
                    const requestSignature = `${request.project_id}-${request.combination_signature}`;
                    const alreadyExists = existingSignatures.has(requestSignature);
                    
                    if (alreadyExists) {
                        console.log(`Filtering out item code request ${request.id} - already exists as final item code`);
                    }
                    
                    return !alreadyExists;
                });
                
                console.log(`Filtered item codes: ${originalCount} -> ${filteredItemCodes.length}`);
            }
        }

        // Debug: Log some sample data to understand what's being retrieved
        if (reviewerApprovedProjects.data?.length > 0) {
            console.log('Sample project pending admin review:', {
                id: reviewerApprovedProjects.data[0].id,
                name: reviewerApprovedProjects.data[0].project_name,
                status: reviewerApprovedProjects.data[0].status,
                admin_reviewed_at: reviewerApprovedProjects.data[0].admin_reviewed_at,
                reviewed_at: reviewerApprovedProjects.data[0].reviewed_at
            });
        }
        
        if (reviewerApprovedItemCodes.data?.length > 0) {
            console.log('Sample item code pending admin review:', {
                id: reviewerApprovedItemCodes.data[0].id,
                item_code: reviewerApprovedItemCodes.data[0].item_code,
                status: reviewerApprovedItemCodes.data[0].status,
                reviewed_at: reviewerApprovedItemCodes.data[0].reviewed_at
            });
        }

        // Display ONLY items that need admin final decision (reviewer_approved)
        const adminPendingItems = [
            ...(reviewerApprovedProjects.data || []).map(p => ({
                ...p,
                type: 'project',
                priority: 'high',
                title: p.project_name,
                subtitle: `${p.division_code}-${p.section_code}-${p.detailed_section_code}-${p.item_code}`,
                creator_name: p.creator?.username,
                reviewer_name: p.reviewer?.username,
                date: p.reviewed_at
            })),
            ...filteredItemCodes.map(r => ({
                ...r,
                type: 'code',
                priority: 'high',
                title: r.item_code || 'Item Code Request',
                subtitle: r.project?.project_name || 'Unknown Project',
                creator_name: r.created_by_user?.username,
                reviewer_name: r.reviewed_by_user?.username,
                date: r.reviewed_at
            })),
            ...(reviewerApprovedStandardValues.data || []).map(r => ({
                ...r,
                type: 'value',
                priority: 'high',
                title: `Add Value: ${r.new_value}`,
                subtitle: `Attribute: ${r.attribute_name}`,
                creator_name: r.created_by_user?.username,
                reviewer_name: r.reviewed_by_user?.username,
                date: r.reviewed_at
            })),
            ...(reviewerApprovedCombinations.data || []).map(r => ({
                ...r,
                type: 'block',
                priority: 'high',
                title: `Block Combination`,
                subtitle: r.project?.project_name || 'Unknown Project',
                creator_name: r.created_by_user?.username,
                reviewer_name: r.reviewed_by_user?.username,
                date: r.reviewed_at
            }))
        ];

        // Store for searching
        window.originalAdminRequests = adminPendingItems;

        // Display Admin Pending Section
        if (adminPendingItems.length > 0) {
            hasContent = true;
            const adminPendingSection = document.createElement('div');
            adminPendingSection.className = 'mb-8';
            adminPendingSection.innerHTML = `
                <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-orange-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        ‚è≥ AWAITING YOUR ADMIN DECISION (${adminPendingItems.length})
                    </h3>
                    <p class="text-sm text-orange-700">Items approved by reviewers that need your final admin approval/rejection decision</p>
                </div>
                <div id="admin-pending-container" class="grid gap-4"></div>
            `;
            container.appendChild(adminPendingSection);

            const adminPendingContainer = document.getElementById('admin-pending-container');
            
            // Add debug information
            if (adminPendingItems.length > 0) {
                console.log('Displaying admin pending items:', adminPendingItems.map(item => ({
                    id: item.id,
                    type: item.type,
                    title: item.title,
                    status: item.status,
                    admin_reviewed_at: item.admin_reviewed_at
                })));
            }
            
            adminPendingItems
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .forEach(item => {
                    adminPendingContainer.appendChild(createDetailedAdminReviewCard(item));
                });
        }


        if (!hasContent) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg">√É¬∞√Ö¬∏√Ö¬Ω√¢‚Ç¨¬∞ All caught up!</p>
                    <p class="text-sm">No items pending admin review</p>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading admin pending requests:', error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading pending requests</div>';
    }
}
function createDetailedAdminReviewCard(item) {
    const card = document.createElement('div');
    card.className = `request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow ${
        item.priority === 'high' ? 'border-l-4 border-l-orange-500' : 'border-l-4 border-l-blue-500'
    }`;
    
    const typeInfo = {
        'project': { 
            icon: '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬Å', 
            color: 'purple', 
            label: 'Classification Project',
            bgClass: 'bg-purple-100 text-purple-800'
        },
        'code': { 
            icon: '√É¬∞√Ö¬∏√Ç¬è√Ç¬∑√É¬Ø√Ç¬∏√Ç¬è', 
            color: 'green', 
            label: 'Item Code Request',
            bgClass: 'bg-green-100 text-green-800'
        },
        'value': { 
            icon: '√É¬¢√Ö¬æ√¢‚Ç¨¬¢', 
            color: 'blue', 
            label: 'Standard Value Request',
            bgClass: 'bg-blue-100 text-blue-800'
        },
        'block': { 
            icon: '√É¬∞√Ö¬∏√Ö¬°√Ç¬´', 
            color: 'red', 
            label: 'Block Combination',
            bgClass: 'bg-red-100 text-red-800'
        }
    };

    const info = typeInfo[item.type] || typeInfo['code'];
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">${info.icon}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${info.bgClass}">
                        ${info.label}
                    </span>
                    ${item.priority === 'high' ? `
                        
                    ` : ''}
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.status === 'reviewer_approved' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                    }">
                        ${item.status.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.title}</h3>
                ${item.type === 'project' ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                    </div>
                ` : (item.type === 'code' || item.type === 'value') && item.project ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">Associated Project CSI Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.division_code || item.project?.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.division_description || item.project?.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.section_code || item.project?.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.section_description || item.project?.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.detailed_section_code || item.project?.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.detailed_section_description || item.project?.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.item_code || item.project?.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.item_description || item.project?.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                        <div class="text-xs text-white mt-2 opacity-75">Project: ${item.project.project_name || item.project?.project_name || 'Unknown Project'}</div>
                    </div>
                ` : `
                    <p class="text-sm text-gray-600 mb-2">${item.subtitle}</p>
                `}
                
                <!-- Detailed Information Grid -->
                <div class="grid grid-cols-2 gap-4 text-xs bg-gray-50 p-3 rounded mt-3">
                    <div>
                        <span class="font-medium text-gray-600">Requester:</span>
                        <p class="text-gray-800">${item.creator_name || 'Unknown'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Reviewer:</span>
                        <p class="text-gray-800">${item.reviewer_name || 'Unassigned'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Date:</span>
                        <p class="text-gray-800">${formatDate(item.date)}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">ID:</span>
                        <p class="text-gray-800 font-mono">#${item.id}</p>
                    </div>
                </div>

                ${item.type === 'code' ? `
                    <div class="mt-3 text-xs space-y-1">
                        <div><span class="font-medium">UOM:</span> ${item.uom || 'N/A'}</div>
                        <div><span class="font-medium">Country:</span> ${item.country_of_origin || 'N/A'}</div>
                        <div><span class="font-medium">Model:</span> ${item.model_number || 'N/A'}</div>
                    </div>
                ` : ''}

                ${item.type === 'value' ? `
                    <div class="mt-3 p-2 bg-green-50 rounded text-xs">
                        <span class="font-medium text-green-800">New Value:</span> 
                        <span class="text-green-900 font-bold">${item.new_value}</span>
                        <br>
                        <span class="font-medium text-green-800">Reason:</span> 
                        <span class="text-green-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}

                ${item.type === 'block' ? `
                    <div class="mt-3 p-2 bg-red-50 rounded text-xs">
                        <span class="font-medium text-red-800">Block Reason:</span> 
                        <span class="text-red-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}

                ${(item.reviewer_comments || item.review_comments) ? `
                    <div class="mt-3 p-2 bg-blue-50 rounded text-xs">
                        <span class="font-medium text-blue-800">Reviewer Comments:</span>
                        <p class="text-blue-900 mt-1">${item.reviewer_comments || item.review_comments}</p>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <div class="flex space-x-2 mt-4">
            <button onclick="viewRequestDetails('${item.type}', ${item.id})" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                √É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨≈æ View Full Details
            </button>
            ${item.priority === 'high' ? `
                <button onclick="reviewAdminRequest('${item.type}', ${item.id}, 'approve')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approve
                </button>
                <button onclick="reviewAdminRequest('${item.type}', ${item.id}, 'reject')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    √É¬¢√Ç¬ù√Ö‚Äô Reject
                </button>
            ` : `
                <button onclick="assignReviewer(${item.id}, '${item.type}')" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    √É¬∞√Ö¬∏√¢‚Ç¨Àú√Ç¬§ Assign Reviewer
                </button>
            `}
        </div>
    `;
    
    return card;
}
async function loadReviewerPendingRequests() {
    const container = document.getElementById('pending-requests-container');
    container.innerHTML = ''; // Clear existing content
    let hasContent = false;

    try {
        console.log('Loading reviewer pending requests for:', currentUser.id);
        
        // Initialize global storage for search functionality
        if (!window.allPendingItems) {
            window.allPendingItems = [];
        }

    // Section 1: Load ONLY projects pending review (status = 'submitted')
        console.log('Loading projects pending review...');
        
        // First, let's check what projects are assigned to this reviewer (any status)
        const { data: allAssignedProjects, error: allProjectsError } = await supabase
            .from('classification_projects')
            .select(`
                id,
                project_name,
                division_code,
                section_code,
                detailed_section_code,
                item_code,
                additional_level_name,
                additional_level_value,
                created_by,
                submitted_at,
                status,
                assigned_reviewer_id
            `)
            .eq('assigned_reviewer_id', currentUser.id);
            
        console.log('All projects assigned to reviewer:', allAssignedProjects);
        console.log('All projects error:', allProjectsError);
        
        // Now filter for only submitted projects
        const assignedProjects = allAssignedProjects?.filter(project => project.status === 'submitted') || [];
        const projectsError = allProjectsError;
        
        console.log('Filtered submitted projects:', assignedProjects);

        if (projectsError) {
            console.error('Error loading assigned projects:', projectsError);
        } else {
            console.log('Projects pending review (submitted only):', assignedProjects);
            // Debug: Log the first project to verify structure and status
            if (assignedProjects && assignedProjects.length > 0) {
                console.log('First project structure:', assignedProjects[0]);
                console.log('Project ID field:', assignedProjects[0].id);
                console.log('Project status:', assignedProjects[0].status);
            }
        }
        
        // Get creator information separately if needed
        if (assignedProjects && assignedProjects.length > 0) {
            for (let project of assignedProjects) {
                const { data: creator } = await supabase
                    .from('users')
                    .select('username, email')
                    .eq('id', project.created_by)
                    .single();
                project.creator = creator;
            }
        }

        // Section 2: Load ONLY item code requests with status 'pending' assigned to this reviewer
        console.log('Loading item code requests pending review...');
        const { data: itemCodeRequests, error: itemCodeError } = await supabase
            .from('item_code_requests')
            .select(`
                id, item_code, status, created_at, uom, country_of_origin, 
                model_number, description1, description2, review_comments,
                created_by_user:created_by(username, email),
                project:project_id(project_name, division_code, section_code, detailed_section_code, item_code, division_description, section_description, detailed_section_description, item_description)
            `)
            .eq('reviewed_by', currentUser.id)
            .eq('status', 'pending')  // ONLY pending requests
            .order('created_at', { ascending: false });

        if (itemCodeError) {
            console.error('Error loading item code requests:', itemCodeError);
        } else {
            console.log('Item code requests pending review:', itemCodeRequests);
        }

        // Section 3: Load ONLY standard value requests with status 'pending' assigned to this reviewer
        console.log('Loading standard value requests pending review...');
        const { data: standardValueRequests, error: standardValueError } = await supabase
            .from('standard_value_requests')
            .select(`
                id, attribute_name, new_value, reason, status, created_at, reviewer_comments,
                created_by_user:created_by(username, email),
                project:project_id(project_name, division_code, section_code, detailed_section_code, item_code, division_description, section_description, detailed_section_description, item_description)
            `)
            .eq('reviewed_by', currentUser.id)
            .eq('status', 'pending')  // ONLY pending requests
            .order('created_at', { ascending: false });

        if (standardValueError) {
            console.error('Error loading standard value requests:', standardValueError);
        } else {
            console.log('Standard value requests pending review:', standardValueRequests);
        }

        // Section 4: Load ONLY combination requests with status 'pending' assigned to this reviewer
        console.log('Loading combination requests pending review...');
        const { data: combinationRequests, error: combinationError } = await supabase
            .from('combination_requests')
            .select(`
                id, request_type, reason, status, created_at, reviewer_comments,
                created_by_user:created_by(username, email),
                project:project_id(project_name)
            `)
            .eq('reviewed_by', currentUser.id)
            .eq('status', 'pending')  // ONLY pending requests
            .order('created_at', { ascending: false });

        if (combinationError) {
            console.error('Error loading combination requests:', combinationError);
        } else {
            console.log('Combination requests pending review:', combinationRequests);
        }

        // Display Projects Section (ONLY if they are truly pending reviewer action)
        if (assignedProjects && assignedProjects.length > 0) {
            hasContent = true;
            const projectsSection = document.createElement('div');
            projectsSection.className = 'mb-8';
            projectsSection.innerHTML = `
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-purple-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        √É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬Å PROJECTS AWAITING YOUR REVIEW (${assignedProjects.length})
                    </h3>
                    <p class="text-sm text-purple-700">Classification projects submitted and waiting for your review decision</p>
                </div>
                <div id="assigned-projects-container" class="grid gap-4"></div>
            `;
            container.appendChild(projectsSection);

            const projectsContainer = document.getElementById('assigned-projects-container');
            assignedProjects.forEach(project => {
                projectsContainer.appendChild(createSimpleReviewerCard({
                    ...project,
                    id: project.id, // Use the actual id field
                    project_id: project.id, // Also provide project_id for compatibility
                    type: 'project',
                    title: project.project_name,
                    subtitle: `${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}`,
                    creator_name: project.creator?.username || 'Unknown',
                    date: project.submitted_at,
                    status: project.status, // Use actual status from database
                    canReview: project.status === 'submitted'  // Only show review buttons for submitted projects
                }));
            });
        }

        // Display Item Code Requests Section (ONLY pending ones)
        if (itemCodeRequests && itemCodeRequests.length > 0) {
            hasContent = true;
            const itemCodeSection = document.createElement('div');
            itemCodeSection.className = 'mb-8';
            itemCodeSection.innerHTML = `
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        √É¬∞√Ö¬∏√Ç¬è√Ç¬∑√É¬Ø√Ç¬∏√Ç¬è ITEM CODE REQUESTS AWAITING YOUR REVIEW (${itemCodeRequests.length})
                    </h3>
                    <p class="text-sm text-green-700">Item code requests assigned to you and waiting for your review decision</p>
                </div>
                <div id="item-code-container" class="grid gap-4"></div>
            `;
            container.appendChild(itemCodeSection);

            const itemCodeContainer = document.getElementById('item-code-container');
            itemCodeRequests.forEach(request => {
                itemCodeContainer.appendChild(createSimpleReviewerCard({
                    ...request,
                    type: 'code',
                    title: request.item_code || 'Item Code Request',
                    subtitle: request.project?.project_name || 'Unknown Project',
                    creator_name: request.created_by_user?.username,
                    date: request.created_at,
                    canReview: true  // Flag to show review buttons
                }));
            });
        }

        // Display Standard Value Requests Section (ONLY pending ones)
        if (standardValueRequests && standardValueRequests.length > 0) {
            hasContent = true;
            const standardValueSection = document.createElement('div');
            standardValueSection.className = 'mb-8';
            standardValueSection.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        √É¬¢√Ö¬æ√¢‚Ç¨¬¢ STANDARD VALUE REQUESTS AWAITING YOUR REVIEW (${standardValueRequests.length})
                    </h3>
                    <p class="text-sm text-blue-700">Standard value requests assigned to you and waiting for your review decision</p>
                </div>
                <div id="standard-value-container" class="grid gap-4"></div>
            `;
            container.appendChild(standardValueSection);

            const standardValueContainer = document.getElementById('standard-value-container');
            standardValueRequests.forEach(request => {
                standardValueContainer.appendChild(createSimpleReviewerCard({
                    ...request,
                    type: 'value',
                    title: `Add Value: ${request.new_value}`,
                    subtitle: `Attribute: ${request.attribute_name}`,
                    creator_name: request.created_by_user?.username,
                    date: request.created_at,
                    canReview: true  // Flag to show review buttons
                }));
            });
        }

        // Display Combination Requests Section (ONLY pending ones)
        if (combinationRequests && combinationRequests.length > 0) {
            hasContent = true;
            const combinationSection = document.createElement('div');
            combinationSection.className = 'mb-8';
            combinationSection.innerHTML = `
                <div class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-red-800 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"></path>
                        </svg>
                        √É¬∞√Ö¬∏√Ö¬°√Ç¬´ COMBINATION BLOCK REQUESTS AWAITING YOUR REVIEW (${combinationRequests.length})
                    </h3>
                    <p class="text-sm text-red-700">Combination block requests assigned to you and waiting for your review decision</p>
                </div>
                <div id="combination-container" class="grid gap-4"></div>
            `;
            container.appendChild(combinationSection);

            const combinationContainer = document.getElementById('combination-container');
            combinationRequests.forEach(request => {
                combinationContainer.appendChild(createSimpleReviewerCard({
                    ...request,
                    type: 'block',
                    title: `Block Combination`,
                    subtitle: request.project?.project_name || 'Unknown Project',
                    creator_name: request.created_by_user?.username,
                    date: request.created_at,
                    canReview: true  // Flag to show review buttons
                }));
            });
        }

        // Store all pending items globally for search functionality
        console.log('Storing pending items for search...');
        window.allPendingItems = [
            // Projects
            ...(assignedProjects || []).map(project => ({
                ...project,
                type: 'project',
                title: project.project_name,
                subtitle: `${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}`,
                creator_name: 'Unknown', // Will be enhanced if creator data is available
                created_by_name: 'Unknown',
                project_id: project.id,
                project_name: project.project_name
            })),
            // Item Code Requests
            ...(itemCodeRequests || []).map(request => ({
                ...request,
                type: 'code',
                title: request.item_code || 'Item Code Request',
                subtitle: request.project?.project_name || 'Unknown Project',
                creator_name: request.created_by_user?.username || 'Unknown',
                created_by_name: request.created_by_user?.username || 'Unknown',
                project_name: request.project?.project_name
            })),
            // Standard Value Requests
            ...(standardValueRequests || []).map(request => ({
                ...request,
                type: 'value',
                title: `Add Value: ${request.new_value}`,
                subtitle: `Attribute: ${request.attribute_name}`,
                creator_name: request.created_by_user?.username || 'Unknown',
                created_by_name: request.created_by_user?.username || 'Unknown',
                project_name: request.project?.project_name
            })),
            // Combination Requests
            ...(combinationRequests || []).map(request => ({
                ...request,
                type: 'block',
                title: 'Block Combination',
                subtitle: request.project?.project_name || 'Unknown Project',
                creator_name: request.created_by_user?.username || 'Unknown',
                created_by_name: request.created_by_user?.username || 'Unknown',
                project_name: request.project?.project_name
            }))
        ];

        console.log('Stored pending items for search:', window.allPendingItems.length);
        console.log('Sample pending items:', window.allPendingItems.slice(0, 2));

        if (!hasContent) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg">√É¬∞√Ö¬∏√Ö¬Ω√¢‚Ç¨¬∞ All caught up!</p>
                    <p class="text-sm">No items currently awaiting your review</p>
                    <p class="text-xs text-gray-400 mt-2">When new items are assigned to you, they'll appear here</p>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading reviewer pending requests:', error);
        container.innerHTML = `
            <div class="text-center text-red-500 py-8">
                <p>Error loading pending requests</p>
                <p class="text-sm mt-2">${error.message}</p>
            </div>
        `;
    }
}
function createSimpleReviewerCard(item) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow border-l-4 border-l-blue-500';
    
    const typeInfo = {
        'project': { icon: '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬Å', label: 'Classification Project', bgClass: 'bg-purple-100 text-purple-800' },
        'code': { icon: '√É¬∞√Ö¬∏√Ç¬è√Ç¬∑√É¬Ø√Ç¬∏√Ç¬è', label: 'Item Code Request', bgClass: 'bg-green-100 text-green-800' },
        'value': { icon: '√É¬¢√Ö¬æ√¢‚Ç¨¬¢', label: 'Standard Value Request', bgClass: 'bg-blue-100 text-blue-800' },
        'block': { icon: '√É¬∞√Ö¬∏√Ö¬°√Ç¬´', label: 'Block Combination', bgClass: 'bg-red-100 text-red-800' }
    };

    const info = typeInfo[item.type] || typeInfo['code'];
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">${info.icon}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${info.bgClass}">
                        ${info.label}
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.status === 'pending' || item.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' :
                        item.status === 'reviewer_approved' ? 'bg-green-100 text-green-800' :
                        item.status === 'reviewer_rejected' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${item.status?.replace('_', ' ')?.toUpperCase() || 'PENDING'}
                    </span>
                </div>
                <h4 class="font-semibold text-gray-900">${item.title}</h4>
                ${item.type === 'project' ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">CSI Code Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                    </div>
                ` : (item.type === 'code' || item.type === 'value') && item.project ? `
                    <div class="csi-path-container">
                        <div class="text-xs text-white mb-2 font-medium">Associated Project CSI Hierarchy:</div>
                        <div class="flex flex-col space-y-1">
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.division_code || item.project?.division_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.division_description || item.project?.division_description || 'Division Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.section_code || item.project?.section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.section_description || item.project?.section_description || 'Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.detailed_section_code || item.project?.detailed_section_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.detailed_section_description || item.project?.detailed_section_description || 'Detailed Section Description'}</span>
                            </div>
                            <div class="csi-path-item">
                                <span class="font-bold">${item.project.item_code || item.project?.item_code || 'N/A'}</span>
                                <span class="csi-path-arrow">√¢‚Ä†‚Äô</span>
                                <span class="text-xs opacity-90">${item.project.item_description || item.project?.item_description || 'Item Description'}</span>
                            </div>
                        </div>
                        <div class="text-xs text-white mt-2 opacity-75">Project: ${item.project.project_name || item.project?.project_name || 'Unknown Project'}</div>
                    </div>
                ` : `
                    <p class="text-sm text-gray-600">${item.subtitle}</p>
                `}
                <div class="text-xs text-gray-500 mt-2">
                    <span>By: ${item.creator_name || 'Unknown'}</span> | 
                    <span>${formatDate(item.date)}</span> | 
                    <span>ID: #${item.id}</span>
                </div>
            </div>
        </div>
        
        <div class="flex space-x-2">
            <button onclick="openReviewModal('${item.type}', ${item.id})" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                √É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨≈æ Review Details
            </button>
            ${item.status === 'pending' || item.status === 'submitted' ? `
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'approve'); return false;" 
                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                    √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approve
                </button>
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'reject'); return false;" 
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                    √É¬¢√Ç¬ù√Ö‚Äô Reject
                </button>
            ` : `
                <span class="px-3 py-2 bg-gray-100 text-gray-600 rounded text-sm">
                    ${item.status === 'reviewer_approved' ? '√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approved' : 
                      item.status === 'reviewer_rejected' ? '√É¬¢√Ç¬ù√Ö‚Äô Rejected' : 
                      'Reviewed'}
                </span>
            `}
        </div>
    `;
    
    return card;
}

function createDetailedReviewerCard(item) {
    const card = document.createElement('div');
    card.className = `request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow ${
        item.priority === 'assigned' ? 'border-l-4 border-l-blue-500' : 'border-l-4 border-l-gray-400'
    }`;
    
    const typeInfo = {
        'project': { 
            icon: '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬Å', 
            color: 'purple', 
            label: 'Classification Project',
            bgClass: 'bg-purple-100 text-purple-800'
        },
        'code': { 
            icon: '√É¬∞√Ö¬∏√Ç¬è√Ç¬∑√É¬Ø√Ç¬∏√Ç¬è', 
            color: 'green', 
            label: 'Item Code Request',
            bgClass: 'bg-green-100 text-green-800'
        },
        'value': { 
            icon: '√É¬¢√Ö¬æ√¢‚Ç¨¬¢', 
            color: 'blue', 
            label: 'Standard Value Request',
            bgClass: 'bg-blue-100 text-blue-800'
        },
        'block': { 
            icon: '√É¬∞√Ö¬∏√Ö¬°√Ç¬´', 
            color: 'red', 
            label: 'Block Combination',
            bgClass: 'bg-red-100 text-red-800'
        }
    };

    const info = typeInfo[item.type] || typeInfo['code'];
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">${info.icon}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${info.bgClass}">
                        ${info.label}
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        ASSIGNED TO YOU
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.status === 'pending' || item.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' :
                        item.status === 'reviewer_approved' ? 'bg-green-100 text-green-800' :
                        item.status === 'reviewer_rejected' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${item.status?.replace('_', ' ')?.toUpperCase() || 'PENDING'}
                    </span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.title}</h3>
                <p class="text-sm text-gray-600 mb-2">${item.subtitle}</p>
                
                <!-- Detailed Information Grid -->
                <div class="grid grid-cols-2 gap-4 text-xs bg-gray-50 p-3 rounded mt-3">
                    <div>
                        <span class="font-medium text-gray-600">Requester:</span>
                        <p class="text-gray-800">${item.creator_name || 'Unknown'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Reviewer:</span>
                        <p class="text-gray-800">${item.reviewer_name || 'You'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Date:</span>
                        <p class="text-gray-800">${formatDate(item.date)}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">ID:</span>
                        <p class="text-gray-800 font-mono">#${item.id}</p>
                    </div>
                </div>

                ${item.type === 'code' ? `
                    <div class="mt-3 text-xs space-y-1">
                        <div><span class="font-medium">UOM:</span> ${item.uom || 'N/A'}</div>
                        <div><span class="font-medium">Country:</span> ${item.country_of_origin || 'N/A'}</div>
                        <div><span class="font-medium">Model:</span> ${item.model_number || 'N/A'}</div>
                    </div>
                ` : ''}

                ${item.type === 'value' ? `
                    <div class="mt-3 p-2 bg-green-50 rounded text-xs">
                        <span class="font-medium text-green-800">New Value:</span> 
                        <span class="text-green-900 font-bold">${item.new_value}</span>
                        <br>
                        <span class="font-medium text-green-800">Reason:</span> 
                        <span class="text-green-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}

                ${item.type === 'block' ? `
                    <div class="mt-3 p-2 bg-red-50 rounded text-xs">
                        <span class="font-medium text-red-800">Block Reason:</span> 
                        <span class="text-red-900">${item.reason || 'No reason provided'}</span>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <div class="flex space-x-2 mt-4">
            <button onclick="openReviewModal('${item.type}', ${item.id})" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                √É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨≈æ Review Details
            </button>
            ${item.status === 'pending' || item.status === 'submitted' ? `
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'approve'); return false;" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approve
                </button>
                <button onclick="event.preventDefault(); reviewReviewerRequest('${item.type}', ${item.id}, 'reject'); return false;" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    √É¬¢√Ç¬ù√Ö‚Äô Reject
                </button>
            ` : `
                <span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-md text-sm font-medium">
                    ${item.status === 'reviewer_approved' ? '√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ You Approved' : 
                      item.status === 'reviewer_rejected' ? '√É¬¢√Ç¬ù√Ö‚Äô You Rejected' : 
                      'Reviewed'}
                </span>
            `}
        </div>
    `;
    
    return card;
}
async function reviewReviewerRequest(type, requestId, decision) {
    console.log('reviewReviewerRequest called with:', { type, requestId, decision });
    
    // Validate requestId is not undefined
    if (!requestId || requestId === 'undefined') {
        console.error('Invalid requestId:', requestId);
        alert('Error: Invalid request ID. Please refresh the page and try again.');
        return;
    }
    
    // Prevent any form submission or page reload
    event?.preventDefault();
    
    const comments = prompt(`Enter your comments for ${decision === 'approve' ? 'approving' : 'rejecting'} this request:`);
    if (comments === null) {
        console.log('User cancelled the review');
        return; // User cancelled
    }
    
    try {
        console.log('Processing reviewer request:', { type, requestId, decision, comments });
        
        // Show loading state
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'loading-msg-reviewer';
        loadingMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded z-50';
        loadingMsg.textContent = 'Processing...';
        document.body.appendChild(loadingMsg);
        
        let result;
        
        if (type === 'project') {
            // Handle project review using direct database update
            const newStatus = decision === 'approve' ? 'reviewer_approved' : 'reviewer_rejected';
            
            console.log('Updating project with ID:', requestId, 'to status:', newStatus);
            
            const { error } = await supabase
                .from('classification_projects')
                .update({
                    status: newStatus,
                    reviewer_comments: comments,
                    reviewed_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .eq('id', requestId);

            if (error) {
                console.error('Database update error:', error);
                throw error;
            }
            
            console.log('Project status updated successfully');
            
            result = {
                success: true,
                message: decision === 'approve' ? 
                    'Project approved and forwarded to admin for final review' : 
                    'Project rejected'
            };
        } else {
            // Handle item requests using the submitReviewerReview function
            result = await submitReviewerReview(type, requestId, decision, comments);
        }
        
        // Remove loading message
        document.getElementById('loading-msg-reviewer')?.remove();
        
        if (result && result.success) {
            alert(result.message || 'Review submitted successfully');
            await loadPendingRequests();
            await loadDashboardStats();
        } else {
            alert(result?.message || 'Error processing review');
        }
        
    } catch (error) {
        console.error('Error reviewing request:', error);
        
        // Remove loading message
        document.getElementById('loading-msg-reviewer')?.remove();
        
        alert(`Error processing request: ${error.message}`);
    }
}
async function claimRequest(type, requestId) {
    try {
        const confirmed = confirm('Do you want to claim this request for review?');
        if (!confirmed) return;
        
        let table;
        switch(type) {
            case 'code': table = 'item_code_requests'; break;
            case 'value': table = 'standard_value_requests'; break;
            case 'block': table = 'combination_requests'; break;
            default: throw new Error('Unknown request type');
        }
        
        const { error } = await supabase
            .from(table)
            .update({ reviewed_by: currentUser.id })
            .eq('id', requestId)
            .is('reviewed_by', null);
        
        if (error) throw error;
        
        alert('Request claimed successfully!');
        await loadPendingRequests();
        
    } catch (error) {
        console.error('Error claiming request:', error);
        alert('Error claiming request: ' + error.message);
    }
}
async function loadPendingProjectReviews() {
    try {
        console.log('Loading pending project reviews for reviewer:', currentUser.id);
        
        const { data: projects, error } = await supabase
            .rpc('get_pending_reviews', { reviewer_id_param: currentUser.id });

        console.log('Pending projects response:', projects, error);

        if (error) throw error;

        const container = document.getElementById('pending-requests-container');
        
        if (projects && projects.length > 0) {
            // Add section header for projects
            const projectsSection = document.createElement('div');
            projectsSection.className = 'mb-6';
            projectsSection.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Classification Projects Pending Review (${projects.length})
                </h3>
                <div id="pending-projects-container" class="space-y-4"></div>
            `;
            container.appendChild(projectsSection);

            const projectsContainer = document.getElementById('pending-projects-container');
            projects.forEach(project => {
                projectsContainer.appendChild(createProjectReviewCard(project));
            });
        }
    } catch (error) {
        console.error('Error loading pending project reviews:', error);
    }
}

async function loadPendingItemRequests() {
    try {
        console.log('Loading pending item requests for reviewer:', currentUser.id);
        
        // Get assigned requests
        const [codeRequests, blockRequests, valueRequests] = await Promise.all([
            supabase.from('item_code_requests').select(`
                *, 
                created_by_user:users!item_code_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).eq('reviewed_by', currentUser.id).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('combination_requests').select(`
                *, 
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).eq('reviewed_by', currentUser.id).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('standard_value_requests').select(`
                *, 
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).eq('reviewed_by', currentUser.id).eq('status', 'pending').order('created_at', { ascending: false })
        ]);

        // Get unassigned requests
        const [unassignedCodes, unassignedBlocks, unassignedValues] = await Promise.all([
            supabase.from('item_code_requests').select(`
                *, 
                created_by_user:users!item_code_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).is('reviewed_by', null).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('combination_requests').select(`
                *, 
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).is('reviewed_by', null).eq('status', 'pending').order('created_at', { ascending: false }),
            
            supabase.from('standard_value_requests').select(`
                *, 
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `).is('reviewed_by', null).eq('status', 'pending').order('created_at', { ascending: false })
        ]);

        const container = document.getElementById('pending-requests-container');

        // Combine assigned and unassigned requests
        const assignedRequests = [
            ...(codeRequests.data || []).map(r => ({...r, type: 'code', isAssigned: true})),
            ...(blockRequests.data || []).map(r => ({...r, type: 'block', isAssigned: true})),
            ...(valueRequests.data || []).map(r => ({...r, type: 'value', isAssigned: true}))
        ];

        const unassignedRequests = [
            ...(unassignedCodes.data || []).map(r => ({...r, type: 'code', isAssigned: false})),
            ...(unassignedBlocks.data || []).map(r => ({...r, type: 'block', isAssigned: false})),
            ...(unassignedValues.data || []).map(r => ({...r, type: 'value', isAssigned: false}))
        ];

        // Add item requests sections
        if (assignedRequests.length > 0 || unassignedRequests.length > 0) {
            const itemsSection = document.createElement('div');
            itemsSection.className = 'mt-8';
            itemsSection.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Item Requests Pending Review
                </h3>
            `;
            container.appendChild(itemsSection);

            if (assignedRequests.length > 0) {
                const assignedSection = document.createElement('div');
                assignedSection.innerHTML = `
                    <h4 class="text-md font-medium text-gray-700 mb-3">
                        Assigned to You (${assignedRequests.length})
                    </h4>
                    <div class="grid gap-4 mb-6" id="assigned-requests"></div>
                `;
                container.appendChild(assignedSection);

                const assignedContainer = document.getElementById('assigned-requests');
                assignedRequests.forEach(request => {
                    assignedContainer.appendChild(createPendingRequestCard(request));
                });
            }

            if (unassignedRequests.length > 0) {
                const unassignedSection = document.createElement('div');
                unassignedSection.innerHTML = `
                    <h4 class="text-md font-medium text-gray-700 mb-3">
                        Available to Claim (${unassignedRequests.length})
                    </h4>
                    <div class="grid gap-4" id="unassigned-requests"></div>
                `;
                container.appendChild(unassignedSection);

                const unassignedContainer = document.getElementById('unassigned-requests');
                unassignedRequests.forEach(request => {
                    unassignedContainer.appendChild(createPendingRequestCard(request));
                });
            }
        }

        // Check if there are no requests at all
        const totalRequests = assignedRequests.length + unassignedRequests.length;
        const hasProjects = document.getElementById('pending-projects-container') && 
                           document.getElementById('pending-projects-container').children.length > 0;
        
        if (totalRequests === 0 && !hasProjects) {
            if (!document.querySelector('.no-requests-message')) {
                const noRequestsDiv = document.createElement('div');
                noRequestsDiv.className = 'text-center text-gray-500 py-8 no-requests-message';
                noRequestsDiv.innerHTML = `
                    <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>No pending requests</p>
                `;
                container.appendChild(noRequestsDiv);
            }
        }
    } catch (error) {
        console.error('Error loading pending item requests:', error);
    }
}

// ===== LOAD ALL REQUESTS =====
async function loadAllRequests() {
    try {
        console.log('Loading all requests for user:', currentUser);
        
        // Load user's projects and item requests based on role
        let allRequests = [];
        
        if (currentUser.role === 'reviewer' || currentUser.role === 'admin') {
            // For reviewers and admins, load both projects they've reviewed and item requests
            allRequests = await Promise.all([
                loadUserProjects(),
                loadUserItemRequests()
            ]);
        } else {
            // For other users, load only their own requests
            allRequests = await Promise.all([
                loadUserProjects(),
                loadUserItemRequests()
            ]);
        }
        
        // Flatten the results
        const flatRequests = allRequests.flat();
        
        // Update summary stats
        updateRequestsSummary(flatRequests);
        
        // Display requests
        displayAllRequests(flatRequests);
        
    } catch (error) {
        console.error('Error loading all requests:', error);
        const container = document.getElementById('all-requests-container');
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Error loading requests</div>';
    }
}

async function loadUserProjects() {
    try {
        let query;
        
        if (currentUser.role === 'reviewer') {
            // Load projects assigned to this reviewer
            query = supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                    admin:users!classification_projects_admin_id_fkey(username, email)
                `)
                .eq('assigned_reviewer_id', currentUser.id);
        } else if (currentUser.role === 'admin') {
            // Load all projects for admin
            query = supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                    admin:users!classification_projects_admin_id_fkey(username, email)
                `);
        } else {
            // Load projects created by this user
            query = supabase
                .from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email),
                    reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                    admin:users!classification_projects_admin_id_fkey(username, email)
                `)
                .eq('created_by', currentUser.id);
        }
        
        const { data: projects, error } = await query.order('updated_at', { ascending: false });
        
        if (error) throw error;
        
        return (projects || []).map(project => ({
            ...project,
            type: 'project',
            request_type: 'Classification Project',
            title: project.project_name,
            created_at: project.created_at,
            updated_at: project.updated_at,
            created_by_name: project.creator?.username,
            reviewed_by_name: project.reviewer?.username,
            admin_name: project.admin?.username
        }));
    } catch (error) {
        console.error('Error loading user projects:', error);
        return [];
    }
}

async function loadUserItemRequests() {
    try {
        let codeRequests = [], blockRequests = [], valueRequests = [];
        
        if (currentUser.role === 'reviewer') {
            // Load requests assigned to this reviewer
            const [codes, blocks, values] = await Promise.all([
                supabase.from('item_code_requests').select(`
                    *,
                    created_by_user:users!item_code_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('reviewed_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('combination_requests').select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('reviewed_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('standard_value_requests').select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('reviewed_by', currentUser.id).order('created_at', { ascending: false })
            ]);
            
            codeRequests = codes.data || [];
            blockRequests = blocks.data || [];
            valueRequests = values.data || [];
        } else if (currentUser.role === 'admin') {
            // Load all requests for admin
            const [codes, blocks, values] = await Promise.all([
                supabase.from('item_code_requests').select(`
                    *,
                    created_by_user:users!item_code_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).order('created_at', { ascending: false }),
                
                supabase.from('combination_requests').select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).order('created_at', { ascending: false }),
                
                supabase.from('standard_value_requests').select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).order('created_at', { ascending: false })
            ]);
            
            codeRequests = codes.data || [];
            blockRequests = blocks.data || [];
            valueRequests = values.data || [];
        } else {
            // Load requests created by this user
            const [codes, blocks, values] = await Promise.all([
                supabase.from('item_code_requests').select(`
                    *,
                    created_by_user:users!item_code_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('created_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('combination_requests').select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('created_by', currentUser.id).order('created_at', { ascending: false }),
                
                supabase.from('standard_value_requests').select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name)
                `).eq('created_by', currentUser.id).order('created_at', { ascending: false })
            ]);
            
            codeRequests = codes.data || [];
            blockRequests = blocks.data || [];
            valueRequests = values.data || [];
        }
        
        // Map to standard format
        const allItemRequests = [
            ...codeRequests.map(r => ({
                ...r,
                type: 'code',
                request_type: 'Item Code Request',
                title: r.item_code,
                created_by_name: r.created_by_user?.username,
                reviewed_by_name: r.reviewed_by_user?.username
            })),
            ...blockRequests.map(r => ({
                ...r,
                type: 'block',
                request_type: 'Block Combination Request',
                title: 'Block Combination',
                created_by_name: r.created_by_user?.username,
                reviewed_by_name: r.reviewed_by_user?.username
            })),
            ...valueRequests.map(r => ({
                ...r,
                type: 'value',
                request_type: 'Standard Value Request',
                title: `${r.attribute_name}: ${r.new_value}`,
                created_by_name: r.created_by_user?.username,
                reviewed_by_name: r.reviewed_by_user?.username
            }))
        ];
        
        return allItemRequests;
    } catch (error) {
        console.error('Error loading user item requests:', error);
        return [];
    }
}

function updateRequestsSummary(requests) {
    const total = requests.length;
    const pending = requests.filter(r => r.status === 'pending' || r.status === 'draft').length;
    const underReview = requests.filter(r => r.status === 'submitted' || r.status === 'reviewer_approved').length;
    const approved = requests.filter(r => r.status === 'admin_approved').length;
    const rejected = requests.filter(r => r.status === 'reviewer_rejected' || r.status === 'admin_rejected').length;
    
    document.getElementById('total-requests-count').textContent = total;
    document.getElementById('pending-requests-count').textContent = pending;
    document.getElementById('under-review-count').textContent = underReview;
    document.getElementById('approved-requests-count').textContent = approved;
    document.getElementById('rejected-requests-count').textContent = rejected;
}

function displayAllRequests(requests) {
    const container = document.getElementById('all-requests-container');
    container.innerHTML = '';
    
    if (requests.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-lg">No requests found</p>
                <p class="text-sm">Try adjusting your filters or create a new request</p>
            </div>
        `;
        return;
    }
    
    // Group requests by type
    const groupedRequests = {
        project: requests.filter(r => r.type === 'project'),
        code: requests.filter(r => r.type === 'code'),
        block: requests.filter(r => r.type === 'block'),
        value: requests.filter(r => r.type === 'value')
    };
    
    // Display each group
    Object.entries(groupedRequests).forEach(([type, typeRequests]) => {
        if (typeRequests.length > 0) {
            const sectionTitle = {
                project: 'Classification Projects',
                code: 'Item Code Requests',
                block: 'Block Combination Requests',
                value: 'Standard Value Requests'
            }[type];
            
            const section = document.createElement('div');
            section.className = 'mb-8';
            section.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <span class="mr-2">${getTypeIcon(type)}</span>
                    ${sectionTitle} (${typeRequests.length})
                </h3>
                <div class="grid gap-4" id="${type}-requests-section"></div>
            `;
            container.appendChild(section);
            
            const sectionContainer = document.getElementById(`${type}-requests-section`);
            typeRequests.forEach(request => {
                sectionContainer.appendChild(createAllRequestCard(request));
            });
        }
    });
}

function getTypeIcon(type) {
    const icons = {
        project: '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π',
        code: '√É¬∞√Ö¬∏√Ç¬è√Ç¬∑√É¬Ø√Ç¬∏√Ç¬è',
        block: '√É¬∞√Ö¬∏√Ö¬°√Ç¬´',
        value: '√É¬¢√Ç¬≠√Ç¬ê'
    };
    return icons[type] || '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨≈æ';
}

function createAllRequestCard(request) {
    const card = document.createElement('div');
    card.className = 'request-card bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
    
    const statusClass = getStatusClass(request.status);
    const statusText = getStatusText(request.status);
    const canReview = canUserReview(request);
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">${request.request_type}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">${statusText}</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">${request.title}</h3>
                <p class="text-sm text-gray-600">${request.project?.project_name || 'No Project'}</p>
            </div>
            <div class="flex space-x-2 ml-4">
                ${canReview ? 
                    `<button onclick="openReviewModal('${request.type}', ${request.id})" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        Review
                    </button>` : ''
                }
                <button onclick="openReviewModal('${request.type}', ${request.id})" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                    View Details
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm bg-gray-50 p-3 rounded">
            <div>
                <span class="font-medium text-gray-600">Created by:</span>
                <p>${request.created_by_name || 'Unknown'}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Created:</span>
                <p>${new Date(request.created_at).toLocaleDateString()}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Last Updated:</span>
                <p>${new Date(request.updated_at || request.created_at).toLocaleDateString()}</p>
            </div>
            ${request.reviewed_by_name ? `
            <div>
                <span class="font-medium text-gray-600">Reviewed by:</span>
                <p>${request.reviewed_by_name}</p>
            </div>
            ` : ''}
            ${request.admin_name ? `
            <div>
                <span class="font-medium text-gray-600">Admin:</span>
                <p>${request.admin_name}</p>
            </div>
            ` : ''}
            <div>
                <span class="font-medium text-gray-600">Request ID:</span>
                <p class="font-mono text-xs">${request.id}</p>
            </div>
        </div>
        
        ${(request.reviewer_comments || request.admin_comments || request.review_comments) ? `
        <div class="mt-4 p-3 bg-blue-50 rounded border-l-4 border-blue-200">
            <span class="font-medium text-gray-600">Comments:</span>
            <p class="text-sm text-gray-800 mt-1">${request.reviewer_comments || request.admin_comments || request.review_comments}</p>
        </div>
        ` : ''}
    `;
    
    return card;
}

function getStatusClass(status) {
    const classes = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'draft': 'bg-gray-100 text-gray-800',
        'submitted': 'bg-blue-100 text-blue-800',
        'reviewer_approved': 'bg-green-100 text-green-800',
        'reviewer_rejected': 'bg-red-100 text-red-800',
        'admin_approved': 'bg-green-100 text-green-800',
        'admin_rejected': 'bg-red-100 text-red-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'pending': 'PENDING',
        'draft': 'DRAFT',
        'submitted': 'SUBMITTED',
        'reviewer_approved': 'REVIEWER APPROVED',
        'reviewer_rejected': 'REVIEWER REJECTED',
        'admin_approved': 'ADMIN APPROVED',
        'admin_rejected': 'ADMIN REJECTED'
    };
    return texts[status] || status.toUpperCase();
}

function canUserReview(request) {
    if (currentUser.role === 'admin') {
        return request.status === 'reviewer_approved';
    } else if (currentUser.role === 'reviewer') {
        return request.status === 'submitted' || request.status === 'pending';
    }
    return false;
}

async function applyFilters() {
    const statusFilter = document.getElementById('status-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    
    console.log('Applying filters:', { statusFilter, typeFilter, dateFilter });
    
    try {
        // Load all requests first
        const allRequests = await loadUserItemRequests();
        
        // Apply filters
        let filteredRequests = allRequests;
        
        // Filter by status
        if (statusFilter) {
            filteredRequests = filteredRequests.filter(request => request.status === statusFilter);
        }
        
        // Filter by type
        if (typeFilter) {
            if (typeFilter === 'project') {
                // Load and filter projects
                const projects = await loadUserProjects();
                const filteredProjects = statusFilter ? 
                    projects.filter(p => p.status === statusFilter) : projects;
                
                filteredRequests = [
                    ...filteredProjects.map(p => ({...p, type: 'project'})),
                    ...filteredRequests.filter(r => r.type !== 'project')
                ];
            } else {
                filteredRequests = filteredRequests.filter(request => request.type === typeFilter);
            }
        } else {
            // If no type filter, include projects
            const projects = await loadUserProjects();
            const filteredProjects = statusFilter ? 
                projects.filter(p => p.status === statusFilter) : projects;
            
            filteredRequests = [
                ...filteredProjects.map(p => ({...p, type: 'project'})),
                ...filteredRequests
            ];
        }
        
        // Filter by date
        if (dateFilter) {
            const now = new Date();
            let dateThreshold;
            
            switch(dateFilter) {
                case 'today':
                    dateThreshold = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    dateThreshold = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    dateThreshold = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    dateThreshold = null;
            }
            
            if (dateThreshold) {
                filteredRequests = filteredRequests.filter(request => {
                    const requestDate = new Date(request.created_at);
                    return requestDate >= dateThreshold;
                });
            }
        }
        
        // Update display
        updateRequestsSummary(filteredRequests);
        displayAllRequests(filteredRequests);
        
    } catch (error) {
        console.error('Error applying filters:', error);
        alert('Error applying filters');
    }
}
async function loadAdminAwaitingApproval() {
    try {
        console.log('Loading admin awaiting approval');
        const container = document.getElementById('pending-requests-container');
        container.innerHTML = '';

        // Load projects pending admin approval (status = 'reviewer_approved')
        const { data: projects, error: projectError } = await supabase
            .from('classification_projects')
            .select(`
                *,
                creator:users!classification_projects_created_by_fkey(username, email),
                reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email),
                attribute_count:project_attributes(count)
            `)
            .eq('status', 'reviewer_approved')
            .order('reviewed_at', { ascending: true });

        if (projectError) {
            console.error('Error loading pending admin projects:', projectError);
        }

        // Load all types of requests that need admin approval
        const [codeRequests, blockRequests, valueRequests] = await Promise.all([
            // Item code requests pending admin approval
            supabase.from('item_code_requests').select(`
                *,
                created_by_user:users!item_code_requests_created_by_fkey(username, email),
                reviewed_by_user:users!item_code_requests_reviewed_by_fkey(username, email),
                project:classification_projects(project_name)
            `).in('status', ['reviewer_approved', 'pending']).order('created_at', { ascending: false }),
            
            // Combination requests pending admin approval
            supabase.from('combination_requests').select(`
                *,
                created_by_user:users!combination_requests_created_by_fkey(username, email),
                reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                project:classification_projects(project_name)
            `).in('status', ['reviewer_approved', 'pending']).order('created_at', { ascending: false }),
            
            // Standard value requests pending admin approval
            supabase.from('standard_value_requests').select(`
                *,
                created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                project:classification_projects(project_name)
            `).in('status', ['reviewer_approved', 'pending']).order('created_at', { ascending: false })
        ]);

        console.log('Admin pending data:', {
            projects: projects?.length || 0,
            codeRequests: codeRequests.data?.length || 0,
            blockRequests: blockRequests.data?.length || 0,
            valueRequests: valueRequests.data?.length || 0
        });

        let hasContent = false;

        // Add projects pending admin approval
        if (projects && projects.length > 0) {
            hasContent = true;
            const projectsSection = document.createElement('div');
            projectsSection.className = 'mb-6';
            projectsSection.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Classification Projects Pending Admin Approval (${projects.length})
                </h3>
                <div id="pending-admin-projects-container" class="space-y-4"></div>
            `;
            container.appendChild(projectsSection);

            const projectsContainer = document.getElementById('pending-admin-projects-container');
            projects.forEach(project => {
                // Flatten the attribute count
                const flattenedProject = {
                    ...project,
                    project_id: project.id,
                    creator_name: project.creator?.username || 'Unknown',
                    reviewer_name: project.reviewer?.username || 'Unknown',
                    reviewer_approved_at: project.reviewed_at,
                    attribute_count: project.attribute_count?.[0]?.count || 0
                };
                projectsContainer.appendChild(createAdminProjectReviewCard(flattenedProject));
            });
        }

        // Process and display all request types
        const allRequests = [
            ...(codeRequests.data || []).map(r => ({
                ...r,
                type: 'code',
                request_type: 'Item Code Request',
                title: r.item_code || 'New Item Code',
                created_by_name: r.created_by_user?.username || 'Unknown',
                reviewed_by_name: r.reviewed_by_user?.username || 'Unknown'
            })),
            ...(blockRequests.data || []).map(r => ({
                ...r,
                type: 'block',
                request_type: 'Block Combination Request',
                title: 'Block Combination',
                created_by_name: r.created_by_user?.username || 'Unknown',
                reviewed_by_name: r.reviewed_by_user?.username || 'Unknown'
            })),
            ...(valueRequests.data || []).map(r => ({
                ...r,
                type: 'value',
                request_type: 'Standard Value Request',
                title: `${r.attribute_name}: ${r.new_value}`,
                created_by_name: r.created_by_user?.username || 'Unknown',
                reviewed_by_name: r.reviewed_by_user?.username || 'Unknown'
            }))
        ];

        if (allRequests.length > 0) {
            hasContent = true;
            
            // Group requests by status
            const pendingRequests = allRequests.filter(r => r.status === 'pending');
            const reviewerApprovedRequests = allRequests.filter(r => r.status === 'reviewer_approved');
            
            // Show reviewer approved requests first (higher priority)
            if (reviewerApprovedRequests.length > 0) {
                const reviewerApprovedSection = document.createElement('div');
                reviewerApprovedSection.className = 'mt-8';
                reviewerApprovedSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        Requests Approved by Reviewer - Awaiting Admin Decision (${reviewerApprovedRequests.length})
                    </h3>
                    <div id="reviewer-approved-requests-container" class="space-y-4"></div>
                `;
                container.appendChild(reviewerApprovedSection);

                const reviewerApprovedContainer = document.getElementById('reviewer-approved-requests-container');
                reviewerApprovedRequests.forEach(request => {
                    const cardElement = document.createElement('div');
cardElement.innerHTML = createAdminRequestReviewCard(request);
reviewerApprovedContainer.appendChild(cardElement.firstElementChild);
                });
            }
            
            // Show pending requests
            if (pendingRequests.length > 0) {
                const pendingSection = document.createElement('div');
                pendingSection.className = 'mt-8';
                pendingSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Other Pending Requests (${pendingRequests.length})
                    </h3>
                    <div id="pending-other-requests-container" class="space-y-4"></div>
                `;
                container.appendChild(pendingSection);

                const pendingContainer = document.getElementById('pending-other-requests-container');
                pendingRequests.forEach(request => {
                    const cardElement = document.createElement('div');
cardElement.innerHTML = createAdminRequestReviewCard(request);
pendingContainer.appendChild(cardElement.firstElementChild);
                });
            }
        }

        if (!hasContent) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg">No items pending admin approval</p>
                    <p class="text-sm">All submissions have been processed</p>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading admin awaiting approval:', error);
        const container = document.getElementById('pending-requests-container');
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Error loading admin requests</div>';
    }
}

// ===== CREATE ITEM CODE FROM APPROVED REQUEST =====
async function createItemCodeFromRequest(requestId) {
    try {
        console.log('Creating item code from request ID:', requestId);
        
        // Get the approved request details
        const { data: request, error: fetchError } = await supabase
            .from('item_code_requests')
            .select('*')
            .eq('id', requestId)
            .single();
            
        if (fetchError) {
            console.error('Error fetching request:', fetchError);
            throw fetchError;
        }
        
        if (!request) {
            throw new Error('Request not found');
        }
        
        console.log('Request data:', request);
        
        // Generate duplicate check hash
        const hashInput = [
            request.project_id || '',
            JSON.stringify(request.attribute_selections || {}),
            request.uom || '',
            request.country_of_origin || '',
            request.model_number || ''
        ].join('|');
        
        // Simple hash function
        let hash = 0;
        for (let i = 0; i < hashInput.length; i++) {
            const char = hashInput.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        const duplicateCheckHash = Math.abs(hash).toString(16);
        
        // Extract serial number from item code (last part after final dash)
        let serialNumber = 1;
        if (request.item_code) {
            const parts = request.item_code.split('-');
            const lastPart = parts[parts.length - 1];
            if (!isNaN(lastPart)) {
                serialNumber = parseInt(lastPart);
            }
        }
        
        // Create the item code entry
        const itemCodeData = {
            project_id: request.project_id,
            csi_base_code: request.csi_division_code,
            csi_description: null, // Will be populated by trigger if needed
            additional_level: request.additional_level,
            item_code: request.item_code,
            description1: request.description1,
            description2: request.description2,
            combination_signature: request.combination_signature,
            attribute_selections: request.attribute_selections,
            uom: request.uom,
            country_of_origin: request.country_of_origin,
            model_number: request.model_number,
            serial_number: serialNumber,
            created_by: request.created_by,
            status: 'approved',
            approved_by: currentUser.id,
            approved_at: new Date().toISOString(),
            duplicate_check_hash: duplicateCheckHash,
            erp_integrated: false
        };
        
        console.log('Creating item code with data:', itemCodeData);
        
        const { data: newItemCode, error: insertError } = await supabase
            .from('item_codes')
            .insert([itemCodeData])
            .select()
            .single();
            
        if (insertError) {
            console.error('Error creating item code:', insertError);
            throw insertError;
        }
        
        console.log('Item code created successfully:', newItemCode);
        return newItemCode;
        
    } catch (error) {
        console.error('Error in createItemCodeFromRequest:', error);
        throw error;
    }
}
// ===== REVIEW SUBMISSION FUNCTIONS =====
async function submitReviewerReview(type, id, decision, comments) {
    const newStatus = decision === 'approve' ? 'reviewer_approved' : 'reviewer_rejected';
    
    let table, updateData;
    
    switch(type) {
        case 'code':
            table = 'item_code_requests';
            updateData = {
                status: newStatus,
                review_comments: comments,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            };
            break;
        case 'block':
            table = 'combination_requests';
            updateData = {
                status: newStatus,
                reviewer_comments: comments,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            };
            break;
        case 'value':
            table = 'standard_value_requests';
            updateData = {
                status: newStatus,
                reviewer_comments: comments,
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            };
            break;
    }
    
    const { error } = await supabase
        .from(table)
        .update(updateData)
        .eq('id', id);
    
    if (error) {
        console.error('Database update error:', error);
        throw error;
    }
    
    return {
        success: true,
        message: decision === 'approve' ? 
            'Request approved and forwarded to admin for final review' : 
            'Request rejected'
    };
}
async function submitAdminReview(type, id, decision, comments) {
    try {
        console.log('submitAdminReview called with:', { type, id, decision, comments });
        
        if (type === 'project') {
            // Handle project review using the correct RPC function
            const { data, error } = await supabase.rpc('admin_review_decision', {
                project_id_param: id,
                admin_id_param: currentUser.id,
                decision_param: decision,
                comments_param: comments
            });
            
            if (error) {
                console.error('RPC error:', error);
                throw error;
            }
            
            console.log('Admin review decision response:', data);
            return data;
        }
        
        // Handle item requests - normalize decision values
        const normalizedDecision = decision === 'approved' ? 'approve' : decision === 'rejected' ? 'reject' : decision;
        const newStatus = normalizedDecision === 'approve' ? 'admin_approved' : 'admin_rejected';
        
        let table, updateData;
        
        switch(type) {
            case 'code':
                table = 'item_code_requests';
                updateData = {
                    status: newStatus,
                    review_comments: comments,
                    reviewed_at: new Date().toISOString()
                };
                break;
            case 'block':
                table = 'combination_requests';
                updateData = {
                    status: newStatus,
                    admin_comments: comments,
                    admin_reviewed_by: currentUser.id,
                    admin_reviewed_at: new Date().toISOString()
                };
                break;
            case 'value':
                table = 'standard_value_requests';
                updateData = {
                    status: newStatus,
                    admin_comments: comments,
                    admin_reviewed_by: currentUser.id,
                    admin_reviewed_at: new Date().toISOString()
                };
                break;
            default:
                throw new Error('Unknown request type: ' + type);
        }
        
        console.log('Updating table:', table, 'with data:', updateData);
        
        const { error } = await supabase
            .from(table)
            .update(updateData)
            .eq('id', id);
        
        if (error) {
            console.error('Database update error:', error);
            throw error;
        }

        // ADDED: Handle item code creation for admin-approved item_code_requests
        if (table === 'item_code_requests' && newStatus === 'admin_approved') {
            console.log('Creating item code for admin-approved request...');
            try {
                await createItemCodeFromRequest(id);
                console.log('Item code created successfully for request:', id);
            } catch (createError) {
                console.error('Error creating item code:', createError);
                // Note: We don't throw here to avoid rolling back the approval
                // The request is still approved, but item code creation failed
            }
        }
        
        return {
            success: true,
            message: normalizedDecision === 'approve' ? 
                'Request approved successfully' : 
                'Request rejected successfully'
        };
    } catch (error) {
        console.error('Error in submitAdminReview:', error);
        return {
            success: false,
            message: 'Error processing review: ' + error.message
        };
    }
}
// ===== DASHBOARD STATS =====
async function loadDashboardStats() {
    try {
        console.log('Loading dashboard stats for user:', currentUser);
        
        if (currentUser.role === 'reviewer') {
            const { data: stats, error } = await supabase
                .rpc('get_reviewer_stats', { reviewer_id_param: currentUser.id });
            
            if (error) throw error;
            
            console.log('Reviewer stats:', stats);
            
            if (stats) {
                document.getElementById('pending-count').textContent = stats.pending || 0;
                document.getElementById('approved-count').textContent = stats.approved || 0;
                document.getElementById('rejected-count').textContent = stats.rejected || 0;
                document.getElementById('reviewer-approved-count').textContent = stats.total_assigned || 0;
            }
        } else if (currentUser.role === 'admin') {
            const { data: stats, error } = await supabase
                .rpc('get_admin_stats', { admin_id_param: currentUser.id });
            
            if (error) throw error;
            
            console.log('Admin stats:', stats);
            
            if (stats) {
                document.getElementById('pending-count').textContent = stats.pending_admin_approval || 0;
                document.getElementById('approved-count').textContent = stats.admin_approved || 0;
                document.getElementById('rejected-count').textContent = stats.admin_rejected || 0;
                document.getElementById('reviewer-approved-count').textContent = stats.total_in_system || 0;
            }
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

// ===== LOGIN FUNCTIONS =====
async function handleLogin(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const email = formData.get('email');
    const password = formData.get('password');
    
    try {
        console.log('Attempting login for:', email);
        
        const { data, error } = await supabase
            .rpc('authenticate_user', {
                email_param: email,
                password_param: password
            });
        
        console.log('Login response:', data);
        
        if (error) throw error;
        
        if (data.success) {
            currentUser = data.user;
            console.log('Login successful:', currentUser);
            
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('main-container').classList.remove('hidden');
            document.getElementById('user-info').textContent = `${currentUser.username} (${currentUser.role})`;
            
            // Show admin tab if user is admin
            if (currentUser.role === 'admin') {
                document.getElementById('admin-tab').classList.remove('hidden');
            }
            
            // Show reviewer history tab if user is reviewer
            if (currentUser.role === 'reviewer') {
                document.getElementById('reviewer-history-btn').classList.remove('hidden');
            }
            
            await loadDashboardStats();
            await loadPendingRequests();
        } else {
            document.getElementById('login-error').textContent = data.message;
            document.getElementById('login-error').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Login error:', error);
        document.getElementById('login-error').textContent = 'Login failed. Please try again.';
        document.getElementById('login-error').classList.remove('hidden');
    }
}

function handleLogout() {
    currentUser = null;
    document.getElementById('main-container').classList.add('hidden');
    document.getElementById('login-modal').classList.remove('hidden');
    document.getElementById('login-error').classList.add('hidden');
    document.getElementById('admin-tab').classList.add('hidden');
    document.getElementById('reviewer-history-btn').classList.add('hidden');
}

// ===== TAB FUNCTIONS =====
function switchTab(tabName) {
    console.log('=== SWITCHING TO TAB:', tabName, '===');
    
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active state from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab
    const targetTab = document.getElementById(tabName + '-tab');
    console.log('Target tab element:', targetTab);
    console.log('Target tab tagName:', targetTab?.tagName);
    console.log('Target tab classes:', targetTab?.className);
    
    if (targetTab) {
        if (targetTab.tagName === 'BUTTON') {
            console.error('ERROR: Found button instead of content div! ID conflict detected.');
            console.log('Looking for content div with class tab-content...');
            
            // Try to find the actual content div
            const contentDivs = document.querySelectorAll('.tab-content');
            console.log('Available content divs:', contentDivs);
            
            contentDivs.forEach(div => {
                if (div.id === tabName + '-tab') {
                    console.log('Found correct content div:', div);
                    div.classList.remove('hidden');
                }
            });
        } else {
            targetTab.classList.remove('hidden');
            console.log('Tab should now be visible');
        }
    } else {
        console.error('Target tab not found:', tabName + '-tab');
    }
    
    // Add active state to clicked button
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.add('border-blue-500', 'text-blue-600');
    activeBtn.classList.remove('border-transparent', 'text-gray-500');
    
    // Load appropriate content
    if (tabName === 'pending-requests') {
        loadPendingRequests();
    } else if (tabName === 'all-requests') {
        loadAllRequests();
    } else if (tabName === 'reviewer-history') {
        loadReviewerHistory();
    } else if (tabName === 'admin-panel') {
        loadAdminPanel();
    }
}

async function loadAdminPanel() {
    const container = document.getElementById('admin-panel-container');
    container.innerHTML = '<div class="text-center text-gray-500 py-8">Admin panel functionality - to be implemented</div>';
}

// ===== REVIEWER HISTORY FUNCTIONS =====
async function loadReviewerHistory() {
    try {
        console.log('=== LOADING REVIEWER HISTORY ===');
        console.log('Current user:', currentUser);
        console.log('User role:', currentUser?.role);
        console.log('User ID:', currentUser?.id);
        
        if (currentUser.role !== 'reviewer') {
            console.log('User is not a reviewer, showing access denied message');
            const container = document.getElementById('reviewer-history-container');
            container.innerHTML = '<div class="text-center text-gray-500 py-8">This section is only available for reviewers</div>';
            return;
        }

        console.log('Starting queries for reviewer history...');
        
        // Load all requests reviewed by this user (approved or rejected)
        const [
            reviewedProjects,
            reviewedItemCodes,
            reviewedStandardValues,
            reviewedCombinations
        ] = await Promise.all([
            // Projects reviewed by this reviewer
            supabase.from('classification_projects')
                .select(`
                    *,
                    creator:users!classification_projects_created_by_fkey(username, email)
                `)
                .eq('assigned_reviewer_id', currentUser.id)
                .in('status', ['reviewer_approved', 'reviewer_rejected', 'admin_approved', 'admin_rejected'])
                .not('reviewed_at', 'is', null)  // Only get items that have been reviewed
                .order('reviewed_at', { ascending: false }),

            // Item code requests reviewed by this reviewer
            supabase.from('item_code_requests')
                .select(`
                    *,
                    created_by_user:users!item_code_requests_created_by_fkey(username, email),
                    project:classification_projects(project_name)
                `)
                .eq('reviewed_by', currentUser.id)
                .in('status', ['reviewer_approved', 'reviewer_rejected', 'admin_approved', 'admin_rejected'])
                .not('reviewed_at', 'is', null)  // Only get items that have been reviewed
                .order('reviewed_at', { ascending: false }),

            // Standard value requests reviewed by this reviewer
            supabase.from('standard_value_requests')
                .select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    project:classification_projects(project_name)
                `)
                .eq('reviewed_by', currentUser.id)
                .in('status', ['reviewer_approved', 'reviewer_rejected', 'admin_approved', 'admin_rejected'])
                .not('reviewed_at', 'is', null)  // Only get items that have been reviewed
                .order('reviewed_at', { ascending: false }),

            // Combination requests reviewed by this reviewer
            supabase.from('combination_requests')
                .select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    project:classification_projects(project_name)
                `)
                .eq('reviewed_by', currentUser.id)
                .in('status', ['reviewer_approved', 'reviewer_rejected', 'admin_approved', 'admin_rejected'])
                .not('reviewed_at', 'is', null)  // Only get items that have been reviewed
                .order('reviewed_at', { ascending: false })
        ]);

        console.log('=== QUERY RESULTS ===');
        console.log('Projects query result:', reviewedProjects);
        console.log('Item codes query result:', reviewedItemCodes);
        console.log('Standard values query result:', reviewedStandardValues);
        console.log('Combinations query result:', reviewedCombinations);

        console.log('=== DATA COUNTS ===');
        console.log('Projects:', reviewedProjects.data?.length || 0);
        console.log('Item codes:', reviewedItemCodes.data?.length || 0);
        console.log('Standard values:', reviewedStandardValues.data?.length || 0);
        console.log('Combinations:', reviewedCombinations.data?.length || 0);

        // Check for errors
        if (reviewedProjects.error) console.error('Projects query error:', reviewedProjects.error);
        if (reviewedItemCodes.error) console.error('Item codes query error:', reviewedItemCodes.error);
        if (reviewedStandardValues.error) console.error('Standard values query error:', reviewedStandardValues.error);
        if (reviewedCombinations.error) console.error('Combinations query error:', reviewedCombinations.error);

        // Combine all reviewed items
        const allReviewedItems = [
            ...(reviewedProjects.data || []).map(p => ({
                ...p,
                type: 'project',
                title: p.project_name,
                subtitle: `${p.division_code}-${p.section_code}-${p.detailed_section_code}-${p.item_code}`,
                creator_name: p.creator?.username,
                date: p.reviewed_at,
                my_action: p.status.startsWith('reviewer_') ? p.status : (p.status.includes('approved') ? 'reviewer_approved' : 'reviewer_rejected'),
                final_status: p.status
            })),
            ...(reviewedItemCodes.data || []).map(r => ({
                ...r,
                type: 'code',
                title: r.item_code || 'Item Code Request',
                subtitle: r.project?.project_name || 'Unknown Project',
                creator_name: r.created_by_user?.username,
                date: r.reviewed_at,
                my_action: r.status.startsWith('reviewer_') ? r.status : (r.status.includes('approved') ? 'reviewer_approved' : 'reviewer_rejected'),
                final_status: r.status
            })),
            ...(reviewedStandardValues.data || []).map(r => ({
                ...r,
                type: 'value',
                title: `Add Value: ${r.new_value}`,
                subtitle: `Attribute: ${r.attribute_name}`,
                creator_name: r.created_by_user?.username,
                date: r.reviewed_at,
                my_action: r.status.startsWith('reviewer_') ? r.status : (r.status.includes('approved') ? 'reviewer_approved' : 'reviewer_rejected'),
                final_status: r.status
            })),
            ...(reviewedCombinations.data || []).map(r => ({
                ...r,
                type: 'block',
                title: 'Block Combination',
                subtitle: r.project?.project_name || 'Unknown Project',
                creator_name: r.created_by_user?.username,
                date: r.reviewed_at,
                my_action: r.status.startsWith('reviewer_') ? r.status : (r.status.includes('approved') ? 'reviewer_approved' : 'reviewer_rejected'),
                final_status: r.status
            }))
        ];

        console.log('=== PROCESSED DATA ===');
        console.log('Total reviewed items:', allReviewedItems.length);
        console.log('Sample items:', allReviewedItems.slice(0, 3));

        // Check for any null dates that might cause issues
        if (allReviewedItems.length > 0) {
            const itemsWithNullDates = allReviewedItems.filter(item => !item.date);
            if (itemsWithNullDates.length > 0) {
                console.warn('Items with null dates found:', itemsWithNullDates);
            }
        }

        // Add a test message if we have no data but expect some
        if (allReviewedItems.length === 0) {
            console.log('No reviewed items found. This could be because:');
            console.log('1. The reviewer has not reviewed any items yet');
            console.log('2. The items do not have status: reviewer_approved/rejected/admin_approved/rejected');
            console.log('3. The items do not have reviewed_by = currentUser.id');
            console.log('4. The reviewed_at field is null');
            console.log('5. There might be a database connection issue');
        }

        // Store globally for filtering
        window.allReviewedItems = allReviewedItems;

        // Update summary stats
        console.log('Updating summary stats...');
        updateHistorySummary(allReviewedItems);

        // Display all reviewed items
        console.log('Displaying reviewer history...');
        displayReviewerHistory(allReviewedItems);

        console.log('=== REVIEWER HISTORY LOAD COMPLETE ===');

    } catch (error) {
        console.error('Error loading reviewer history:', error);
        const container = document.getElementById('reviewer-history-container');
        container.innerHTML = '<div class="text-center text-red-500 py-8">Error loading review history</div>';
    }
}

function updateHistorySummary(items) {
    const approved = items.filter(item => item.my_action === 'reviewer_approved').length;
    const rejected = items.filter(item => item.my_action === 'reviewer_rejected').length;
    const total = items.length;

    document.getElementById('history-approved-count').textContent = approved;
    document.getElementById('history-rejected-count').textContent = rejected;
    document.getElementById('history-total-count').textContent = total;
}

function displayReviewerHistory(items) {
    console.log('=== DISPLAYING REVIEWER HISTORY ===');
    console.log('Items received:', items.length);
    console.log('Container element:', document.getElementById('reviewer-history-container'));
    
    const container = document.getElementById('reviewer-history-container');
    
    if (!container) {
        console.error('ERROR: reviewer-history-container not found!');
        return;
    }
    
    container.innerHTML = '';
    console.log('Container cleared');

    if (items.length === 0) {
        console.log('No items to display, showing empty message');
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-lg">No Review History</p>
                <p class="text-sm">You haven't reviewed any items yet</p>
                <p class="text-xs text-gray-400 mt-2">Debug: Container found but no items to display</p>
            </div>
        `;
        return;
    }

    // Group by action type
    const approvedItems = items.filter(item => item.my_action === 'reviewer_approved');
    const rejectedItems = items.filter(item => item.my_action === 'reviewer_rejected');
    
    console.log('Approved items:', approvedItems.length);
    console.log('Rejected items:', rejectedItems.length);

    // Display approved section
    if (approvedItems.length > 0) {
        const approvedSection = document.createElement('div');
        approvedSection.className = 'mb-8';
        approvedSection.innerHTML = `
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ‚úÖ ITEMS I APPROVED (${approvedItems.length})
                </h3>
                <p class="text-sm text-green-700">Items you reviewed and approved</p>
            </div>
            <div id="approved-history-container" class="space-y-4"></div>
        `;
        container.appendChild(approvedSection);

        const approvedContainer = document.getElementById('approved-history-container');
        approvedItems.forEach(item => {
            approvedContainer.appendChild(createHistoryCard(item));
        });
    }

    // Display rejected section
    if (rejectedItems.length > 0) {
        const rejectedSection = document.createElement('div');
        rejectedSection.className = 'mb-8';
        rejectedSection.innerHTML = `
            <div class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-red-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    ‚ùå ITEMS I REJECTED (${rejectedItems.length})
                </h3>
                <p class="text-sm text-red-700">Items you reviewed and rejected</p>
            </div>
            <div id="rejected-history-container" class="space-y-4"></div>
        `;
        container.appendChild(rejectedSection);

        const rejectedContainer = document.getElementById('rejected-history-container');
        rejectedItems.forEach(item => {
            rejectedContainer.appendChild(createHistoryCard(item));
        });
    }
    
    console.log('=== DISPLAY COMPLETE ===');
    console.log('Final container HTML length:', container.innerHTML.length);
    console.log('Container visibility check:', {
        display: getComputedStyle(container).display,
        visibility: getComputedStyle(container).visibility,
        opacity: getComputedStyle(container).opacity,
        height: getComputedStyle(container).height
    });
    
    // Force visibility to ensure it's not hidden by CSS
    container.style.display = 'block';
    container.style.visibility = 'visible';
    container.style.opacity = '1';
}

function createHistoryCard(item) {
    const card = document.createElement('div');
    card.className = 'bg-white border rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow border-l-4 ' + 
        (item.my_action === 'reviewer_approved' ? 'border-l-green-500' : 'border-l-red-500');
    
    const typeInfo = {
        'project': { icon: 'üìã', label: 'Classification Project', bgClass: 'bg-purple-100 text-purple-800' },
        'code': { icon: 'üè∑Ô∏è', label: 'Item Code Request', bgClass: 'bg-green-100 text-green-800' },
        'value': { icon: '‚≠ê', label: 'Standard Value Request', bgClass: 'bg-blue-100 text-blue-800' },
        'block': { icon: 'üö´', label: 'Block Combination', bgClass: 'bg-red-100 text-red-800' }
    };

    const info = typeInfo[item.type] || typeInfo['code'];
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">${info.icon}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${info.bgClass}">
                        ${info.label}
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.my_action === 'reviewer_approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        MY ACTION: ${item.my_action === 'reviewer_approved' ? 'APPROVED' : 'REJECTED'}
                    </span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${
                        item.final_status.includes('approved') ? 'bg-green-100 text-green-800' : 
                        item.final_status.includes('rejected') ? 'bg-red-100 text-red-800' : 
                        'bg-yellow-100 text-yellow-800'
                    }">
                        FINAL: ${item.final_status.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
                <h4 class="font-semibold text-gray-900">${item.title}</h4>
                <p class="text-sm text-gray-600">${item.subtitle}</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm bg-gray-50 p-3 rounded">
            <div>
                <span class="font-medium text-gray-600">Created by:</span>
                <p>${item.creator_name || 'Unknown'}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">My Review Date:</span>
                <p>${new Date(item.date).toLocaleDateString()}</p>
            </div>
            <div>
                <span class="font-medium text-gray-600">Request ID:</span>
                <p class="font-mono text-xs">${item.id}</p>
            </div>
        </div>

        ${(item.reviewer_comments || item.review_comments) ? `
        <div class="mt-4 p-3 bg-blue-50 rounded border-l-4 border-blue-200">
            <span class="font-medium text-gray-600">My Comments:</span>
            <p class="text-sm text-gray-800 mt-1">${item.reviewer_comments || item.review_comments}</p>
        </div>
        ` : ''}
    `;
    
    return card;
}

async function applyHistoryFilters() {
    // Use the new comprehensive search function instead
    searchReviewerHistory();
}

// ===== INITIALIZATION =====
async function initializeApp() {
    console.log('Initializing app...');
    
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Add event listeners
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });
    
    console.log('App initialized successfully');
}

// Start the app when page loads
// ===== SEARCH FUNCTIONS =====

// Store original data for filtering
window.originalPendingRequests = [];
window.originalReviewHistory = [];
window.originalAdminRequests = [];

function searchPendingRequests() {
    const requestIdSearch = document.getElementById('pending-request-id-search').value.toLowerCase();
    const projectIdSearch = document.getElementById('pending-project-search').value.toLowerCase();
    const creatorSearch = document.getElementById('pending-creator-search').value.toLowerCase();
    
    if (!window.originalPendingRequests || window.originalPendingRequests.length === 0) {
        console.log('No pending requests data to search');
        return;
    }

    let filteredRequests = window.originalPendingRequests;

    // Filter by request ID
    if (requestIdSearch) {
        filteredRequests = filteredRequests.filter(request => 
            request.id.toString().toLowerCase().includes(requestIdSearch)
        );
    }

    // Filter by project ID
    if (projectIdSearch) {
        filteredRequests = filteredRequests.filter(request => 
            (request.project_id && request.project_id.toString().toLowerCase().includes(projectIdSearch)) ||
            (request.project?.id && request.project.id.toString().toLowerCase().includes(projectIdSearch))
        );
    }

    // Filter by creator
    if (creatorSearch) {
        filteredRequests = filteredRequests.filter(request => 
            (request.created_by_user?.username && request.created_by_user.username.toLowerCase().includes(creatorSearch)) ||
            (request.creator?.username && request.creator.username.toLowerCase().includes(creatorSearch)) ||
            (request.creator_name && request.creator_name.toLowerCase().includes(creatorSearch))
        );
    }

    // Update search results count
    document.getElementById('pending-search-results').textContent = 
        `Showing ${filteredRequests.length} of ${window.originalPendingRequests.length} requests`;

    // Re-display the filtered results
    displayFilteredPendingRequests(filteredRequests);
}

function displayFilteredPendingRequests(requests) {
    const container = document.getElementById('pending-requests-container');
    container.innerHTML = '';

    if (requests.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p class="text-lg">No matching requests found</p>
                <p class="text-sm">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }

    // Group by type and display
    const projects = requests.filter(r => r.type === 'project');
    const itemCodes = requests.filter(r => r.type === 'code');
    const standardValues = requests.filter(r => r.type === 'value');
    const combinations = requests.filter(r => r.type === 'block');

    // Display projects
    if (projects.length > 0) {
        const projectSection = document.createElement('div');
        projectSection.innerHTML = `
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-purple-800 mb-2">üìã Classification Projects (${projects.length})</h3>
            </div>
            <div id="filtered-projects-container" class="grid gap-4 mb-8"></div>
        `;
        container.appendChild(projectSection);

        const projectsContainer = document.getElementById('filtered-projects-container');
        projects.forEach(project => {
            projectsContainer.appendChild(createSimpleReviewerCard(project));
        });
    }

    // Display other types similarly...
    if (itemCodes.length > 0) {
        const itemCodesSection = document.createElement('div');
        itemCodesSection.innerHTML = `
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-green-800 mb-2">üè∑Ô∏è Item Code Requests (${itemCodes.length})</h3>
            </div>
            <div id="filtered-itemcodes-container" class="grid gap-4 mb-8"></div>
        `;
        container.appendChild(itemCodesSection);

        const itemCodesContainer = document.getElementById('filtered-itemcodes-container');
        itemCodes.forEach(request => {
            itemCodesContainer.appendChild(createSimpleReviewerCard(request));
        });
    }
}

// Search functions for Pending Requests tab
function searchPendingRequests() {
    const requestIdSearch = document.getElementById('pending-request-id-search').value.toLowerCase();
    const projectSearch = document.getElementById('pending-project-search').value.toLowerCase();
    const creatorSearch = document.getElementById('pending-creator-search').value.toLowerCase();
    
    console.log('Searching pending requests:', { requestIdSearch, projectSearch, creatorSearch });
    
    if (!window.allPendingItems) {
        console.log('No pending items data available - reloading pending requests');
        loadPendingRequests();
        return;
    }
    
    let filteredItems = window.allPendingItems.filter(item => {
        const requestIdMatch = !requestIdSearch || 
            (item.id && item.id.toString().toLowerCase().includes(requestIdSearch));
            
        const projectMatch = !projectSearch || 
            (item.id && item.id.toString().includes(projectSearch)) ||
            (item.project_id && item.project_id.toString().includes(projectSearch)) ||
            (item.project_name && item.project_name.toLowerCase().includes(projectSearch));
            
        const creatorMatch = !creatorSearch || 
            (item.creator_name && item.creator_name.toLowerCase().includes(creatorSearch)) ||
            (item.created_by_name && item.created_by_name.toLowerCase().includes(creatorSearch));
            
        return requestIdMatch && projectMatch && creatorMatch;
    });
    
    console.log(`Filtered pending requests: ${window.allPendingItems.length} -> ${filteredItems.length}`);
    
    // Update search results display
    document.getElementById('pending-search-results').textContent = 
        `Showing ${filteredItems.length} of ${window.allPendingItems.length} requests`;
    
    // Store filtered items globally
    window.filteredPendingItems = filteredItems;
    
    // Display filtered results directly
    displayFilteredPendingRequests(filteredItems);
}

function displayFilteredPendingRequests(filteredItems) {
    const container = document.getElementById('pending-requests-container');
    container.innerHTML = '';

    if (filteredItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p class="text-lg">No matching requests found</p>
                <p class="text-sm">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }

    // Group by type
    const projects = filteredItems.filter(item => item.type === 'project');
    const itemCodes = filteredItems.filter(item => item.type === 'code');
    const standardValues = filteredItems.filter(item => item.type === 'value');
    const combinations = filteredItems.filter(item => item.type === 'block');

    // Display Projects Section
    if (projects.length > 0) {
        const projectsSection = document.createElement('div');
        projectsSection.className = 'mb-8';
        projectsSection.innerHTML = `
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-purple-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    üìã PROJECTS (${projects.length})
                </h3>
            </div>
            <div id="filtered-projects-container" class="grid gap-4"></div>
        `;
        container.appendChild(projectsSection);

        const projectsContainer = document.getElementById('filtered-projects-container');
        projects.forEach(project => {
            projectsContainer.appendChild(createSimpleReviewerCard({
                ...project,
                canReview: true
            }));
        });
    }

    // Display Item Codes Section
    if (itemCodes.length > 0) {
        const itemCodesSection = document.createElement('div');
        itemCodesSection.className = 'mb-8';
        itemCodesSection.innerHTML = `
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    üè∑Ô∏è ITEM CODES (${itemCodes.length})
                </h3>
            </div>
            <div id="filtered-itemcodes-container" class="grid gap-4"></div>
        `;
        container.appendChild(itemCodesSection);

        const itemCodesContainer = document.getElementById('filtered-itemcodes-container');
        itemCodes.forEach(request => {
            itemCodesContainer.appendChild(createSimpleReviewerCard({
                ...request,
                canReview: true
            }));
        });
    }

    // Display Standard Values Section
    if (standardValues.length > 0) {
        const standardValuesSection = document.createElement('div');
        standardValuesSection.className = 'mb-8';
        standardValuesSection.innerHTML = `
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    ‚≠ê STANDARD VALUES (${standardValues.length})
                </h3>
            </div>
            <div id="filtered-values-container" class="grid gap-4"></div>
        `;
        container.appendChild(standardValuesSection);

        const standardValuesContainer = document.getElementById('filtered-values-container');
        standardValues.forEach(request => {
            standardValuesContainer.appendChild(createSimpleReviewerCard({
                ...request,
                canReview: true
            }));
        });
    }

    // Display Combinations Section
    if (combinations.length > 0) {
        const combinationsSection = document.createElement('div');
        combinationsSection.className = 'mb-8';
        combinationsSection.innerHTML = `
            <div class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-red-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"></path>
                    </svg>
                    üö´ BLOCK COMBINATIONS (${combinations.length})
                </h3>
            </div>
            <div id="filtered-combinations-container" class="grid gap-4"></div>
        `;
        container.appendChild(combinationsSection);

        const combinationsContainer = document.getElementById('filtered-combinations-container');
        combinations.forEach(request => {
            combinationsContainer.appendChild(createSimpleReviewerCard({
                ...request,
                canReview: true
            }));
        });
    }
}

function clearPendingSearch() {
    document.getElementById('pending-request-id-search').value = '';
    document.getElementById('pending-project-search').value = '';
    document.getElementById('pending-creator-search').value = '';
    document.getElementById('pending-search-results').textContent = '';
    window.filteredPendingItems = null;
    loadPendingRequests();
}

// Search functions for Reviewer History tab  
function searchReviewerHistory() {
    const requestIdSearch = document.getElementById('history-request-id-search').value.toLowerCase();
    const projectSearch = document.getElementById('history-project-search').value.toLowerCase();
    const creatorSearch = document.getElementById('history-creator-search').value.toLowerCase();
    const statusFilter = document.getElementById('history-status-filter').value;
    const typeFilter = document.getElementById('history-type-filter').value;
    
    console.log('Searching reviewer history:', { requestIdSearch, projectSearch, creatorSearch, statusFilter, typeFilter });
    
    if (!window.allReviewedItems) {
        console.log('No reviewed items data available');
        return;
    }
    
    let filteredItems = window.allReviewedItems.filter(item => {
        const requestIdMatch = !requestIdSearch || 
            (item.id && item.id.toString().toLowerCase().includes(requestIdSearch));
            
        const projectMatch = !projectSearch || 
            (item.id && item.id.toString().includes(projectSearch)) ||
            (item.project_id && item.project_id.toString().includes(projectSearch)) ||
            (item.project_name && item.project_name.toLowerCase().includes(projectSearch));
            
        const creatorMatch = !creatorSearch || 
            (item.creator_name && item.creator_name.toLowerCase().includes(creatorSearch));
            
        const statusMatch = !statusFilter || item.my_action === statusFilter;
        const typeMatch = !typeFilter || item.type === typeFilter;
            
        return requestIdMatch && projectMatch && creatorMatch && statusMatch && typeMatch;
    });
    
    console.log(`Filtered reviewer history: ${window.allReviewedItems.length} -> ${filteredItems.length}`);
    
    // Update summary stats with filtered data
    updateHistorySummary(filteredItems);
    
    // Display filtered results
    displayReviewerHistory(filteredItems);
}

function clearHistorySearch() {
    document.getElementById('history-request-id-search').value = '';
    document.getElementById('history-project-search').value = '';
    document.getElementById('history-creator-search').value = '';
    document.getElementById('history-status-filter').value = '';
    document.getElementById('history-type-filter').value = '';
    
    // Reset to show all items
    if (window.allReviewedItems) {
        updateHistorySummary(window.allReviewedItems);
        displayReviewerHistory(window.allReviewedItems);
    }
}

// Search functions for All Requests tab
function searchAllRequests() {
    const projectSearch = document.getElementById('all-project-search').value.toLowerCase();
    const creatorSearch = document.getElementById('all-creator-search').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    
    console.log('Searching all requests:', { projectSearch, creatorSearch, statusFilter, typeFilter, dateFilter });
    
    if (!window.allRequestsData) {
        console.log('No all requests data available');
        return;
    }
    
    let filteredItems = window.allRequestsData.filter(item => {
        const projectMatch = !projectSearch || 
            (item.id && item.id.toString().includes(projectSearch)) ||
            (item.project_id && item.project_id.toString().includes(projectSearch)) ||
            (item.project_name && item.project_name.toLowerCase().includes(projectSearch));
            
        const creatorMatch = !creatorSearch || 
            (item.creator_name && item.creator_name.toLowerCase().includes(creatorSearch)) ||
            (item.created_by_name && item.created_by_name.toLowerCase().includes(creatorSearch));
            
        const statusMatch = !statusFilter || item.status === statusFilter;
        const typeMatch = !typeFilter || item.type === typeFilter;
        
        // Date filtering logic
        let dateMatch = true;
        if (dateFilter && item.created_at) {
            const itemDate = new Date(item.created_at);
            const now = new Date();
            
            switch(dateFilter) {
                case 'today':
                    dateMatch = itemDate.toDateString() === now.toDateString();
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    dateMatch = itemDate >= weekAgo;
                    break;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    dateMatch = itemDate >= monthAgo;
                    break;
                case 'quarter':
                    const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    dateMatch = itemDate >= quarterAgo;
                    break;
            }
        }
            
        return projectMatch && creatorMatch && statusMatch && typeMatch && dateMatch;
    });
    
    console.log(`Filtered all requests: ${window.allRequestsData.length} -> ${filteredItems.length}`);
    
    // Store filtered data and reload
    window.filteredAllRequestsData = filteredItems;
    // TODO: Implement re-rendering for all requests tab
}

function clearAllRequestsSearch() {
    document.getElementById('all-project-search').value = '';
    document.getElementById('all-creator-search').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('type-filter').value = '';
    document.getElementById('date-filter').value = '';
    
    window.filteredAllRequestsData = null;
    // TODO: Reload all requests tab
}

// ===== ADMIN SEARCH FUNCTIONS =====
function searchAdminRequests() {
    const requestIdSearch = document.getElementById('admin-request-id-search').value.toLowerCase();
    const creatorSearch = document.getElementById('admin-creator-search').value.toLowerCase();
    const reviewerSearch = document.getElementById('admin-reviewer-search').value.toLowerCase();
    
    console.log('Searching admin requests:', { requestIdSearch, creatorSearch, reviewerSearch });
    
    if (!window.originalAdminRequests) {
        console.log('No admin requests data available');
        return;
    }
    
    let filteredRequests = window.originalAdminRequests.filter(request => {
        const requestIdMatch = !requestIdSearch || 
            (request.id && request.id.toString().toLowerCase().includes(requestIdSearch));
            
        const creatorMatch = !creatorSearch || 
            (request.creator_name && request.creator_name.toLowerCase().includes(creatorSearch));
            
        const reviewerMatch = !reviewerSearch || 
            (request.reviewer_name && request.reviewer_name.toLowerCase().includes(reviewerSearch));
            
        return requestIdMatch && creatorMatch && reviewerMatch;
    });
    
    console.log(`Filtered admin requests: ${window.originalAdminRequests.length} -> ${filteredRequests.length}`);
    
    // Update search results display
    document.getElementById('admin-search-results').textContent = 
        `Showing ${filteredRequests.length} of ${window.originalAdminRequests.length} requests`;
    
    // Re-display filtered results
    displayFilteredAdminRequests(filteredRequests);
}

function displayFilteredAdminRequests(requests) {
    const container = document.getElementById('admin-panel-container');
    container.innerHTML = '';

    if (requests.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p class="text-lg">No matching requests found</p>
                <p class="text-sm">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }

    // Create admin pending section with filtered results
    const adminPendingSection = document.createElement('div');
    adminPendingSection.className = 'mb-8';
    adminPendingSection.innerHTML = `
        <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-orange-800 mb-2 flex items-center">
                <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                ‚è≥ FILTERED ADMIN REQUESTS (${requests.length})
            </h3>
        </div>
        <div id="filtered-admin-container" class="grid gap-4"></div>
    `;
    container.appendChild(adminPendingSection);

    const adminContainer = document.getElementById('filtered-admin-container');
    requests.forEach(item => {
        adminContainer.appendChild(createDetailedAdminReviewCard(item));
    });
}

function clearAdminSearch() {
    document.getElementById('admin-request-id-search').value = '';
    document.getElementById('admin-creator-search').value = '';
    document.getElementById('admin-reviewer-search').value = '';
    document.getElementById('admin-search-results').textContent = '';
    
    // Reset to show all admin requests
    if (currentUser.role === 'admin') {
        loadAdminPendingRequests();
    }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', initializeApp);

</script>

</body>
</html>
